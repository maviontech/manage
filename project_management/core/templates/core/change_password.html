{% extends "core/base.html" %}
{% block title %}Change Password — Trackline{% endblock %}

{% block content %}
<style>
/* NAMESPACED styles for Change Password page
   All selectors start with .pw- to avoid colliding with global .card / .btn etc.
*/
.pw-wrap {
  max-width: 920px;
  margin: 28px auto;
  padding: 0 18px;
}

/* card container (namespaced) */
.pw-card {
  background: #fff;
  border-radius: 12px;
  padding: 26px;
  box-shadow: 0 10px 30px rgba(16,24,40,0.06);
  overflow: hidden;
}

/* header */
.pw-hero { display:flex; align-items:center; gap:16px; margin-bottom:14px; }
.pw-hero .pw-title { font-size:20px; font-weight:700; color:#0f172a; margin:0; }
.pw-hero .pw-subtitle { color:#64748b; font-size:13px; margin:0; }

/* grid layout */
.pw-grid { display:grid; grid-template-columns: 1fr; gap:14px; }
@media(min-width:700px){ .pw-grid { grid-template-columns: 1fr 360px; align-items:start; } }

.pw-form-column { display:flex; flex-direction:column; gap:12px; }
.pw-field { display:flex; flex-direction:column; gap:6px; }
.pw-label { font-weight:600; font-size:14px; color:#0f172a; }

.pw-input {
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #e6eef9;
  background:#fff;
  outline:none;
  font-size:14px;
}
.pw-input:focus { box-shadow:0 4px 12px rgba(34,110,255,0.06); border-color:#90baff; }

.pw-row-inline { display:flex; gap:8px; align-items:center; }
.pw-toggle-btn { background:transparent; border:none; cursor:pointer; font-size:13px; color:#2563eb; padding:6px; }

/* namespaced strength bar */
.pw-strength {
  height:8px; border-radius:6px; background:#eef2ff; overflow:hidden;
  box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);
}
.pw-strength > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff9a00,#0b57a4); transition:width .25s ease; }

/* rules / tips */
.pw-rules { font-size:13px; color:#64748b; margin-top:6px; line-height:1.5; }
.pw-rule { display:flex; gap:8px; align-items:center; }
.pw-rule.ok { color:#065f46; font-weight:600; }
.pw-rule .pw-dot { width:10px; height:10px; border-radius:50%; background:#e2e8f0; display:inline-block; }
.pw-rule.ok .pw-dot { background:#10b981; box-shadow:0 2px 6px rgba(16,185,129,0.12); }

/* namespaced action buttons to avoid overriding global .btn */
.pw-actions { display:flex; gap:10px; margin-top:8px; }
.pw-btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,#0b57a4,#1f86e3); color:white; font-weight:600; }
.pw-btn-ghost { padding:10px 14px; border-radius:10px; border:1px solid #e6eef9; background:transparent; cursor:pointer; color:#0f172a; }

.pw-note { color:#94a3b8; font-size:13px; margin-top:6px; }
.pw-error { color:#b91c1c; font-size:13px; margin-top:6px; }
.pw-success { color:#065f46; font-size:13px; margin-top:6px; }

/* keep the sidebar and other global components untouched */
</style>

<div class="pw-wrap">
  <div class="pw-card" role="region" aria-labelledby="change-password-title">
    <div class="pw-hero">
      <div>
        <h2 id="change-password-title" class="pw-title">Change Password</h2>
        <p class="pw-subtitle">Choose a strong password to keep your account secure.</p>
      </div>
    </div>

    <div class="pw-grid">
      <!-- Left: Form -->
      <div class="pw-form-column" aria-live="polite">
        <form id="pwChangeForm" method="post" action="">
          {% csrf_token %}
          <div class="pw-field">
            <label class="pw-label" for="current_password">Current password</label>
            <div class="pw-row-inline">
              <input id="current_password" name="current_password" type="password" class="pw-input" required autocomplete="current-password" />
              <button type="button" class="pw-toggle-btn" data-target="current_password" aria-label="Show current password">Show</button>
            </div>
          </div>

          <div class="pw-field">
            <label class="pw-label" for="new_password">New password</label>
            <div class="pw-row-inline">
              <input id="new_password" name="new_password" type="password" class="pw-input" required autocomplete="new-password" />
              <button type="button" class="pw-toggle-btn" data-target="new_password" aria-label="Show new password">Show</button>
            </div>

            <div class="pw-strength" aria-hidden="true" title="Password strength">
              <i id="pwStrengthBar" class="pw-strength-bar"></i>
            </div>
            <div id="pwQualityText" class="pw-note">Enter a password to see strength.</div>
          </div>

          <div class="pw-field">
            <label class="pw-label" for="confirm_password">Confirm new password</label>
            <div class="pw-row-inline">
              <input id="confirm_password" name="confirm_password" type="password" class="pw-input" required autocomplete="new-password" />
              <button type="button" class="pw-toggle-btn" data-target="confirm_password" aria-label="Show confirm password">Show</button>
            </div>
            <div id="matchNote" class="pw-note"></div>
          </div>

          <div class="pw-actions">
            <button id="submitBtn" class="pw-btn" type="submit" disabled>Change password</button>
            <button type="button" id="cancelBtn" class="pw-btn-ghost">Cancel</button>
          </div>

          <div id="formMessage" aria-live="assertive"></div>
        </form>
      </div>

      <!-- Right: Password rules / tips (namespaced) -->
      <aside>
        <div class="pw-rules" aria-hidden="false">
          <div style="font-weight:700;margin-bottom:8px">Password requirements</div>
          <div class="pw-rule" id="r-length"><span class="pw-dot"></span> At least 8 characters</div>
          <div class="pw-rule" id="r-upper"><span class="pw-dot"></span> Uppercase letter (A–Z)</div>
          <div class="pw-rule" id="r-lower"><span class="pw-dot"></span> Lowercase letter (a–z)</div>
          <div class="pw-rule" id="r-number"><span class="pw-dot"></span> A number (0–9)</div>
          <div class="pw-rule" id="r-special"><span class="pw-dot"></span> A special character (e.g. !@#$%)</div>

          <div style="margin-top:12px" class="pw-note">
            Tip: Use a passphrase for better memorability and strength. Avoid reuse of old passwords.
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
/* Namespaced JS — uses namespaced classes/IDs only. */
(function(){
  const newPw = document.getElementById('new_password');
  const confirmPw = document.getElementById('confirm_password');
  const strengthBar = document.getElementById('pwStrengthBar');
  const qualityText = document.getElementById('pwQualityText');
  const submitBtn = document.getElementById('submitBtn');
  const matchNote = document.getElementById('matchNote');

  const rules = {
    length: s => s.length >= 8,
    upper: s => /[A-Z]/.test(s),
    lower: s => /[a-z]/.test(s),
    number: s => /[0-9]/.test(s),
    special: s => /[^A-Za-z0-9]/.test(s)
  };

  function evaluate(pw){
    if(!pw) return {score:0, label:'Enter a password'};
    let score = 0;
    if(rules.length(pw)) score += 1;
    if(rules.upper(pw)) score += 1;
    if(rules.lower(pw)) score += 1;
    if(rules.number(pw)) score += 1;
    if(rules.special(pw)) score += 1;
    let label = ['Very weak','Weak','Okay','Good','Strong','Excellent'][score];
    return {score, label};
  }

  function updateRules(pw){
    const mapping = [
      ['r-length', rules.length],
      ['r-upper', rules.upper],
      ['r-lower', rules.lower],
      ['r-number', rules.number],
      ['r-special', rules.special]
    ];
    mapping.forEach(([id, fn])=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(fn(pw)) el.classList.add('ok'); else el.classList.remove('ok');
    });
  }

  function updateStrength(pw){
    const res = evaluate(pw);
    const pct = (res.score / 5) * 100;
    strengthBar.style.width = pct + '%';
    qualityText.textContent = res.label;
  }

  function checkMatch(){
    if(!confirmPw.value) { matchNote.textContent = ''; matchNote.className = 'pw-note'; return false; }
    if(newPw.value === confirmPw.value){
      matchNote.textContent = 'Passwords match';
      matchNote.className = 'pw-success';
      return true;
    } else {
      matchNote.textContent = 'Passwords do not match';
      matchNote.className = 'pw-error';
      return false;
    }
  }

  function toggleSubmitState(){
    const passedRules = Object.values(rules).every(fn => fn(newPw.value));
    const matched = checkMatch();
    submitBtn.disabled = !(passedRules && matched);
  }

  newPw.addEventListener('input', (e)=>{
    const val = e.target.value || '';
    updateRules(val);
    updateStrength(val);
    checkMatch();
    toggleSubmitState();
  });

  confirmPw.addEventListener('input', ()=>{
    checkMatch();
    toggleSubmitState();
  });

  // show/hide toggles limited to namespaced .pw-toggle-btn
  document.querySelectorAll('.pw-toggle-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.getAttribute('data-target');
      const el = document.getElementById(targetId);
      if(!el) return;
      el.type = el.type === 'password' ? 'text' : 'password';
      btn.textContent = el.type === 'password' ? 'Show' : 'Hide';
    });
  });

  // Cancel: go back
  const cancel = document.getElementById('cancelBtn');
  if(cancel) cancel.addEventListener('click', ()=> window.history.back());

  // final safety: validate on submit (client-only)
  const form = document.getElementById('pwChangeForm');
  if(form) form.addEventListener('submit', (ev)=>{
    if(submitBtn.disabled){
      ev.preventDefault();
      alert('Please satisfy password requirements and ensure confirmation matches.');
    }
  });

})();
</script>
{% endblock %}
