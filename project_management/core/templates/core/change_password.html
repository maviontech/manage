{% extends "core/base.html" %}
{% block title %}Change Password — Trackline{% endblock %}

{% block content %}
<style>
/* Small, self-contained styles that match the app's polished look */
.pw-wrap {
  max-width: 820px;
  margin: 28px auto;
  padding: 0 18px;
}
.pw-card {
  background: #fff;
  border-radius: 12px;
  padding: 26px;
  box-shadow: 0 10px 30px rgba(16,24,40,0.06);
  overflow: hidden;
}
.pw-hero {
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:14px;
}
.pw-hero .title { font-size:20px; font-weight:700; color:#0f172a; margin:0; }
.pw-hero .subtitle { color:#64748b; font-size:13px; margin:0; }

.pw-grid { display:grid; grid-template-columns: 1fr; gap:14px; }
@media(min-width:700px){ .pw-grid { grid-template-columns: 1fr 360px; align-items:start; } }

.form-column { display:flex; flex-direction:column; gap:12px; }
.field { display:flex; flex-direction:column; gap:6px; }
.label { font-weight:600; font-size:14px; color:#0f172a; }
.input {
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #e6eef9;
  background:#fff;
  outline:none;
  font-size:14px;
}
.input:focus { box-shadow:0 4px 12px rgba(34, 110, 255, 0.08); border-color:#90baff; }

.row-inline { display:flex; gap:8px; align-items:center; }
.toggle-btn { background:transparent; border:none; cursor:pointer; font-size:13px; color:#2563eb; }

.pw-strength {
  height:8px; border-radius:6px; background:#eef2ff; overflow:hidden;
  box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);
}
.pw-strength > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff9a00,#0b57a4); transition:width .25s ease; }

.rules { font-size:13px; color:#64748b; margin-top:6px; line-height:1.5; }
.rule { display:flex; gap:8px; align-items:center; }
.rule.ok { color:#065f46; font-weight:600; }
.rule .dot { width:10px; height:10px; border-radius:50%; background:#e2e8f0; display:inline-block; }
.rule.ok .dot { background:#10b981; box-shadow:0 2px 6px rgba(16,185,129,0.12); }

.actions { display:flex; gap:10px; margin-top:8px; }
.btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,#0b57a4,#1f86e3); color:white; font-weight:600; }
.btn-ghost { padding:10px 14px; border-radius:10px; border:1px solid #e6eef9; background:transparent; cursor:pointer; color:#0f172a; }

.note { color:#94a3b8; font-size:13px; margin-top:6px; }
.error { color:#b91c1c; font-size:13px; margin-top:6px; }
.success { color:#065f46; font-size:13px; margin-top:6px; }
</style>

<div class="pw-wrap">
  <div class="pw-card" role="region" aria-labelledby="change-password-title">
    <div class="pw-hero">
      <div>
        <h2 id="change-password-title" class="title">Change Password</h2>
        <p class="subtitle">Choose a strong password to keep your account secure.</p>
      </div>
    </div>

    <div class="pw-grid">
      <!-- Left: Form -->
      <div class="form-column" aria-live="polite">
        <form id="changePasswordForm" method="post" action="">
          {% csrf_token %}
          <div class="field">
            <label class="label" for="current_password">Current password</label>
            <div class="row-inline">
              <input id="current_password" name="current_password" type="password" class="input" required autocomplete="current-password" />
              <button type="button" class="toggle-btn" data-target="current_password" aria-label="Show current password">Show</button>
            </div>
          </div>

          <div class="field">
            <label class="label" for="new_password">New password</label>
            <div class="row-inline">
              <input id="new_password" name="new_password" type="password" class="input" required autocomplete="new-password" />
              <button type="button" class="toggle-btn" data-target="new_password" aria-label="Show new password">Show</button>
            </div>

            <div class="pw-strength" aria-hidden="true" title="Password strength">
              <i id="pwStrengthBar"></i>
            </div>
            <div id="pwQualityText" class="note">Enter a password to see strength.</div>
          </div>

          <div class="field">
            <label class="label" for="confirm_password">Confirm new password</label>
            <div class="row-inline">
              <input id="confirm_password" name="confirm_password" type="password" class="input" required autocomplete="new-password" />
              <button type="button" class="toggle-btn" data-target="confirm_password" aria-label="Show confirm password">Show</button>
            </div>
            <div id="matchNote" class="note"></div>
          </div>

          <div class="actions">
            <button id="submitBtn" class="btn" type="submit" disabled>Change password</button>
            <button type="button" id="cancelBtn" class="btn-ghost">Cancel</button>
          </div>

          <div id="formMessage" aria-live="assertive"></div>
        </form>
      </div>

      <!-- Right: Password rules / tips -->
      <aside>
        <div class="rules" aria-hidden="false">
          <div style="font-weight:700;margin-bottom:8px">Password requirements</div>
          <div class="rule" id="r-length"><span class="dot"></span> At least 8 characters</div>
          <div class="rule" id="r-upper"><span class="dot"></span> Uppercase letter (A–Z)</div>
          <div class="rule" id="r-lower"><span class="dot"></span> Lowercase letter (a–z)</div>
          <div class="rule" id="r-number"><span class="dot"></span> A number (0–9)</div>
          <div class="rule" id="r-special"><span class="dot"></span> A special character (e.g. !@#$%)</div>

          <div style="margin-top:12px" class="note">
            Tip: Use a passphrase for better memorability and strength. Avoid reuse of old passwords.
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
/* Client-side UX: strength meter, show/hide, validation
   Keep logic purely cosmetic — server must still verify rules on submit.
*/
(function(){
  const newPw = document.getElementById('new_password');
  const confirmPw = document.getElementById('confirm_password');
  const strengthBar = document.getElementById('pwStrengthBar');
  const qualityText = document.getElementById('pwQualityText');
  const submitBtn = document.getElementById('submitBtn');
  const matchNote = document.getElementById('matchNote');

  const rules = {
    length: el => el.length >= 8,
    upper: el => /[A-Z]/.test(el),
    lower: el => /[a-z]/.test(el),
    number: el => /[0-9]/.test(el),
    special: el => /[^A-Za-z0-9]/.test(el)
  };

  function evaluate(pw){
    if(!pw) return {score:0, label:'Enter a password'};
    let score = 0;
    if(rules.length(pw)) score += 1;
    if(rules.upper(pw)) score += 1;
    if(rules.lower(pw)) score += 1;
    if(rules.number(pw)) score += 1;
    if(rules.special(pw)) score += 1;
    let label = ['Very weak','Weak','Okay','Good','Strong','Excellent'][score];
    return {score, label};
  }

  function updateRules(pw){
    const mapping = [
      ['r-length', rules.length],
      ['r-upper', rules.upper],
      ['r-lower', rules.lower],
      ['r-number', rules.number],
      ['r-special', rules.special]
    ];
    mapping.forEach(([id, fn])=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(fn(pw)){
        el.classList.add('ok');
      } else {
        el.classList.remove('ok');
      }
    });
  }

  function updateStrength(pw){
    const res = evaluate(pw);
    const pct = (res.score / 5) * 100;
    strengthBar.style.width = pct + '%';
    qualityText.textContent = res.label;
  }

  function checkMatch(){
    if(!confirmPw.value) { matchNote.textContent = ''; return false; }
    if(newPw.value === confirmPw.value){
      matchNote.textContent = 'Passwords match';
      matchNote.className = 'success';
      return true;
    } else {
      matchNote.textContent = 'Passwords do not match';
      matchNote.className = 'error';
      return false;
    }
  }

  function toggleSubmitState(){
    const passedRules = Object.values(rules).every(fn => fn(newPw.value));
    const matched = checkMatch();
    submitBtn.disabled = !(passedRules && matched);
  }

  newPw.addEventListener('input', (e)=>{
    const val = e.target.value || '';
    updateRules(val);
    updateStrength(val);
    checkMatch();
    toggleSubmitState();
  });

  confirmPw.addEventListener('input', ()=>{
    checkMatch();
    toggleSubmitState();
  });

  // show/hide toggles
  document.querySelectorAll('.toggle-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.getAttribute('data-target');
      const el = document.getElementById(targetId);
      if(!el) return;
      el.type = el.type === 'password' ? 'text' : 'password';
      btn.textContent = el.type === 'password' ? 'Show' : 'Hide';
    });
  });

  // Cancel: go back
  document.getElementById('cancelBtn').addEventListener('click', ()=>{
    window.history.back();
  });

  // final safety: validate on submit (client-side nicety only)
  document.getElementById('changePasswordForm').addEventListener('submit', (ev)=>{
    // run check, but let server enforce rules
    if(submitBtn.disabled){
      ev.preventDefault();
      alert('Please satisfy password requirements and ensure confirmation matches.');
    }
  });

})();
</script>
{% endblock %}
