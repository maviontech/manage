{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">

  <!-- ===== Header Section ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
    <div>
      <h4 class="fw-bold text-gradient mb-0">
        <i class="fa-solid fa-table-columns me-2"></i> Task Board
      </h4>
      <p class="small text-muted mb-0">Drag &amp; drop tasks between columns. Click a card to view details.</p>
    </div>

    <!-- Action buttons -->
    <div class="d-flex flex-wrap align-items-center gap-2 header-actions">
      <a href="{% url 'create_task' %}" class="btn btn-gradient btn-lg">
        <i class="fa-solid fa-plus me-1"></i> New Task
      </a>
      <a href="{% url 'unassigned_tasks' %}" class="btn btn-outline-gradient btn-lg">
        <i class="fa-solid fa-user-clock me-1"></i> Unassigned
      </a>
    </div>
  </div>

  <!-- ===== Search Bar ===== -->
  <div class="card mb-4 border-0 shadow-sm search-card">
    <div class="card-body py-3 d-flex align-items-center gap-3 flex-wrap">
      <div class="position-relative flex-fill" style="min-width:280px;">
        <input type="text" id="taskSearch" class="form-control search-input" placeholder="Search tasks by title, assignee or priority...">
      </div>

      <div class="d-flex gap-2">
        <select id="priorityFilter" class="form-select" style="width:160px;">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
        <button id="clearFilters" class="btn btn-light">Clear</button>
      </div>
    </div>
  </div>

  <!-- ===== Kanban Board ===== -->
  <div class="kanban-board-wrapper mb-3">
    <div class="kanban-board" id="kanbanBoard">
      {% for col in status_columns %}
      <div class="kanban-column">
        <div class="kanban-header">{{ col }}</div>
        <div class="kanban-body" data-status="{{ col }}" id="col-{{ col|slugify }}"></div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Pagination / Summary ===== -->
  <div class="d-flex flex-column align-items-center mt-3">
    <div id="boardSummary" class="small text-muted mb-1"></div>
    <nav aria-label="Task board pages">
      <ul class="pagination mb-0" id="boardPagination"></ul>
    </nav>
  </div>
</div>

<!-- ===== Task Detail Modal (styled like Create Task) ===== -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true" hidden>
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content modal-opaque-content" role="dialog" aria-modal="true" aria-labelledby="taskDetailTitle">

      <!-- Circular close (top-right) -->
      <button type="button" class="modal-close-circle" aria-label="Close" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="#0b2440"/></svg>
      </button>

      <form id="taskDetailForm" class="row gx-4" novalidate>
        {% csrf_token %}
        <input type="hidden" id="modal_task_id" name="task_id" value="">
        <div class="card-body p-4" style="background:transparent; box-shadow:none; padding-left:34px; padding-right:34px;">
          <div class="modal-header-centered mb-3">
            <div class="modal-title-wrap">
              <h3 class="fw-bold mb-1 text-gradient text-center" id="taskDetailTitle">Task Details</h3>
              <p class="text-muted small mb-0 text-center" id="modalSubtitle">View and update task information</p>
            </div>
          </div>

          <!-- ===== Re-use Create Task form styling here (labels on left, inputs on right) ==== -->
          <div class="form-grid">

            <!-- Title -->
            <div class="form-row">
              <label class="form-label">Task Title <span class="text-danger">*</span></label>
              <div class="form-control-wrap">
                <input id="modal_title" name="title" type="text" class="form-control" placeholder="e.g. Implement user authentication" required>
                <div class="form-hint">Short, descriptive title</div>
              </div>
            </div>

            <!-- Project (populated from AJAX, not template context) -->
            <div class="form-row">
              <label class="form-label">Project</label>
              <div class="form-control-wrap">
                <select name="project_id" id="modal_project" class="form-select">
                  <option value="">-- Choose Project --</option>
                </select>
              </div>
            </div>

            <!-- Subproject -->
            <div class="form-row">
              <label class="form-label">Subproject</label>
              <div class="form-control-wrap">
                <select name="subproject_id" id="modal_subproject" class="form-select">
                  <option value="">-- Optional Subproject --</option>
                </select>
              </div>
            </div>

            <!-- Priority -->
            <div class="form-row">
              <label class="form-label">Priority</label>
              <div class="form-control-wrap">
                <select id="modal_priority" name="priority" class="form-select">
                  <option value="Low">Low</option>
                  <option value="Normal">Normal</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <!-- Due date -->
            <div class="form-row">
              <label class="form-label">Due date</label>
              <div class="form-control-wrap">
                <input id="modal_due_date" name="due_date" type="date" class="form-control">
              </div>
            </div>

            <!-- Assign to (populated from API at runtime) -->
            <div class="form-row">
              <label class="form-label">Assign to</label>
              <div class="form-control-wrap">
                <select name="assigned_to" id="modal_assignee" class="form-select">
                  <option value="">Unassigned</option>
                  <!-- populated by JS from /api/people/list and /api/teams/list -->
                </select>
              </div>
            </div>

            <!-- Description (spans full width) -->
            <div class="form-row" style="grid-column: 1 / -1;">
              <label class="form-label fw-semibold">Description</label>
              <div class="form-control-wrap">
                <textarea id="modal_description" name="description" rows="6" class="form-control" placeholder="Add detailed notes, acceptance criteria, links, steps to reproduce..."></textarea>
                <div class="form-text mt-2">Optional — good place for acceptance criteria or reproduction steps.</div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer: centered buttons like Create Task (centered inside modal content) -->
        <div class="modal-footer-centered">
          <div class="footer-inner">
            <div class="footer-btns">
              <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
              <button id="saveTaskBtn" type="submit" class="btn btn-gradient"><i class="fa-solid fa-check me-1"></i> Save changes</button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ===== Styles: adopt Create Task styles for the overlay + soft frosted backdrop ===== -->
<style>
/* Board styles kept */
.header-actions .btn { display:inline-flex; align-items:center; gap:8px; }
.search-card { border-radius:10px; }
.search-input { border-radius:8px; border:1px solid #e6eef6; box-shadow:none; height:44px; }
/* .search-icon removed */
.btn-lg { padding:10px 16px; border-radius:10px; font-weight:600; }
.header-actions { margin-left:12px; }

.kanban-board-wrapper { overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
.kanban-board { display: flex; gap: 16px; min-height: 70vh; padding-bottom: 10px; align-items: flex-start; }
.kanban-column { flex: 0 0 320px; background: #fbfeff; border-radius: 12px; box-shadow: 0 6px 18px rgba(13,38,71,0.06); display: flex; flex-direction: column; height: auto; max-height: 80vh; }
.kanban-header { background: linear-gradient(90deg, #0b57a4, #38bdf8); color: #fff; text-align: center; border-radius: 8px 8px 0 0; font-weight: 700; padding: 10px; position: sticky; top: 0; z-index: 2; }
.kanban-body { flex: 1; padding: 12px; border-radius: 0 0 12px 12px; background-color: #f9fcff; min-height: 55vh; overflow-y: auto; position: relative; z-index: 1; }
.kanban-body.drag-over { background-color: rgba(56, 189, 248, 0.12); border: 2px dashed #38bdf8; }
.task-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:14px 16px; margin-bottom:12px; cursor:grab; transition:transform .12s ease, box-shadow .12s ease; }
.task-card:active { cursor:grabbing; }
.task-card:focus, .task-card:hover { transform:translateY(-4px); box-shadow:0 10px 26px rgba(10,30,60,0.08); outline: none; }
.task-title { font-weight:700; font-size:0.98rem; margin-bottom:4px; color:#0f1724; }
.task-meta { font-size:0.82rem; color:#54607a; margin-top:2px; }
.assignee-name { font-size:0.82rem; font-weight:600; color:#0b57a4; margin-top:8px; }

/* ===== Create Task form look (applied inside modal) ===== */
.form-grid { display:block; max-width:880px; margin: 0 auto; }
.form-row { display:grid; grid-template-columns: 200px 1fr; gap: 12px 20px; align-items:start; margin-bottom:18px; }
.form-label { font-weight:600; color:#0b57a4; font-size:0.95rem; padding-top:6px; text-align:left; }
.form-control-wrap { display:flex; flex-direction:column; }
.form-control, .form-select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #dee2e6; transition:box-shadow .12s, border-color .12s; background:#fff; }
.form-control:focus, .form-select:focus, textarea:focus { outline:none; border-color:#38bdf8; box-shadow:0 4px 14px rgba(56,189,248,0.08); }
.form-hint { font-size:0.85rem; color:#6c757d; margin-top:6px; }
.btn-gradient { background:linear-gradient(90deg,#0b57a4,#1f86e3,#38bdf8); color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:600; }
.btn-outline-gradient { background:#fff; color:#0b57a4; border:1px solid #38bdf8; border-radius:10px; padding:9px 16px; font-weight:600; }

/* custom cancel button matching create_task */
.btn-cancel {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px 14px;
  border-radius:8px;
  background:#ffffff;
  color:#0b57a4;
  border:1px solid rgba(11,87,164,0.12);
  font-weight:600;
  box-shadow: 0 6px 18px rgba(11,87,164,0.03);
}

/* Footer centered layout */
.modal-footer-centered { display:flex; justify-content:center; padding: 12px 20px 20px 20px; background: transparent; }
.footer-inner { width:100%; max-width:880px; margin: 0 auto; display:flex; justify-content:center; }
.footer-btns { display:flex; gap:14px; justify-content:center; align-items:center; width:100%; max-width:420px; }

/* ===== Modal backdrop (soft frost) and modal card ===== */
.modal-backdrop,
.modal-backdrop.fallback {
  position: fixed !important;
  inset: 0 !important;
  background: rgba(6,18,34,0.30) !important; /* mild dim */
  backdrop-filter: blur(6px) saturate(1.05) contrast(0.98);
  -webkit-backdrop-filter: blur(6px) saturate(1.05) contrast(0.98);
  z-index: 1050 !important;
  pointer-events: auto;
}
.modal { z-index: 1060 !important; }

/* Opaque modal content: subtle frosted card with side margins enforced */
.modal-opaque-content {
  position: relative;
  z-index: 1061;
  border-radius: 12px;
  overflow: hidden;
  border: none;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(247,251,255,0.96));
  box-shadow: 0 24px 60px rgba(6,30,60,0.28);
  max-width: 980px;
  margin: 0 auto;
  color: #122033;
  transition: transform .12s ease, opacity .12s ease;
  border: 1px solid rgba(14,66,122,0.04);
  padding-bottom: 6px;
}

/* circular close button */
.modal-close-circle {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(180deg,#ffffff,#f4fbff);
  border: 1px solid rgba(11,87,164,0.06);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 20px rgba(11,87,164,0.06);
  cursor: pointer;
  z-index: 1070;
}
.modal-close-circle svg { display:block; }

/* Center header title & subtitle */
.modal-header-centered { display:block; text-align:center; padding-top:6px; padding-bottom:12px; }
.modal-title-wrap { max-width:760px; margin: 0 auto; }

/* Fallback show (centers modal when bootstrap modal not available) */
.modal.fallback-show {
  display: flex !important;
  position: fixed !important;
  inset: 0 !important;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 1061 !important;
  overflow: auto;
}
.modal.fallback-show .modal-dialog { display:flex; align-items:center; justify-content:center; min-height:0; max-width:96%; margin:0; }
.modal.fallback-show .modal-content { max-height: calc(100vh - 80px); overflow:auto; }

/* Ensure modal dialog centers even when bootstrap attempted to position at bottom */
.modal-dialog { display: flex; align-items: center; min-height: calc(100vh - 80px); }

/* Responsive */
@media (max-width: 992px) {
  .form-row { grid-template-columns: 1fr !important; }
  .modal-opaque-content { margin: 12px; max-width: 96%; padding-left:16px; padding-right:16px; }
  .modal-close-circle { top: 10px; right: 10px; width:36px; height:36px; }
  .footer-inner { padding-left: 8px; padding-right: 8px; }
}
</style>

<!-- ===== JS Logic (board + modal + assignees load + projects load + improved population flow) ===== -->
<script>
let CURRENT_BOARD_PAGE = 1;
const PER_PAGE = 10;
let ALL_TASKS = [];
const TASK_DETAIL_API = "{% url 'api_task_detail' %}";
const TASK_UPDATE_API = "{% url 'api_task_update' %}";
const BOARD_DATA_API = "{% url 'board_data' %}";
const CSRF_TOKEN = "{{ csrf_token }}";

/* Load board (unchanged) */
async function loadBoard(page=1){
  try {
    CURRENT_BOARD_PAGE = page;
    const res = await fetch(BOARD_DATA_API + "?page=" + page);
    if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to load board`);
    const payload = await res.json();
    const tasks = Array.isArray(payload.tasks) ? payload.tasks : [];
    ALL_TASKS = tasks;
    const pageNum = payload.page || 1;
    const totalPages = payload.total_pages || 1;
    const totalCount = payload.total_count || tasks.length;
    renderAllColumns(tasks);
    renderPagination(pageNum, totalPages);
    updateSummary(pageNum, totalCount, totalPages);
  } catch (err) {
    console.error("Board load failed", err);
    document.querySelectorAll(".kanban-body").forEach(c => c.innerHTML = '<div class="text-muted text-center p-3">Error loading tasks</div>');
  }
}
function renderAllColumns(tasks){
  document.querySelectorAll(".kanban-body").forEach(c => c.innerHTML = "");
  tasks.forEach(t => renderCard(t));
  initDragDrop();
  initSearch(ALL_TASKS);
}

/* Card render */
function renderCard(t){
  if (!t || !t.id || !t.status) {
    console.warn("Invalid task data:", t);
    return;
  }
  
  const col = document.querySelector(`[data-status="${t.status}"]`) || document.querySelector(".kanban-body");
  if (!col) return;
  
  const card = document.createElement("div");
  card.className = "task-card";
  card.setAttribute("draggable", "true");
  card.dataset.id = t.id;
  card.setAttribute("tabindex","0");
  card.setAttribute("role","button");
  card.setAttribute("aria-label", "Open task " + (t.title || 'Untitled') );

  let displayAssignee = "";
  if (t.assigned_to_display) displayAssignee = t.assigned_to_display;
  else if (t.assigned_to && typeof t.assigned_to === 'string' && t.assigned_to.startsWith("member:"))
    displayAssignee = "Member " + t.assigned_to.split(":")[1];
  else if (t.assigned_to && typeof t.assigned_to === 'string' && t.assigned_to.startsWith("team:"))
    displayAssignee = "Team " + t.assigned_to.split(":")[1];

  card.innerHTML = `
    <div>
      <div class="task-title">${escapeHtml(t.title || 'Untitled')}</div>
      <div class="task-meta">
        ${escapeHtml(t.priority || 'Normal')}${t.due_date ? ' • Due ' + escapeHtml(t.due_date) : ''}
      </div>
      ${displayAssignee ? `<div class="assignee-name"><i class="fa-solid fa-user me-1"></i>${escapeHtml(displayAssignee)}</div>` : ''}
    </div>
  `;

  card.addEventListener("click", e => {
    if (card.dataset.dragging === "1") return;
    openTaskModal(t.id);
  });
  card.addEventListener("keydown", e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTaskModal(t.id); }
  });

  col.appendChild(card);
}

/* Drag & drop */
function initDragDrop(){
  document.querySelectorAll(".task-card").forEach(card=>{
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", card.dataset.id);
      try { e.dataTransfer.effectAllowed = "move"; } catch(err) {}
      card.dataset.dragging = "1"; card.classList.add("dragging");
    });
    card.addEventListener("dragend", e=>{
      card.dataset.dragging = "0"; card.classList.remove("dragging");
    });
  });

  document.querySelectorAll(".kanban-body").forEach(col=>{
    col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("drag-over"); e.dataTransfer.dropEffect = 'move'; });
    col.addEventListener("dragenter", e=>{ e.preventDefault(); col.classList.add("drag-over"); });
    col.addEventListener("dragleave", e=>{ col.classList.remove("drag-over"); });
    col.addEventListener("drop", async e=>{
      e.preventDefault(); col.classList.remove("drag-over");
      const id = e.dataTransfer.getData("text/plain");
      const newStatus = col.dataset.status;
      if (!id || !newStatus) {
        console.warn("Invalid drag data: id or status missing");
        return;
      }
      try {
        const fd = new FormData();
        fd.append("task_id", id);
        fd.append("status", newStatus);
        const res = await fetch("{% url 'api_update_status' %}", {
          method: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          body: fd
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if(json.ok){ loadBoard(1); } else { console.error("Status update failed:", json.error); alert("Status update failed: " + (json.error || 'Unknown error')); }
      } catch (err) { console.error("Drag drop error:", err); alert("Network error while updating status."); }
    });
  });
}

/* Board drag-scroll */
(function enableBoardDragScroll(){
  const boardWrapper = document.querySelector('.kanban-board-wrapper');
  if(!boardWrapper) return;
  let isDown = false; let startX; let scrollLeft;
  boardWrapper.addEventListener('mousedown', (e) => {
    if (e.target.closest('.task-card')) return;
    isDown = true; boardWrapper.classList.add('drag-scrolling');
    startX = e.pageX - boardWrapper.offsetLeft; scrollLeft = boardWrapper.scrollLeft; boardWrapper.style.cursor = 'grabbing'; e.preventDefault();
  });
  boardWrapper.addEventListener('mouseleave', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });
  boardWrapper.addEventListener('mouseup', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });
  boardWrapper.addEventListener('mousemove', (e) => {
    if(!isDown) return; const x = e.pageX - boardWrapper.offsetLeft; const walk = (x - startX) * 1.2; boardWrapper.scrollLeft = scrollLeft - walk;
  });
})();

/* Search / filter */
function initSearch(allTasks){
  const searchInput = document.getElementById("taskSearch");
  const priorityFilter = document.getElementById("priorityFilter");
  const clearBtn = document.getElementById("clearFilters");
  function applyFilter(){
    if (!Array.isArray(allTasks)) return;
    const term = (searchInput?.value || '').trim().toLowerCase();
    const pri = priorityFilter?.value || '';
    document.querySelectorAll(".task-card").forEach(card => card.style.display = "none");
    allTasks.forEach(t => {
      if (!t || !t.id) return;
      const titleMatch = t.title ? t.title.toLowerCase().includes(term) : false;
      const priorityMatch = t.priority ? t.priority.toLowerCase().includes(term) : false;
      const assigneeMatch = t.assigned_to_display ? t.assigned_to_display.toLowerCase().includes(term) : false;
      const matchTerm = (titleMatch || priorityMatch || assigneeMatch);
      const matchPri = !pri || (t.priority === pri);
      if ((term === "" || matchTerm) && matchPri) {
        const cardEl = document.querySelector(`.task-card[data-id="${t.id}"]`);
        if (cardEl) cardEl.style.display = "";
      }
    });
  }
  if (searchInput) searchInput.addEventListener('input', applyFilter);
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilter);
  if (clearBtn) clearBtn.addEventListener('click', function(){ 
    if (searchInput) searchInput.value = '';
    if (priorityFilter) priorityFilter.value = '';
    applyFilter();
  });
}

/* Pagination */
function renderPagination(current, total){
  const container = document.getElementById("boardPagination");
  if(!container) return;
  container.innerHTML = "";
  
  if (!Number.isInteger(current) || !Number.isInteger(total) || total < 1) {
    console.warn("Invalid pagination params:", { current, total });
    return;
  }
  
  function pageItem(label, page, disabled=false, active=false){
    const li = document.createElement("li");
    li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
    const a = document.createElement("a");
    a.className = "page-link";
    a.href = "#";
    a.textContent = label;
    a.addEventListener("click", (ev) => { 
      ev.preventDefault();
      if(disabled || page === current) return;
      loadBoard(page);
    });
    li.appendChild(a);
    return li;
  }
  
  container.appendChild(pageItem("Prev", Math.max(1, current-1), current<=1));
  const pages = new Set();
  pages.add(1);
  if (total > 1) pages.add(total);
  for(let p=current-2; p<=current+2; p++) {
    if(p>1 && p<total) pages.add(p);
  }
  const pagesArr = Array.from(pages).sort((a,b)=>a-b);
  let last = 0;
  pagesArr.forEach(p=>{
    if(last && p - last > 1){ 
      const ell = document.createElement("li");
      ell.className = "page-item disabled";
      ell.innerHTML = '<span class="page-link">…</span>';
      container.appendChild(ell);
    }
    container.appendChild(pageItem(p, p, false, p===current));
    last = p;
  });
  container.appendChild(pageItem("Next", Math.min(total, current+1), current>=total));
}
function updateSummary(page, totalCount, totalPages){
  const summary = document.getElementById("boardSummary");
  if(!summary) return;
  if (!Number.isInteger(page) || !Number.isInteger(totalCount) || totalCount < 0) {
    summary.textContent = "Error loading summary";
    return;
  }
  const start = Math.max(1, (page-1)*PER_PAGE + 1);
  const end = Math.min(page*PER_PAGE, totalCount);
  summary.textContent = `Showing ${start}-${end} of ${totalCount} tasks`;
}

/* Modal + fallback backdrop + assignees + projects load + improved population flow */
let taskModalInstance = null;

function createFallbackBackdrop() {
  if (document.querySelector('.modal-backdrop.fallback')) return;
  const modalEl = document.getElementById('taskDetailModal');
  const b = document.createElement('div');
  b.className = 'modal-backdrop fallback';
  b.style.position = 'fixed';
  b.style.inset = '0';
  b.style.background = 'rgba(6,18,34,0.30)';
  b.style.backdropFilter = 'blur(6px)';
  b.style.zIndex = '1050';
  if (modalEl && modalEl.parentElement) { modalEl.parentElement.insertBefore(b, modalEl); }
  else document.body.appendChild(b);
}
function removeFallbackBackdrop() { document.querySelectorAll('.modal-backdrop.fallback').forEach(el => el.remove()); }

function showModalFallback(modalEl) {
  if (!modalEl) return;
  createFallbackBackdrop();
  modalEl.removeAttribute('hidden');
  modalEl.setAttribute('aria-hidden', 'false');
  modalEl.classList.add('fallback-show');
  document.body.classList.add('modal-open');
  const first = modalEl.querySelector('input, textarea, button, select, a');
  if (first) try { first.focus(); } catch(e) {}
}
function hideModalFallback(modalEl) {
  if (!modalEl) return;
  modalEl.classList.remove('fallback-show');
  modalEl.setAttribute('hidden', '');
  modalEl.setAttribute('aria-hidden', 'true');
  removeFallbackBackdrop();
  document.body.classList.remove('modal-open');
}

/* Load projects via AJAX (projects/ajax/search/) and populate modal_project */
async function loadProjects(q = '') {
  const select = document.getElementById('modal_project');
  if (!select) return;
  select.innerHTML = '<option>Loading...</option>';
  try {
    const res = await fetch(`/projects/ajax/search/?q=${encodeURIComponent(q)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to load projects`);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.projects || []);
    select.innerHTML = '<option value="">-- Choose Project --</option>';
    if (Array.isArray(list)) {
      list.forEach(p => {
        if (p && p.id) {
          const o = document.createElement('option');
          o.value = p.id;
          o.textContent = p.name || p.title || (`Project ${p.id}`);
          select.appendChild(o);
        }
      });
    }
  } catch (err) {
    select.innerHTML = '<option value="">-- Choose Project --</option>';
    console.warn('projects load failed', err);
  }
}

/* Populate assignee dropdown (members + teams) from APIs */
async function loadAssignees(){
  const select = document.getElementById('modal_assignee');
  if (!select) return;
  select.innerHTML = '<option value="">Unassigned</option>';
  try {
    let res = await fetch('/api/people/list');
    if (res.ok) {
      const data = await res.json();
      const memGroup = document.createElement('optgroup');
      memGroup.label = 'Members';
      const memberList = Array.isArray(data) ? data : (data.members || []);
      if (Array.isArray(memberList)) {
        memberList.forEach(m => {
          if (m && m.id && m.first_name !== undefined && m.last_name !== undefined) {
            const o = document.createElement('option');
            o.value = `member:${m.id}`;
            o.textContent = `${m.first_name} ${m.last_name}${m.email ? ' — ' + m.email : ''}`;
            memGroup.appendChild(o);
          }
        });
      }
      if (memGroup.children.length) select.appendChild(memGroup);
    }
  } catch(e){ 
    console.warn('members load failed', e); 
  }

  try {
    let res2 = await fetch('/api/teams/list');
    if (res2.ok) {
      const data2 = await res2.json();
      const tGroup = document.createElement('optgroup');
      tGroup.label = 'Teams';
      const teamList = Array.isArray(data2) ? data2 : (data2.teams || []);
      if (Array.isArray(teamList)) {
        teamList.forEach(t => {
          if (t && t.id && t.name) {
            const o = document.createElement('option');
            o.value = `team:${t.id}`;
            o.textContent = `Team: ${t.name}`;
            tGroup.appendChild(o);
          }
        });
      }
      if (tGroup.children.length) select.appendChild(tGroup);
    }
  } catch(e){ 
    console.warn('teams load failed', e); 
  }
}

/* Load subprojects for modal (returns Promise) */
function loadModalSubprojects(pid, selectValue=null){
  const sp = document.getElementById('modal_subproject');
  if(!sp || !pid) return Promise.resolve();
  sp.innerHTML = '<option>Loading...</option>';
  return fetch(`/tasks/api/subprojects/?project_id=${encodeURIComponent(pid)}`).then(r=>{
    if (!r.ok) throw new Error(`HTTP ${r.status}: Failed to load subprojects`);
    return r.json();
  }).then(data=>{
    sp.innerHTML = '<option value="">-- Optional Subproject --</option>';
    const subprojects = data.subprojects || [];
    if (Array.isArray(subprojects)) {
      subprojects.forEach(s => {
        if (s && s.id && s.name) {
          const o = document.createElement('option');
          o.value = s.id;
          o.textContent = s.name;
          sp.appendChild(o);
        }
      });
    }
    if (selectValue && Array.from(sp.options).some(opt => opt.value == selectValue)) {
      sp.value = selectValue;
    }
  }).catch(err=>{
    console.warn('subprojects load failed', err);
    sp.innerHTML = '<option value="">-- Optional Subproject --</option>';
  });
}

/* Open task modal (improved flow):
   1) fetch task detail
   2) fetch projects + assignees (in parallel)
   3) fetch subprojects (if project)
   4) populate all fields (ensures selects exist before setting value)
*/
async function openTaskModal(taskId){
  const modalEl = document.getElementById('taskDetailModal'); if (!modalEl) return;

  // reset UI and show spinner text
  document.getElementById('taskDetailTitle').textContent = 'Loading...';
  document.getElementById('modal_task_id').value = taskId || '';
  document.getElementById('modal_title').value = '';
  document.getElementById('modal_description').value = '';
  document.getElementById('modal_priority').value = 'Normal';
  document.getElementById('modal_due_date').value = '';
  document.getElementById('modal_assignee').innerHTML = '<option value=\"\">Unassigned</option>';
  document.getElementById('modal_subproject').innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
  document.getElementById('modal_project').innerHTML = '<option>Loading...</option>';

  // append modal to body
  if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

  // show modal (bootstrap if present, otherwise fallback)
  let usedBootstrap = false;
  try {
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      if (!taskModalInstance) taskModalInstance = new bootstrap.Modal(modalEl, { backdrop: true });
      taskModalInstance.show();
      usedBootstrap = true;
    }
  } catch (err) {
    usedBootstrap = false;
  }
  setTimeout(() => {
    const actuallyShown = document.querySelector('.modal-backdrop') || modalEl.classList.contains('show') || modalEl.classList.contains('fallback-show');
    if (!actuallyShown) showModalFallback(modalEl);
  }, 100);

  // 1) fetch task detail
  let taskData = null;
  try {
    const r = await fetch(TASK_DETAIL_API + '?id=' + encodeURIComponent(taskId));
    if (!r.ok) throw new Error('task not found');
    taskData = await r.json();
    if (taskData.error) throw new Error(taskData.error);
  } catch (err) {
    console.error('task detail load failed', err);
    alert('Failed to load task details.');
    if (!usedBootstrap) hideModalFallback(modalEl);
    return;
  }

  // 2) load projects + assignees in parallel
  const promises = [ loadProjects(''), loadAssignees() ];
  await Promise.allSettled(promises);

  // 3) if project present, load subprojects
  const pid = taskData.project_id || taskData.project || '';
  if (pid) {
    await loadModalSubprojects(pid, taskData.subproject_id || taskData.subproject || null);
  } else {
    document.getElementById('modal_subproject').innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
  }

  // 4) populate fields safely
  // Title & header with ID
  const displayTitle = taskData.title || ('Task #' + (taskData.id || ''));
  document.getElementById('taskDetailTitle').textContent = displayTitle + (taskData.id ? (' — #' + taskData.id) : '');
  document.getElementById('modal_title').value = taskData.title || '';
  document.getElementById('modal_description').value = taskData.description || '';

  // priority
  const priEl = document.getElementById('modal_priority');
  if (priEl && taskData.priority) try { priEl.value = taskData.priority; } catch(e){}

  // due_date ISO -> yyyy-mm-dd
  const dueRaw = taskData.due_date || taskData.due || '';
  if (dueRaw) {
    document.getElementById('modal_due_date').value = String(dueRaw).split('T')[0];
  } else {
    document.getElementById('modal_due_date').value = '';
  }

  // project select: set after loadProjects completed
  const pEl = document.getElementById('modal_project');
  if (pEl) {
    try {
      if ((taskData.project_id || taskData.project) && Array.from(pEl.options).some(o => o.value == (taskData.project_id || taskData.project))) {
        pEl.value = taskData.project_id || taskData.project;
      } else if (taskData.project_id || taskData.project) {
        // fallback: if project option not found, add one
        const val = taskData.project_id || taskData.project;
        const o = document.createElement('option'); o.value = val; o.textContent = taskData.project_name || ('Project ' + val); pEl.appendChild(o); pEl.value = val;
      } else {
        pEl.value = '';
      }
    } catch(e){
      pEl.value = '';
    }
  }

  // assigned: map assigned_type + assigned_to -> "member:123" etc.
  const aEl = document.getElementById('modal_assignee');
  if (aEl) {
    const atype = taskData.assigned_type || '';
    const atoid = taskData.assigned_to || '';
    if (atype && (atoid !== null && atoid !== undefined && atoid !== '')) {
      const val = `${atype}:${atoid}`;
      if (Array.from(aEl.options).some(opt => opt.value === val)) {
        aEl.value = val;
      } else {
        // create fallback option with display text
        const fo = document.createElement('option');
        fo.value = val;
        fo.textContent = taskData.assigned_to_display || (atype + ':' + atoid);
        aEl.appendChild(fo);
        aEl.value = val;
      }
    } else {
      aEl.value = '';
    }
  }

  // focus title
  try { document.getElementById('modal_title').focus(); } catch(e){}
}

/* Show alert inside modal */
function showModalAlert(type, text){
  let el = document.getElementById('modal_alert');
  if (!el) {
    el = document.createElement('div'); el.id = 'modal_alert'; el.className = 'alert mt-3'; document.querySelector('#taskDetailModal .modal-opaque-content .card-body')?.appendChild(el);
  }
  el.className = 'alert mt-3';
  el.textContent = text || '';
  el.classList.remove('d-none');
}

/* Submit save */
document.getElementById('taskDetailForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('saveTaskBtn');
  const taskIdField = document.getElementById('modal_task_id');
  
  if (!taskIdField || !taskIdField.value) {
    showModalAlert('error', 'Error: No task ID found');
    return;
  }
  
  if (btn) { 
    btn.disabled = true; 
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Saving...';
  }

  const fd = new FormData(this);
  try {
    const res = await fetch(TASK_UPDATE_API, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const json = await res.json();
    if (json && json.ok) {
      showModalAlert('success', 'Saved successfully');
      setTimeout(() => {
        try { if (taskModalInstance) taskModalInstance.hide(); } catch (e) {}
        hideModalFallback(document.getElementById('taskDetailModal'));
        loadBoard(1);
      }, 450);
    } else {
      console.error('Save error:', json);
      showModalAlert('error', json.error || 'Save failed');
    }
  } catch (err) {
    console.error('Save exception:', err);
    showModalAlert('error', 'Network error while saving: ' + err.message);
  } finally {
    if (btn) { 
      btn.disabled = false; 
      btn.innerHTML = '<i class="fa-solid fa-check me-1"></i> Save changes';
    }
  }
});

/* Close/hide handlers */
document.addEventListener('click', function (e) {
  if (e.target.closest('[data-bs-dismiss="modal"]') || e.target.closest('.btn-close') || e.target.closest('.modal-close-circle')) {
    const modalEl = document.getElementById('taskDetailModal');
    try { if (taskModalInstance) taskModalInstance.hide(); } catch(e) {}
    hideModalFallback(modalEl);
  }
});

document.addEventListener('hidden.bs.modal', function(ev){
  const modalEl = document.getElementById('taskDetailModal');
  removeFallbackBackdrop();
  if (modalEl) { modalEl.setAttribute('hidden',''); modalEl.setAttribute('aria-hidden','true'); }
});
document.addEventListener('keydown', function(ev){
  if (ev.key === 'Escape') {
    const modalEl = document.getElementById('taskDetailModal');
    try { if (taskModalInstance) taskModalInstance.hide(); } catch(e) {}
    hideModalFallback(modalEl);
  }
});

/* DOM ready: ensure modal exists on body, wire events */
document.addEventListener("DOMContentLoaded", function(){
  const modalEl = document.getElementById('taskDetailModal');
  if (!modalEl) {
    console.warn("taskDetailModal not found in DOM");
    return;
  }
  
  if (modalEl.parentElement !== document.body) {
    document.body.appendChild(modalEl);
  }

  const closeCircle = document.querySelector('.modal-close-circle');
  if (closeCircle && modalEl) {
    closeCircle.setAttribute('role','button');
    closeCircle.setAttribute('tabindex','0');
    closeCircle.setAttribute('aria-controls','taskDetailModal');
    closeCircle.addEventListener('keydown', function(e){ 
      if (e.key === 'Enter' || e.key === ' ') { 
        e.preventDefault(); 
        closeCircle.click(); 
      }
    });
  }

  const projectSelect = document.getElementById('modal_project');
  if (projectSelect) {
    projectSelect.addEventListener('change', function(e){
      const pid = e.target.value;
      if(pid) {
        loadModalSubprojects(pid);
      } else {
        const sp = document.getElementById('modal_subproject');
        if (sp) sp.innerHTML = '<option value="">-- Optional Subproject --</option>';
      }
    });
  }

  // preload lists to speed up modal
  loadProjects().catch(err => console.warn('Failed to preload projects:', err));
  loadAssignees().catch(err => console.warn('Failed to preload assignees:', err));
  loadBoard(1);
});

/* Utilities */
function escapeHtml(s){
  if (!s) return "";
  return String(s).replace(/[&<>"']/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[c]));
}
</script>
{% endblock %}
