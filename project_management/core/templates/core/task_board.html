{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">

  <!-- ===== Header Section ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
    <div>
      <h4 class="fw-bold text-gradient mb-0">
        <i class="fa-solid fa-table-columns me-2"></i> Task Board
      </h4>
      <p class="small text-muted mb-0">Drag &amp; drop tasks between columns. Click a card to view details.</p>
    </div>

    <!-- Action buttons -->
    <div class="d-flex flex-wrap align-items-center gap-2 header-actions">
      <a href="{% url 'create_task' %}" class="btn btn-gradient btn-lg">
        <i class="fa-solid fa-plus me-1"></i> New Task
      </a>
      <a href="{% url 'unassigned_tasks' %}" class="btn btn-outline-gradient btn-lg">
        <i class="fa-solid fa-user-clock me-1"></i> Unassigned
      </a>
    </div>
  </div>

  <!-- ===== Search Bar ===== -->
  <div class="card mb-4 border-0 shadow-sm search-card">
    <div class="card-body py-3 d-flex align-items-center gap-3 flex-wrap">
      <div class="position-relative flex-fill" style="min-width:280px;">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" id="taskSearch" class="form-control search-input" placeholder="Search tasks by title, assignee or priority...">
      </div>

      <div class="d-flex gap-2">
        <select id="priorityFilter" class="form-select" style="width:160px;">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
        <button id="clearFilters" class="btn btn-light">Clear</button>
      </div>
    </div>
  </div>

  <!-- ===== Kanban Board ===== -->
  <div class="kanban-board-wrapper mb-3">
    <div class="kanban-board" id="kanbanBoard">
      {% for col in status_columns %}
      <div class="kanban-column">
        <div class="kanban-header">{{ col }}</div>
        <div class="kanban-body" data-status="{{ col }}" id="col-{{ col|slugify }}"></div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Pagination / Summary ===== -->
  <div class="d-flex flex-column align-items-center mt-3">
    <div id="boardSummary" class="small text-muted mb-1"></div>
    <nav aria-label="Task board pages">
      <ul class="pagination mb-0" id="boardPagination"></ul>
    </nav>
  </div>
</div>

<!-- ===== Task Detail Modal (styled like Create Task) ===== -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true" hidden>
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content modal-opaque-content" role="dialog" aria-modal="true" aria-labelledby="taskDetailTitle">

      <!-- Circular close (top-right) -->
      <button type="button" class="modal-close-circle" aria-label="Close" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="#0b2440"/></svg>
      </button>

      <form id="taskDetailForm" class="row gx-4" novalidate>
        {% csrf_token %}
        <input type="hidden" id="modal_task_id" name="task_id" value="">
        <div class="card-body p-4" style="background:transparent; box-shadow:none; padding-left:34px; padding-right:34px;">
          <div class="modal-header-centered mb-3">
            <div class="modal-title-wrap">
              <h3 class="fw-bold mb-1 text-gradient text-center" id="taskDetailTitle">Task Details</h3>
              <p class="text-muted small mb-0 text-center" id="modalSubtitle">View and update task information</p>
            </div>
          </div>

          <!-- ===== Re-use Create Task form styling here (labels on left, inputs on right) ==== -->
          <div class="form-grid">

            <!-- Title -->
            <div class="form-row">
              <label class="form-label">Task Title <span class="text-danger">*</span></label>
              <div class="form-control-wrap">
                <input id="modal_title" name="title" type="text" class="form-control" placeholder="e.g. Implement user authentication" required>
                <div class="form-hint">Short, descriptive title</div>
              </div>
            </div>

            <!-- Project -->
            <div class="form-row">
              <label class="form-label">Project</label>
              <div class="form-control-wrap">
                <select name="project_id" id="modal_project" class="form-select">
                  <option value="">-- Choose Project --</option>
                  {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Subproject -->
            <div class="form-row">
              <label class="form-label">Subproject</label>
              <div class="form-control-wrap">
                <select name="subproject_id" id="modal_subproject" class="form-select">
                  <option value="">-- Optional Subproject --</option>
                </select>
              </div>
            </div>

            <!-- Priority -->
            <div class="form-row">
              <label class="form-label">Priority</label>
              <div class="form-control-wrap">
                <select id="modal_priority" name="priority" class="form-select">
                  <option value="Low">Low</option>
                  <option value="Normal">Normal</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <!-- Due date -->
            <div class="form-row">
              <label class="form-label">Due date</label>
              <div class="form-control-wrap">
                <input id="modal_due_date" name="due_date" type="date" class="form-control">
              </div>
            </div>

            <!-- Assign to (populated from API at runtime) -->
            <div class="form-row">
              <label class="form-label">Assign to</label>
              <div class="form-control-wrap">
                <select name="assigned_to" id="modal_assignee" class="form-select">
                  <option value="">Unassigned</option>
                  <!-- populated by JS from /api/people/list and /api/teams/list -->
                </select>
              </div>
            </div>

            <!-- Description (spans full width) -->
            <div class="form-row" style="grid-column: 1 / -1;">
              <label class="form-label fw-semibold">Description (optional)</label>
              <div class="form-control-wrap">
                <textarea id="modal_description" name="description" rows="6" class="form-control" placeholder="Add detailed notes, acceptance criteria, links, steps to reproduce..."></textarea>
                <div class="form-text mt-2">Optional — good place for acceptance criteria or reproduction steps.</div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer: centered buttons like Create Task -->
        <div class="col-12 mt-2 d-flex justify-content-center gap-3 px-4 pb-4">
          <button type="button" class="btn btn-outline-gradient btn-lg" data-bs-dismiss="modal">Cancel</button>
          <button id="saveTaskBtn" type="submit" class="btn btn-gradient btn-lg"><i class="fa-solid fa-check me-1"></i> Save changes</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ===== Styles: adopt Create Task styles for the overlay + soft frosted backdrop ===== -->
<style>
/* Board styles kept */
.header-actions .btn { display:inline-flex; align-items:center; gap:8px; }
.search-card { border-radius:10px; }
.search-input { padding-left:40px; border-radius:8px; border:1px solid #e6eef6; box-shadow:none; height:44px; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6c757d; font-size:14px; }
.btn-lg { padding:10px 16px; border-radius:10px; font-weight:600; }
.header-actions { margin-left:12px; }

.kanban-board-wrapper { overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
.kanban-board { display: flex; gap: 16px; min-height: 70vh; padding-bottom: 10px; align-items: flex-start; }
.kanban-column { flex: 0 0 320px; background: #fbfeff; border-radius: 12px; box-shadow: 0 6px 18px rgba(13,38,71,0.06); display: flex; flex-direction: column; height: auto; max-height: 80vh; }
.kanban-header { background: linear-gradient(90deg, #0b57a4, #38bdf8); color: #fff; text-align: center; border-radius: 8px 8px 0 0; font-weight: 700; padding: 10px; position: sticky; top: 0; z-index: 2; }
.kanban-body { flex: 1; padding: 12px; border-radius: 0 0 12px 12px; background-color: #f9fcff; min-height: 55vh; overflow-y: auto; position: relative; z-index: 1; }
.kanban-body.drag-over { background-color: rgba(56, 189, 248, 0.12); border: 2px dashed #38bdf8; }
.task-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:14px 16px; margin-bottom:12px; cursor:grab; transition:transform .12s ease, box-shadow .12s ease; }
.task-card:active { cursor:grabbing; }
.task-card:focus, .task-card:hover { transform:translateY(-4px); box-shadow:0 10px 26px rgba(10,30,60,0.08); outline: none; }
.task-title { font-weight:700; font-size:0.98rem; margin-bottom:4px; color:#0f1724; }
.task-meta { font-size:0.82rem; color:#54607a; margin-top:2px; }
.assignee-name { font-size:0.82rem; font-weight:600; color:#0b57a4; margin-top:8px; }

/* ===== Create Task form look (applied inside modal) ===== */
.form-grid { display:block; max-width:880px; margin: 0 auto; }
.form-row { display:grid; grid-template-columns: 200px 1fr; gap: 12px 20px; align-items:start; margin-bottom:18px; }
.form-label { font-weight:600; color:#0b57a4; font-size:0.95rem; padding-top:6px; text-align:left; }
.form-control-wrap { display:flex; flex-direction:column; }
.form-control, .form-select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #dee2e6; transition:box-shadow .12s, border-color .12s; background:#fff; }
.form-control:focus, .form-select:focus, textarea:focus { outline:none; border-color:#38bdf8; box-shadow:0 4px 14px rgba(56,189,248,0.08); }
.form-hint { font-size:0.85rem; color:#6c757d; margin-top:6px; }
.btn-gradient { background:linear-gradient(90deg,#0b57a4,#1f86e3,#38bdf8); color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:600; }
.btn-outline-gradient { background:#fff; color:#0b57a4; border:1px solid #38bdf8; border-radius:10px; padding:9px 16px; font-weight:600; }

.form-text { color:#6b7b8a; font-size:.88rem; }

/* ===== Modal backdrop (soft frost) and modal card ===== */
.modal-backdrop,
.modal-backdrop.fallback {
  position: fixed !important;
  inset: 0 !important;
  background: rgba(6,18,34,0.30) !important; /* mild dim */
  backdrop-filter: blur(6px) saturate(1.05) contrast(0.98);
  -webkit-backdrop-filter: blur(6px) saturate(1.05) contrast(0.98);
  z-index: 1050 !important;
  pointer-events: auto;
}
.modal { z-index: 1060 !important; }

/* Opaque modal content: subtle frosted card with side margins enforced */
.modal-opaque-content {
  position: relative;
  z-index: 1061;
  border-radius: 12px;
  overflow: hidden;
  border: none;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(247,251,255,0.96));
  box-shadow: 0 24px 60px rgba(6,30,60,0.28);
  max-width: 980px;
  margin: 0 auto;
  color: #122033;
  transition: transform .12s ease, opacity .12s ease;
  border: 1px solid rgba(14,66,122,0.04);
  padding-bottom: 6px;
}

/* circular close button */
.modal-close-circle {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(180deg,#ffffff,#f4fbff);
  border: 1px solid rgba(11,87,164,0.06);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 20px rgba(11,87,164,0.06);
  cursor: pointer;
  z-index: 1070;
}
.modal-close-circle svg { display:block; }

/* Center header title & subtitle */
.modal-header-centered { display:block; text-align:center; padding-top:6px; padding-bottom:12px; }
.modal-title-wrap { max-width:760px; margin: 0 auto; }

/* Footer buttons centered */
.modal .d-flex.justify-content-center { justify-content:center !important; }

/* Fallback show (centers modal when bootstrap modal not available) */
.modal.fallback-show {
  display: flex !important;
  position: fixed !important;
  inset: 0 !important;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 1061 !important;
  overflow: auto;
}
.modal.fallback-show .modal-dialog { display:flex; align-items:center; justify-content:center; min-height:0; max-width:96%; margin:0; }
.modal.fallback-show .modal-content { max-height: calc(100vh - 80px); overflow:auto; }

/* Responsive */
@media (max-width: 992px) {
  .form-row { grid-template-columns: 1fr !important; }
  .modal-opaque-content { margin: 12px; max-width: 96%; padding-left:16px; padding-right:16px; }
  .modal-close-circle { top: 10px; right: 10px; width:36px; height:36px; }
}
</style>

<!-- ===== JS Logic (board + modal + assignees load + fallback) ===== -->
<script>
let CURRENT_BOARD_PAGE = 1;
const PER_PAGE = 10;
let ALL_TASKS = [];
const TASK_DETAIL_API = "{% url 'api_task_detail' %}";
const TASK_UPDATE_API = "{% url 'api_task_update' %}";
const CSRF_TOKEN = "{{ csrf_token }}";

/* Load board (unchanged) */
async function loadBoard(page=1){
  try {
    CURRENT_BOARD_PAGE = page;
    const res = await fetch("{% url 'board_data' %}?page=" + page);
    const payload = await res.json();
    const tasks = payload.tasks || [];
    ALL_TASKS = tasks;
    const pageNum = payload.page || 1;
    const totalPages = payload.total_pages || 1;
    const totalCount = payload.total_count || tasks.length;
    renderAllColumns(tasks);
    renderPagination(pageNum, totalPages);
    updateSummary(pageNum, totalCount, totalPages);
  } catch (err) {
    console.error("Board load failed", err);
  }
}
function renderAllColumns(tasks){
  document.querySelectorAll(".kanban-body").forEach(c => c.innerHTML = "");
  tasks.forEach(t => renderCard(t));
  initDragDrop();
  initSearch(ALL_TASKS);
}

/* Card render */
function renderCard(t){
  const col = document.querySelector(`[data-status="${t.status}"]`) || document.querySelector(".kanban-body");
  const card = document.createElement("div");
  card.className = "task-card";
  card.setAttribute("draggable", "true");
  card.dataset.id = t.id;
  card.setAttribute("tabindex","0");
  card.setAttribute("role","button");
  card.setAttribute("aria-label", "Open task " + (t.title || '') );

  let displayAssignee = "";
  if (t.assigned_to_display) displayAssignee = t.assigned_to_display;
  else if (t.assigned_to && t.assigned_to.startsWith("member:"))
    displayAssignee = "Member " + t.assigned_to.split(":")[1];
  else if (t.assigned_to && t.assigned_to.startsWith("team:"))
    displayAssignee = "Team " + t.assigned_to.split(":")[1];

  card.innerHTML = `
    <div>
      <div class="task-title">${escapeHtml(t.title)}</div>
      <div class="task-meta">
        ${escapeHtml(t.priority || '')}${t.due_date ? ' • Due ' + escapeHtml(t.due_date) : ''}
      </div>
      ${displayAssignee ? `<div class="assignee-name"><i class="fa-solid fa-user me-1"></i>${escapeHtml(displayAssignee)}</div>` : ''}
    </div>
  `;

  card.addEventListener("click", e => {
    if (card.dataset.dragging === "1") return;
    openTaskModal(t.id);
  });
  card.addEventListener("keydown", e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTaskModal(t.id); }
  });

  col.appendChild(card);
}

/* Drag & drop */
function initDragDrop(){
  document.querySelectorAll(".task-card").forEach(card=>{
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", card.dataset.id);
      try { e.dataTransfer.effectAllowed = "move"; } catch(err) {}
      card.dataset.dragging = "1"; card.classList.add("dragging");
    });
    card.addEventListener("dragend", e=>{
      card.dataset.dragging = "0"; card.classList.remove("dragging");
    });
  });

  document.querySelectorAll(".kanban-body").forEach(col=>{
    col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("drag-over"); e.dataTransfer.dropEffect = 'move'; });
    col.addEventListener("dragenter", e=>{ e.preventDefault(); col.classList.add("drag-over"); });
    col.addEventListener("dragleave", e=>{ col.classList.remove("drag-over"); });
    col.addEventListener("drop", async e=>{
      e.preventDefault(); col.classList.remove("drag-over");
      const id = e.dataTransfer.getData("text/plain");
      const newStatus = col.dataset.status;
      try {
        const fd = new FormData();
        fd.append("task_id", id);
        fd.append("status", newStatus);
        const res = await fetch("{% url 'api_update_status' %}", {
          method: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          body: fd
        });
        const json = await res.json();
        if(json.ok){ loadBoard(CURRENT_BOARD_PAGE); } else { alert("Status update failed"); }
      } catch (err) { console.error(err); alert("Network error."); }
    });
  });
}

/* Board drag-scroll */
(function enableBoardDragScroll(){
  const boardWrapper = document.querySelector('.kanban-board-wrapper');
  if(!boardWrapper) return;
  let isDown = false; let startX; let scrollLeft;
  boardWrapper.addEventListener('mousedown', (e) => {
    if (e.target.closest('.task-card')) return;
    isDown = true; boardWrapper.classList.add('drag-scrolling');
    startX = e.pageX - boardWrapper.offsetLeft; scrollLeft = boardWrapper.scrollLeft; boardWrapper.style.cursor = 'grabbing'; e.preventDefault();
  });
  boardWrapper.addEventListener('mouseleave', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });
  boardWrapper.addEventListener('mouseup', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });
  boardWrapper.addEventListener('mousemove', (e) => {
    if(!isDown) return; const x = e.pageX - boardWrapper.offsetLeft; const walk = (x - startX) * 1.2; boardWrapper.scrollLeft = scrollLeft - walk;
  });
})();

/* Search / filter */
function initSearch(allTasks){
  const searchInput = document.getElementById("taskSearch");
  const priorityFilter = document.getElementById("priorityFilter");
  const clearBtn = document.getElementById("clearFilters");
  function applyFilter(){
    const term = (searchInput.value || '').trim().toLowerCase();
    const pri = priorityFilter.value;
    document.querySelectorAll(".task-card").forEach(card => card.style.display = "none");
    allTasks.forEach(t => {
      const matchTerm = (t.title && t.title.toLowerCase().includes(term)) || (t.priority && t.priority.toLowerCase().includes(term)) || (t.assigned_to_display && t.assigned_to_display.toLowerCase().includes(term));
      const matchPri = !pri || (t.priority === pri);
      if ((term === "" || matchTerm) && matchPri) {
        const cardEl = document.querySelector(`.task-card[data-id="${t.id}"]`); if (cardEl) cardEl.style.display = "";
      }
    });
  }
  if (searchInput) searchInput.addEventListener('input', applyFilter);
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilter);
  if (clearBtn) clearBtn.addEventListener('click', function(){ searchInput.value=''; priorityFilter.value=''; applyFilter(); });
}

/* Pagination */
function renderPagination(current, total){
  const container = document.getElementById("boardPagination"); if(!container) return; container.innerHTML = "";
  function pageItem(label, page, disabled=false, active=false){
    const li = document.createElement("li");
    li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
    const a = document.createElement("a"); a.className = "page-link"; a.href = "#"; a.textContent = label;
    a.addEventListener("click", (ev) => { ev.preventDefault(); if(disabled || page === current) return; loadBoard(page); });
    li.appendChild(a); return li;
  }
  container.appendChild(pageItem("Prev", Math.max(1, current-1), current<=1));
  const pages = new Set(); pages.add(1); pages.add(total);
  for(let p=current-2; p<=current+2; p++) if(p>1 && p<total) pages.add(p);
  const pagesArr = Array.from(pages).sort((a,b)=>a-b);
  let last = 0;
  pagesArr.forEach(p=>{
    if(last && p - last > 1){ const ell = document.createElement("li"); ell.className = "page-item disabled"; ell.innerHTML = '<span class="page-link">…</span>'; container.appendChild(ell); }
    container.appendChild(pageItem(p, p, false, p===current)); last = p;
  });
  container.appendChild(pageItem("Next", Math.min(total, current+1), current>=total));
}
function updateSummary(page, totalCount, totalPages){
  const summary = document.getElementById("boardSummary"); if(!summary) return;
  const start = (page-1)*PER_PAGE + 1; const end = Math.min(page*PER_PAGE, totalCount);
  summary.textContent = `Showing ${start}-${end} of ${totalCount} tasks`;
}

/* Modal + fallback backdrop + assignees loader */
let taskModalInstance = null;

function createFallbackBackdrop() {
  if (document.querySelector('.modal-backdrop.fallback')) return;
  const modalEl = document.getElementById('taskDetailModal');
  const b = document.createElement('div');
  b.className = 'modal-backdrop fallback';
  b.style.position = 'fixed';
  b.style.inset = '0';
  b.style.background = 'rgba(6,18,34,0.30)';
  b.style.backdropFilter = 'blur(6px)';
  b.style.zIndex = '1050';
  if (modalEl && modalEl.parentElement) { modalEl.parentElement.insertBefore(b, modalEl); }
  else document.body.appendChild(b);
}
function removeFallbackBackdrop() { document.querySelectorAll('.modal-backdrop.fallback').forEach(el => el.remove()); }

function showModalFallback(modalEl) {
  if (!modalEl) return;
  createFallbackBackdrop();
  modalEl.removeAttribute('hidden');
  modalEl.setAttribute('aria-hidden', 'false');
  modalEl.classList.add('fallback-show');
  document.body.classList.add('modal-open');
  const first = modalEl.querySelector('input, textarea, button, select, a');
  if (first) try { first.focus(); } catch(e) {}
}
function hideModalFallback(modalEl) {
  if (!modalEl) return;
  modalEl.classList.remove('fallback-show');
  modalEl.setAttribute('hidden', '');
  modalEl.setAttribute('aria-hidden', 'true');
  removeFallbackBackdrop();
  document.body.classList.remove('modal-open');
}

/* Populate assignee dropdown (members + teams) from APIs */
async function loadAssignees(){
  const select = document.getElementById('modal_assignee');
  if (!select) return;
  // keep Unassigned option
  select.innerHTML = '<option value="">Unassigned</option>';
  try {
    // people list
    let res = await fetch('/api/people/list');
    if (res.ok) {
      const data = await res.json();
      // assume data is list of {id, first_name, last_name, email}
      if (Array.isArray(data)) {
        const memGroup = document.createElement('optgroup'); memGroup.label = 'Members';
        data.forEach(m => {
          const o = document.createElement('option');
          o.value = `member:${m.id}`;
          o.textContent = `${m.first_name} ${m.last_name} — ${m.email || ''}`;
          memGroup.appendChild(o);
        });
        if (memGroup.children.length) select.appendChild(memGroup);
      } else if (data.members) {
        const memGroup = document.createElement('optgroup'); memGroup.label = 'Members';
        data.members.forEach(m => {
          const o = document.createElement('option');
          o.value = `member:${m.id}`;
          o.textContent = `${m.first_name} ${m.last_name} — ${m.email || ''}`;
          memGroup.appendChild(o);
        });
        if (memGroup.children.length) select.appendChild(memGroup);
      }
    }
  } catch(e){ console.warn('members load failed', e); }

  try {
    let res2 = await fetch('/api/teams/list');
    if (res2.ok) {
      const data2 = await res2.json();
      const tGroup = document.createElement('optgroup'); tGroup.label = 'Teams';
      if (Array.isArray(data2)) {
        data2.forEach(t => {
          const o = document.createElement('option');
          o.value = `team:${t.id}`;
          o.textContent = `Team: ${t.name}`;
          tGroup.appendChild(o);
        });
      } else if (data2.teams) {
        data2.teams.forEach(t => {
          const o = document.createElement('option');
          o.value = `team:${t.id}`;
          o.textContent = `Team: ${t.name}`;
          tGroup.appendChild(o);
        });
      }
      if (tGroup.children.length) select.appendChild(tGroup);
    }
  } catch(e){ console.warn('teams load failed', e); }
}

/* Open task modal (fetch details & populate fields) */
function openTaskModal(taskId){
  const modalEl = document.getElementById('taskDetailModal'); if (!modalEl) return;

  // reset UI
  const alertEl = document.getElementById('modal_alert'); if (alertEl) alertEl.classList.add('d-none');
  document.getElementById('taskDetailTitle').textContent = 'Loading...';
  document.getElementById('modal_task_id').value = taskId || '';

  // Append modal to body to avoid z-index nesting
  if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

  // attempt to show bootstrap modal, fallback otherwise
  let usedBootstrap = false;
  try {
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      if (!taskModalInstance) taskModalInstance = new bootstrap.Modal(modalEl, { backdrop: true });
      taskModalInstance.show();
      usedBootstrap = true;
    }
  } catch (err) {
    console.warn('bootstrap modal failed, falling back', err); usedBootstrap = false;
  }

  // ensure assignees are loaded before populating assigned value
  loadAssignees().finally(() => {
    // fetch task details
    fetch(TASK_DETAIL_API + '?id=' + encodeURIComponent(taskId))
      .then(r => r.json())
      .then(data => {
        if (!data || data.error) {
          alert('Failed to load task details.');
          if (!usedBootstrap) hideModalFallback(modalEl);
          return;
        }

        document.getElementById('taskDetailTitle').textContent = data.title || ('Task #' + (data.id || ''));
        document.getElementById('modal_title').value = data.title || '';
        document.getElementById('modal_description').value = data.description || '';
        document.getElementById('modal_priority').value = data.priority || 'Normal';
        // due_date as ISO -> if empty leave blank otherwise use yyyy-mm-dd
        document.getElementById('modal_due_date').value = data.due_date || '';

        // project/subproject if returned
        if (data.project_id) {
          const p = document.getElementById('modal_project');
          if (p) p.value = data.project_id;
          loadModalSubprojects(data.project_id, data.subproject_id);
        } else {
          const p = document.getElementById('modal_project'); if (p) p.value = '';
          const sp = document.getElementById('modal_subproject'); if (sp) sp.innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
        }

        // assigned: use assigned_type + assigned_to to match value format in select
        const aEl = document.getElementById('modal_assignee');
        if (aEl) {
          const atype = data.assigned_type || '';
          const atoid = data.assigned_to || '';
          if (atype && atoid) {
            const val = `${atype}:${atoid}`;
            // if option exists set it; otherwise leave as unassigned
            try {
              aEl.value = val;
              // if the exact option is not present, create a fallback option showing display name
              if (!Array.from(aEl.options).some(opt => opt.value === val)) {
                const fo = document.createElement('option');
                fo.value = val;
                fo.textContent = data.assigned_to_display || (atype + ':' + atoid);
                aEl.appendChild(fo);
                aEl.value = val;
              }
            } catch (e) {
              aEl.value = '';
            }
          } else {
            aEl.value = '';
          }
        }
      })
      .catch(err => { console.error(err); alert('Network error loading task.'); });
  });

  // ensure fallback shows if bootstrap didn't appear
  setTimeout(() => {
    const actuallyShown = document.querySelector('.modal-backdrop') || modalEl.classList.contains('show') || modalEl.classList.contains('fallback-show');
    if (!actuallyShown) showModalFallback(modalEl);
  }, 180);
}

/* Load subprojects for modal (same endpoint as create task) */
async function loadModalSubprojects(pid, selectValue=null){
  const sp = document.getElementById('modal_subproject');
  if(!sp) return;
  sp.innerHTML = '<option>Loading...</option>';
  try {
    const res = await fetch(`/tasks/api/subprojects/?project_id=${pid}`);
    if(!res.ok) throw new Error('no data');
    const data = await res.json();
    sp.innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
    (data.subprojects || []).forEach(s => {
      const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sp.appendChild(o);
    });
    if (selectValue) sp.value = selectValue;
  } catch (err) {
    sp.innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
  }
}

/* Show alert inside modal */
function showModalAlert(type, text){
  let el = document.getElementById('modal_alert');
  if (!el) {
    el = document.createElement('div'); el.id = 'modal_alert'; el.className = 'alert mt-3'; document.querySelector('#taskDetailModal .modal-opaque-content .card-body')?.appendChild(el);
  }
  el.className = 'alert mt-3';
  if (type === 'success') { el.classList.add('success'); el.textContent = text; el.classList.remove('d-none'); }
  else { el.classList.add('error'); el.textContent = text; el.classList.remove('d-none'); }
}

/* Submit save */
document.getElementById('taskDetailForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('saveTaskBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Saving...'; }

  const fd = new FormData(this);
  try {
    const res = await fetch(TASK_UPDATE_API, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    });
    const json = await res.json();
    if (json && json.ok) {
      showModalAlert('success', 'Saved successfully');
      setTimeout(() => {
        try { if (taskModalInstance) taskModalInstance.hide(); } catch (e) {}
        hideModalFallback(document.getElementById('taskDetailModal'));
        loadBoard(CURRENT_BOARD_PAGE);
      }, 450);
    } else {
      showModalAlert('error', json.error || 'Save failed');
    }
  } catch (err) {
    console.error(err);
    showModalAlert('error', 'Network error while saving.');
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check me-1"></i> Save changes'; }
  }
});

/* Close/hide handlers */
document.addEventListener('click', function (e) {
  if (e.target.closest('[data-bs-dismiss="modal"]') || e.target.closest('.btn-close') || e.target.closest('.modal-close-circle')) {
    const modalEl = document.getElementById('taskDetailModal');
    try { if (taskModalInstance) taskModalInstance.hide(); } catch(e) {}
    hideModalFallback(modalEl);
  }
});

document.addEventListener('hidden.bs.modal', function(ev){
  const modalEl = document.getElementById('taskDetailModal');
  removeFallbackBackdrop();
  if (modalEl) { modalEl.setAttribute('hidden',''); modalEl.setAttribute('aria-hidden','true'); }
});
document.addEventListener('keydown', function(ev){
  if (ev.key === 'Escape') {
    const modalEl = document.getElementById('taskDetailModal');
    try { if (taskModalInstance) taskModalInstance.hide(); } catch(e) {}
    hideModalFallback(modalEl);
  }
});

/* Ensure modal appended to body and accessible close circle keyboard support */
document.addEventListener("DOMContentLoaded", function(){
  const modalEl = document.getElementById('taskDetailModal');
  if (modalEl && modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

  const closeCircle = document.querySelector('.modal-close-circle');
  if (closeCircle && modalEl) {
    closeCircle.setAttribute('role','button');
    closeCircle.setAttribute('tabindex','0');
    closeCircle.setAttribute('aria-controls','taskDetailModal');
    closeCircle.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); closeCircle.click(); }});
  }

  // wire project->subproject load inside modal similar to create_task behaviour
  document.getElementById('modal_project')?.addEventListener('change', function(e){
    const pid = e.target.value;
    if(pid) loadModalSubprojects(pid);
    else {
      const sp = document.getElementById('modal_subproject'); if (sp) sp.innerHTML = '<option value=\"\">-- Optional Subproject --</option>';
    }
  });

  // preload assignees on page load so modal shows quickly
  loadAssignees().catch(()=>{});
  loadBoard(1);
});

/* Utilities */
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
{% endblock %}
