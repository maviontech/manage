{% extends "core/base.html" %}
{% block content %}
<div class="container-fluid py-4">

  <!-- ===== Header Section ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
    <div>
      <h4 class="fw-bold text-gradient mb-0">
        <i class="fa-solid fa-table-columns me-2"></i> Task Board
      </h4>
      <p class="small text-muted mb-0">Drag &amp; drop tasks between columns. Click a card to view details.</p>
    </div>

    <!-- Action buttons grouped and separated from search -->
    <div class="d-flex flex-wrap align-items-center gap-2 header-actions">
      <a href="{% url 'create_task' %}" class="btn btn-gradient btn-lg">
        <i class="fa-solid fa-plus me-1"></i> New Task
      </a>
      <a href="{% url 'unassigned_tasks' %}" class="btn btn-outline-gradient btn-lg">
        <i class="fa-solid fa-user-clock me-1"></i> Unassigned
      </a>
      <!-- optional quick filter / other buttons can go here -->
    </div>
  </div>

  <!-- ===== Search Bar (separated with margin from header actions) ===== -->
  <div class="card mb-4 border-0 shadow-sm search-card">
    <div class="card-body py-3 d-flex align-items-center gap-3 flex-wrap">
      <div class="position-relative flex-fill" style="min-width:280px;">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" id="taskSearch" class="form-control search-input" placeholder="Search tasks by title, assignee or priority...">
      </div>

      <!-- small quick filters to the right of search (optional) -->
      <div class="d-flex gap-2">
        <select id="priorityFilter" class="form-select" style="width:160px;">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
        <button id="clearFilters" class="btn btn-light">Clear</button>
      </div>
    </div>
  </div>

  <!-- ===== Kanban Columns ===== -->
  <div class="row g-3 board-row">
    {% for col in status_columns %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
      <div class="kanban-column p-2">
        <div class="kanban-header">{{ col }}</div>
        <div class="kanban-body" data-status="{{ col }}" id="col-{{ col|slugify }}"></div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ===== Pagination ===== -->
  <div class="d-flex flex-column align-items-center mt-3">
    <div id="boardSummary" class="small text-muted mb-1"></div>
    <nav aria-label="Task board pages">
      <ul class="pagination mb-0" id="boardPagination"></ul>
    </nav>
  </div>
</div>

<!-- ===== Task Detail Modal ===== -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <form id="taskDetailForm">
        <div class="modal-header">
          <h5 class="modal-title" id="taskDetailTitle">Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="task_id" id="modal_task_id" />

          <div class="mb-3">
            <label class="form-label">Title</label>
            <input id="modal_title" name="title" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="modal_description" name="description" class="form-control" rows="6"></textarea>
          </div>

          <div class="row g-2">
            <div class="col-sm-6">
              <label class="form-label">Priority</label>
              <select id="modal_priority" name="priority" class="form-select">
                <option value="">--</option>
                <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Due date</label>
              <input id="modal_due_date" name="due_date" type="date" class="form-control">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Assignee</label>
            <input id="modal_assignee" name="assigned_to_display" class="form-control" placeholder="Assignee name or team (editable)">
            <div class="form-text">Type member or team; backend will resolve on save.</div>
          </div>

          <div id="modal_alert" class="alert d-none mt-3" role="alert"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="saveTaskBtn" type="submit" class="btn btn-gradient">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ===== Styling tweaks ===== -->
<style>
/* header action spacing */
.header-actions .btn { display:inline-flex; align-items:center; gap:8px; }

/* larger, separated search area */
.search-card { border-radius:10px; }
.search-input { padding-left:40px; border-radius:8px; border:1px solid #e6eef6; box-shadow:none; height:44px; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6c757d; font-size:14px; }

/* improve button visuals and spacing vs search */
.btn-lg { padding:10px 16px; border-radius:10px; font-weight:600; }
.header-actions { margin-left:12px; }

/* column/card styles (kept from your original but small polish) */
.kanban-column { background:#fbfeff; border-radius:12px; min-height:54vh; box-shadow:0 6px 18px rgba(13,38,71,0.06); padding-bottom:18px; }
.kanban-header { background:linear-gradient(90deg,#0b57a4,#38bdf8); color:#fff; text-align:center; border-radius:8px; font-weight:700; padding:10px; margin-bottom:12px; }

/* task card clickable UI */
.task-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:14px 16px; margin-bottom:12px; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
.task-card:focus, .task-card:hover { transform:translateY(-4px); box-shadow:0 10px 26px rgba(10,30,60,0.08); outline: none; }
.task-title { font-weight:700; font-size:0.98rem; margin-bottom:4px; color:#0f1724; }
.task-meta { font-size:0.82rem; color:#54607a; margin-top:2px; }
.assignee-name { font-size:0.82rem; font-weight:600; color:#0b57a4; margin-top:8px; }

/* modal form */
.modal .form-label { font-weight:600; color:#0b2440; }
#modal_alert.success { background:#ecfdf5; color:#065f46; border:1px solid rgba(16,185,129,0.12); }
#modal_alert.error { background:#fff1f2; color:#9f1239; border:1px solid rgba(239,68,68,0.08); }

/* small responsive polish */
@media (max-width: 900px) {
  .header-actions { width:100%; justify-content:flex-start; gap:8px; }
  .search-card .card-body { flex-direction:column; gap:10px; }
}
</style>

<!-- ===== JS Logic ===== -->
<script>
let CURRENT_BOARD_PAGE = 1;
const PER_PAGE = 10;
let ALL_TASKS = [];
const TASK_DETAIL_API = "{% url 'api_task_detail' %}";        // expects GET ?id=ID
const TASK_UPDATE_API = "{% url 'api_task_update' %}";       // expects POST form data
const CSRF_TOKEN = "{{ csrf_token }}";

/* --- Board load (unchanged core logic) --- */
async function loadBoard(page=1){
  try {
    CURRENT_BOARD_PAGE = page;
    const res = await fetch("{% url 'board_data' %}?page=" + page);
    const payload = await res.json();
    const tasks = payload.tasks || [];
    ALL_TASKS = tasks;
    const pageNum = payload.page || 1;
    const totalPages = payload.total_pages || 1;
    const totalCount = payload.total_count || tasks.length;

    renderAllColumns(tasks);
    renderPagination(pageNum, totalPages);
    updateSummary(pageNum, totalCount, totalPages);
  } catch (err) {
    console.error("Board load failed", err);
  }
}

function renderAllColumns(tasks){
  document.querySelectorAll(".kanban-body").forEach(c => c.innerHTML = "");
  tasks.forEach(t => renderCard(t));
  initDragDrop();
  initSearch(ALL_TASKS);
}

/* --- Card rendering: make them clickable and accessible --- */
function renderCard(t){
  const col = document.querySelector(`[data-status="${t.status}"]`) || document.querySelector(".kanban-body");
  const card = document.createElement("div");
  card.className = "task-card";
  card.setAttribute("draggable", "true");
  card.dataset.id = t.id;
  card.setAttribute("tabindex","0");
  card.setAttribute("role","button");
  card.setAttribute("aria-label", "Open task " + (t.title || '') );

  let displayAssignee = "";
  if (t.assigned_to_display) displayAssignee = t.assigned_to_display;
  else if (t.assigned_to && t.assigned_to.startsWith("member:"))
    displayAssignee = "Member " + t.assigned_to.split(":")[1];
  else if (t.assigned_to && t.assigned_to.startsWith("team:"))
    displayAssignee = "Team " + t.assigned_to.split(":")[1];

  card.innerHTML = `
    <div>
      <div class="task-title">${escapeHtml(t.title)}</div>
      <div class="task-meta">
        ${escapeHtml(t.priority || '')}${t.due_date ? ' • Due ' + escapeHtml(t.due_date) : ''}
      </div>
      ${displayAssignee ? `<div class="assignee-name"><i class="fa-solid fa-user me-1"></i>${escapeHtml(displayAssignee)}</div>` : ''}
    </div>
  `;

  // click to open modal detail
  card.addEventListener("click", e => {
    if (card.dataset.dragging === "1") return;
    openTaskModal(t.id);
  });
  card.addEventListener("keydown", e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTaskModal(t.id); }
  });

  col.appendChild(card);
}

/* === Drag/drop preserved from original === */
function initDragDrop(){
  document.querySelectorAll(".task-card").forEach(card=>{
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", card.dataset.id);
      card.dataset.dragging = "1";
      card.classList.add("dragging");
    });
    card.addEventListener("dragend", e=>{
      card.dataset.dragging = "0";
      card.classList.remove("dragging");
    });
  });

  document.querySelectorAll(".kanban-body").forEach(col=>{
    col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("drag-over"); });
    col.addEventListener("dragleave", e=>{ col.classList.remove("drag-over"); });
    col.addEventListener("drop", async e=>{
      e.preventDefault(); col.classList.remove("drag-over");
      const id = e.dataTransfer.getData("text/plain");
      const newStatus = col.dataset.status;
      try {
        const fd = new FormData();
        fd.append("task_id", id);
        fd.append("status", newStatus);
        const res = await fetch("{% url 'api_update_status' %}", {
          method: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          body: fd
        });
        const json = await res.json();
        if(json.ok){ loadBoard(CURRENT_BOARD_PAGE); } else { alert("Status update failed"); }
      } catch (err) { console.error(err); alert("Network error."); }
    });
  });
}

/* === Search / Filter === */
function initSearch(allTasks){
  const searchInput = document.getElementById("taskSearch");
  const priorityFilter = document.getElementById("priorityFilter");
  const clearBtn = document.getElementById("clearFilters");

  function applyFilter(){
    const term = searchInput.value.trim().toLowerCase();
    const pri = priorityFilter.value;
    document.querySelectorAll(".task-card").forEach(card => card.style.display = "none");

    allTasks.forEach(t => {
      const matchTerm =
        (t.title && t.title.toLowerCase().includes(term)) ||
        (t.priority && t.priority.toLowerCase().includes(term)) ||
        (t.assigned_to_display && t.assigned_to_display.toLowerCase().includes(term));
      const matchPri = !pri || (t.priority === pri);
      if ((term === "" || matchTerm) && matchPri) {
        const cardEl = document.querySelector(`.task-card[data-id="${t.id}"]`);
        if (cardEl) cardEl.style.display = "";
      }
    });
  }

  if (searchInput) searchInput.addEventListener('input', applyFilter);
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilter);
  if (clearBtn) clearBtn.addEventListener('click', function(){ searchInput.value=''; priorityFilter.value=''; applyFilter(); });
}

/* === Pagination & Summary (unchanged) === */
function renderPagination(current, total){
  const container = document.getElementById("boardPagination");
  if(!container) return;
  container.innerHTML = "";

  function pageItem(label, page, disabled=false, active=false){
    const li = document.createElement("li");
    li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
    const a = document.createElement("a");
    a.className = "page-link";
    a.href = "#";
    a.textContent = label;
    a.addEventListener("click", (ev) => {
      ev.preventDefault();
      if(disabled || page === current) return;
      loadBoard(page);
    });
    li.appendChild(a);
    return li;
  }

  container.appendChild(pageItem("Prev", Math.max(1, current-1), current<=1));

  const pages = new Set();
  pages.add(1);
  pages.add(total);
  for(let p=current-2; p<=current+2; p++) if(p>1 && p<total) pages.add(p);
  const pagesArr = Array.from(pages).sort((a,b)=>a-b);

  let last = 0;
  pagesArr.forEach(p=>{
    if(last && p - last > 1){
      const ell = document.createElement("li");
      ell.className = "page-item disabled";
      ell.innerHTML = '<span class="page-link">…</span>';
      container.appendChild(ell);
    }
    container.appendChild(pageItem(p, p, false, p===current));
    last = p;
  });

  container.appendChild(pageItem("Next", Math.min(total, current+1), current>=total));
}

function updateSummary(page, totalCount, totalPages){
  const summary = document.getElementById("boardSummary");
  if(!summary) return;
  const start = (page-1)*PER_PAGE + 1;
  const end = Math.min(page*PER_PAGE, totalCount);
  summary.textContent = `Showing ${start}-${end} of ${totalCount} tasks`;
}

/* === Task Modal: open, fetch, populate, save === */
let taskModalInstance = null;
function openTaskModal(taskId){
  const modalEl = document.getElementById('taskDetailModal');
  if (!modalEl) return;
  // create bootstrap modal if not already
  if (!taskModalInstance) taskModalInstance = new bootstrap.Modal(modalEl);

  // clear form
  document.getElementById('modal_alert').classList.add('d-none');
  document.getElementById('taskDetailTitle').textContent = 'Loading...';
  document.getElementById('modal_task_id').value = taskId;
  document.getElementById('modal_title').value = '';
  document.getElementById('modal_description').value = '';
  document.getElementById('modal_priority').value = '';
  document.getElementById('modal_due_date').value = '';
  document.getElementById('modal_assignee').value = '';

  // show the modal (loading state visible)
  taskModalInstance.show();

  // fetch details
  fetch(TASK_DETAIL_API + '?id=' + encodeURIComponent(taskId))
    .then(r => r.json())
    .then(data => {
      if (!data || !data.id) {
        showModalAlert('error', 'Failed to load task details.');
        return;
      }
      // populate fields
      document.getElementById('taskDetailTitle').textContent = data.title || ('Task #' + data.id);
      document.getElementById('modal_task_id').value = data.id;
      document.getElementById('modal_title').value = data.title || '';
      document.getElementById('modal_description').value = data.description || '';
      document.getElementById('modal_priority').value = data.priority || '';
      document.getElementById('modal_due_date').value = data.due_date || '';
      document.getElementById('modal_assignee').value = data.assigned_to_display || (data.assigned_to || '');
    })
    .catch(err => {
      console.error(err);
      showModalAlert('error', 'Network error loading task.');
    });
}

function showModalAlert(type, text){
  const el = document.getElementById('modal_alert');
  el.className = 'alert mt-3';
  if (type === 'success') { el.classList.add('success'); el.textContent = text; el.classList.remove('d-none'); }
  else { el.classList.add('error'); el.textContent = text; el.classList.remove('d-none'); }
}

/* Submit form via AJAX */
document.getElementById('taskDetailForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('saveTaskBtn');
  btn.disabled = true;
  btn.innerHTML = 'Saving...';

  const fd = new FormData(this);
  fd.append('task_id', document.getElementById('modal_task_id').value);

  try {
    const res = await fetch(TASK_UPDATE_API, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    });
    const json = await res.json();
    if (json && json.ok) {
      showModalAlert('success', 'Saved successfully');
      // reload board to reflect changes
      setTimeout(() => {
        if (taskModalInstance) taskModalInstance.hide();
        loadBoard(CURRENT_BOARD_PAGE);
      }, 600);
    } else {
      showModalAlert('error', json.error || 'Save failed');
    }
  } catch (err) {
    console.error(err);
    showModalAlert('error', 'Network error while saving.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Save changes';
  }
});

/* === Utilities === */
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* === Init === */
document.addEventListener("DOMContentLoaded", function(){
  loadBoard(1);
});
</script>
{% endblock %}
