{% extends "core/base.html" %}
{% block content %}
<div class="container-fluid py-4">

  <!-- ===== Header Section ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
    <div>
      <h4 class="fw-bold text-gradient mb-0">
        <i class="fa-solid fa-table-columns me-2"></i> Task Board
      </h4>
      <p class="small text-muted mb-0">Drag &amp; drop tasks between columns. Click a card to view details.</p>
    </div>

    <!-- Action buttons grouped and separated from search -->
    <div class="d-flex flex-wrap align-items-center gap-2 header-actions">
      <a href="{% url 'create_task' %}" class="btn btn-gradient btn-lg">
        <i class="fa-solid fa-plus me-1"></i> New Task
      </a>
      <a href="{% url 'unassigned_tasks' %}" class="btn btn-outline-gradient btn-lg">
        <i class="fa-solid fa-user-clock me-1"></i> Unassigned
      </a>
    </div>
  </div>

  <!-- ===== Search Bar (separated with margin from header actions) ===== -->
  <div class="card mb-4 border-0 shadow-sm search-card">
    <div class="card-body py-3 d-flex align-items-center gap-3 flex-wrap">
      <div class="position-relative flex-fill" style="min-width:280px;">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" id="taskSearch" class="form-control search-input" placeholder="Search tasks by title, assignee or priority...">
      </div>

      <!-- small quick filters to the right of search (optional) -->
      <div class="d-flex gap-2">
        <select id="priorityFilter" class="form-select" style="width:160px;">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
        <button id="clearFilters" class="btn btn-light">Clear</button>
      </div>
    </div>
  </div>

  <!-- ===== Kanban Board (Horizontal Scroll Layout) ===== -->
  <div class="kanban-board-wrapper mb-3">
    <div class="kanban-board" id="kanbanBoard">
      {% for col in status_columns %}
      <div class="kanban-column">
        <div class="kanban-header">{{ col }}</div>
        <div class="kanban-body" data-status="{{ col }}" id="col-{{ col|slugify }}"></div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Pagination / Summary (footer wrapper will be created by JS) ===== -->
  <div class="d-flex flex-column align-items-center mt-3">
    <div id="boardSummary" class="small text-muted mb-1"></div>
    <nav aria-label="Task board pages">
      <ul class="pagination mb-0" id="boardPagination"></ul>
    </nav>
  </div>
</div>

<!-- ===== Task Detail Modal (Hidden by Default) ===== -->
<!-- kept hidden attribute so it doesn't render inline unexpectedly; JS removes hidden before show -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true" hidden>
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <form id="taskDetailForm" class="needs-validation" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="taskDetailTitle">Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body py-4">
          <input type="hidden" name="task_id" id="modal_task_id" />

          <div class="mb-3">
            <label class="form-label fw-semibold">Title</label>
            <input id="modal_title" name="title" class="form-control form-control-lg" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Description</label>
            <textarea id="modal_description" name="description" class="form-control" rows="6"></textarea>
          </div>

          <div class="row g-2">
            <div class="col-sm-6">
              <label class="form-label fw-semibold">Priority</label>
              <select id="modal_priority" name="priority" class="form-select">
                <option value="">--</option>
                <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label fw-semibold">Due date</label>
              <input id="modal_due_date" name="due_date" type="date" class="form-control">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-semibold">Assignee</label>
            <input id="modal_assignee" name="assigned_to_display" class="form-control" placeholder="Assignee name or team (editable)">
            <div class="form-text">Type member or team; backend will resolve on save.</div>
          </div>

          <div id="modal_alert" class="alert d-none mt-3" role="alert"></div>
        </div>

        <div class="modal-footer d-flex justify-content-end gap-2 px-4 py-3">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
          <button id="saveTaskBtn" type="submit" class="btn btn-gradient btn-lg">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ===== Styling tweaks ===== -->
<style>
/* header action spacing */
.header-actions .btn { display:inline-flex; align-items:center; gap:8px; }

/* larger, separated search area */
.search-card { border-radius:10px; }
.search-input { padding-left:40px; border-radius:8px; border:1px solid #e6eef6; box-shadow:none; height:44px; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6c757d; font-size:14px; }

/* improve button visuals and spacing vs search */
.btn-lg { padding:10px 16px; border-radius:10px; font-weight:600; }
.header-actions { margin-left:12px; }

/* --- Modern Kanban Board Layout --- */
.kanban-board-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  padding-bottom: 10px;
  -webkit-overflow-scrolling: touch;
}

.kanban-board {
  display: flex;
  gap: 16px;
  min-height: 70vh;
  padding-bottom: 10px;
  align-items: flex-start;
}

.kanban-column {
  flex: 0 0 320px;
  background: #fbfeff;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(13,38,71,0.06);
  display: flex;
  flex-direction: column;
  height: auto;
  max-height: 80vh;
}

.kanban-header {
  background: linear-gradient(90deg, #0b57a4, #38bdf8);
  color: #fff;
  text-align: center;
  border-radius: 8px 8px 0 0;
  font-weight: 700;
  padding: 10px;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* body is the drop area and scrollable per column */
.kanban-body {
  flex: 1;
  padding: 12px;
  border-radius: 0 0 12px 12px;
  background-color: #f9fcff;
  min-height: 55vh;
  overflow-y: auto;
  position: relative;
  z-index: 1;
}

.kanban-body.drag-over {
  background-color: rgba(56, 189, 248, 0.12);
  border: 2px dashed #38bdf8;
}

/* task card clickable UI */
.task-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:14px 16px; margin-bottom:12px; cursor:grab; transition:transform .12s ease, box-shadow .12s ease; }
.task-card:active { cursor:grabbing; }
.task-card:focus, .task-card:hover { transform:translateY(-4px); box-shadow:0 10px 26px rgba(10,30,60,0.08); outline: none; }
.task-title { font-weight:700; font-size:0.98rem; margin-bottom:4px; color:#0f1724; }
.task-meta { font-size:0.82rem; color:#54607a; margin-top:2px; }
.assignee-name { font-size:0.82rem; font-weight:600; color:#0b57a4; margin-top:8px; }

/* modal form */
.modal .form-label { font-weight:600; color:#0b2440; }
#modal_alert.success { background:#ecfdf5; color:#065f46; border:1px solid rgba(16,185,129,0.12); }
#modal_alert.error { background:#fff1f2; color:#9f1239; border:1px solid rgba(239,68,68,0.08); }

/* dragging visual */
.task-card.dragging { opacity: 0.6; transform: scale(0.995); }

/* Scrollbar styling for horizontal wrapper */
.kanban-board-wrapper::-webkit-scrollbar { height: 10px; }
.kanban-board-wrapper::-webkit-scrollbar-thumb { background: linear-gradient(90deg, #0b57a4, #38bdf8); border-radius: 5px; }
.kanban-board-wrapper::-webkit-scrollbar-track { background: #eef5fa; }

/* ensure modal markup stays hidden until JS shows it */
.modal[hidden] { display: none !important; visibility: hidden !important; }

/* ------------ Pagination / Summary styling ------------ */
#boardSummary {
  color: #374151;
  font-size: 0.92rem;
  margin-right: 12px;
}

/* Force pagination UL to be inline, remove bullets and default spacing */
#boardPagination {
  display: flex;
  gap: 8px;
  list-style: none;
  padding-left: 0;
  margin: 8px 0 0 0;
  align-items: center;
}

/* Page item and links - pill style */
#boardPagination .page-item { display: inline-block; }
#boardPagination .page-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 36px;
  border-radius: 20px;
  padding: 0 10px;
  border: 1px solid rgba(11,87,164,0.12);
  background: #ffffff;
  color: #0b57a4;
  font-weight: 600;
  text-decoration: none;
  box-shadow: 0 2px 6px rgba(11,87,164,0.03);
}
#boardPagination .page-item.active .page-link {
  background: linear-gradient(90deg,#0b57a4,#38bdf8);
  color: #fff;
  border-color: transparent;
}
#boardPagination .page-item.disabled .page-link {
  opacity: 0.45;
  cursor: not-allowed;
  background: #f3f6f9;
}

/* make the footer compact and centered */
.footer-pagination {
  display:flex;
  gap:18px;
  align-items:center;
  justify-content:center;
  padding: 16px 0 28px 0;
}

/* small responsive tweak so it wraps nicely on narrow screens */
@media (max-width: 600px) {
  .footer-pagination { flex-direction: column; gap: 6px; padding-bottom: 18px; }
  #boardPagination .page-link { min-width: 32px; height: 32px; }
}

/* ------------ Modal overlay & z-index fix ------------ */
/* Ensure backdrop sits under modal but above page content */
.modal-backdrop {
  z-index: 1050 !important;
}

/* Ensure modal itself is above backdrop and everything else */
.modal {
  z-index: 1060 !important;
}

/* Make sure modal uses fixed positioning and covers viewport (bootstrap does this by default) */
.modal.show {
  display: block;
}

/* Modal visual polish */
.modal .modal-content {
  border-radius: 12px;
  box-shadow: 0 18px 60px rgba(8,30,59,0.12);
  border: none;
  overflow: hidden;
}
.modal .modal-header .modal-title {
  font-size: 1.2rem;
  font-weight: 800;
  color: #072a4f;
}
.modal .modal-body { font-size: 0.95rem; color: #2b3b4a; }

/* fallback fixed modal style when bootstrap fails to position it */
.modal.fallback-show {
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  display: block !important;
  visibility: visible !important;
  width: 92% !important;
  max-width: 940px !important;
  z-index: 20000 !important;
  margin: 0 !important;
}

/* fallback backdrop */
.modal-backdrop.fallback {
  position: fixed !important;
  inset: 0 !important;
  background: rgba(6, 30, 60, 0.55) !important;
  z-index: 19990 !important;
}

/* optional: dim the board behind modal a touch more when modal open */
body.modal-open .kanban-board-wrapper,
body.modal-open .kanban-board {
  filter: blur(0.2px);
}

/* small responsive polish */
@media (max-width: 1100px) {
  .kanban-column { flex: 0 0 280px; }
}
@media (max-width: 900px) {
  .header-actions { width:100%; justify-content:flex-start; gap:8px; }
  .search-card .card-body { flex-direction:column; gap:10px; }
  .kanban-column { flex: 0 0 240px; }
}
</style>

<!-- ===== JS Logic ===== -->
<script>
let CURRENT_BOARD_PAGE = 1;
const PER_PAGE = 10;
let ALL_TASKS = [];
const TASK_DETAIL_API = "{% url 'api_task_detail' %}";        // expects GET ?id=ID
const TASK_UPDATE_API = "{% url 'api_task_update' %}";       // expects POST form data
const CSRF_TOKEN = "{{ csrf_token }}";

/* --- Board load (unchanged core logic) --- */
async function loadBoard(page=1){
  try {
    CURRENT_BOARD_PAGE = page;
    const res = await fetch("{% url 'board_data' %}?page=" + page);
    const payload = await res.json();
    const tasks = payload.tasks || [];
    ALL_TASKS = tasks;
    const pageNum = payload.page || 1;
    const totalPages = payload.total_pages || 1;
    const totalCount = payload.total_count || tasks.length;

    renderAllColumns(tasks);
    renderPagination(pageNum, totalPages);
    updateSummary(pageNum, totalCount, totalPages);
  } catch (err) {
    console.error("Board load failed", err);
  }
}

function renderAllColumns(tasks){
  document.querySelectorAll(".kanban-body").forEach(c => c.innerHTML = "");
  tasks.forEach(t => renderCard(t));
  initDragDrop();
  initSearch(ALL_TASKS);
}

/* --- Card rendering: make them clickable and accessible --- */
function renderCard(t){
  const col = document.querySelector(`[data-status="${t.status}"]`) || document.querySelector(".kanban-body");
  const card = document.createElement("div");
  card.className = "task-card";
  card.setAttribute("draggable", "true");
  card.dataset.id = t.id;
  card.setAttribute("tabindex","0");
  card.setAttribute("role","button");
  card.setAttribute("aria-label", "Open task " + (t.title || '') );

  let displayAssignee = "";
  if (t.assigned_to_display) displayAssignee = t.assigned_to_display;
  else if (t.assigned_to && t.assigned_to.startsWith("member:"))
    displayAssignee = "Member " + t.assigned_to.split(":")[1];
  else if (t.assigned_to && t.assigned_to.startsWith("team:"))
    displayAssignee = "Team " + t.assigned_to.split(":")[1];

  card.innerHTML = `
    <div>
      <div class="task-title">${escapeHtml(t.title)}</div>
      <div class="task-meta">
        ${escapeHtml(t.priority || '')}${t.due_date ? ' • Due ' + escapeHtml(t.due_date) : ''}
      </div>
      ${displayAssignee ? `<div class="assignee-name"><i class="fa-solid fa-user me-1"></i>${escapeHtml(displayAssignee)}</div>` : ''}
    </div>
  `;

  // click to open modal detail
  card.addEventListener("click", e => {
    if (card.dataset.dragging === "1") return;
    openTaskModal(t.id);
  });
  card.addEventListener("keydown", e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTaskModal(t.id); }
  });

  col.appendChild(card);
}

/* === Drag/drop preserved from original === */
function initDragDrop(){
  // re-bind cards
  document.querySelectorAll(".task-card").forEach(card=>{
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", card.dataset.id);
      try { e.dataTransfer.effectAllowed = "move"; } catch(err) {}
      card.dataset.dragging = "1";
      card.classList.add("dragging");
    });
    card.addEventListener("dragend", e=>{
      card.dataset.dragging = "0";
      card.classList.remove("dragging");
    });
  });

  // columns as drop targets
  document.querySelectorAll(".kanban-body").forEach(col=>{
    // allow dropping
    col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("drag-over"); e.dataTransfer.dropEffect = 'move'; });
    col.addEventListener("dragenter", e=>{ e.preventDefault(); col.classList.add("drag-over"); });
    col.addEventListener("dragleave", e=>{ col.classList.remove("drag-over"); });
    col.addEventListener("drop", async e=>{
      e.preventDefault(); col.classList.remove("drag-over");
      const id = e.dataTransfer.getData("text/plain");
      const newStatus = col.dataset.status;
      try {
        const fd = new FormData();
        fd.append("task_id", id);
        fd.append("status", newStatus);
        const res = await fetch("{% url 'api_update_status' %}", {
          method: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          body: fd
        });
        const json = await res.json();
        if(json.ok){ loadBoard(CURRENT_BOARD_PAGE); } else { alert("Status update failed"); }
      } catch (err) { console.error(err); alert("Network error."); }
    });
  });
}

/* === Drag-scroll for board (mouse drag to scroll horizontally) === */
(function enableBoardDragScroll(){
  const boardWrapper = document.querySelector('.kanban-board-wrapper');
  if(!boardWrapper) return;
  let isDown = false;
  let startX;
  let scrollLeft;

  boardWrapper.addEventListener('mousedown', (e) => {
    // only activate if clicking on empty board area, not when interacting inside a card
    if (e.target.closest('.task-card')) return;
    isDown = true;
    boardWrapper.classList.add('drag-scrolling');
    startX = e.pageX - boardWrapper.offsetLeft;
    scrollLeft = boardWrapper.scrollLeft;
    boardWrapper.style.cursor = 'grabbing';
    e.preventDefault();
  });

  boardWrapper.addEventListener('mouseleave', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });
  boardWrapper.addEventListener('mouseup', () => { isDown = false; boardWrapper.style.cursor = ''; boardWrapper.classList.remove('drag-scrolling'); });

  boardWrapper.addEventListener('mousemove', (e) => {
    if(!isDown) return;
    const x = e.pageX - boardWrapper.offsetLeft;
    const walk = (x - startX) * 1.2; // scroll speed
    boardWrapper.scrollLeft = scrollLeft - walk;
  });
})();

/* === Search / Filter === */
function initSearch(allTasks){
  const searchInput = document.getElementById("taskSearch");
  const priorityFilter = document.getElementById("priorityFilter");
  const clearBtn = document.getElementById("clearFilters");

  function applyFilter(){
    const term = (searchInput.value || '').trim().toLowerCase();
    const pri = priorityFilter.value;
    document.querySelectorAll(".task-card").forEach(card => card.style.display = "none");

    allTasks.forEach(t => {
      const matchTerm =
        (t.title && t.title.toLowerCase().includes(term)) ||
        (t.priority && t.priority.toLowerCase().includes(term)) ||
        (t.assigned_to_display && t.assigned_to_display.toLowerCase().includes(term));
      const matchPri = !pri || (t.priority === pri);
      if ((term === "" || matchTerm) && matchPri) {
        const cardEl = document.querySelector(`.task-card[data-id="${t.id}"]`);
        if (cardEl) cardEl.style.display = "";
      }
    });
  }

  if (searchInput) searchInput.addEventListener('input', applyFilter);
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilter);
  if (clearBtn) clearBtn.addEventListener('click', function(){ searchInput.value=''; priorityFilter.value=''; applyFilter(); });
}

/* === Pagination & Summary (unchanged) === */
function renderPagination(current, total){
  const container = document.getElementById("boardPagination");
  if(!container) return;
  container.innerHTML = "";

  function pageItem(label, page, disabled=false, active=false){
    const li = document.createElement("li");
    li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
    const a = document.createElement("a");
    a.className = "page-link";
    a.href = "#";
    a.textContent = label;
    a.addEventListener("click", (ev) => {
      ev.preventDefault();
      if(disabled || page === current) return;
      loadBoard(page);
    });
    li.appendChild(a);
    return li;
  }

  container.appendChild(pageItem("Prev", Math.max(1, current-1), current<=1));

  const pages = new Set();
  pages.add(1);
  pages.add(total);
  for(let p=current-2; p<=current+2; p++) if(p>1 && p<total) pages.add(p);
  const pagesArr = Array.from(pages).sort((a,b)=>a-b);

  let last = 0;
  pagesArr.forEach(p=>{
    if(last && p - last > 1){
      const ell = document.createElement("li");
      ell.className = "page-item disabled";
      ell.innerHTML = '<span class="page-link">…</span>';
      container.appendChild(ell);
    }
    container.appendChild(pageItem(p, p, false, p===current));
    last = p;
  });

  container.appendChild(pageItem("Next", Math.min(total, current+1), current>=total));
}

function updateSummary(page, totalCount, totalPages){
  const summary = document.getElementById("boardSummary");
  if(!summary) return;
  const start = (page-1)*PER_PAGE + 1;
  const end = Math.min(page*PER_PAGE, totalCount);
  summary.textContent = `Showing ${start}-${end} of ${totalCount} tasks`;
}

/* === Task Modal: open, fetch, populate, save === */
/* The openTaskModal below uses bootstrap when available but provides a robust fallback
   that ensures the modal/backdrop overlay covers the viewport and looks professional. */

let taskModalInstance = null;

// light-weight backdrop creation used by fallback
function createFallbackBackdrop() {
  // avoid duplicate
  if (document.querySelector('.modal-backdrop.fallback')) return;
  const b = document.createElement('div');
  b.className = 'modal-backdrop fallback';
  document.body.appendChild(b);
}

function removeFallbackBackdrop() {
  document.querySelectorAll('.modal-backdrop.fallback').forEach(el => el.remove());
}

/* fallback show/hide in case bootstrap fails */
function showModalFallback(modalEl) {
  if (!modalEl) return;
  createFallbackBackdrop();
  modalEl.classList.add('fallback-show');
  document.body.classList.add('modal-open');
  // focus first focusable element for accessibility
  const first = modalEl.querySelector('input, textarea, button, select, a');
  if (first) try { first.focus(); } catch(e) {}
}
function hideModalFallback(modalEl) {
  if (!modalEl) return;
  modalEl.classList.remove('fallback-show');
  removeFallbackBackdrop();
  document.body.classList.remove('modal-open');
}

/* main open function */
function openTaskModal(taskId){
  const modalEl = document.getElementById('taskDetailModal');
  if (!modalEl) return;

  // keep modal markup hidden by default
  if (modalEl.hasAttribute('hidden')) {
    modalEl.removeAttribute('hidden');
    modalEl.setAttribute('aria-hidden', 'false');
  }

  // ensure modal is attached to body so backdrop covers full viewport
  if (modalEl.parentElement !== document.body) {
    document.body.appendChild(modalEl);
  }

  // clear form & set loading text
  document.getElementById('modal_alert').classList.add('d-none');
  document.getElementById('taskDetailTitle').textContent = 'Loading...';
  document.getElementById('modal_task_id').value = taskId;
  document.getElementById('modal_title').value = '';
  document.getElementById('modal_description').value = '';
  document.getElementById('modal_priority').value = '';
  document.getElementById('modal_due_date').value = '';
  document.getElementById('modal_assignee').value = '';

  // Try using Bootstrap modal if available
  let usedBootstrap = false;
  try {
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      if (!taskModalInstance) taskModalInstance = new bootstrap.Modal(modalEl, { backdrop: true });
      taskModalInstance.show();
      usedBootstrap = true;
    }
  } catch (err) {
    console.warn('Bootstrap modal failed, will use fallback', err);
    usedBootstrap = false;
  }

  // Fetch details (do this regardless of which show method used)
  fetch(TASK_DETAIL_API + '?id=' + encodeURIComponent(taskId))
    .then(r => r.json())
    .then(data => {
      if (!data || !data.id) {
        showModalAlert('error', 'Failed to load task details.');
        // if bootstrap used but failed to fetch, ensure fallback not left visible
        if (!usedBootstrap && modalEl.classList.contains('fallback-show')) hideModalFallback(modalEl);
        return;
      }
      // populate fields
      document.getElementById('taskDetailTitle').textContent = data.title || ('Task #' + data.id);
      document.getElementById('modal_task_id').value = data.id;
      document.getElementById('modal_title').value = data.title || '';
      document.getElementById('modal_description').value = data.description || '';
      document.getElementById('modal_priority').value = data.priority || '';
      document.getElementById('modal_due_date').value = data.due_date || '';
      document.getElementById('modal_assignee').value = data.assigned_to_display || (data.assigned_to || '');
    })
    .catch(err => {
      console.error(err);
      showModalAlert('error', 'Network error loading task.');
    });

  // After a short delay, if bootstrap didn't actually show the modal, fall back
  setTimeout(() => {
    const actuallyShown = modalEl.classList.contains('show') || modalEl.classList.contains('fallback-show') || document.querySelector('.modal-backdrop');
    if (!actuallyShown) {
      // Use fallback show to guarantee overlay and fixed positioning
      showModalFallback(modalEl);
    }
  }, 160);
}

function showModalAlert(type, text){
  const el = document.getElementById('modal_alert');
  el.className = 'alert mt-3';
  if (type === 'success') { el.classList.add('success'); el.textContent = text; el.classList.remove('d-none'); }
  else { el.classList.add('error'); el.textContent = text; el.classList.remove('d-none'); }
}

/* Submit form via AJAX */
document.getElementById('taskDetailForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('saveTaskBtn');
  btn.disabled = true;
  btn.innerHTML = 'Saving...';

  const fd = new FormData(this);
  fd.append('task_id', document.getElementById('modal_task_id').value);

  try {
    const res = await fetch(TASK_UPDATE_API, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    });
    const json = await res.json();
    if (json && json.ok) {
      showModalAlert('success', 'Saved successfully');
      // reload board to reflect changes
      setTimeout(() => {
        try {
          if (taskModalInstance) taskModalInstance.hide();
        } catch (e) {}
        // hide fallback if it was used
        hideModalFallback(document.getElementById('taskDetailModal'));
        loadBoard(CURRENT_BOARD_PAGE);
      }, 500);
    } else {
      showModalAlert('error', json.error || 'Save failed');
    }
  } catch (err) {
    console.error(err);
    showModalAlert('error', 'Network error while saving.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Save changes';
  }
});

/* Close handling: hide fallback on close buttons or bootstrap events */
document.addEventListener('click', function (e) {
  if (e.target.closest('[data-bs-dismiss="modal"]') || e.target.closest('.btn-close')) {
    const modalEl = document.getElementById('taskDetailModal');
    try { if (taskModalInstance) taskModalInstance.hide(); } catch(e) {}
    hideModalFallback(modalEl);
  }
});
document.addEventListener('hidden.bs.modal', function(ev){
  const modalEl = document.getElementById('taskDetailModal');
  hideModalFallback(modalEl);
});

/* === Enhance footer (wrap summary + pagination into a centered footer) and modal z-index handlers === */
(function enhanceFooterAndModalBehavior(){
  // build footer wrapper
  const summary = document.getElementById('boardSummary');
  const pagination = document.getElementById('boardPagination');
  if (summary && pagination) {
    // create wrapper only if not present
    if (!document.querySelector('.footer-pagination')) {
      const parent = summary.parentElement || pagination.parentElement;
      const wrapper = document.createElement('div');
      wrapper.className = 'footer-pagination';
      parent.insertBefore(wrapper, parent.firstChild);
      wrapper.appendChild(summary);
      wrapper.appendChild(pagination);
    }
  }

  // Ensure Bootstrap modal backdrop and z-index are correct on show
  document.addEventListener('shown.bs.modal', function (ev) {
    const modal = ev.target;
    if (modal && modal.classList && modal.classList.contains('modal')) {
      modal.style.zIndex = 1060;
      document.querySelectorAll('.modal-backdrop').forEach(b => b.style.zIndex = 1050);
    }
  });

  // clean stray backdrops when modal hides
  document.addEventListener('hidden.bs.modal', function (ev) {
    document.querySelectorAll('.modal-backdrop:not(.fade)').forEach(b => b.remove());
  });
})();

/* === Utilities === */
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* === Init === */
document.addEventListener("DOMContentLoaded", function(){
  loadBoard(1);
});
</script>
{% endblock %}
