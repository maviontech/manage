{% extends 'core/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/page_view.css' %}">
<link rel="stylesheet" href="{% static 'core/css/all.min.css' %}">
<style>
    /* Ensure modals are hidden by default */
    .modal {
        display: none !important;
    }
    
    .modal.active {
        display: block !important;
    }
    
    /* Ensure proper grid layout */
    .detail-content {
        display: grid !important;
        grid-template-columns: 1fr 350px !important;
        gap: 30px !important;
    }
    
    /* Ensure proper container */
    .feedback-detail-container {
        max-width: 1400px !important;
        margin: 0 auto !important;
        padding: 20px !important;
    }
    
    .assignee-section {
        position: relative;
    }

    .assignee-input-wrapper {
        position: relative;
        margin-top: 12px;
    }

    .assignee-input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
    }

    .assignee-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .clear-assignee {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        font-size: 18px;
        padding: 4px 8px;
        display: none;
        line-height: 1;
    }

    .clear-assignee:hover {
        color: #ef4444;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        margin-top: 4px;
    }

    .search-results.active {
        display: block;
    }

    .search-result-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: #f8fafc;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .result-name {
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 4px;
        font-size: 14px;
    }

    .result-details {
        font-size: 12px;
        color: #64748b;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .result-details span:not(:last-child)::after {
        content: "���";
        margin-left: 8px;
        color: #cbd5e1;
    }

    .no-results {
        padding: 16px;
        text-align: center;
        color: #94a3b8;
        font-size: 14px;
    }

    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #e2e8f0;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .search-hint {
        font-size: 12px;
        color: #64748b;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-save-assignee {
        margin-top: 12px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: none;
        transition: all 0.2s;
    }

    .btn-save-assignee:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        transform: translateY(-1px);
    }

    .btn-save-assignee.active {
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="feedback-detail-container">
    <!-- Header Section -->
    <div class="detail-header">
        <div class="header-left">
            <a href="{% url 'my_tasks' %}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back to My Tasks
            </a>
            <h1 class="issue-title">
                <span class="issue-id">{{ issue.issue_id }}</span>
                {{ issue.summary }}
            </h1>
        </div>
        <div class="header-actions">
            {% if user_ldap == issue.reporter_ldap or user_role == 'ADMIN' %}
            <a href="{% url 'edit_task' issue.id %}" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
            {% endif %}
            <button class="btn btn-primary" onclick="addComment()">
                <i class="fas fa-comment"></i> Add Comment
            </button>
        </div>
    </div>

    <div class="detail-content">
        <!-- Left Panel: Issue Details -->
        <div class="detail-main">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <span class="label">Status:</span>
                    <span class="badge badge-{{ issue.status|lower }}">{{ issue.status }}</span>
                </div>
                <div class="status-item">
                    <span class="label">Priority:</span>
                    <span class="badge badge-priority-{{ issue.priority|lower }}">{{ issue.priority }}</span>
                </div>
                <div class="status-item">
                    <span class="label">Type:</span>
                    <span class="badge badge-type">{{ issue.issue_type }}</span>
                </div>
                <div class="status-item">
                    <span class="label">Severity:</span>
                    <span class="badge badge-severity-{{ issue.severity|lower }}">{{ issue.severity }}</span>
                </div>
            </div>

            <!-- Description Section -->
            <div class="card description-card">
                <div class="card-header">
                    <h3><i class="fas fa-info-circle"></i> Description</h3>
                </div>
                <div class="card-body">
                    <div class="description-content">
                        {{ issue.description|linebreaks|default:"No description provided." }}
                    </div>
                </div>
            </div>

            <!-- Attachments Section -->
            {% if attachments %}
            <div class="card attachments-card">
                <div class="card-header">
                    <h3><i class="fas fa-paperclip"></i> Attachments ({{ attachments|length }})</h3>
                    <button class="btn-icon" onclick="uploadAttachment()">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="attachments-grid">
                        {% for att in attachments %}
                        <div class="attachment-item">
                            <div class="attachment-icon">
                                <i class="fas fa-file"></i>
                            </div>
                            <div class="attachment-info">
                                <a href="{{ att.file_path }}" target="_blank" class="attachment-name">
                                    {{ att.file_name }}
                                </a>
                                <span class="attachment-meta">
                                    {{ att.file_size|filesizeformat }} • {{ att.uploaded_at|date:"M d, Y" }}
                                </span>
                            </div>
                            <button class="btn-icon" onclick="downloadFile('{{ att.file_path }}')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="card comments-card">
                <div class="card-header">
                    <h3><i class="fas fa-comments"></i> Comments ({{ comments|length }})</h3>
                </div>
                <div class="card-body">
                    <div class="comments-list">
                        {% for comment in comments %}
                        <div class="comment-item {% if comment.is_internal %}internal{% endif %}">
                            <div class="comment-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.commenter_name }}</span>
                                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                                    {% if comment.is_internal %}
                                    <span class="badge badge-internal">Internal</span>
                                    {% endif %}
                                </div>
                                <div class="comment-text">
                                    {{ comment.comment_text|linebreaks }}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-comments">
                            <i class="fas fa-inbox"></i>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Add Comment Form -->
                    <div class="comment-form" id="commentForm" style="display: none;">
                        <textarea id="commentText" class="form-control" rows="4"
                                  placeholder="Write your comment..."></textarea>
                        <div class="form-actions">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isInternal">
                                <span>Internal Comment (visible to team only)</span>
                            </label>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="cancelComment()">Cancel</button>
                                <button class="btn btn-primary" onclick="submitComment()">
                                    <i class="fas fa-paper-plane"></i> Post Comment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card activity-card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Activity Timeline</h3>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for activity in activities %}
                        <div class="activity-item">
                            <div class="activity-icon activity-{{ activity.action_type|lower }}">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    <strong>{{ activity.user_name }}</strong>
                                    <span class="activity-action">{{ activity.action_type|title }}</span>
                                </div>
                                {% if activity.old_value or activity.new_value %}
                                <div class="activity-changes">
                                    {% if activity.old_value %}
                                    <span class="old-value">{{ activity.old_value }}</span>
                                    <i class="fas fa-arrow-right"></i>
                                    {% endif %}
                                    <span class="new-value">{{ activity.new_value }}</span>
                                </div>
                                {% endif %}
                                {% if activity.description %}
                                <p class="activity-description">{{ activity.description }}</p>
                                {% endif %}
                                <span class="activity-time">{{ activity.created_at|timesince }} ago</span>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">No activity recorded yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Metadata -->
        <div class="detail-sidebar">
            <!-- Issue Metadata Card -->
            <div class="card metadata-card">
                <div class="card-header">
                    <h3><i class="fas fa-tags"></i> Details</h3>
                </div>
                <div class="card-body">
                    <div class="metadata-group">
                        <label>Reporter</label>
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="user-name">{{ issue.reporter_name }}</div>
                                <div class="user-email">{{ issue.reporter_email }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="metadata-group assignee-section">
                        <label>Assignee</label>
                        {% if issue.assignee_ldap %}
                        <div class="user-info" id="currentAssignee">
                            <i class="fas fa-user-tie"></i>
                            <div>
                                <div class="user-name">{{ issue.assignee_name }}</div>
                                <div class="user-email">{{ issue.assignee_ldap }}</div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="assignee-input-wrapper">
                            <input
                                type="text"
                                id="assignee-search"
                                class="assignee-input"
                                placeholder="Type name or LDAP username (min 3 chars)..."
                                autocomplete="off"
                            >
                            <button type="button" class="clear-assignee" id="clear-assignee">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="search-results" id="search-results"></div>
                        </div>
                        <div class="search-hint">
                            <i class="fas fa-info-circle"></i> Type at least 3 characters to search
                        </div>
                        <button type="button" class="btn-save-assignee" id="save-assignee">
                            <i class="fas fa-check"></i> Save Assignee
                        </button>
                    </div>

                    <div class="metadata-group">
                        <label>Module</label>
                        <div class="metadata-value">
                            {% if issue.module %}
                            <span class="badge badge-module">{{ issue.module }}</span>
                            {% else %}
                            <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="metadata-group">
                        <label>Resolution</label>
                        <div class="metadata-value">
                            <span class="badge badge-resolution-{{ issue.resolution|lower }}">
                                {{ issue.resolution }}
                            </span>
                        </div>
                    </div>

                    <div class="metadata-group">
                        <label>Dates</label>
                        <div class="dates-info">
                            <div class="date-item">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Created: {{ issue.created_at|date:"M d, Y" }}</span>
                            </div>
                            {% if issue.start_date %}
                            <div class="date-item">
                                <i class="fas fa-play"></i>
                                <span>Started: {{ issue.start_date|date:"M d, Y" }}</span>
                            </div>
                            {% endif %}
                            {% if issue.due_date %}
                            <div class="date-item">
                                <i class="fas fa-flag-checkered"></i>
                                <span>Due: {{ issue.due_date|date:"M d, Y" }}</span>
                            </div>
                            {% endif %}
                            {% if issue.closed_date %}
                            <div class="date-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Closed: {{ issue.closed_date|date:"M d, Y" }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if issue.browser_info %}
                    <div class="metadata-group">
                        <label>Environment</label>
                        <div class="env-info">
                            <div><i class="fas fa-browser"></i> {{ issue.browser_info }}</div>
                            {% if issue.screen_resolution %}
                            <div><i class="fas fa-desktop"></i> {{ issue.screen_resolution }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card actions-card">
                <div class="card-header">
                    <h3><i class="fas fa-cogs"></i> Actions</h3>
                </div>
                <div class="card-body">
                    <!-- Change Status Dropdown -->
                    <div class="action-item">
                        <label><i class="fas fa-sync-alt"></i> Change Status</label>
                        <select id="statusSelect" class="action-select" onchange="updateStatus(this.value)">
                            <option value="">Select Status</option>
                            <option value="Open" {% if issue.status == 'Open' %}selected{% endif %}>Open</option>
                            <option value="New" {% if issue.status == 'New' %}selected{% endif %}>New</option>
                            <option value="In Progress" {% if issue.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Finished" {% if issue.status == 'Finished' %}selected{% endif %}>Finished</option>
                            <option value="Closed" {% if issue.status == 'Closed' %}selected{% endif %}>Closed</option>
                        </select>
                    </div>

                    <!-- Update Priority Dropdown -->
                    <div class="action-item">
                        <label><i class="fas fa-exclamation-circle"></i> Update Priority</label>
                        <select id="prioritySelect" class="action-select" onchange="updatePriority(this.value)">
                            <option value="">Select Priority</option>
                            <option value="Critical" {% if issue.priority == 'Critical' %}selected{% endif %}>Critical</option>
                            <option value="High" {% if issue.priority == 'High' %}selected{% endif %}>High</option>
                            <option value="Medium" {% if issue.priority == 'Medium' %}selected{% endif %}>Medium</option>
                            <option value="Normal" {% if issue.priority == 'Normal' %}selected{% endif %}>Normal</option>
                            <option value="Low" {% if issue.priority == 'Low' %}selected{% endif %}>Low</option>
                        </select>
                    </div>

                    <!-- Add Attachment Button -->
                    <button class="action-btn" onclick="uploadAttachment()">
                        <i class="fas fa-paperclip"></i>
                        Add Attachment
                    </button>

                    {% if user_role == 'ADMIN' %}
                    <button class="action-btn danger" onclick="deleteIssue()">
                        <i class="fas fa-trash"></i>
                        Delete Issue
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Attachment Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Attachment</h3>
            <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="file" id="attachmentFile" class="form-control" multiple>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('uploadModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitAttachment()">Upload</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this issue? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/detail.js' %}"></script>
<script>
    // Initialize global constants for detail.js
    const issueId = {{ issue.id }};
    const csrfToken = '{{ csrf_token }}';
    
    // Update Status Function
    function updateStatus(newStatus) {
        if (!newStatus) return;
        
        if (confirm(`Change status to "${newStatus}"?`)) {
            fetch(`/tasks/${issueId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Status updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update status'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating status');
            });
        } else {
            // Reset dropdown to current value
            document.getElementById('statusSelect').value = '{{ issue.status }}';
        }
    }
    
    // Update Priority Function
    function updatePriority(newPriority) {
        if (!newPriority) return;
        
        if (confirm(`Change priority to "${newPriority}"?`)) {
            fetch(`/tasks/${issueId}/update-priority/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ priority: newPriority })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Priority updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update priority'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating priority');
            });
        } else {
            // Reset dropdown to current value
            document.getElementById('prioritySelect').value = '{{ issue.priority }}';
        }
    }
    
    // Add Comment Functions
    function addComment() {
        document.getElementById('commentForm').style.display = 'block';
        document.getElementById('commentText').focus();
    }
    
    function cancelComment() {
        document.getElementById('commentForm').style.display = 'none';
        document.getElementById('commentText').value = '';
        document.getElementById('isInternal').checked = false;
    }
    
    function submitComment() {
        const commentText = document.getElementById('commentText').value.trim();
        const isInternal = document.getElementById('isInternal').checked;
        
        if (!commentText) {
            alert('Please enter a comment');
            return;
        }
        
        fetch(`/tasks/${issueId}/add-comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                comment_text: commentText,
                is_internal: isInternal
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Comment posted successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to post comment'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while posting comment');
        });
    }
</script>
{% endblock %}