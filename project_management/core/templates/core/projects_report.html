{% extends "core/base.html" %}

{% block title %}Trackline Projects Report{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --primary: #0b57a4;
  --primary-light: #1f86e3;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
}

.report-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.report-header {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

.report-header h1 {
  margin: 0 0 10px 0;
  font-size: 28px;
  font-weight: 700;
}

.report-header p {
  margin: 0;
  opacity: 0.9;
  font-size: 15px;
}

.filters-section {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-input {
  padding: 10px 14px;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
}

.filter-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(11, 87, 164, 0.1);
}

.btn-filter {
  padding: 10px 20px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-filter:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(11, 87, 164, 0.3);
}

.btn-reset {
  padding: 10px 20px;
  background: white;
  color: var(--gray-700);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-reset:hover {
  background: var(--gray-50);
}

/* Custom Team Dropdown Styles */
.custom-dropdown {
  position: relative;
  width: 100%;
}

.dropdown-toggle {
  width: 100%;
  padding: 10px 40px 10px 12px;
  background: white;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
  color: var(--gray-700);
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
  position: relative;
}

.dropdown-toggle:hover {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(11, 87, 164, 0.1);
}

.dropdown-toggle::after {
  content: "â–¼";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px;
  color: var(--gray-500);
  transition: transform 0.2s;
}

.dropdown-toggle.active::after {
  transform: translateY(-50%) rotate(180deg);
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  margin-top: 4px;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: none;
}

.dropdown-menu.active {
  display: block;
}

.dropdown-search {
  position: sticky;
  top: 0;
  background: white;
  padding: 8px;
  border-bottom: 1px solid var(--gray-200);
}

.dropdown-search input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 14px;
}

.dropdown-search input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(11, 87, 164, 0.1);
}

.dropdown-item {
  padding: 10px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid var(--gray-100);
}

.dropdown-item:hover {
  background: var(--gray-50);
}

.dropdown-item:last-child {
  border-bottom: none;
}

.team-name {
  flex: 1;
  font-size: 14px;
  color: var(--gray-700);
}

.view-members-btn {
  padding: 4px 10px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.view-members-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

/* Members Modal Styles */
.members-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.members-modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-800);
}

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--gray-500);
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.close-modal:hover {
  background: var(--gray-100);
  color: var(--gray-700);
}

.modal-search {
  padding: 16px 24px;
  border-bottom: 1px solid var(--gray-200);
}

.modal-search input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 14px;
}

.modal-search input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(11, 87, 164, 0.1);
}

.modal-body {
  padding: 20px 24px;
  max-height: 50vh;
  overflow-y: auto;
}

.member-card {
  padding: 16px;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.member-card:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(11, 87, 164, 0.1);
}

.member-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
  margin-bottom: 8px;
}

.member-info {
  font-size: 14px;
  color: var(--gray-600);
  line-height: 1.6;
}

.no-members {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
  font-size: 14px;
}

.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.chart-card {
  background: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.chart-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--gray-800);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-container {
  position: relative;
  height: 280px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid var(--primary);
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.stat-card.success { border-left-color: var(--success); }
.stat-card.warning { border-left-color: var(--warning); }
.stat-card.danger { border-left-color: var(--danger); }
.stat-card.info { border-left-color: var(--info); }

.stat-label {
  font-size: 13px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--gray-800);
  line-height: 1;
}

.stat-icon {
  float: right;
  font-size: 28px;
  opacity: 0.2;
}

.projects-table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  overflow: hidden;
}

.table-header {
  padding: 20px 24px;
  border-bottom: 2px solid var(--gray-100);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--gray-800);
}

.search-box {
  padding: 8px 16px;
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  width: 300px;
  font-size: 14px;
}

.projects-table {
  width: 100%;
  border-collapse: collapse;
}

.projects-table thead {
  background: var(--gray-50);
}

.projects-table th {
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: var(--gray-700);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--gray-200);
}

.projects-table td {
  padding: 16px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
  color: var(--gray-700);
}

.projects-table tbody tr:hover {
  background: var(--gray-50);
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: capitalize;
}

.status-active {
  background: #dbeafe;
  color: #1e40af;
}

.status-completed {
  background: #d1fae5;
  color: #065f46;
}

.status-planned {
  background: #e0e7ff;
  color: #4338ca;
}

.status-onhold {
  background: #fef3c7;
  color: #92400e;
}

.timeline-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.timeline-ontrack {
  background: #d1fae5;
  color: #065f46;
}

.timeline-atrisk {
  background: #fef3c7;
  color: #92400e;
}

.timeline-overdue {
  background: #fee2e2;
  color: #991b1b;
}

.timeline-completed {
  background: #e0e7ff;
  color: #4338ca;
}

.progress-bar-container {
  width: 100%;
  height: 8px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 4px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--success), #34d399);
  transition: width 0.3s ease;
  border-radius: 4px;
}

.task-stats {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 12px;
}

.task-stat {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  background: var(--gray-100);
  border-radius: 6px;
  white-space: nowrap;
}

.task-stat.completed {
  background: #d1fae5;
  color: #065f46;
}

.task-stat.pending {
  background: #fef3c7;
  color: #92400e;
}

.task-stat.overdue {
  background: #fee2e2;
  color: #991b1b;
}

.employee-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.employee-name {
  font-weight: 600;
  color: var(--gray-800);
}

.employee-meta {
  font-size: 12px;
  color: var(--gray-600);
}

.no-data {
  text-align: center;
  padding: 60px 20px;
  color: var(--gray-600);
}

.no-data i {
  font-size: 48px;
  color: var(--gray-200);
  margin-bottom: 16px;
}

.btn-export {
  background: white;
  border: 1px solid var(--gray-200);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-export:hover {
  background: var(--gray-50);
  border-color: var(--gray-300);
}

.pagination-container {
  padding: 20px 24px;
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.pagination-info {
  font-size: 14px;
  color: var(--gray-600);
}

.pagination-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.pagination-btn {
  padding: 8px 12px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  font-size: 14px;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
  min-width: 36px;
  text-align: center;
}

.pagination-btn:hover:not(:disabled) {
  background: var(--gray-50);
  border-color: var(--primary);
  color: var(--primary);
}

.pagination-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.pagination-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  border-color: var(--primary);
  font-weight: 600;
}

.pagination-ellipsis {
  padding: 8px 4px;
  color: var(--gray-400);
}

.pagination-select {
  padding: 6px 10px;
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  font-size: 14px;
  color: var(--gray-700);
  cursor: pointer;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .search-box {
    width: 100%;
    margin-top: 10px;
  }
  
  .table-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .projects-table {
    display: block;
    overflow-x: auto;
  }
  
  .pagination-container {
    flex-direction: column;
    align-items: center;
  }
  
  .pagination-controls {
    flex-wrap: wrap;
    justify-content: center;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="report-container">
  <!-- Header -->
  <div class="report-header">
    <h1><i class="fa fa-chart-line"></i> Trackline Projects Report</h1>
    <p>Comprehensive overview of all projects with live tracking data, task statistics, and employee assignments</p>
  </div>

  <!-- Date Filters -->
  <div class="filters-section">
    <div class="filters-grid">
      <div class="filter-group">
        <label class="filter-label">
          <i class="fa fa-calendar"></i> Start Date From
        </label>
        <input type="date" id="startDateFrom" class="filter-input">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fa fa-calendar"></i> Start Date To
        </label>
        <input type="date" id="startDateTo" class="filter-input">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fa fa-filter"></i> Status
        </label>
        <select id="statusFilter" class="filter-input">
          <option value="">All Statuses</option>
          <option value="Active">Active</option>
          <option value="Completed">Completed</option>
          <option value="Planned">Planned</option>
          <option value="On Hold">On Hold</option>
        </select>
      </div>

      <!-- Team Selector with Search -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fa fa-users"></i> Team
        </label>
        <div style="position: relative;">
          <input type="text" id="teamSearchInput" class="filter-input" 
                 placeholder="Search teams..." 
                 onclick="toggleTeamDropdown()" 
                 oninput="searchTeams()" 
                 readonly
                 style="cursor: pointer; background: white;">
          <i class="fa fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #6b7280;"></i>
        </div>
        <input type="hidden" id="teamFilter" value="all">
        
        <!-- Team Dropdown -->
        <div id="teamDropdown" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 400px; overflow-y: auto; margin-top: 4px; min-width: 300px;">
          <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 1;">
            <input type="text" id="teamSearchField" class="filter-input" 
                   placeholder="ðŸ” Search teams..." 
                   oninput="searchTeams()"
                   style="margin: 0;">
          </div>
          <div id="teamList" style="max-height: 300px; overflow-y: auto;">
            <div class="team-option" data-team-id="all" onclick="selectTeam('all', 'All Teams')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #1f2937;">All Teams</div>
                <div style="font-size: 12px; color: #6b7280;">View all teams</div>
              </div>
            </div>
            {% for team in teams %}
            <div class="team-option" data-team-id="{{ team.id }}" data-team-name="{{ team.name|lower }}" onclick="selectTeam('{{ team.id }}', '{{ team.name|escapejs }}')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1f2937;">{{ team.name }}</div>
                <div style="font-size: 12px; color: #6b7280;">Team ID: {{ team.id }}</div>
              </div>
              <button onclick="event.stopPropagation(); viewTeamMembers('{{ team.id }}', '{{ team.name|escapejs }}')" 
                      style="padding: 6px 12px; background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <i class="fa fa-eye"></i> Members
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <div class="filter-group">
        <button class="btn-filter" onclick="applyFilters()">
          <i class="fa fa-search"></i> Apply Filters
        </button>
      </div>
      
      <div class="filter-group">
        <button class="btn-reset" onclick="resetFilters()">
          <i class="fa fa-redo"></i> Reset
        </button>
      </div>
    </div>
  </div>

<script>
function handleTeamChange() {
  var teamFilter = document.getElementById('teamFilter');
  var allTeamSearchContainer = document.getElementById('allTeamSearchContainer');
  if (teamFilter.value === 'all') {
    allTeamSearchContainer.style.display = 'block';
  } else {
    allTeamSearchContainer.style.display = 'none';
  }
}

function filterAllTeams() {
  var input = document.getElementById('allTeamSearchInput').value.toLowerCase();
  var teamFilter = document.getElementById('teamFilter');
  for (var i = 0; i < teamFilter.options.length; i++) {
    var option = teamFilter.options[i];
    if (option.value !== 'all' && option.value !== '') {
      option.style.display = option.text.toLowerCase().includes(input) ? '' : 'none';
    }
  }
}
</script>

  <!-- Charts Section -->
  <div class="charts-section">
    <!-- Project Status Donut Chart -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="fa fa-chart-pie"></i> Projects by Status
      </div>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- Task Completion Donut Chart -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="fa fa-tasks"></i> Tasks Overview
      </div>
      <div class="chart-container">
        <canvas id="tasksChart"></canvas>
      </div>
    </div>

    <!-- Employee Status Donut Chart -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="fa fa-users"></i> Employee Status
      </div>
      <div class="chart-container">
        <canvas id="employeeChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <i class="fa fa-folder-open stat-icon"></i>
      <div class="stat-label">Total Projects</div>
      <div class="stat-value">{{ summary.total_projects }}</div>
    </div>

    <div class="stat-card success">
      <i class="fa fa-check-circle stat-icon"></i>
      <div class="stat-label">Active Projects</div>
      <div class="stat-value">{{ summary.active_projects }}</div>
    </div>


    <div class="stat-card warning">
      <i class="fa fa-hourglass-half stat-icon"></i>
      <div class="stat-label">Pending Tasks</div>
      <div class="stat-value">{{ summary.pending_tasks }}</div>
    </div>

    <div class="stat-card danger">
      <i class="fa fa-exclamation-triangle stat-icon"></i>
      <div class="stat-label">Overdue Tasks</div>
      <div class="stat-value">{{ summary.overdue_tasks }}</div>
    </div>

    <div class="stat-card info">
      <i class="fa fa-trophy stat-icon"></i>
      <div class="stat-label">Completed Projects</div>
      <div class="stat-value">{{ summary.completed_projects }}</div>
    </div>
  </div>

  <!-- Projects Table -->
  <div class="projects-table-container">
    <div class="table-header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <h2 style="margin: 0;"><i class="fa fa-list"></i> <span id="viewTitle">Project Details</span></h2>
        <select id="viewModeSelector" class="filter-input" style="width: auto; min-width: 200px;" onchange="switchViewMode()">
          <option value="projects">Projects View ({{ projects|length }})</option>
          <option value="tasks">Tasks View ({{ tasks|length }})</option>
        </select>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="searchInput" class="search-box" placeholder="Search...">
        <button class="btn-export" onclick="exportToCSV()">
          <i class="fa fa-file-excel"></i> Export to Excel
        </button>
      </div>
    </div>
    <!-- Team/Member Toggle -->
    <div style="display: flex; gap: 20px; align-items: center; margin: 18px 0 8px 0; justify-content: flex-start;">
      <div class="toggle-group" style="display: flex; gap: 12px;">
        <label class="toggle-label" style="font-weight:600; font-size:15px; color:#374151;">
          <input type="checkbox" id="teamToggle" checked style="accent-color: #0b57a4; margin-right:6px;"> Team
        </label>
        <label class="toggle-label" style="font-weight:600; font-size:15px; color:#374151;">
          <input type="checkbox" id="memberToggle" style="accent-color: #10b981; margin-right:6px;"> Member
        </label>
      </div>
      <span style="font-size:13px; color:#6b7280;">Select to view Team or Member data</span>
    </div>

    {% if projects %}
    <table class="projects-table" id="projectsTable">
      <thead>
        <tr>
          <th>Project Name</th>
          <th>Team / Member</th>
          <th>Status</th>
          <th>Timeline</th>
          <th>Tasks</th>
          <th>Progress</th>
          <th>Dates</th>
        </tr>
      </thead>
      <tbody>
        {% for project in projects %}
        <tr>
          <!-- Project Name & Description -->
          <td>
            <div style="max-width: 250px;">
              <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                {{ project.name }}
              </div>
              {% if project.description %}
              <div style="font-size: 12px; color: #6b7280; line-height: 1.4;">
                {{ project.description|truncatewords:15 }}
              </div>
              {% endif %}
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
                Created by: {{ project.created_by_name }}
              </div>
            </div>
          </td>

          <!-- Employee Information -->
          <td class="team-member-cell">
            <div class="team-data" style="display:block;">
              <div style="font-weight:600; color:#0b57a4; margin-bottom:4px;">
                <i class="fa fa-users"></i> {{ project.team_name|default:'No Team' }}
              </div>
              {% if project.team_name and project.team_lead %}
              <div style="font-size:12px; color:#6b7280;">
                <i class="fa fa-user-tie"></i> Lead: {{ project.team_lead }}
              </div>
              {% endif %}
            </div>
            <div class="member-data" style="display:none;">
              <div class="employee-info">
                <div class="employee-name">
                  <i class="fa fa-user-tie" style="color: #0b57a4;"></i>
                  {{ project.employee_name }}
                </div>
                {% if project.employee_name != 'Not Assigned' %}
                <div class="employee-meta">
                  <i class="fa fa-id-badge"></i> {{ project.employee_code }}
                </div>
                <div class="employee-meta">
                  <i class="fa fa-building"></i> {{ project.department }}
                </div>
                <div class="employee-meta">
                  <i class="fa fa-briefcase"></i> {{ project.designation }}
                </div>
                {% endif %}
              </div>
            </div>
          </td>

          <!-- Status -->
          <td>
            <span class="status-badge status-{{ project.status|lower|cut:' ' }}">
              {{ project.status }}
            </span>
          </td>

          <!-- Timeline Status -->
          <td>
            <span class="timeline-badge timeline-{{ project.timeline_status|lower|cut:' ' }}">
              {{ project.timeline_status }}
            </span>
          </td>

          <!-- Task Statistics -->
          <td>
            <div class="task-stats">
              <div class="task-stat">
                <i class="fa fa-tasks"></i>
                <span>{{ project.total_tasks }} Total</span>
              </div>
              <div class="task-stat completed">
                <i class="fa fa-check"></i>
                <span>{{ project.completed_tasks }} Done</span>
              </div>
              <div class="task-stat pending">
                <i class="fa fa-clock"></i>
                <span>{{ project.pending_tasks }} Pending</span>
              </div>
              {% if project.overdue_tasks > 0 %}
              <div class="task-stat overdue">
                <i class="fa fa-exclamation-circle"></i>
                <span>{{ project.overdue_tasks }} Overdue</span>
              </div>
              {% endif %}
              {% if project.critical_tasks > 0 %}
              <div class="task-stat" style="background: #fee2e2; color: #991b1b;">
                <i class="fa fa-fire"></i>
                <span>{{ project.critical_tasks }} Critical</span>
              </div>
              {% endif %}
            </div>
          </td>

          <!-- Progress -->
          <td>
            <div style="min-width: 100px;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">
                {{ project.progress }}%
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ project.progress }}%;"></div>
              </div>
            </div>
          </td>

          <!-- Dates -->
          <td>
            <div style="font-size: 12px; line-height: 1.6;">
              {% if project.start_date %}
              <div><strong>Start:</strong> {{ project.start_date|date:"M d, Y" }}</div>
              {% endif %}
              {% if project.tentative_end_date %}
              <div><strong>Due:</strong> {{ project.tentative_end_date|date:"M d, Y" }}</div>
              {% endif %}
              {% if project.end_date %}
              <div style="color: #10b981;"><strong>Completed:</strong> {{ project.end_date|date:"M d, Y" }}</div>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="no-data">
      <i class="fa fa-folder-open"></i>
      <p style="font-size: 16px; margin-top: 12px;">No projects found</p>
      <p style="font-size: 14px; color: #9ca3af;">Create your first project to get started</p>
    </div>
    {% endif %}

    <!-- Tasks Table (Hidden by default) -->
    {% if tasks %}
    <table class="projects-table" id="tasksTable" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Task Title</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Due Date</th>
          <th>Assigned To (Team/Member)</th>
          <th>Project</th>
          <th>Created At</th>
          <th>Created By</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr>
          <!-- Task ID -->
          <td>
            <div style="font-weight: 600; color: #0b57a4; font-size: 14px;">
              #{{ task.id }}
            </div>
          </td>

          <!-- Task Title & Description -->
          <td>
            <div style="max-width: 300px;">
              <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                {{ task.title }}
              </div>
              {% if task.description %}
              <div style="font-size: 12px; color: #6b7280; line-height: 1.4;">
                {{ task.description|truncatewords:20 }}
              </div>
              {% endif %}
            </div>
          </td>

          <!-- Priority -->
          <td>
            <span class="timeline-badge {% if task.priority == 'Critical' %}timeline-overdue{% elif task.priority == 'High' %}timeline-atrisk{% elif task.priority == 'Normal' %}timeline-ontrack{% else %}timeline-completed{% endif %}">
              {{ task.priority }}
            </span>
          </td>

          <!-- Status -->
          <td>
            <span class="status-badge {% if task.status == 'Completed' %}status-completed{% elif task.status == 'In Progress' %}status-active{% elif task.status == 'Open' or task.status == 'New' %}status-planned{% else %}status-onhold{% endif %}">
              {{ task.status }}
            </span>
          </td>

          <!-- Due Date -->
          <td>
            <div style="font-size: 13px;">
              {% if task.due_date %}
                <div style="font-weight: 500; color: #374151;">
                  {{ task.due_date|date:"M d, Y" }}
                </div>
              {% else %}
                <span style="color: #9ca3af; font-style: italic;">No due date</span>
              {% endif %}
            </div>
          </td>

          <!-- Assigned To -->
          <td class="task-team-member-cell">
            <div class="task-team-data" style="display:block;">
              {% if task.assigned_type == 'team' %}
                <i class="fa fa-users" style="color: #8b5cf6;"></i> {{ task.assigned_name }}
              {% else %}
                <span style="color:#9ca3af; font-style:italic;">No Team</span>
              {% endif %}
            </div>
            <div class="task-member-data" style="display:none;">
              {% if task.assigned_type != 'team' %}
                <i class="fa fa-user" style="color: #10b981;"></i> {{ task.assigned_name }}
              {% else %}
                <span style="color:#9ca3af; font-style:italic;">No Member</span>
              {% endif %}
            </div>
          </td>

          <!-- Project Name -->
          <td>
            <div style="font-size: 13px; color: #6b7280;">
              {% if task.project_name and task.project_name != 'No Project' %}
                <i class="fa fa-folder" style="color: #0b57a4;"></i>
                {{ task.project_name }}
              {% else %}
                <span style="color: #9ca3af; font-style: italic;">No Project</span>
              {% endif %}
            </div>
          </td>

          <!-- Created At -->
          <td>
            <div style="font-size: 13px; font-weight: 500; color: #374151;">
              {{ task.created_at|date:"M d, Y" }}
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">
                {{ task.created_at|date:"h:i A" }}
              </div>
            </div>
          </td>

          <!-- Created By -->
          <td>
            <div style="font-size: 13px; color: #6b7280;">
              <i class="fa fa-user" style="color: #6b7280;"></i>
              {{ task.created_by_name }}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    
    <!-- Pagination Controls for Projects -->
    <div class="pagination-container" id="projectsPagination" style="display: none;">
      <div class="pagination-info">
        Showing <span id="projectsShowingStart">1</span> to <span id="projectsShowingEnd">10</span> of <span id="projectsTotal">0</span> projects
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="projectsFirstPage" onclick="paginateProjects('first')">
          <i class="fa fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" id="projectsPrevPage" onclick="paginateProjects('prev')">
          <i class="fa fa-angle-left"></i> Prev
        </button>
        <div id="projectsPageNumbers" style="display: flex; gap: 8px;"></div>
        <button class="pagination-btn" id="projectsNextPage" onclick="paginateProjects('next')">
          Next <i class="fa fa-angle-right"></i>
        </button>
        <button class="pagination-btn" id="projectsLastPage" onclick="paginateProjects('last')">
          <i class="fa fa-angle-double-right"></i>
        </button>
        <select class="pagination-select" id="projectsPerPage" onchange="changeProjectsPerPage()">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
      </div>
    </div>
    
    <!-- Pagination Controls for Tasks -->
    <div class="pagination-container" id="tasksPagination" style="display: none;">
      <div class="pagination-info">
        Showing <span id="tasksShowingStart">1</span> to <span id="tasksShowingEnd">10</span> of <span id="tasksTotal">0</span> tasks
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="tasksFirstPage" onclick="paginateTasks('first')">
          <i class="fa fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" id="tasksPrevPage" onclick="paginateTasks('prev')">
          <i class="fa fa-angle-left"></i> Prev
        </button>
        <div id="tasksPageNumbers" style="display: flex; gap: 8px;"></div>
        <button class="pagination-btn" id="tasksNextPage" onclick="paginateTasks('next')">
          Next <i class="fa fa-angle-right"></i>
        </button>
        <button class="pagination-btn" id="tasksLastPage" onclick="paginateTasks('last')">
          <i class="fa fa-angle-double-right"></i>
        </button>
        <select class="pagination-select" id="tasksPerPage" onchange="changeTasksPerPage()">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Chart instances
let statusChart, tasksChart, employeeChart;

// Pagination state
let projectsCurrentPage = 1;
let projectsPerPage = 10;
let projectsAllRows = [];
let tasksCurrentPage = 1;
let tasksPerPage = 10;
let tasksAllRows = [];

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
  initializeCharts();
  initializePagination();
  // Team/Member Toggle Logic
  const teamToggle = document.getElementById('teamToggle');
  const memberToggle = document.getElementById('memberToggle');
  function updateTeamMemberDisplay() {
    // Projects Table
    const projectCells = document.querySelectorAll('.team-member-cell');
    projectCells.forEach(cell => {
      const teamData = cell.querySelector('.team-data');
      const memberData = cell.querySelector('.member-data');
      if (teamToggle.checked && !memberToggle.checked) {
        if (teamData) teamData.style.display = 'block';
        if (memberData) memberData.style.display = 'none';
      } else if (!teamToggle.checked && memberToggle.checked) {
        if (teamData) teamData.style.display = 'none';
        if (memberData) memberData.style.display = 'block';
      } else if (teamToggle.checked && memberToggle.checked) {
        if (teamData) teamData.style.display = 'block';
        if (memberData) memberData.style.display = 'block';
      } else {
        if (teamData) teamData.style.display = 'none';
        if (memberData) memberData.style.display = 'none';
      }
    });
    // Tasks Table
    const taskCells = document.querySelectorAll('.task-team-member-cell');
    taskCells.forEach(cell => {
      const teamData = cell.querySelector('.task-team-data');
      const memberData = cell.querySelector('.task-member-data');
      if (teamToggle.checked && !memberToggle.checked) {
        if (teamData) teamData.style.display = 'block';
        if (memberData) memberData.style.display = 'none';
      } else if (!teamToggle.checked && memberToggle.checked) {
        if (teamData) teamData.style.display = 'none';
        if (memberData) memberData.style.display = 'block';
      } else if (teamToggle.checked && memberToggle.checked) {
        if (teamData) teamData.style.display = 'block';
        if (memberData) memberData.style.display = 'block';
      } else {
        if (teamData) teamData.style.display = 'none';
        if (memberData) memberData.style.display = 'none';
      }
    });
  }
  if (teamToggle && memberToggle) {
    teamToggle.addEventListener('change', updateTeamMemberDisplay);
    memberToggle.addEventListener('change', updateTeamMemberDisplay);
    updateTeamMemberDisplay();
  }
});

// Switch between Projects and Tasks view
function switchViewMode() {
  const selector = document.getElementById('viewModeSelector');
  const viewTitle = document.getElementById('viewTitle');
  const projectsTable = document.getElementById('projectsTable');
  const tasksTable = document.getElementById('tasksTable');
  const searchInput = document.getElementById('searchInput');
  const projectsPagination = document.getElementById('projectsPagination');
  const tasksPagination = document.getElementById('tasksPagination');
  
  if (selector.value === 'tasks') {
    // Show tasks table, hide projects table
    if (projectsTable) projectsTable.style.display = 'none';
    if (tasksTable) tasksTable.style.display = 'table';
    if (projectsPagination) projectsPagination.style.display = 'none';
    if (tasksPagination) tasksPagination.style.display = 'flex';
    viewTitle.textContent = 'Task Details';
    searchInput.placeholder = 'Search tasks...';
    
    // Re-capture task rows and render pagination
    tasksAllRows = Array.from(tasksTable.querySelectorAll('tbody tr'));
    tasksCurrentPage = 1;
    renderTasksPagination();
  } else {
    // Show projects table, hide tasks table
    if (projectsTable) projectsTable.style.display = 'table';
    if (tasksTable) tasksTable.style.display = 'none';
    if (projectsPagination) projectsPagination.style.display = 'flex';
    if (tasksPagination) tasksPagination.style.display = 'none';
    viewTitle.textContent = 'Project Details';
    searchInput.placeholder = 'Search projects...';
    
    // Re-render projects pagination
    renderProjectsPagination();
  }
  
  // Clear search when switching views
  searchInput.value = '';
}

function initializeCharts() {
  // Project Status Donut Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  const statusData = {
    labels: ['Active', 'Completed', 'Planned', 'On Hold'],
    datasets: [{
      data: [
        {{ summary.active_projects }},
        {{ summary.completed_projects }},
        {{ summary.planned_projects|default:0 }},
        {{ summary.onhold_projects|default:0 }}
      ],
      backgroundColor: [
        '#3b82f6',  // Blue for Active
        '#10b981',  // Green for Completed
        '#8b5cf6',  // Purple for Planned
        '#f59e0b'   // Orange for On Hold
      ],
      borderWidth: 0,
      hoverOffset: 10
    }]
  };

  statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: statusData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 12, weight: '600' },
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '65%'
    }
  });

  // Tasks Overview Donut Chart
  const tasksCtx = document.getElementById('tasksChart').getContext('2d');
  const tasksData = {
    labels: ['Completed', 'Pending', 'Overdue'],
    datasets: [{
      data: [
        {{ summary.completed_tasks }},
        {{ summary.pending_tasks }},
        {{ summary.overdue_tasks|default:0 }}
      ],
      backgroundColor: [
        '#10b981',  // Green for Completed
        '#f59e0b',  // Orange for Pending
        '#ef4444'   // Red for Overdue
      ],
      borderWidth: 0,
      hoverOffset: 10
    }]
  };

  tasksChart = new Chart(tasksCtx, {
    type: 'doughnut',
    data: tasksData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 12, weight: '600' },
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '65%'
    }
  });

  // Employee Status Donut Chart
  const employeeCtx = document.getElementById('employeeChart').getContext('2d');
  
  const employeeData = {
    labels: ['Active', 'Inactive', 'On Leave'],
    datasets: [{
      data: [
        {{ summary.active_employees }},
        {{ summary.inactive_employees|default:0 }},
        {{ summary.onleave_employees|default:0 }}
      ],
      backgroundColor: [
        '#10b981',  // Green for Active
        '#f59e0b',  // Orange for Inactive
        '#8b5cf6'   // Purple for On Leave
      ],
      borderWidth: 0,
      hoverOffset: 10
    }]
  };

  employeeChart = new Chart(employeeCtx, {
    type: 'doughnut',
    data: employeeData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 12, weight: '600' },
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '65%'
    }
  });
}

// Filter functionality
function applyFilters() {
  const startDateFrom = document.getElementById('startDateFrom').value;
  const startDateTo = document.getElementById('startDateTo').value;
  const statusFilter = document.getElementById('statusFilter').value;
  
  const table = document.getElementById('projectsTable');
  if (!table) return;
  
  const rows = table.querySelectorAll('tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    let show = true;
    
    // Get row data
    const startDateCell = row.querySelector('td:nth-last-child(2)');
    const statusCell = row.querySelector('.status-badge');
    
    if (!startDateCell || !statusCell) {
      row.style.display = 'none';
      return;
    }
    
    const rowStartDate = startDateCell.textContent.trim().split('Start:')[1]?.trim().split('\\n')[0];
    const rowStatus = statusCell.textContent.trim();
    
    // Apply date filters
    if (startDateFrom && rowStartDate) {
      const rowDate = new Date(rowStartDate);
      const filterDate = new Date(startDateFrom);
      if (rowDate < filterDate) show = false;
    }
    
    if (startDateTo && rowStartDate) {
      const rowDate = new Date(rowStartDate);
      const filterDate = new Date(startDateTo);
      if (rowDate > filterDate) show = false;
    }
    
    // Apply status filter
    if (statusFilter && rowStatus !== statusFilter) {
      show = false;
    }
    
    row.style.display = show ? '' : 'none';
    if (show) visibleCount++;
  });
  
  // Show message if no results
  const tbody = table.querySelector('tbody');
  const noResults = tbody.querySelector('.no-results-row');
  
  if (visibleCount === 0 && !noResults) {
    const tr = document.createElement('tr');
    tr.className = 'no-results-row';
    tr.innerHTML = '<td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="fa fa-filter" style="font-size:32px;margin-bottom:12px;display:block;"></i>No projects match the selected filters</td>';
    tbody.appendChild(tr);
  } else if (visibleCount > 0 && noResults) {
    noResults.remove();
  }
}

function resetFilters() {
  document.getElementById('startDateFrom').value = '';
  document.getElementById('startDateTo').value = '';
  document.getElementById('statusFilter').value = '';
  
  const table = document.getElementById('projectsTable');
  if (table) {
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      if (!row.classList.contains('no-results-row')) {
        row.style.display = '';
      }
    });
    
    const noResults = table.querySelector('.no-results-row');
    if (noResults) noResults.remove();
  }
}

// Search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const viewMode = document.getElementById('viewModeSelector').value;
    const table = viewMode === 'tasks' ? document.getElementById('tasksTable') : document.getElementById('projectsTable');
    
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      if (row.classList.contains('no-results-row')) return;
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

// Export to Excel with Professional Styling
function exportToCSV() {
  const viewMode = document.getElementById('viewModeSelector').value;
  const exportBtn = document.querySelector('.btn-export');
  
  // Show loading state
  const originalHTML = exportBtn.innerHTML;
  exportBtn.disabled = true;
  exportBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Exporting...';
  
  // Build URL with view mode parameter
  const url = "{% url 'export_projects_excel' %}?view_mode=" + viewMode;
  
  // Create a temporary link to trigger download
  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Export failed');
      }
      return response.blob();
    })
    .then(blob => {
      const downloadUrl = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      
      // Set filename based on view mode
      const date = new Date().toISOString().split('T')[0];
      if (viewMode === 'tasks') {
        a.download = `Trackline_Tasks_Report_${date}.xlsx`;
      } else {
        a.download = `Trackline_Projects_Report_${date}.xlsx`;
      }
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(downloadUrl);
      
      // Reset button
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalHTML;
      
      // Show success message
      showNotification('Excel file downloaded successfully!', 'success');
    })
    .catch(error => {
      console.error('Export error:', error);
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalHTML;
      showNotification('Failed to export Excel file. Please try again.', 'error');
    });
}

// Notification helper
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  notification.innerHTML = `<i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Team Dropdown Functions
function toggleTeamDropdown() {
  const dropdown = document.getElementById('teamDropdown');
  const isVisible = dropdown.style.display === 'block';
  dropdown.style.display = isVisible ? 'none' : 'block';
  if (!isVisible) {
    document.getElementById('teamSearchField').focus();
  }
}

function searchTeams() {
  const input = document.getElementById('teamSearchField').value.toLowerCase();
  const teamOptions = document.querySelectorAll('.team-option');
  
  teamOptions.forEach(option => {
    const teamName = option.getAttribute('data-team-name') || '';
    const teamId = option.getAttribute('data-team-id');
    if (teamId === 'all' || teamName.includes(input)) {
      option.style.display = 'flex';
    } else {
      option.style.display = 'none';
    }
  });
}

function selectTeam(teamId, teamName) {
  document.getElementById('teamFilter').value = teamId;
  document.getElementById('teamSearchInput').value = teamName;
  document.getElementById('teamDropdown').style.display = 'none';
  document.getElementById('teamSearchField').value = '';
  searchTeams();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('teamDropdown');
  const teamInput = document.getElementById('teamSearchInput');
  if (dropdown && !dropdown.contains(event.target) && event.target !== teamInput) {
    dropdown.style.display = 'none';
  }
});

// Team Members Modal
function viewTeamMembers(teamId, teamName) {
  // Create modal
  const modal = document.createElement('div');
  modal.id = 'teamMembersModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
  `;
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
      <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #2563eb, #3b82f6); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">
              <i class="fa fa-users"></i> ${teamName}
            </h2>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">Team Members</p>
          </div>
          <button onclick="closeTeamMembersModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; transition: all 0.2s;">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>
      
      <div style="padding: 20px;">
        <div style="margin-bottom: 16px;">
          <input type="text" id="memberSearchInput" placeholder="ðŸ” Search members..." 
                 oninput="filterMembers()" 
                 style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; box-sizing: border-box;">
        </div>
        
        <div id="membersListContainer" style="max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <i class="fa fa-spinner fa-spin" style="font-size: 32px; color: #3b82f6;"></i>
            <p style="margin-top: 16px;">Loading members...</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Fetch team members
  fetch(`/api/team-members/?team_id=${teamId}`)
    .then(response => response.json())
    .then(data => {
      const members = data.members || [];
      displayTeamMembers(members);
      // (debug panel removed)
    })
    .catch(error => {
      console.error('Error fetching team members:', error);
      document.getElementById('membersListContainer').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #ef4444;">
          <i class="fa fa-exclamation-circle" style="font-size: 32px;"></i>
          <p style="margin-top: 16px;">Failed to load members</p>
        </div>
      `;
    });
}

function displayTeamMembers(members) {
  const container = document.getElementById('membersListContainer');
  
  if (members.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #6b7280;">
        <i class="fa fa-users" style="font-size: 32px;"></i>
        <p style="margin-top: 16px;">No members found</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = members.map(member => `
    <div class="member-item" data-member-name="${(member.first_name + ' ' + member.last_name).toLowerCase()}" 
         style="padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 16px; transition: background 0.2s;">
      <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #2563eb); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
        ${(member.first_name || 'U').charAt(0).toUpperCase()}
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${member.first_name || ''} ${member.last_name || ''}</div>
        <div style="font-size: 13px; color: #6b7280;">
          <i class="fa fa-envelope"></i> ${member.email || 'No email'}
          ${member.phone ? ` â€¢ <i class="fa fa-phone"></i> ${member.phone}` : ''}
        </div>
      </div>
    </div>
  `).join('');
  
  // Add hover effect
  document.querySelectorAll('.member-item').forEach(item => {
    item.addEventListener('mouseenter', function() {
      this.style.background = '#f9fafb';
    });
    item.addEventListener('mouseleave', function() {
      this.style.background = 'transparent';
    });
  });
}

function filterMembers() {
  const input = document.getElementById('memberSearchInput').value.toLowerCase();
  const memberItems = document.querySelectorAll('.member-item');
  
  memberItems.forEach(item => {
    const memberName = item.getAttribute('data-member-name') || '';
    item.style.display = memberName.includes(input) ? 'flex' : 'none';
  });
}

function closeTeamMembersModal() {
  const modal = document.getElementById('teamMembersModal');
  if (modal) {
    modal.remove();
  }
}

// Pagination Functions
function initializePagination() {
  const projectsTable = document.getElementById('projectsTable');
  const tasksTable = document.getElementById('tasksTable');
  
  if (projectsTable) {
    projectsAllRows = Array.from(projectsTable.querySelectorAll('tbody tr'));
    if (projectsAllRows.length > 0) {
      document.getElementById('projectsPagination').style.display = 'flex';
      renderProjectsPagination();
    }
  }
  
  if (tasksTable) {
    tasksAllRows = Array.from(tasksTable.querySelectorAll('tbody tr'));
    if (tasksAllRows.length > 0) {
      renderTasksPagination();
    }
  }
}

function renderProjectsPagination() {
  const totalRows = projectsAllRows.length;
  const totalPages = Math.ceil(totalRows / projectsPerPage);
  const startIndex = (projectsCurrentPage - 1) * projectsPerPage;
  const endIndex = Math.min(startIndex + projectsPerPage, totalRows);
  
  // Hide all rows first
  projectsAllRows.forEach(row => row.style.display = 'none');
  
  // Show only current page rows
  for (let i = startIndex; i < endIndex; i++) {
    projectsAllRows[i].style.display = '';
  }
  
  // Update pagination info
  document.getElementById('projectsShowingStart').textContent = totalRows > 0 ? startIndex + 1 : 0;
  document.getElementById('projectsShowingEnd').textContent = endIndex;
  document.getElementById('projectsTotal').textContent = totalRows;
  
  // Update page buttons
  document.getElementById('projectsFirstPage').disabled = projectsCurrentPage === 1;
  document.getElementById('projectsPrevPage').disabled = projectsCurrentPage === 1;
  document.getElementById('projectsNextPage').disabled = projectsCurrentPage === totalPages;
  document.getElementById('projectsLastPage').disabled = projectsCurrentPage === totalPages;
  
  // Render page numbers
  renderPageNumbers('projects', projectsCurrentPage, totalPages);
}

function renderTasksPagination() {
  const totalRows = tasksAllRows.length;
  const totalPages = Math.ceil(totalRows / tasksPerPage);
  const startIndex = (tasksCurrentPage - 1) * tasksPerPage;
  const endIndex = Math.min(startIndex + tasksPerPage, totalRows);
  
  // Hide all rows first
  tasksAllRows.forEach(row => row.style.display = 'none');
  
  // Show only current page rows
  for (let i = startIndex; i < endIndex; i++) {
    tasksAllRows[i].style.display = '';
  }
  
  // Update pagination info
  document.getElementById('tasksShowingStart').textContent = totalRows > 0 ? startIndex + 1 : 0;
  document.getElementById('tasksShowingEnd').textContent = endIndex;
  document.getElementById('tasksTotal').textContent = totalRows;
  
  // Update page buttons
  document.getElementById('tasksFirstPage').disabled = tasksCurrentPage === 1;
  document.getElementById('tasksPrevPage').disabled = tasksCurrentPage === 1;
  document.getElementById('tasksNextPage').disabled = tasksCurrentPage === totalPages;
  document.getElementById('tasksLastPage').disabled = tasksCurrentPage === totalPages;
  
  // Render page numbers
  renderPageNumbers('tasks', tasksCurrentPage, totalPages);
}

function renderPageNumbers(type, currentPage, totalPages) {
  const container = document.getElementById(type + 'PageNumbers');
  container.innerHTML = '';
  
  if (totalPages <= 7) {
    // Show all pages if 7 or fewer
    for (let i = 1; i <= totalPages; i++) {
      container.appendChild(createPageButton(type, i, currentPage));
    }
  } else {
    // Show first, last, current and nearby pages with ellipsis
    container.appendChild(createPageButton(type, 1, currentPage));
    
    if (currentPage > 3) {
      container.appendChild(createEllipsis());
    }
    
    const start = Math.max(2, currentPage - 1);
    const end = Math.min(totalPages - 1, currentPage + 1);
    
    for (let i = start; i <= end; i++) {
      container.appendChild(createPageButton(type, i, currentPage));
    }
    
    if (currentPage < totalPages - 2) {
      container.appendChild(createEllipsis());
    }
    
    container.appendChild(createPageButton(type, totalPages, currentPage));
  }
}

function createPageButton(type, pageNum, currentPage) {
  const btn = document.createElement('button');
  btn.className = 'pagination-btn' + (pageNum === currentPage ? ' active' : '');
  btn.textContent = pageNum;
  btn.onclick = () => {
    if (type === 'projects') {
      projectsCurrentPage = pageNum;
      renderProjectsPagination();
    } else {
      tasksCurrentPage = pageNum;
      renderTasksPagination();
    }
  };
  return btn;
}

function createEllipsis() {
  const span = document.createElement('span');
  span.className = 'pagination-ellipsis';
  span.textContent = '...';
  return span;
}

function paginateProjects(action) {
  const totalPages = Math.ceil(projectsAllRows.length / projectsPerPage);
  
  switch(action) {
    case 'first':
      projectsCurrentPage = 1;
      break;
    case 'prev':
      projectsCurrentPage = Math.max(1, projectsCurrentPage - 1);
      break;
    case 'next':
      projectsCurrentPage = Math.min(totalPages, projectsCurrentPage + 1);
      break;
    case 'last':
      projectsCurrentPage = totalPages;
      break;
  }
  
  renderProjectsPagination();
}

function paginateTasks(action) {
  const totalPages = Math.ceil(tasksAllRows.length / tasksPerPage);
  
  switch(action) {
    case 'first':
      tasksCurrentPage = 1;
      break;
    case 'prev':
      tasksCurrentPage = Math.max(1, tasksCurrentPage - 1);
      break;
    case 'next':
      tasksCurrentPage = Math.min(totalPages, tasksCurrentPage + 1);
      break;
    case 'last':
      tasksCurrentPage = totalPages;
      break;
  }
  
  renderTasksPagination();
}

function changeProjectsPerPage() {
  projectsPerPage = parseInt(document.getElementById('projectsPerPage').value);
  projectsCurrentPage = 1;
  renderProjectsPagination();
}

function changeTasksPerPage() {
  tasksPerPage = parseInt(document.getElementById('tasksPerPage').value);
  tasksCurrentPage = 1;
  renderTasksPagination();
}
</script>
{% endblock %}
