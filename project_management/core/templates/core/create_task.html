{% extends "core/base.html" %}
{% load static %}

{% block content %}
<style>
/* ========== MODERN CREATE TASK UI ========== */
.create-task-page {
  max-width: 1000px;
  margin: 0 auto;
  padding: 2.5rem 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #e8f0fe 100%);
  min-height: 100vh;
}

/* Page Header */
.page-header-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.5rem;
  margin-bottom: 2rem;
  padding: 2rem 2.5rem;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 2px solid rgba(59, 130, 246, 0.1);
  position: relative;
  overflow: hidden;
}

.page-header-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
}

.header-content .header-title {
  font-size: 2rem;
  font-weight: 800;
  margin: 0 0 0.5rem 0;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.header-content .header-subtitle {
  color: #64748b;
  font-size: 0.95rem;
  font-weight: 500;
  margin: 0;
  line-height: 1.5;
}

.header-actions .btn-back {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  font-weight: 700;
  font-size: 0.9rem;
  text-decoration: none;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.header-actions .btn-back:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

/* Form Card */
.form-main-card {
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 2px solid rgba(59, 130, 246, 0.08);
  padding: 2.5rem 3rem;
}

/* Form Layout */
.form-section {
  margin-bottom: 2rem;
}

.form-grid-modern {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.form-field-full {
  grid-column: 1 / -1;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.field-label {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  letter-spacing: -0.1px;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.field-label .required {
  color: #ef4444;
  font-weight: 800;
}

.field-input,
.field-select,
.field-textarea {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.95rem;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #1e293b;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
}

.field-input:focus,
.field-select:focus,
.field-textarea:focus {
  border-color: #3b82f6;
  outline: none;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15), 0 2px 8px rgba(0, 0, 0, 0.05);
  background: #ffffff;
  transform: translateY(-2px);
}

.field-hint {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 500;
}

/* Description Section */
.description-section {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  padding: 1.5rem 2rem;
  border: 2px solid #e2e8f0;
  margin-top: 2rem;
}

.description-section .field-label {
  margin-bottom: 0.75rem;
}

.field-textarea {
  resize: vertical;
  min-height: 140px;
  font-family: inherit;
}

/* Action Buttons */
.form-actions {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 2.5rem 0 1.5rem 0;
  padding-top: 2rem;
  border-top: 2px solid #f1f5f9;
}

.btn-modern {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.875rem 2rem;
  border-radius: 12px;
  font-weight: 700;
  font-size: 0.95rem;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  letter-spacing: 0.2px;
  min-width: 160px;
  cursor: pointer;
}

.btn-modern.primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  border: none;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-modern.primary:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  color: #ffffff;
}

.btn-modern.primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-modern.secondary {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  border: 2px solid #e2e8f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.btn-modern.secondary:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

/* Responsive Design */
@media (max-width: 900px) {
  .create-task-page {
    padding: 1.5rem 1rem;
  }

  .page-header-card {
    flex-direction: column;
    align-items: flex-start;
    padding: 1.5rem;
  }

  .header-content .header-title {
    font-size: 1.5rem;
  }

  .header-actions {
    width: 100%;
  }

  .header-actions .btn-back {
    width: 100%;
    justify-content: center;
  }

  .form-main-card {
    padding: 1.5rem 1.25rem;
  }

  .form-grid-modern {
    grid-template-columns: 1fr;
    gap: 1.25rem;
  }

  .form-actions {
    flex-direction: column;
  }

  .btn-modern {
    width: 100%;
  }

  .description-section {
    padding: 1.25rem;
  }
}
</style>

<div class="create-task-page">
  <!-- Page Header -->
  <div class="page-header-card">
    <div class="header-content">
      <h3 class="header-title"><i class="fa-solid fa-plus-circle"></i> Create Task</h3>
      <p class="header-subtitle">Provide essential details below to create a new task for your project.</p>
    </div>
    <div class="header-actions">
      <a href="{% url 'task_board' %}" class="btn-back">
        <i class="fa-solid fa-arrow-left"></i> Back to Board
      </a>
    </div>
  </div>

  <!-- Form Card -->
  <div class="form-main-card">
    <form method="post" id="createTaskForm" novalidate>
      {% csrf_token %}

      <!-- Main Form Fields -->
      <div class="form-section">
        <div class="form-grid-modern">
          <!-- Task Title (Full Width) -->
          <div class="form-field form-field-full">
            <label class="field-label">
              Task Title <span class="required">*</span>
            </label>
            <input name="title" type="text" class="field-input" placeholder="e.g. Implement user authentication" required>
            <span class="field-hint">Short, descriptive title for your task</span>
          </div>

          <!-- Project -->
          <div class="form-field">
            <label class="field-label">Project</label>
            <select name="project_id" id="projectSelect" class="field-select">
              <option value="">-- Choose Project --</option>
              {% for p in projects %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Subproject -->
          <div class="form-field">
            <label class="field-label">Subproject (WBS)</label>
            <select name="subproject_id" id="subprojectSelect" class="field-select">
              <option value="">-- Optional Subproject --</option>
            </select>
          </div>

          <!-- Priority -->
          <div class="form-field">
            <label class="field-label">Priority</label>
            <select name="priority" class="field-select">
              <option value="Low">Low</option>
              <option value="Normal" selected>Normal</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>

          <!-- Work Type (NEW) -->
          <div class="form-field">
            <label class="field-label">
              <i class="fa-solid fa-layer-group"></i> Work Type
            </label>
            <select name="work_type" id="workTypeSelect" class="field-select">
              {% for wtype in work_types %}
                <option value="{{ wtype }}" {% if wtype == 'Task' %}selected{% endif %}>{{ wtype }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Due Date -->
          <div class="form-field">
            <label class="field-label">Due Date</label>
            <input type="date" name="due_date" class="field-input">
          </div>

          <!-- Assign To (Full Width) -->
          <div class="form-field form-field-full">
            <label class="field-label">Assign To</label>
            <select name="assigned_to" id="assignSelect" class="field-select">
              <option value="">Unassigned</option>
              <optgroup label="Members">
                {% for m in members %}
                  <option value="member:{{ m.id }}">{{ m.first_name }} {{ m.last_name }} — {{ m.email }}</option>
                {% endfor %}
              </optgroup>
              <optgroup label="Teams">
                {% for t in teams %}
                  <option value="team:{{ t.id }}">Team: {{ t.name }}</option>
                {% endfor %}
              </optgroup>
            </select>
          </div>
        </div>
      </div>

      <!-- Description Section -->
      <div class="description-section">
        <label class="field-label">Description (optional)</label>
        <textarea name="description" rows="6" class="field-textarea" placeholder="Add detailed notes, acceptance criteria, links, steps to reproduce..."></textarea>
        <span class="field-hint">Optional — good place for acceptance criteria or reproduction steps</span>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <a href="{% url 'task_board' %}" class="btn-modern secondary">Cancel</a>
        <button id="createBtn" type="submit" class="btn-modern primary">
          <i class="fa-solid fa-check"></i> Create Task
        </button>
      </div>
    </form>
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function(){
  console.log('Page loaded - script initialized');
  const projectSelect = document.getElementById('projectSelect');
  const subprojectSelect = document.getElementById('subprojectSelect');
  const createBtn = document.getElementById('createBtn');
  const workTypeSelect = document.getElementById('workTypeSelect');
  
  console.log('projectSelect found:', !!projectSelect);
  console.log('subprojectSelect found:', !!subprojectSelect);

  // Load work types based on selected project
  async function loadProjectWorkTypes(projectId) {
    if (!workTypeSelect || !projectId) return;
    
    try {
      const response = await fetch(`/tasks/api/project-work-types/?project_id=${projectId}`);
      const data = await response.json();
      
      if (data.work_types && data.work_types.length > 0) {
        const currentValue = workTypeSelect.value;
        workTypeSelect.innerHTML = '';
        
        data.work_types.forEach(wtype => {
          const option = document.createElement('option');
          option.value = wtype;
          option.textContent = wtype;
          if (wtype === currentValue || wtype === 'Task') {
            option.selected = true;
          }
          workTypeSelect.appendChild(option);
        });
        console.log('Loaded work types for project:', data.work_types);
      }
    } catch (error) {
      console.error('Error loading work types:', error);
    }
  }

  // Handle work type selection - redirect to specific form
  if(workTypeSelect) {
    workTypeSelect.addEventListener('change', function(e) {
      const selectedType = e.target.value;
      console.log('Work type changed to:', selectedType);
      
      // Define URL mappings for each work type
      const workTypeUrls = {
        'Bug': '{% url "create_bug" %}',
        'Story': '{% url "create_story" %}',
        'Defect': '{% url "create_defect" %}',
        'Sub Task': '{% url "create_subtask" %}',
        'Report': '{% url "create_report" %}',
        'Change Request': '{% url "create_change_request" %}',
        'Task': '{% url "create_task" %}'
      };
      
      // If a specific work type with its own page is selected, redirect
      if (workTypeUrls[selectedType] && selectedType !== 'Task') {
        console.log('Redirecting to:', workTypeUrls[selectedType]);
        // Store selected project in sessionStorage before redirect
        if (projectSelect && projectSelect.value) {
          sessionStorage.setItem('selectedProjectId', projectSelect.value);
        }
        window.location.href = workTypeUrls[selectedType];
      }
    });
  }

  async function loadSubprojects(pid){
    console.log('loadSubprojects called with project ID:', pid);
    if(!subprojectSelect) {
      console.error('subprojectSelect element not found!');
      return;
    }
    subprojectSelect.innerHTML = '<option value="">Loading...</option>';
    subprojectSelect.disabled = true;
    try {
      const url = `/tasks/api/subprojects/?project_id=${pid}`;
      console.log('Fetching from:', url);
      const res = await fetch(url);
      console.log('Response status:', res.status);
      if(!res.ok) {
        console.error('API response not ok:', res.status, res.statusText);
        const errorText = await res.text();
        console.error('Error response:', errorText);
        throw new Error('API request failed');
      }
      const data = await res.json();
      console.log('Subprojects loaded:', data);
      
      subprojectSelect.innerHTML = '<option value="">-- Optional Subproject --</option>';
      
      if(data.subprojects && data.subprojects.length > 0) {
        console.log('Adding', data.subprojects.length, 'subprojects to dropdown');
        data.subprojects.forEach(sp => {
          const o = document.createElement('option'); 
          o.value = sp.id; 
          o.textContent = sp.name;
          subprojectSelect.appendChild(o);
          console.log('Added subproject:', sp.name);
        });
      } else {
        console.log('No subprojects found for this project');
        const o = document.createElement('option');
        o.value = '';
        o.textContent = '(No subprojects available)';
        o.disabled = true;
        subprojectSelect.appendChild(o);
      }
      subprojectSelect.disabled = false;
    } catch (err) {
      console.error('Error loading subprojects:', err);
      subprojectSelect.innerHTML = '<option value="">-- Error loading subprojects --</option>';
      subprojectSelect.disabled = false;
    }
  }

  if(projectSelect) {
    projectSelect.addEventListener('change', e => {
      const pid = e.target.value;
      console.log('Project dropdown changed. Selected value:', pid);
      if(pid) {
        console.log('Loading subprojects for project:', pid);
        loadSubprojects(pid);
        // Load work types for selected project
        loadProjectWorkTypes(pid);
      } else {
        console.log('No project selected, resetting subproject dropdown');
        subprojectSelect.innerHTML = '<option value="">-- Optional Subproject --</option>';
        subprojectSelect.disabled = false;
      }
    });
  } else {
    console.error('projectSelect element not found!');
  }

  document.getElementById('createTaskForm')?.addEventListener('submit', function(){
    createBtn.disabled = true;
    createBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';
  });
});
</script>
{% endblock %}
