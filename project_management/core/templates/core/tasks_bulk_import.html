{% extends "core/base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold text-gradient"><i class="fa-solid fa-file-csv me-2"></i> Bulk Task Import</h4>
      <p class="small text-muted mb-0">Upload CSV to create tasks in bulk. You will be shown a summary after import.</p>
    </div>
    <div>
      <a href="{% url 'task_board' %}" class="btn btn-outline-gradient"><i class="fa-solid fa-th-large me-1"></i> Board</a>
    </div>
  </div>

  <div class="card soft-card p-4">
    <form id="bulkForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row g-3 align-items-center">
        <div class="col-md-8">
          <label class="form-label fw-semibold text-primary">CSV file</label>
          <input type="file" name="csv_file" id="csv_file" accept=".csv" required class="form-control">
        </div>
        <div class="col-md-4 d-grid">
          <button type="submit" class="btn btn-gradient btn-lg"><i class="fa-solid fa-upload me-1"></i> Upload & Import</button>
        </div>
      </div>
    </form>

    <div class="alert alert-light border mt-4">
      <strong>Columns:</strong>
      <code>title, description, project_id, subproject_id, status, priority, assigned_to, due_date</code>
      <p class="small text-muted mt-2 mb-0">Use <code>member:ID</code> or <code>team:ID</code> in <code>assigned_to</code>. Dates: <code>YYYY-MM-DD</code>.</p>
    </div>

    <a href="{% static 'samples/sample_tasks_import.csv' %}" download class="btn btn-outline-gradient mt-3 btn-sm">
      <i class="fa-solid fa-download me-1"></i> Download Sample CSV
    </a>
  </div>

  <!-- Import result panel (rendered server-side after POST) -->
  {% if inserted is defined %}
  <div class="card mt-4 soft-card">
    <div class="card-body">
      <h5 class="mb-2">Import Result</h5>
      <p class="mb-2">Inserted: <strong>{{ inserted }}</strong> &nbsp;&nbsp; Errors: <strong>{{ errors|length }}</strong></p>
      {% if errors %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>#</th><th>Row</th><th>Error</th></tr></thead>
          <tbody>
            {% for e in errors %}
            <tr><td>{{ forloop.counter }}</td><td>{{ e.row }}</td><td class="text-danger">{{ e.error }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<style>
.soft-card { border-radius:12px; box-shadow:0 6px 18px rgba(13,38,71,0.04); border:none; }
.btn-gradient { background: linear-gradient(90deg,#0b57a4,#1f86e3,#38bdf8); color:#fff; border-radius:8px; }
.btn-outline-gradient { border:1px solid #38bdf8; color:#0b57a4; border-radius:8px; padding:6px 10px; }
</style>

<script>
document.getElementById('bulkForm')?.addEventListener('submit', async function(ev){
  // Let server handle large imports synchronously for simplicity; but show UI feedback
  const btn = ev.target.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Importing...';
});
</script>
{% endblock %}
