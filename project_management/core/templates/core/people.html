{% extends "core/base.html" %}
{% block content %}
<style>
/* ========== Modern People & Directory UI ========== */
.people-page { 
  max-width: 1400px; 
  margin: 0 auto; 
  padding: 2.5rem 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #e8f0fe 100%);
  min-height: 100vh;
}

.page-hero { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  gap: 1.5rem; 
  margin-bottom: 2rem;
  padding: 2rem 2.5rem;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 2px solid rgba(59, 130, 246, 0.1);
  position: relative;
  overflow: hidden;
}

.page-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
}

.page-title { 
  font-size: 2rem; 
  font-weight: 800; 
  margin: 0 0 0.5rem 0;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.page-sub { 
  color: #64748b; 
  font-size: 0.95rem;
  font-weight: 500;
  margin: 0;
  line-height: 1.5;
}

.grid { 
  display: flex; 
  gap: 1.5rem; 
  align-items: flex-start; 
  flex-wrap: wrap; 
}

/* ========== Cards ========== */
.card { 
  background: #ffffff;
  border-radius: 20px; 
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  padding: 2rem;
  border: 2px solid rgba(59, 130, 246, 0.08);
  transition: all 0.3s ease;
}

.form-card { 
  flex: 1 1 420px; 
  min-width: 360px; 
}

.list-card { 
  flex: 2 1 740px; 
  min-width: 400px; 
}

/* ========== Form Elements ========== */
.form-row { 
  display: flex; 
  gap: 1rem; 
  flex-wrap: wrap; 
  align-items: center; 
  margin-bottom: 1.25rem; 
}

.form-row .field { 
  flex: 1 1 200px; 
  min-width: 180px; 
}

.label { 
  font-size: 0.9rem; 
  margin-bottom: 0.5rem; 
  display: block;
  font-weight: 600;
  color: #1e293b;
  letter-spacing: -0.1px;
}

.input, .select { 
  width: 100%; 
  padding: 0.875rem 1rem; 
  border: 2px solid #e2e8f0; 
  border-radius: 10px; 
  font-size: 0.95rem; 
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #1e293b;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
}

.input:focus, .select:focus { 
  border-color: #3b82f6;
  outline: none;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15), 0 2px 8px rgba(0, 0, 0, 0.05);
  background: #ffffff;
  transform: translateY(-2px);
}

.checkbox-inline { 
  display: inline-flex; 
  align-items: center; 
  gap: 0.5rem; 
  font-size: 0.95rem; 
  color: #1e293b;
  font-weight: 500;
}

.checkbox-inline input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #3b82f6;
}

/* ========== Buttons ========== */
.btn { 
  padding: 0.75rem 1.5rem; 
  border-radius: 10px; 
  border: none; 
  cursor: pointer; 
  font-weight: 700;
  font-size: 0.95rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  letter-spacing: 0.2px;
}

.btn.primary { 
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn.primary:hover { 
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn.ghost { 
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 2px solid #e2e8f0; 
  color: #475569;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.btn.ghost:hover { 
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

.btn.small { 
  padding: 0.5rem 1rem; 
  font-size: 0.85rem;
}

/* ========== Table ========== */
.table { 
  width: 100%; 
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem; 
}

.table th, .table td { 
  padding: 1rem 1.25rem; 
  text-align: left; 
  border-bottom: 2px solid #f1f5f9; 
  vertical-align: middle; 
}

.table th { 
  color: #64748b; 
  font-weight: 700; 
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e2e8f0;
}

.table th:first-child {
  border-radius: 10px 0 0 0;
}

.table th:last-child {
  border-radius: 0 10px 0 0;
}

.table tbody tr {
  transition: all 0.3s ease;
}

.table tbody tr:hover {
  background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
}

.table tbody tr:last-child td {
  border-bottom: none;
}

/* ========== Avatar ========== */
.avatar { 
  width: 44px; 
  height: 44px; 
  border-radius: 50%; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  font-weight: 700; 
  color: #ffffff; 
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  font-size: 1.05rem;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  border: 3px solid #ffffff;
}

/* ========== Pagination ========== */
.pager { 
  display: flex; 
  gap: 0.5rem; 
  align-items: center; 
  justify-content: flex-end; 
  margin-top: 1.5rem; 
}

.page-num { 
  padding: 0.5rem 0.875rem; 
  border-radius: 8px; 
  cursor: pointer; 
  border: 2px solid #e2e8f0;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.page-num:hover:not(:disabled) {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
}

.page-num.active { 
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff; 
  border-color: #3b82f6;
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.page-num:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* ========== Search Box ========== */
.search-box { 
  display: flex; 
  gap: 0.75rem; 
  align-items: center; 
  margin-bottom: 1rem; 
  flex-wrap: wrap;
}

.empty { 
  color: #94a3b8; 
  padding: 2.5rem 0; 
  text-align: center;
  font-weight: 500;
  font-size: 1rem;
}

/* ========== Responsive ========== */
@media (max-width:900px) {
  .people-page {
    padding: 1.5rem 1rem;
  }
  
  .page-hero { 
    flex-direction: column; 
    align-items: flex-start; 
    gap: 1rem;
    padding: 1.5rem;
  }
  
  .page-title {
    font-size: 1.5rem;
  }
  
  .pager { 
    justify-content: flex-start; 
  }
  
  .grid {
    flex-direction: column;
  }
  
  .form-card, .list-card {
    flex: 1 1 100%;
    min-width: 100%;
  }
  
  .card {
    padding: 1.5rem;
  }
  
  .search-box {
    width: 100%;
  }
  
  .search-box .input,
  .search-box .select {
    flex: 1 1 100%;
  }
}

/* Sidebar and menu color fix for People page */
/* .sidebar, .sidebar .menu-root, .sidebar .menu-item.open, .sidebar .submenu {
  ##background: #0b2341 !important;##
} */
.sidebar .menu-link, .sidebar .submenu-link, .sidebar .menu-link .icon, .sidebar .submenu-link .icon {
  color: #fff !important;
}
.sidebar .menu-link .label, .sidebar .submenu-link .label {
  color: #fff !important;
}
.sidebar .menu-item.active > .menu-link, .sidebar .menu-item.open > .menu-link {
  color: #fff !important;
}
.sidebar .submenu-link:hover {
  background: rgba(255,255,255,0.02) !important;
  color: #fff !important;
}
.sidebar .menu-header, .sidebar .menu-header * {
  background: #0b2341 !important;
  color: #fff !important;
}
</style>

<div class="people-page">
  <div class="page-hero">
    <div>
      <div class="page-title">People &amp; Directory</div>
      <div class="page-sub">Manage your organization's members â€” add, invite, and assign team membership.</div>
    </div>
    <div>
      <button id="btn-open-form" class="btn primary">Add Member</button>
    </div>
  </div>

  <div class="grid">
    <!-- Add / Update Member form (inline by default) -->
    <div class="card form-card" id="add-member-card" aria-hidden="false">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0">Add / Update Member</h4>
        <button id="btn-close-form" class="btn ghost" title="Hide form" style="display:none">Close</button>
      </div>

      <form id="form-member" autocomplete="off">
        <div class="form-row">
          <div class="field">
            <label class="label">Email</label>
            <input class="input" name="email" type="email" placeholder="user@company.com" required />
          </div>
          <div class="field">
            <label class="label">First name</label>
            <input class="input" name="first_name" placeholder="First name" />
          </div>
          <div class="field">
            <label class="label">Last name</label>
            <input class="input" name="last_name" placeholder="Last name" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label class="label">Phone</label>
            <input class="input" name="phone" placeholder="+91 99999 99999" />
          </div>
          <div style="flex:0 0 auto; display:flex; align-items:center;">
            <label class="checkbox-inline"><input type="checkbox" name="create_user" checked /> Create user account</label>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:6px;">
          <button type="submit" class="btn primary">Save Member</button>
          <button type="button" id="btn-reset" class="btn ghost">Reset</button>
        </div>
      </form>
    </div>

    <!-- People list -->
    <div class="card list-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0">People</h4>
        <div class="search-box">
          <input id="people-search" class="input" placeholder="Search by name or email" />
          <select id="page-size" class="select" style="padding:8px 10px; border-radius:6px;">
            <option value="10">10 / page</option>
            <option value="25">25 / page</option>
            <option value="50">50 / page</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto;">
        <table class="table" id="people-table" aria-live="polite">
          <thead>
            <tr><th style="width:64px">Avatar</th><th>Name</th><th>Email</th><th>Phone</th><th style="width:120px">Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
        <div id="list-stats" class="page-sub">0 members</div>
        <div class="pager" id="pager"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* People page JS
   - Loads /api/people/list
   - Renders table with client-side pagination and search
   - Keeps existing POST to /api/people/create for form submission
*/

const API = {
  list: '/api/people/list',
  create: '/api/people/create'
};

let PEOPLE_DATA = [];    // full dataset from server
let FILTERED = [];      // filtered rows after search
let CURRENT_PAGE = 1;
let PAGE_SIZE = 10;

function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : '';
}

const DEFAULT_HEADERS = {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')};

async function apiFetch(path, opts = {}) {
  opts.headers = Object.assign({}, DEFAULT_HEADERS, opts.headers || {});
  return fetch(path, opts).then(res => res.json());
}

async function loadPeople() {
  try {
    const res = await apiFetch(API.list);
    if (!res.ok) {
      console.error('Failed to load people', res);
      PEOPLE_DATA = [];
      renderTable();
      return;
    }
    PEOPLE_DATA = res.members || [];
    // normalize: ensure first_name/last_name keys exist
    PEOPLE_DATA = PEOPLE_DATA.map(r => ({
      id: r.id,
      email: r.email || '',
      first_name: r.first_name || '',
      last_name: r.last_name || '',
      phone: r.phone || ''
    }));
    applyFilterAndRender();
  } catch (err) {
    console.error('loadPeople error', err);
    PEOPLE_DATA = [];
    renderTable();
  }
}

function applyFilterAndRender() {
  const q = document.getElementById('people-search').value.trim().toLowerCase();
  if (q) {
    FILTERED = PEOPLE_DATA.filter(p =>
      (p.email || '').toLowerCase().includes(q) ||
      ((p.first_name || '') + ' ' + (p.last_name || '')).toLowerCase().includes(q)
    );
  } else {
    FILTERED = PEOPLE_DATA.slice();
  }
  PAGE_SIZE = parseInt(document.getElementById('page-size').value, 10) || 10;
  CURRENT_PAGE = 1;
  renderTable();
}

function renderTable() {
  const tbody = document.querySelector('#people-table tbody');
  tbody.innerHTML = '';
  const total = FILTERED.length;
  document.getElementById('list-stats').textContent = `${total} member${total !== 1 ? 's' : ''}`;

  if (total === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="empty">No members found. Add a member using the form.</td></tr>`;
    document.getElementById('pager').innerHTML = '';
    return;
  }

  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const page = Math.min(Math.max(1, CURRENT_PAGE), pages);
  const start = (page - 1) * PAGE_SIZE;
  const chunk = FILTERED.slice(start, start + PAGE_SIZE);

  for (const p of chunk) {
    const name = `${p.first_name || ''} ${p.last_name || ''}`.trim() || '-';
    const avatarChar = (p.first_name || p.email || '?').charAt(0).toUpperCase();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="avatar">${avatarChar}</div></td>
      <td><div style="font-weight:600">${name}</div></td>
      <td>${p.email}</td>
      <td>${p.phone || ''}</td>
      <td>
        <button class="btn small ghost" data-email="${p.email}" onclick="onEdit('${p.email}')">Edit</button>
      </td>`;
    tbody.appendChild(tr);
  }

  renderPager(pages, page);
}

function renderPager(totalPages, current) {
  const pager = document.getElementById('pager');
  pager.innerHTML = '';
  // prev
  const prev = document.createElement('button');
  prev.className = 'page-num';
  prev.textContent = 'Prev';
  prev.disabled = current <= 1;
  prev.onclick = () => changePage(current - 1);
  pager.appendChild(prev);

  // show a few page numbers
  const windowSize = 5;
  let start = Math.max(1, current - Math.floor(windowSize/2));
  let end = Math.min(totalPages, start + windowSize - 1);
  if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);

  for (let i = start; i <= end; i++) {
    const b = document.createElement('button');
    b.className = 'page-num' + (i === current ? ' active' : '');
    b.textContent = i;
    b.onclick = () => changePage(i);
    pager.appendChild(b);
  }

  // next
  const next = document.createElement('button');
  next.className = 'page-num';
  next.textContent = 'Next';
  next.disabled = current >= totalPages;
  next.onclick = () => changePage(current + 1);
  pager.appendChild(next);
}

function changePage(p) {
  CURRENT_PAGE = p;
  renderTable();
}

function onEdit(email) {
  // simple behavior: populate form with email and show it
  const member = PEOPLE_DATA.find(x => x.email === email);
  if (member) {
    const form = document.getElementById('form-member');
    form.email.value = member.email || '';
    form.first_name.value = member.first_name || '';
    form.last_name.value = member.last_name || '';
    form.phone.value = member.phone || '';
    // ensure form visible
    showForm();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

/* Form handlers */
document.getElementById('form-member').addEventListener('submit', async function (ev) {
  ev.preventDefault();
  const f = ev.target;
  const payload = {
    email: f.email.value.trim(),
    first_name: f.first_name.value.trim(),
    last_name: f.last_name.value.trim(),
    phone: f.phone.value.trim(),
    create_user: !!f.create_user.checked
  };
  try {
    const r = await apiFetch(API.create, { method: 'POST', body: JSON.stringify(payload) });
    if (r && r.ok) {
      // success
      showToast('Member saved');
      // clear form or keep values (we keep)
      await loadPeople();
      // if backend returned a temporary password, show it (only for dev/testing)
      if (r.password) {
        alert('Temporary password for new user: ' + r.password + '\nPlease share securely.');
      }
    } else {
      console.error('Save failed', r);
      showToast('Save failed: ' + (r && r.error ? r.error : 'unknown'));
    }
  } catch (err) {
    console.error('Save error', err);
    showToast('Server error while saving member');
  }
});

document.getElementById('btn-reset').addEventListener('click', function () {
  document.getElementById('form-member').reset();
});

document.getElementById('people-search').addEventListener('input', () => {
  applyFilterAndRender();
});

document.getElementById('page-size').addEventListener('change', () => {
  applyFilterAndRender();
});

/* Show / hide form */
function showForm() {
  document.getElementById('add-member-card').style.display = 'block';
  const closeBtn = document.getElementById('btn-close-form');
  closeBtn.style.display = 'inline-block';
}
function hideForm() {
  document.getElementById('add-member-card').style.display = 'none';
  document.getElementById('btn-close-form').style.display = 'none';
}

document.getElementById('btn-open-form').addEventListener('click', () => {
  showForm();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
document.getElementById('btn-close-form').addEventListener('click', () => {
  hideForm();
});

/* Simple toast (non-blocking) */
function showToast(msg) {
  const d = document.createElement('div');
  d.textContent = msg;
  d.style.position = 'fixed';
  d.style.right = '18px';
  d.style.bottom = '18px';
  d.style.background = '#111827';
  d.style.color = '#fff';
  d.style.padding = '10px 14px';
  d.style.borderRadius = '8px';
  d.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
  document.body.appendChild(d);
  setTimeout(() => d.remove(), 2600);
}

/* Init */
document.addEventListener('DOMContentLoaded', () => {
  // keep form visible initially (we want Add member first)
  showForm();
  loadPeople();
});
</script>
{% endblock %}
