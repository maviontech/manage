{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="page-title mb-0"><i class="fa-solid fa-user-clock me-2 text-primary"></i> Unassigned Tasks</h2>
      <p class="text-muted small mb-0">Assign tasks quickly to individual members or teams. Use search and filters to narrow results.</p>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <a href="{% url 'create_task' %}" class="btn btn-gradient btn-lg"><i class="fa-solid fa-plus me-1"></i> New Task</a>
      <a href="{% url 'task_board' %}" class="btn btn-outline-gradient btn-lg"><i class="fa-solid fa-table-columns me-1"></i> Task Board</a>
    </div>
  </div>

  <!-- Search / Controls row -->
  <!-- NOTE: increased margin-top for breathing room after header -->
  <div class="card mb-3 border-0 shadow-sm search-card" style="margin-top:18px;">
    <div class="card-body py-3 d-flex flex-wrap align-items-center gap-3 search-card-body">
      <div class="position-relative flex-fill search-input-wrap" style="min-width:260px;">
        <input id="unassignedSearch" class="form-control search-input" placeholder="Search by ID (#4 or 4) or text in title/description...">
      </div>

      <div style="min-width:140px;">
        <select id="unassignedPriority" class="form-select">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
      </div>

      <div class="d-flex gap-2 align-items-center ms-auto search-controls-right">
        <button id="refreshUnassigned" class="btn btn-outline-gradient">Refresh</button>
        <label class="form-check form-check-inline mb-0 ms-2">
          <input type="checkbox" id="selectAllPage" class="form-check-input">
          <span class="form-check-label small">Select all on page</span>
        </label>
        <button id="assignSelectedBtn" class="btn btn-sm btn-gradient ms-2"><i class="fa-solid fa-user-check me-1"></i> Assign Selected</button>
      </div>
    </div>
  </div>

  <!-- Count / pagination top -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="small text-muted" id="unassignedCount">{% if tasks %}Showing {{ tasks|length }} tasks{% else %}No unassigned tasks{% endif %}</div>
    <nav aria-label="Page navigation">
      <ul class="pagination mb-0" id="topPagination"></ul>
    </nav>
  </div>

  <!-- Compact task table (one-line rows) -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="task-table-header d-none d-md-flex px-3 py-2">
        <div class="col id-col">#</div>
        <div class="col title-col">Title</div>
        <div class="col project-col">Project / Subproject</div>
        <div class="col priority-col">Priority</div>
        <div class="col due-col">Due</div>
        <div class="col action-col text-end">Action</div>
      </div>

      <div id="unassignedList" class="task-table p-3">
        {% comment %} rows will be present server-side too for SEO / noscript - JS will paginate/filter {% endcomment %}
        {% for t in tasks %}
        <div class="task-row d-flex align-items-center mb-2" data-task-id="{{ t.id }}" data-title="{{ t.title|escapejs }}" data-desc="{{ t.description|default:''|escapejs }}" data-priority="{{ t.priority|default:'Normal' }}">
          <div class="col id-col d-flex align-items-center">
            <input type="checkbox" class="task-select form-check-input me-2" data-task="{{ t.id }}">
            <span class="small text-muted">#{{ t.id }}</span>
          </div>

          <div class="col title-col">
            <div class="fw-semibold">{{ t.title }}</div>
            {% if t.description %}
              <div class="small text-muted text-truncate" style="max-width:420px;">{{ t.description|truncatechars:100 }}</div>
            {% endif %}
          </div>

          <div class="col project-col">
            <div class="small text-muted">
              {% if t.project_name %}{{ t.project_name }}{% else %}<em>No project</em>{% endif %}
              {% if t.subproject_name %} &nbsp;•&nbsp; {{ t.subproject_name }}{% endif %}
            </div>
          </div>

          <div class="col priority-col">
            {% if t.priority == "Critical" %}
              <span class="badge priority critical">Critical</span>
            {% elif t.priority == "High" %}
              <span class="badge priority high">High</span>
            {% elif t.priority == "Low" %}
              <span class="badge priority low">Low</span>
            {% else %}
              <span class="badge priority normal">Normal</span>
            {% endif %}
          </div>

          <div class="col due-col">
            <div class="small text-muted">{{ t.due_date|default:"—" }}</div>
          </div>

          <div class="col action-col text-end">
            <button class="btn btn-sm btn-outline-gradient assign-row-btn" data-task="{{ t.id }}"><i class="fa-solid fa-user-plus me-1"></i> Assign</button>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
        <div class="small text-muted" id="bottomCount"></div>
        <nav aria-label="Page navigation">
          <ul class="pagination mb-0" id="bottomPagination"></ul>
        </nav>
      </div>
    </div>
  </div>

</div>

<!-- ===== Assign Modal (polished, centered, left/right margin) ===== -->
<div id="assignModal" class="modal-frost" aria-hidden="true" hidden>
  <div class="modal-backdrop-frost"></div>

  <div class="modal-dialog-frost" role="dialog" aria-modal="true" aria-labelledby="assignModalTitle">
    <div class="modal-content-frost">
      <button class="modal-close-circle" id="assignModalClose" aria-label="Close" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="#0b2440"/></svg>
      </button>

      <form id="assignForm" class="p-4" novalidate>
        {% csrf_token %}
        <input type="hidden" id="assign_task_id" name="task_id" value="">
        <input type="hidden" id="assign_multiple" name="assign_multiple" value="">

        <div class="modal-header-centered mb-2">
          <h3 id="assignModalTitle" class="fw-bold mb-1 text-center">Assign Task(s)</h3>
          <p class="small text-muted text-center mb-0">Choose a member or team to assign the selected task(s).</p>
        </div>

        <div style="max-width:760px; margin:0 auto;">
          <label class="form-label">Assign to</label>
          <select id="assignAssignee" name="assigned_to" class="form-select mb-3">
            <option value="">-- choose member or team --</option>
            {% if members %}
              <optgroup label="Members">
                {% for m in members %}
                  <option value="member:{{ m.id }}">{{ m.first_name }} {{ m.last_name }}</option>
                {% endfor %}
              </optgroup>
            {% endif %}
            {% if teams %}
              <optgroup label="Teams">
                {% for tm in teams %}
                  <option value="team:{{ tm.id }}">{{ tm.name }}</option>
                {% endfor %}
              </optgroup>
            {% endif %}
          </select>
        </div>

        <div class="modal-footer-centered mt-2">
          <div class="footer-inner" style="max-width:760px;">
            <div class="footer-btns">
              <button type="button" class="btn btn-cancel me-2" id="assignModalCancel">Cancel</button>
              <button type="submit" class="btn btn-gradient" id="assignModalSubmit"><i class="fa-solid fa-check me-1"></i> Assign</button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ===== Styles ===== -->
<style>
/* Reuse Task Board look tokens */
.page-title { font-size:1.4rem; color:#103a63; font-weight:700; }
.search-input { border-radius:8px; border:1px solid #e6eef6; height:44px; }

/* --- Header row: horizontal aligned columns (matches row widths) --- */
.task-table-header {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: linear-gradient(90deg,#f7fbff,#fff);
  border-bottom: 1px solid rgba(11,87,164,0.03);
  color: #45647a;
  font-weight: 700;
  margin-bottom: 8px;
}
.task-table-header .col {
  display: flex;
  align-items: center;
  padding: 6px 12px;
}
.task-table-header .id-col { flex: 0 0 120px; }
.task-table-header .title-col { flex: 1 1 45%; min-width:220px; }
.task-table-header .project-col { flex: 1 1 28%; min-width:180px; }
.task-table-header .priority-col { flex: 0 0 110px; }
.task-table-header .due-col { flex: 0 0 120px; }
.task-table-header .action-col { flex: 0 0 150px; text-align: right; }

/* rows */
.task-table { padding:12px; }
.task-row { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid rgba(11,87,164,0.04); }
.task-row + .task-row { margin-top:10px; }
.task-row:hover { transform:translateY(-3px); box-shadow:0 14px 34px rgba(10,30,60,0.05); }

/* columns sizing */
.col { flex: 1 1 0; }
.id-col { flex:0 0 120px; display:flex; align-items:center; gap:8px; }
.title-col { flex:1 1 40%; min-width:220px; }
.project-col { flex:1 1 28%; min-width:180px; color:#395d7a; }
.priority-col { flex:0 0 110px; }
.due-col { flex:0 0 120px; }
.action-col { flex:0 0 150px; }

/* priority badges */
.badge.priority { display:inline-block; padding:6px 10px; border-radius:8px; font-weight:700; }
.badge.priority.critical { background: linear-gradient(90deg,#ffd6d6,#ffb6b6); color:#7a0710; }
.badge.priority.high { background: linear-gradient(90deg,#fff1d6,#ffe4b6); color:#7a4b07; }
.badge.priority.normal { background: linear-gradient(90deg,#dff6ff,#bfeffd); color:#0b57a4; }
.badge.priority.low { background: linear-gradient(90deg,#f3f7fb,#eef5fb); color:#2b5d7a; border:1px solid rgba(11,87,164,0.02); }

/* buttons */
.btn-gradient { background:linear-gradient(90deg,#0b57a4,#1f86e3,#38bdf8); color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:600; }
.btn-outline-gradient { background:#fff; color:#0b57a4; border:1px solid #38bdf8; border-radius:10px; padding:6px 10px; font-weight:600; }
.btn-cancel { display:inline-flex; align-items:center; justify-content:center; padding:8px 14px; border-radius:8px; background:#fff; color:#0b57a4; border:1px solid rgba(11,87,164,0.12); font-weight:600; }

/* search card form controls polish */
.search-card .form-control, .search-card .form-select {
  height:44px;
  border-radius:8px;
  border:1px solid #e6eef6;
}
.search-card .btn-outline-gradient {
  height:40px;
  padding:6px 12px;
}
.search-card .form-check { margin-left:8px; }

/* Ensure search + filter + refresh stay on same row on medium+ screens */
/* Ensure search + filter + refresh stay on same row and evenly spaced */
.search-card-body {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 12px;
  justify-content: flex-start;
}

.search-input-wrap {
  flex: 1 1 auto;
  min-width: 260px;
  max-width: 420px;
}

.search-card-body select,
.search-card-body button {
  flex-shrink: 0;
}

.search-controls-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

@media (max-width: 768px) {
  .search-card-body {
    flex-wrap: wrap;
  }
  .search-controls-right {
    width: 100%;
    justify-content: flex-start;
    margin-top: 8px;
  }
}


/* pagination styling */
.pagination {
  display: flex;
  list-style: none;
  padding: 0;
  gap: 6px;
}
.pagination .page-item { display: inline-block; }
.pagination .page-link {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 8px;
  background: #fff;
  color: #0b57a4;
  border: 1px solid rgba(11,87,164,0.08);
  text-decoration: none;
  font-weight:600;
}
.pagination .page-item.active .page-link {
  background: linear-gradient(90deg,#0b57a4,#1f86e3);
  color: #fff;
  border: none;
}
.pagination .page-item.disabled .page-link {
  opacity: 0.55;
  pointer-events: none;
}

/* Modal styles - soft frost */
.modal-frost { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:2400; }
.modal-frost[hidden] { display:none; }
.modal-backdrop-frost { position:absolute; inset:0; background: rgba(6,18,34,0.30); backdrop-filter: blur(6px) saturate(1.05); -webkit-backdrop-filter: blur(6px); }
.modal-dialog-frost { position:relative; z-index:2; width:100%; max-width:820px; margin:24px; padding:0 12px; }
.modal-content-frost { position:relative; border-radius:12px; overflow:hidden; background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(247,251,255,0.96)); box-shadow: 0 30px 70px rgba(12,22,38,0.18); border:1px solid rgba(11,87,164,0.04); padding:18px 18px 12px 18px; }
.modal-close-circle { position:absolute; top:12px; right:12px; width:40px; height:40px; border-radius:50%; background:linear-gradient(180deg,#ffffff,#f4fbff); border:1px solid rgba(11,87,164,0.06); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }

/* header center */
.modal-header-centered { text-align:center; padding-top:6px; padding-bottom:6px; }

/* footer center */
.modal-footer-centered { display:flex; justify-content:center; padding: 12px 10px 8px 10px; background:transparent; }
.footer-inner { width:100%; display:flex; justify-content:center; }
.footer-btns { display:flex; gap:10px; align-items:center; }

/* responsive tweaks */
@media (max-width: 900px) {
  .task-table-header { display:none; }
  .task-row { flex-wrap:wrap; gap:8px; }
  .id-col, .title-col, .project-col, .priority-col, .due-col, .action-col {
    flex: 1 1 100%; min-width:100%;
  }
  .action-col { text-align:right; }
  .modal-dialog-frost { padding:0 8px; max-width:96%; }
}
</style>

<!-- ===== JS: search, pagination, modal & assign logic ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // URLs from template - guard if url name missing
  const API_TASK_UPDATE = "{% url 'api_task_update' %}";
  const API_PEOPLE = "{% url 'api_people_list' %}";
  const API_TEAMS = "{% url 'api_teams_list' %}";
  const CSRF = "{{ csrf_token }}";

  const ITEMS_PER_PAGE = 10;

  // Safe selector helpers
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  // Collect rows (server rendered). Each row must have data-task-id attribute.
  let ALL_TASK_ROWS = $$('.task-row').map(el => {
    return {
      id: el.getAttribute('data-task-id'),
      title: el.getAttribute('data-title') || (el.querySelector('.fw-semibold')?.textContent || ''),
      desc: el.getAttribute('data-desc') || '',
      priority: el.getAttribute('data-priority') || 'Normal',
      project: (el.querySelector('.project-col')?.textContent || '').trim(),
      due: (el.querySelector('.due-col')?.textContent || '').trim(),
      el: el
    };
  });

  if (!ALL_TASK_ROWS) ALL_TASK_ROWS = [];

  let filtered = [...ALL_TASK_ROWS];
  let currentPage = 1;

  const unassignedList = $('#unassignedList');
  const unassignedSearch = $('#unassignedSearch');
  const unassignedPriority = $('#unassignedPriority');
  const refreshUnassigned = $('#refreshUnassigned');
  const selectAllPage = $('#selectAllPage');
  const assignSelectedBtn = $('#assignSelectedBtn');
  const unassignedCount = $('#unassignedCount');
  const bottomCount = $('#bottomCount');
  const topPagination = $('#topPagination');
  const bottomPagination = $('#bottomPagination');

  const assignModal = $('#assignModal');
  const assignBackdrop = assignModal ? assignModal.querySelector('.modal-backdrop-frost') : null;
  const assignForm = $('#assignForm');
  const assignTaskIdEl = $('#assign_task_id');
  const assignMultipleEl = $('#assign_multiple');
  const assignAssigneeSel = $('#assignAssignee');
  const assignModalCloseBtn = $('#assignModalClose');
  const assignModalCancelBtns = $$('.modal-cancel');

  if (!unassignedList || !unassignedSearch) {
    console.warn('unassigned_tasks: core DOM elements missing (list/search). Aborting JS bootstrap.');
    return;
  }

  function renderPagination() {
    const totalPages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
    const renderPageList = (container) => {
      if (!container) return;
      container.innerHTML = '';
      const makeBtn = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (active ? ' active' : '') + (disabled ? ' disabled' : '');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.addEventListener('click', (e) => { e.preventDefault(); if (!disabled) renderPage(page); });
        li.appendChild(a);
        return li;
      };
      container.appendChild(makeBtn('Prev', Math.max(1, currentPage-1), currentPage<=1));
      const start = Math.max(1, currentPage-2);
      const end = Math.min(totalPages, currentPage+2);
      for (let p=start; p<=end; p++) container.appendChild(makeBtn(String(p), p, false, p===currentPage));
      container.appendChild(makeBtn('Next', Math.min(totalPages, currentPage+1), currentPage>=totalPages));
    };
    renderPageList(topPagination);
    renderPageList(bottomPagination);
  }

  function renderPage(page=1) {
    currentPage = page;
    const start = (page-1) * ITEMS_PER_PAGE;
    const pageItems = filtered.slice(start, start + ITEMS_PER_PAGE);
    unassignedList.innerHTML = '';
    if (!pageItems.length) {
      unassignedList.innerHTML = '<div class="py-4 text-center text-muted">No tasks found.</div>';
    } else {
      for (const t of pageItems) unassignedList.appendChild(t.el);
    }
    if (unassignedCount) unassignedCount.textContent = `Showing ${Math.min(filtered.length, start+1)}–${Math.min(filtered.length, start+pageItems.length)} of ${filtered.length} tasks`;
    if (bottomCount) bottomCount.textContent = `Page ${page} of ${Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE))}`;
    renderPagination();
  }

  function applyFilter() {
    const qraw = (unassignedSearch?.value || '').trim();
    const q = qraw.toLowerCase();
    const pri = (unassignedPriority?.value || '').trim();
    filtered = ALL_TASK_ROWS.filter(t => {
      let idMatch = false;
      if (q) {
        if (q.startsWith('#')) idMatch = (t.id === q.substring(1));
        else if (/^\d+$/.test(q)) idMatch = (t.id === q);
      } else {
        idMatch = true;
      }
      const textMatch = (t.title + ' ' + t.desc + ' ' + (t.project||'')).toLowerCase().includes(q);
      const matchesTextOrId = (!q) || idMatch || textMatch;
      const matchesPriority = (!pri) || (t.priority === pri);
      return matchesTextOrId && matchesPriority;
    });
    renderPage(1);
  }

  if (unassignedSearch) unassignedSearch.addEventListener('input', applyFilter);
  if (unassignedPriority) unassignedPriority.addEventListener('change', applyFilter);
  if (refreshUnassigned) refreshUnassigned.addEventListener('click', () => location.reload());

  if (selectAllPage) {
    selectAllPage.addEventListener('change', function() {
      const checked = !!this.checked;
      const start = (currentPage-1)*ITEMS_PER_PAGE;
      const pageItems = filtered.slice(start, start+ITEMS_PER_PAGE);
      pageItems.forEach(item => {
        const cb = item.el.querySelector('.task-select');
        if (cb) cb.checked = checked;
      });
    });
  }

  if (assignSelectedBtn) {
    assignSelectedBtn.addEventListener('click', () => {
      const checked = $$('input.task-select:checked').map(cb => cb.dataset.task);
      if (!checked.length) { showToast('Select at least one task to assign.', 'warning'); return; }
      openAssignModal(checked);
    });
  }

  async function ensureAssigneesLoaded() {
    if (!assignAssigneeSel) return;
    if (assignAssigneeSel.options && assignAssigneeSel.options.length > 1) return;
    try {
      const p = await fetch(API_PEOPLE).then(r=>r.ok? r.json(): null).catch(()=>null);
      const arrP = Array.isArray(p) ? p : (p && p.members ? p.members : []);
      if (arrP && arrP.length) {
        const og = document.createElement('optgroup'); og.label = 'Members';
        arrP.forEach(m => { const o = document.createElement('option'); o.value = 'member:' + m.id; o.textContent = (m.first_name||'') + ' ' + (m.last_name||''); og.appendChild(o); });
        assignAssigneeSel.appendChild(og);
      }
      const t = await fetch(API_TEAMS).then(r=>r.ok? r.json(): null).catch(()=>null);
      const arrT = Array.isArray(t) ? t : (t && t.teams ? t.teams : []);
      if (arrT && arrT.length) {
        const ogt = document.createElement('optgroup'); ogt.label = 'Teams';
        arrT.forEach(tm => { const o = document.createElement('option'); o.value = 'team:' + tm.id; o.textContent = tm.name; ogt.appendChild(o); });
        assignAssigneeSel.appendChild(ogt);
      }
    } catch (e) {
      console.warn('Failed to load assignees', e);
    }
  }

  function openAssignModal(taskIds) {
    if (!assignModal) return;
    if (assignModal.parentElement !== document.body) document.body.appendChild(assignModal);
    ensureAssigneesLoaded();
    if (Array.isArray(taskIds)) {
      assignMultipleEl.value = JSON.stringify(taskIds);
      assignTaskIdEl.value = taskIds[0] || '';
    } else {
      assignMultipleEl.value = '';
      assignTaskIdEl.value = taskIds || '';
    }
    if (assignAssigneeSel) assignAssigneeSel.value = '';
    assignModal.removeAttribute('hidden');
    assignModal.setAttribute('aria-hidden','false');
    setTimeout(()=> { if (assignAssigneeSel) assignAssigneeSel.focus(); }, 80);
  }

  function closeAssignModal() {
    if (!assignModal) return;
    assignModal.setAttribute('hidden','');
    assignModal.setAttribute('aria-hidden','true');
    if (assignTaskIdEl) assignTaskIdEl.value = '';
    if (assignMultipleEl) assignMultipleEl.value = '';
  }

  if (assignModalCloseBtn) assignModalCloseBtn.addEventListener('click', closeAssignModal);
  if (assignBackdrop) assignBackdrop.addEventListener('click', closeAssignModal);
  assignModalCancelBtns.forEach(b => b.addEventListener('click', closeAssignModal));
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAssignModal(); });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.assign-row-btn');
    if (!btn) return;
    const tid = btn.dataset.task;
    if (!tid) { console.warn('assign button missing data-task'); return; }
    openAssignModal(tid);
  });

  if (assignForm) {
    assignForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const assignee = assignAssigneeSel?.value || '';
      if (!assignee) { showToast('Please choose a member or team to assign.', 'warning'); return; }
      let taskIds = [];
      if (assignMultipleEl?.value) {
        try { taskIds = JSON.parse(assignMultipleEl.value); } catch(e){ taskIds = []; }
      } else if (assignTaskIdEl?.value) {
        taskIds = [assignTaskIdEl.value];
      }
      if (!taskIds.length) { showToast('No tasks selected', 'warning'); return; }

      const submitBtn = $('#assignModalSubmit');
      if (submitBtn) submitBtn.disabled = true;

      try {
        for (const tid of taskIds) {
          const fd = new FormData();
          fd.append('task_id', tid);
          fd.append('assigned_to', assignee);
          fd.append('csrfmiddlewaretoken', CSRF);
          const r = await fetch(API_TASK_UPDATE, { method: 'POST', body: fd });
          let json = null;
          try { json = await r.json(); } catch(e){ json = null; }
          if (!r.ok || !json || !json.ok) {
            console.warn('assign failed for', tid, json);
            showToast('Assign failed for task #' + tid, 'error');
            continue;
          }
          const idx = ALL_TASK_ROWS.findIndex(x => String(x.id) === String(tid));
          if (idx !== -1) {
            const rowEl = ALL_TASK_ROWS[idx].el;
            rowEl.style.transition = 'opacity .25s, transform .25s';
            rowEl.style.opacity = '0';
            rowEl.style.transform = 'translateY(-10px)';
            setTimeout(()=> { try { rowEl.remove(); } catch(e){} }, 260);
            ALL_TASK_ROWS.splice(idx,1);
          }
        }
        setTimeout(() => {
          filtered = [...ALL_TASK_ROWS];
          applyFilter();
          closeAssignModal();
          showToast('Assigned successfully', 'success');
        }, 320);
      } catch (err) {
        console.error('assign submit error', err);
        showToast('Assign failed, see console', 'error');
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  }

  function showToast(message, level='info') {
    try {
      const id = 'toast-' + Date.now();
      const wrap = document.createElement('div');
      wrap.id = id;
      wrap.className = 'custom-toast ' + level;
      wrap.style.position = 'fixed';
      wrap.style.right = '18px';
      wrap.style.bottom = '18px';
      wrap.style.zIndex = 9999;
      wrap.style.background = level === 'success' ? 'linear-gradient(90deg,#0bb27a,#26d09b)' : (level === 'error' ? 'linear-gradient(90deg,#ff6b6b,#ff8f8f)' : '#1f86e3');
      wrap.style.padding = '10px 14px';
      wrap.style.borderRadius = '8px';
      wrap.style.color = '#fff';
      wrap.style.boxShadow = '0 8px 26px rgba(12,22,38,0.18)';
      wrap.style.fontWeight = 600;
      wrap.textContent = message;
      document.body.appendChild(wrap);
      setTimeout(()=> {
        wrap.style.transition = 'opacity .4s';
        wrap.style.opacity = '0';
        setTimeout(()=> wrap.remove(), 420);
      }, 2600);
    } catch(e) { console.warn('toast failed', e); }
  }

  applyFilter();
});
</script>

{% endblock %}
