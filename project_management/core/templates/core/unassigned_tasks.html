{% extends "core/base.html" %}
{% load static %}

{% block content %}
<style>
/* ========== MODERN UNASSIGNED TASKS UI ========== */
.unassigned-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2.5rem 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #e8f0fe 100%);
  min-height: 100vh;
}
</style>

<div class="unassigned-page">
  <!-- Header -->
  <div class="page-hero-header">
    <div class="hero-content">
      <h2 class="hero-title">ðŸ“‹ Unassigned Tasks</h2>
      <p class="hero-subtitle">Assign tasks quickly to individual members or teams. Use search and filters to narrow results.</p>
    </div>

    <div class="hero-actions">
      <a href="{% url 'create_task' %}" class="btn-hero primary"><i class="fa-solid fa-plus"></i> New Task</a>
      <a href="{% url 'task_board' %}" class="btn-hero secondary"><i class="fa-solid fa-table-columns"></i> Task Board</a>
    </div>
  </div>

  <!-- Search / Controls row -->
  <div class="filters-card">
    <div class="filters-inner">
      <div class="filter-search">
        <input id="unassignedSearch" class="modern-input" placeholder="ðŸ” Search by ID (#4 or 4) or text in title/description...">
      </div>

      <div class="filter-select">
        <select id="unassignedPriority" class="modern-select">
          <option value="">All priorities</option>
          <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
        </select>
      </div>

      <div class="filter-select">
        <select id="unassignedProject" class="modern-select">
          <option value="">All projects</option>
        </select>
      </div>

      <div class="filter-select">
        <select id="unassignedDueDate" class="modern-select">
          <option value="">All due dates</option>
          <option value="overdue">Overdue</option>
          <option value="today">Due Today</option>
          <option value="this-week">Due This Week</option>
          <option value="this-month">Due This Month</option>
          <option value="no-due-date">No Due Date</option>
        </select>
      </div>

      <div class="filter-actions">
        <button id="refreshUnassigned" class="btn-filter secondary">ðŸ”„ Refresh</button>
        <label class="checkbox-modern">
          <input type="checkbox" id="selectAllPage">
          <span>Select all on page</span>
        </label>
        <button id="assignSelectedBtn" class="btn-filter primary"><i class="fa-solid fa-user-check"></i> Assign Selected</button>
      </div>
    </div>
  </div>

  <!-- Count / pagination top -->
  <div class="list-header">
    <div class="list-count" id="unassignedCount">{% if tasks %}Showing {{ tasks|length }} tasks{% else %}No unassigned tasks{% endif %}</div>
    <nav aria-label="Page navigation">
      <ul class="modern-pagination" id="topPagination"></ul>
    </nav>
  </div>

  <!-- Task List -->
  <div class="tasks-card">
    <div class="tasks-content">
      <div class="tasks-table-header">
        <div class="col id-col">#</div>
        <div class="col title-col">Title</div>
        <div class="col project-col">Project / Subproject</div>
        <div class="col priority-col">Priority</div>
        <div class="col due-col">Due</div>
        <div class="col action-col text-end">Action</div>
      </div>

      <div id="unassignedList" class="tasks-list">
        {% comment %} rows will be present server-side too for SEO / noscript - JS will paginate/filter {% endcomment %}
        {% for t in tasks %}
        <div class="task-row d-flex align-items-center mb-2" data-task-id="{{ t.id }}" data-title="{{ t.title|escapejs }}" data-desc="{{ t.description|default:''|escapejs }}" data-priority="{{ t.priority|default:'Normal' }}" data-project-id="{{ t.project_id|default:'' }}" data-project-name="{{ t.project_name|default:'' }}" data-status="{{ t.status|default:'Open' }}" data-due-date="{{ t.due_date|default:'' }}">
          <div class="col id-col d-flex align-items-center">
            <input type="checkbox" class="task-select form-check-input me-2" data-task="{{ t.id }}">
            <span class="small text-muted">#{{ t.id }}</span>
          </div>

          <div class="col title-col">
            <div class="fw-semibold">{{ t.title }}</div>
            {% if t.description %}
              <div class="small text-muted text-truncate" style="max-width:420px;">{{ t.description|truncatechars:100 }}</div>
            {% endif %}
          </div>

          <div class="col project-col">
            <div class="small text-muted">
              {% if t.project_name %}{{ t.project_name }}{% else %}<em>No project</em>{% endif %}
              {% if t.subproject_name %} &nbsp;â€¢&nbsp; {{ t.subproject_name }}{% endif %}
            </div>
          </div>

          <div class="col priority-col">
            {% if t.priority == "Critical" %}
              <span class="badge priority critical">Critical</span>
            {% elif t.priority == "High" %}
              <span class="badge priority high">High</span>
            {% elif t.priority == "Low" %}
              <span class="badge priority low">Low</span>
            {% else %}
              <span class="badge priority normal">Normal</span>
            {% endif %}
          </div>

          <div class="col due-col">
            <div class="small text-muted">{{ t.due_date|default:"â€”" }}</div>
          </div>

          <div class="col action-col text-end">
            <button class="btn btn-sm btn-outline-gradient assign-row-btn" data-task="{{ t.id }}"><i class="fa-solid fa-user-plus me-1"></i> Assign</button>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="tasks-footer">
        <div class="footer-count" id="bottomCount"></div>
        <nav aria-label="Page navigation">
          <ul class="modern-pagination" id="bottomPagination"></ul>
        </nav>
      </div>
    </div>
  </div>

</div>

<!-- ===== Assign Modal (polished, centered, left/right margin) ===== -->
<div id="assignModal" class="modal-frost" aria-hidden="true" hidden>
  <div class="modal-backdrop-frost"></div>

  <div class="modal-dialog-frost" role="dialog" aria-modal="true" aria-labelledby="assignModalTitle">
    <div class="modal-content-frost">
      <button class="modal-close-circle" id="assignModalClose" aria-label="Close" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="#0b2440"/></svg>
      </button>

      <form id="assignForm" class="p-4" novalidate>
        {% csrf_token %}
        <input type="hidden" id="assign_task_id" name="task_id" value="">
        <input type="hidden" id="assign_multiple" name="assign_multiple" value="">

        <div class="modal-header-centered mb-2">
          <h3 id="assignModalTitle" class="fw-bold mb-1 text-center">Assign Task(s)</h3>
          <p class="small text-muted text-center mb-0">Choose a member or team to assign the selected task(s).</p>
        </div>

        <div style="max-width:760px; margin:0 auto;">
          <label class="form-label">Assign to</label>
          <select id="assignAssignee" name="assigned_to" class="form-select mb-3">
            <option value="">-- choose member or team --</option>
            {% if members %}
              <optgroup label="Members">
                {% for m in members %}
                  <option value="member:{{ m.id }}">{{ m.first_name }} {{ m.last_name }}</option>
                {% endfor %}
              </optgroup>
            {% endif %}
            {% if teams %}
              <optgroup label="Teams">
                {% for tm in teams %}
                  <option value="team:{{ tm.id }}">{{ tm.name }}</option>
                {% endfor %}
              </optgroup>
            {% endif %}
          </select>
        </div>

        <div class="modal-footer-centered mt-2">
          <div class="footer-inner" style="max-width:760px;">
            <div class="footer-btns">
              <button type="button" class="btn btn-cancel me-2" id="assignModalCancel">Cancel</button>
              <button type="submit" class="btn btn-gradient" id="assignModalSubmit"><i class="fa-solid fa-check me-1"></i> Assign</button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ===== Styles ===== -->
<style>
/* ========== MODERN PROFESSIONAL UNASSIGNED TASKS UI ========== */

/* Page Hero Header */
.page-hero-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2rem;
  margin-bottom: 2rem;
  padding: 2rem 2.5rem;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 2px solid rgba(59, 130, 246, 0.1);
  position: relative;
  overflow: hidden;
}

.page-hero-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
}

.hero-content .hero-title {
  font-size: 2rem;
  font-weight: 800;
  margin: 0 0 0.5rem 0;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.hero-content .hero-subtitle {
  color: #64748b;
  font-size: 0.95rem;
  font-weight: 500;
  margin: 0;
  line-height: 1.5;
}

.hero-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.btn-hero {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.875rem 1.5rem;
  border-radius: 12px;
  font-weight: 700;
  font-size: 0.95rem;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  letter-spacing: 0.2px;
}

.btn-hero.primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.1);
  border: none;
}

.btn-hero.primary:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  color: #ffffff;
}

.btn-hero.secondary {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  border: 2px solid #e2e8f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.btn-hero.secondary:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

/* Filters Card */
.filters-card {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.03);
  border: 2px solid rgba(59, 130, 246, 0.08);
  padding: 1.5rem 2rem;
  margin-bottom: 1.5rem;
}

.filters-inner {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem;
}

.filter-search {
  flex: 1 1 280px;
  min-width: 280px;
}

.filter-select {
  flex: 0 0 auto;
  min-width: 160px;
}

.filter-actions {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
  flex-wrap: wrap;
}

.modern-input,
.modern-select {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.95rem;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #1e293b;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
}

.modern-input:focus,
.modern-select:focus {
  border-color: #3b82f6;
  outline: none;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15), 0 2px 8px rgba(0, 0, 0, 0.05);
  background: #ffffff;
  transform: translateY(-2px);
}

.btn-filter {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  letter-spacing: 0.2px;
  white-space: nowrap;
}

.btn-filter.primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
}

.btn-filter.primary:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 28px rgba(59, 130, 246, 0.4);
}

.btn-filter.secondary {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 2px solid #e2e8f0;
  color: #475569;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.btn-filter.secondary:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

.checkbox-modern {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: #1e293b;
  font-weight: 500;
  cursor: pointer;
}

.checkbox-modern input[type=\"checkbox\"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #3b82f6;
  border-radius: 4px;
}

/* List Header */
.list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding: 0 0.5rem;
}

.list-count {
  color: #64748b;
  font-size: 0.9rem;
  font-weight: 600;
}

/* Tasks Card */
.tasks-card {
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
  border: 2px solid rgba(59, 130, 246, 0.08);
  overflow: hidden;
}

.tasks-content {
  padding: 0;
}

/* Table Header */
.tasks-table-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom: 2px solid #e2e8f0;
  font-weight: 700;
  font-size: 0.85rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tasks-table-header .col {
  display: flex;
  align-items: center;
}

.tasks-table-header .id-col {
  flex: 0 0 120px;
}

.tasks-table-header .title-col {
  flex: 1 1 40%;
  min-width: 220px;
}

.tasks-table-header .project-col {
  flex: 1 1 28%;
  min-width: 180px;
}

.tasks-table-header .priority-col {
  flex: 0 0 110px;
}

.tasks-table-header .due-col {
  flex: 0 0 120px;
}

.tasks-table-header .action-col {
  flex: 0 0 150px;
  text-align: right;
  justify-content: flex-end;
}

/* Tasks List */
.tasks-list {
  padding: 1rem 1.5rem;
}

/* Task Row */
.task-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  background: linear-gradient(135deg, #ffffff 0%, #fbfdff 100%);
  border: 2px solid #f1f5f9;
  margin-bottom: 0.75rem;
  transition: all 0.3s ease;
}

.task-row:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
  border-color: #3b82f6;
  background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
}

.task-row .col {
  flex: 1 1 0;
}

.task-row .id-col {
  flex: 0 0 120px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.task-row .id-col .form-check-input {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #3b82f6;
  border-radius: 4px;
  border: 2px solid #e2e8f0;
}

.task-row .id-col .text-muted {
  font-weight: 600;
  color: #64748b;
  font-size: 0.9rem;
}

.task-row .title-col {
  flex: 1 1 40%;
  min-width: 220px;
}

.task-row .title-col .fw-semibold {
  font-weight: 700;
  color: #1e293b;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.task-row .title-col .small {
  color: #64748b;
  font-size: 0.85rem;
}

.task-row .project-col {
  flex: 1 1 28%;
  min-width: 180px;
  color: #64748b;
  font-size: 0.9rem;
}

.task-row .priority-col {
  flex: 0 0 110px;
}

.task-row .due-col {
  flex: 0 0 120px;
}

.task-row .due-col .small {
  color: #64748b;
  font-size: 0.9rem;
  font-weight: 500;
}

.task-row .action-col {
  flex: 0 0 150px;
  text-align: right;
}

/* Priority Badges */
.badge.priority {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.8rem;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

.badge.priority.critical {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  color: #991b1b;
  border: 2px solid #fca5a5;
}

.badge.priority.high {
  background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
  color: #9a3412;
  border: 2px solid #fb923c;
}

.badge.priority.normal {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
  border: 2px solid #93c5fd;
}

.badge.priority.low {
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  color: #475569;
  border: 2px solid #cbd5e1;
}

/* Action Button */
.assign-row-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  font-weight: 700;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.assign-row-btn:hover {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border-color: #3b82f6;
  color: #ffffff;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
}

/* Tasks Footer */
.tasks-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-top: 2px solid #e2e8f0;
}

.footer-count {
  color: #64748b;
  font-size: 0.9rem;
  font-weight: 600;
}

/* Modern Pagination */
.modern-pagination {
  display: flex;
  list-style: none;
  padding: 0;
  margin: 0;
  gap: 0.5rem;
}

.modern-pagination .page-item {
  display: inline-block;
}

.modern-pagination .page-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 0.875rem;
  border-radius: 8px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  border: 2px solid #e2e8f0;
  text-decoration: none;
  font-weight: 700;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  cursor: pointer;
  min-width: 40px;
}

.modern-pagination .page-link:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
}

.modern-pagination .page-item.active .page-link {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  border-color: #3b82f6;
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.modern-pagination .page-item.disabled .page-link {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

/* Modal Styles */
.modal-frost {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2400;
}

.modal-frost[hidden] {
  display: none;
}

.modal-backdrop-frost {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(30, 64, 175, 0.15) 0%, rgba(59, 130, 246, 0.25) 100%);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.modal-dialog-frost {
  position: relative;
  z-index: 2;
  width: 100%;
  max-width: 820px;
  margin: 24px;
  padding: 0 12px;
}

.modal-content-frost {
  position: relative;
  border-radius: 20px;
  overflow: hidden;
  background: #ffffff;
  box-shadow: 0 32px 80px rgba(0, 0, 0, 0.15), 0 8px 24px rgba(0, 0, 0, 0.08);
  border: 2px solid rgba(59, 130, 246, 0.1);
  padding: 2rem;
}

.modal-content-frost::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
}

.modal-close-circle {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 2px solid #e2e8f0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.modal-close-circle:hover {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  border-color: #f87171;
  transform: rotate(90deg) scale(1.1);
  box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
}

.modal-header-centered {
  text-align: center;
  padding: 1rem 0 1.5rem 0;
}

.modal-header-centered h3 {
  font-size: 1.5rem;
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 0.5rem;
}

.modal-header-centered p {
  color: #64748b;
  font-size: 0.95rem;
}

.modal-content-frost .form-label {
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.modal-content-frost .form-select {
  padding: 0.875rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.95rem;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #1e293b;
  font-weight: 500;
  transition: all 0.3s ease;
}

.modal-content-frost .form-select:focus {
  border-color: #3b82f6;
  outline: none;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
  background: #ffffff;
}

.modal-footer-centered {
  display: flex;
  justify-content: center;
  padding: 1.5rem 0 0.5rem 0;
  background: transparent;
}

.footer-inner {
  width: 100%;
  display: flex;
  justify-content: center;
}

.footer-btns {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.btn-cancel {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.5rem;
  border-radius: 10px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color: #475569;
  border: 2px solid #e2e8f0;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.btn-cancel:hover {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-color: #3b82f6;
  color: #1e40af;
  transform: translateY(-2px);
}

.btn-gradient {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #ffffff;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
  font-size: 0.95rem;
}

.btn-gradient:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

/* Responsive Design */
@media (max-width: 900px) {
  .unassigned-page {
    padding: 1.5rem 1rem;
  }

  .page-hero-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
  }

  .hero-content .hero-title {
    font-size: 1.5rem;
  }

  .hero-actions {
    width: 100%;
    flex-direction: column;
  }

  .btn-hero {
    width: 100%;
    justify-content: center;
  }

  .filters-inner {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-search,
  .filter-select,
  .filter-actions {
    width: 100%;
    min-width: 100%;
  }

  .filter-actions {
    margin-left: 0;
    flex-direction: column;
  }

  .btn-filter {
    width: 100%;
    justify-content: center;
  }

  .tasks-table-header {
    display: none;
  }

  .task-row {
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .task-row .id-col,
  .task-row .title-col,
  .task-row .project-col,
  .task-row .priority-col,
  .task-row .due-col,
  .task-row .action-col {
    flex: 1 1 100%;
    min-width: 100%;
  }

  .task-row .action-col {
    text-align: left;
  }

  .assign-row-btn {
    width: 100%;
    justify-content: center;
  }

  .modal-dialog-frost {
    padding: 0 8px;
    max-width: 96%;
  }

  .modal-content-frost {
    padding: 1.5rem;
  }

  .list-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .tasks-footer {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
}
</style>

<!-- ===== JS: search, pagination, modal & assign logic ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // URLs from template - guard if url name missing
  const API_TASK_UPDATE = "{% url 'api_task_update' %}";
  const API_PEOPLE = "{% url 'api_people_list' %}";
  const API_TEAMS = "{% url 'api_teams_list' %}";
  const CSRF = "{{ csrf_token }}";

  const ITEMS_PER_PAGE = 10;

  // Safe selector helpers
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  // Collect rows (server rendered). Each row must have data-task-id attribute.
  let ALL_TASK_ROWS = $$('.task-row').map(el => {
    return {
      id: el.getAttribute('data-task-id'),
      title: el.getAttribute('data-title') || (el.querySelector('.fw-semibold')?.textContent || ''),
      desc: el.getAttribute('data-desc') || '',
      priority: el.getAttribute('data-priority') || 'Normal',
      projectId: el.getAttribute('data-project-id') || '',
      projectName: el.getAttribute('data-project-name') || '',
      status: el.getAttribute('data-status') || 'Open',
      dueDate: el.getAttribute('data-due-date') || '',
      project: (el.querySelector('.project-col')?.textContent || '').trim(),
      due: (el.querySelector('.due-col')?.textContent || '').trim(),
      el: el
    };
  });

  if (!ALL_TASK_ROWS) ALL_TASK_ROWS = [];

  let filtered = [...ALL_TASK_ROWS];
  let currentPage = 1;

  const unassignedList = $('#unassignedList');
  const unassignedSearch = $('#unassignedSearch');
  const unassignedPriority = $('#unassignedPriority');
  const unassignedProject = $('#unassignedProject');
  const unassignedDueDate = $('#unassignedDueDate');
  const refreshUnassigned = $('#refreshUnassigned');

  // Populate project filter with unique projects
  function populateProjectFilter() {
    if (!unassignedProject) return;
    const projects = new Map();
    ALL_TASK_ROWS.forEach(t => {
      if (t.projectId && t.projectName) {
        projects.set(t.projectId, t.projectName);
      }
    });
    const sortedProjects = Array.from(projects.entries()).sort((a, b) => a[1].localeCompare(b[1]));
    sortedProjects.forEach(([id, name]) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = name;
      unassignedProject.appendChild(option);
    });
  }
  populateProjectFilter();
  const selectAllPage = $('#selectAllPage');
  const assignSelectedBtn = $('#assignSelectedBtn');
  const unassignedCount = $('#unassignedCount');
  const bottomCount = $('#bottomCount');
  const topPagination = $('#topPagination');
  const bottomPagination = $('#bottomPagination');

  const assignModal = $('#assignModal');
  const assignBackdrop = assignModal ? assignModal.querySelector('.modal-backdrop-frost') : null;
  const assignForm = $('#assignForm');
  const assignTaskIdEl = $('#assign_task_id');
  const assignMultipleEl = $('#assign_multiple');
  const assignAssigneeSel = $('#assignAssignee');
  const assignModalCloseBtn = $('#assignModalClose');
  const assignModalCancelBtns = $$('.modal-cancel');

  if (!unassignedList || !unassignedSearch) {
    console.warn('unassigned_tasks: core DOM elements missing (list/search). Aborting JS bootstrap.');
    return;
  }

  function renderPagination() {
    const totalPages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
    const renderPageList = (container) => {
      if (!container) return;
      container.innerHTML = '';
      const makeBtn = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (active ? ' active' : '') + (disabled ? ' disabled' : '');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.addEventListener('click', (e) => { e.preventDefault(); if (!disabled) renderPage(page); });
        li.appendChild(a);
        return li;
      };
      container.appendChild(makeBtn('Prev', Math.max(1, currentPage-1), currentPage<=1));
      const start = Math.max(1, currentPage-2);
      const end = Math.min(totalPages, currentPage+2);
      for (let p=start; p<=end; p++) container.appendChild(makeBtn(String(p), p, false, p===currentPage));
      container.appendChild(makeBtn('Next', Math.min(totalPages, currentPage+1), currentPage>=totalPages));
    };
    renderPageList(topPagination);
    renderPageList(bottomPagination);
  }

  function renderPage(page=1) {
    currentPage = page;
    const start = (page-1) * ITEMS_PER_PAGE;
    const pageItems = filtered.slice(start, start + ITEMS_PER_PAGE);
    unassignedList.innerHTML = '';
    if (!pageItems.length) {
      unassignedList.innerHTML = '<div class="py-4 text-center text-muted">No tasks found.</div>';
    } else {
      for (const t of pageItems) unassignedList.appendChild(t.el);
    }
    if (unassignedCount) unassignedCount.textContent = `Showing ${Math.min(filtered.length, start+1)}â€“${Math.min(filtered.length, start+pageItems.length)} of ${filtered.length} tasks`;
    if (bottomCount) bottomCount.textContent = `Page ${page} of ${Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE))}`;
    renderPagination();
  }

  function applyFilter() {
    const qraw = (unassignedSearch?.value || '').trim();
    const q = qraw.toLowerCase();
    const pri = (unassignedPriority?.value || '').trim();
    const proj = (unassignedProject?.value || '').trim();
    const dueDateFilter = (unassignedDueDate?.value || '').trim();
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    filtered = ALL_TASK_ROWS.filter(t => {
      // Text/ID search
      let idMatch = false;
      if (q) {
        if (q.startsWith('#')) idMatch = (t.id === q.substring(1));
        else if (/^\d+$/.test(q)) idMatch = (t.id === q);
      } else {
        idMatch = true;
      }
      const textMatch = (t.title + ' ' + t.desc + ' ' + (t.project||'')).toLowerCase().includes(q);
      const matchesTextOrId = (!q) || idMatch || textMatch;
      
      // Priority filter
      const matchesPriority = (!pri) || (t.priority === pri);
      
      // Project filter
      const matchesProject = (!proj) || (t.projectId === proj);
      
      // Due date filter
      let matchesDueDate = true;
      if (dueDateFilter) {
        if (dueDateFilter === 'no-due-date') {
          matchesDueDate = !t.dueDate;
        } else if (dueDateFilter === 'overdue') {
          if (t.dueDate) {
            const dueDate = new Date(t.dueDate);
            matchesDueDate = dueDate < today;
          } else {
            matchesDueDate = false;
          }
        } else if (dueDateFilter === 'today') {
          if (t.dueDate) {
            const dueDate = new Date(t.dueDate);
            matchesDueDate = dueDate.toDateString() === today.toDateString();
          } else {
            matchesDueDate = false;
          }
        } else if (dueDateFilter === 'this-week') {
          if (t.dueDate) {
            const dueDate = new Date(t.dueDate);
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            matchesDueDate = dueDate >= today && dueDate <= weekFromNow;
          } else {
            matchesDueDate = false;
          }
        } else if (dueDateFilter === 'this-month') {
          if (t.dueDate) {
            const dueDate = new Date(t.dueDate);
            matchesDueDate = dueDate.getMonth() === today.getMonth() && dueDate.getFullYear() === today.getFullYear();
          } else {
            matchesDueDate = false;
          }
        }
      }
      
      return matchesTextOrId && matchesPriority && matchesProject && matchesDueDate;
    });
    renderPage(1);
  }

  if (unassignedSearch) unassignedSearch.addEventListener('input', applyFilter);
  if (unassignedPriority) unassignedPriority.addEventListener('change', applyFilter);
  if (unassignedProject) unassignedProject.addEventListener('change', applyFilter);
  if (unassignedDueDate) unassignedDueDate.addEventListener('change', applyFilter);
  if (refreshUnassigned) refreshUnassigned.addEventListener('click', () => location.reload());

  if (selectAllPage) {
    selectAllPage.addEventListener('change', function() {
      const checked = !!this.checked;
      const start = (currentPage-1)*ITEMS_PER_PAGE;
      const pageItems = filtered.slice(start, start+ITEMS_PER_PAGE);
      pageItems.forEach(item => {
        const cb = item.el.querySelector('.task-select');
        if (cb) cb.checked = checked;
      });
    });
  }

  if (assignSelectedBtn) {
    assignSelectedBtn.addEventListener('click', () => {
      const checked = $$('input.task-select:checked').map(cb => cb.dataset.task);
      if (!checked.length) { showToast('Select at least one task to assign.', 'warning'); return; }
      openAssignModal(checked);
    });
  }

  async function ensureAssigneesLoaded() {
    if (!assignAssigneeSel) return;
    if (assignAssigneeSel.options && assignAssigneeSel.options.length > 1) return;
    try {
      const p = await fetch(API_PEOPLE).then(r=>r.ok? r.json(): null).catch(()=>null);
      const arrP = Array.isArray(p) ? p : (p && p.members ? p.members : []);
      if (arrP && arrP.length) {
        const og = document.createElement('optgroup'); og.label = 'Members';
        arrP.forEach(m => { const o = document.createElement('option'); o.value = 'member:' + m.id; o.textContent = (m.first_name||'') + ' ' + (m.last_name||''); og.appendChild(o); });
        assignAssigneeSel.appendChild(og);
      }
      const t = await fetch(API_TEAMS).then(r=>r.ok? r.json(): null).catch(()=>null);
      const arrT = Array.isArray(t) ? t : (t && t.teams ? t.teams : []);
      if (arrT && arrT.length) {
        const ogt = document.createElement('optgroup'); ogt.label = 'Teams';
        arrT.forEach(tm => { const o = document.createElement('option'); o.value = 'team:' + tm.id; o.textContent = tm.name; ogt.appendChild(o); });
        assignAssigneeSel.appendChild(ogt);
      }
    } catch (e) {
      console.warn('Failed to load assignees', e);
    }
  }

  function openAssignModal(taskIds) {
    if (!assignModal) return;
    if (assignModal.parentElement !== document.body) document.body.appendChild(assignModal);
    ensureAssigneesLoaded();
    if (Array.isArray(taskIds)) {
      assignMultipleEl.value = JSON.stringify(taskIds);
      assignTaskIdEl.value = taskIds[0] || '';
    } else {
      assignMultipleEl.value = '';
      assignTaskIdEl.value = taskIds || '';
    }
    if (assignAssigneeSel) assignAssigneeSel.value = '';
    assignModal.removeAttribute('hidden');
    assignModal.setAttribute('aria-hidden','false');
    setTimeout(()=> { if (assignAssigneeSel) assignAssigneeSel.focus(); }, 80);
  }

  function closeAssignModal() {
    if (!assignModal) return;
    assignModal.setAttribute('hidden','');
    assignModal.setAttribute('aria-hidden','true');
    if (assignTaskIdEl) assignTaskIdEl.value = '';
    if (assignMultipleEl) assignMultipleEl.value = '';
  }

  if (assignModalCloseBtn) assignModalCloseBtn.addEventListener('click', closeAssignModal);
  if (assignBackdrop) assignBackdrop.addEventListener('click', closeAssignModal);
  assignModalCancelBtns.forEach(b => b.addEventListener('click', closeAssignModal));
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAssignModal(); });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.assign-row-btn');
    if (!btn) return;
    const tid = btn.dataset.task;
    if (!tid) { console.warn('assign button missing data-task'); return; }
    openAssignModal(tid);
  });

  if (assignForm) {
    assignForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const assignee = assignAssigneeSel?.value || '';
      if (!assignee) { showToast('Please choose a member or team to assign.', 'warning'); return; }
      let taskIds = [];
      if (assignMultipleEl?.value) {
        try { taskIds = JSON.parse(assignMultipleEl.value); } catch(e){ taskIds = []; }
      } else if (assignTaskIdEl?.value) {
        taskIds = [assignTaskIdEl.value];
      }
      if (!taskIds.length) { showToast('No tasks selected', 'warning'); return; }

      const submitBtn = $('#assignModalSubmit');
      if (submitBtn) submitBtn.disabled = true;

      try {
        for (const tid of taskIds) {
          const fd = new FormData();
          fd.append('task_id', tid);
          fd.append('assigned_to', assignee);
          fd.append('csrfmiddlewaretoken', CSRF);
          const r = await fetch(API_TASK_UPDATE, { method: 'POST', body: fd });
          let json = null;
          try { json = await r.json(); } catch(e){ json = null; }
          if (!r.ok || !json || !json.ok) {
            console.warn('assign failed for', tid, json);
            showToast('Assign failed for task #' + tid, 'error');
            continue;
          }
          const idx = ALL_TASK_ROWS.findIndex(x => String(x.id) === String(tid));
          if (idx !== -1) {
            const rowEl = ALL_TASK_ROWS[idx].el;
            rowEl.style.transition = 'opacity .25s, transform .25s';
            rowEl.style.opacity = '0';
            rowEl.style.transform = 'translateY(-10px)';
            setTimeout(()=> { try { rowEl.remove(); } catch(e){} }, 260);
            ALL_TASK_ROWS.splice(idx,1);
          }
        }
        setTimeout(() => {
          filtered = [...ALL_TASK_ROWS];
          applyFilter();
          closeAssignModal();
          showToast('Assigned successfully', 'success');
        }, 320);
      } catch (err) {
        console.error('assign submit error', err);
        showToast('Assign failed, see console', 'error');
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  }

  function showToast(message, level='info') {
    try {
      const id = 'toast-' + Date.now();
      const wrap = document.createElement('div');
      wrap.id = id;
      wrap.className = 'custom-toast ' + level;
      wrap.style.position = 'fixed';
      wrap.style.right = '18px';
      wrap.style.bottom = '18px';
      wrap.style.zIndex = 9999;
      wrap.style.background = level === 'success' ? 'linear-gradient(90deg,#0bb27a,#26d09b)' : (level === 'error' ? 'linear-gradient(90deg,#ff6b6b,#ff8f8f)' : '#1f86e3');
      wrap.style.padding = '10px 14px';
      wrap.style.borderRadius = '8px';
      wrap.style.color = '#fff';
      wrap.style.boxShadow = '0 8px 26px rgba(12,22,38,0.18)';
      wrap.style.fontWeight = 600;
      wrap.textContent = message;
      document.body.appendChild(wrap);
      setTimeout(()=> {
        wrap.style.transition = 'opacity .4s';
        wrap.style.opacity = '0';
        setTimeout(()=> wrap.remove(), 420);
      }, 2600);
    } catch(e) { console.warn('toast failed', e); }
  }

  applyFilter();
});
</script>

{% endblock %}
