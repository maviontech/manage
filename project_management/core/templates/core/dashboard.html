{% extends "core/base.html" %}
{% load static %}

{% block title %}Dashboard | MavionTech{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/base.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* ============================================
     PROFESSIONAL COLOR PALETTE & VARIABLES
     ============================================ */
  :root {
    --primary-color: #2563eb;
    --primary-hover: #1d4ed8;
    --primary-light: #dbeafe;
    --success-color: #10b981;
    --success-hover: #059669;
    --success-light: #d1fae5;
    --warning-color: #f59e0b;
    --warning-hover: #d97706;
    --info-color: #0ea5e9;
    --info-hover: #0284c7;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --white: #ffffff;
    --border-radius: 12px;
    --border-radius-sm: 8px;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* ============================================
     PROFESSIONAL WELCOME BANNER
     ============================================ */
  .welcome-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--white);
    padding: 2rem 2.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .welcome-banner::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
    animation: floatBubble 8s ease-in-out infinite;
  }

  @keyframes floatBubble {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }

  .welcome-banner h3 {
    margin: 0 0 0.5rem 0;
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .welcome-banner .user-email-info {
    opacity: 0.95;
    font-size: 15px;
    font-weight: 400;
  }

  .welcome-banner .user-email-info strong {
    font-weight: 600;
    background: rgba(255, 255, 255, 0.15);
    padding: 3px 10px;
    border-radius: 6px;
    margin-left: 4px;
  }

  /* ============================================
     TOP ACTIONS
     ============================================ */
  .top-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    position: relative;
    z-index: 1;
  }

  .btn-team {
    background: var(--white);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: var(--primary-color);
    padding: 10px 20px;
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-md);
  }

  .btn-team:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .btn-logout {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    color: var(--white);
    border: 2px solid rgba(255, 255, 255, 0.3);
    padding: 10px 18px;
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-logout:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
  }

  /* ============================================
     PROFESSIONAL METRICS GRID
     ============================================ */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .metric-card {
    border-radius: var(--border-radius);
    padding: 2rem 1.5rem;
    box-shadow: var(--shadow-lg);
    color: var(--white);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .metric-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    transition: all 0.5s ease;
  }

  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  .metric-card:hover::before {
    transform: scale(1.1);
  }

  .metric-card .label {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.95;
    position: relative;
    z-index: 1;
  }

  .metric-card .value {
    font-size: 42px;
    font-weight: 800;
    position: relative;
    z-index: 1;
    line-height: 1;
  }

  /* Professional gradient backgrounds for metrics */
  .metric-card.total-tasks {
    background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  }

  .metric-card.active-projects {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
  }

  .metric-card.tasks-completed {
    background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
  }

  .metric-card.tasks-pending {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  }

  /* ============================================
     PROFESSIONAL CHARTS SECTION
     ============================================ */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 440px;
    gap: 1.5rem;
    margin-top: 2rem;
  }

  @media (max-width: 1100px) {
    .charts-row {
      grid-template-columns: 1fr;
    }
  }

  .chart-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
  }

  .chart-card:hover {
    box-shadow: var(--shadow-md);
  }

  .chart-card h3 {
    margin: 0 0 1rem 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ============================================
     QUICK ACTIONS & CHART SPLIT
     ============================================ */
  .chart-split {
    display: flex;
    gap: 2rem;
    align-items: stretch;
  }

  .chart-split .shortcuts-area,
  .chart-split .donut-pane {
    flex: 1 1 50%;
    min-width: 0;
  }

  .shortcuts-area h3,
  .donut-pane h3 {
    font-size: 16px;
    font-weight: 700;
    color: var(--gray-800);
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Quick Actions Grid */
  .shortcuts {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    align-content: start;
  }

  .shortcut-btn {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    color: var(--white);
    box-shadow: var(--shadow-md);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 700;
    font-size: 14px;
    height: 120px;
    text-align: center;
    overflow: hidden;
    border: none;
  }

  .shortcut-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .shortcut-btn:hover::before {
    opacity: 1;
  }

  .shortcut-btn svg {
    width: 40px;
    height: 40px;
    color: rgba(255, 255, 255, 0.95);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  }

  .shortcut-btn .lbl {
    font-size: 14px;
    opacity: 0.98;
    color: rgba(255, 255, 255, 0.98);
    font-weight: 600;
    letter-spacing: 0.3px;
  }

  /* Professional gradient palette */
  .shortcut-blue {
    background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
  }

  .shortcut-green {
    background: linear-gradient(135deg, #059669 0%, #34d399 100%);
  }

  .shortcut-violet {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
  }

  .shortcut-orange {
    background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
  }

  .shortcut-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  /* Badge styling */
  .shortcut-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    min-width: 26px;
    height: 26px;
    padding: 0 8px;
    border-radius: 13px;
    background: rgba(255, 255, 255, 0.95);
    color: var(--primary-color);
    font-size: 13px;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
  }

  /* ============================================
     DONUT PANE
     ============================================ */
  .donut-pane {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 1rem;
    padding-left: 1rem;
  }

  #progressChart {
    max-width: 100%;
    margin: 0 auto;
    display: block;
    height: 240px !important;
  }

  #priorityChart {
    width: 100%;
    height: 280px !important;
  }

  .donut-legend {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    align-items: center;
    flex-wrap: wrap;
    font-size: 13px;
    color: var(--gray-700);
    justify-content: center;
  }

  .donut-legend .item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
  }

  .dot {
    width: 16px;
    height: 12px;
    border-radius: 4px;
    display: inline-block;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* ============================================
     TEAM MODAL
     ============================================ */
  .team-modal .modal-dialog {
    max-width: 980px;
  }

  .team-modal .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--white);
    border-bottom: none;
    padding: 1.5rem 2rem;
  }

  .team-modal .modal-title {
    font-weight: 700;
    font-size: 22px;
  }

  .team-modal .btn-close {
    filter: brightness(0) invert(1);
  }

  .team-modal .modal-body {
    padding: 2rem;
  }

  .team-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .team-table thead th {
    background: var(--gray-50);
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--gray-200);
  }

  .team-table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--gray-200);
  }

  .team-table tbody tr:hover {
    background: var(--gray-50);
  }

  .team-table tbody td {
    padding: 1rem 1.25rem;
    font-size: 14px;
    color: var(--gray-700);
  }

  .team-chart {
    width: 100%;
    height: 180px;
  }

  /* ============================================
     SEARCH DROPDOWN
     ============================================ */
  .search-dropdown {
    border-radius: var(--border-radius-sm);
    overflow: hidden;
  }

  .search-result-item {
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--gray-100);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item:hover,
  .search-result-item:focus {
    background: var(--gray-50);
    outline: none;
  }

  /* ============================================
     RESPONSIVE DESIGN
     ============================================ */
  @media (max-width: 1000px) {
    .chart-split {
      flex-direction: column;
      gap: 1.5rem;
    }

    .shortcuts {
      grid-template-columns: repeat(2, 1fr);
    }

    .shortcut-btn {
      height: 100px;
    }

    #progressChart {
      max-width: 100%;
      height: 200px !important;
    }

    .dashboard-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .welcome-banner {
      padding: 1.5rem;
    }

    .welcome-banner h3 {
      font-size: 22px;
    }
  }

  @media (max-width: 640px) {
    .shortcuts {
      grid-template-columns: 1fr;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .top-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .btn-team,
    .btn-logout {
      width: 100%;
      text-align: center;
    }
  }
/* ---------------- MODAL CLOSE BUTTON ---------------- */
.chart-card-modern {
  box-shadow: 0 6px 32px 0 rgba(37,99,235,0.07), 0 1.5px 6px 0 rgba(0,0,0,0.04);
  border: 1.5px solid var(--gray-200);
  padding: 2.2rem 2rem 1.7rem 2rem;
  border-radius: 18px;
  background: linear-gradient(120deg, #f8fafc 60%, #e0e7ef 100%);
  margin-bottom: 0;
  min-width: 0;
}
.chart-title-modern {
  font-size: 1.18rem;
  font-weight: 800;
  color: var(--primary-color);
  margin-bottom: 1.1em;
  letter-spacing: 0.2px;
  display: flex;
  align-items: center;
  gap: 0.5em;
}
.chart-canvas-modern {
  width: 100%;
  min-width: 0;
  margin-bottom: 0.7em;
}
.chart-desc-modern {
  margin-top: 8px;
  color: var(--gray-500);
  font-size: 13px;
  font-style: italic;
}
.table-responsive-modern {
  overflow-x: auto;
  width: 100%;
}
.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 6px;
  background: transparent;
}
.modern-table thead th {
  background: var(--gray-100);
  padding: 12px 16px;
  text-align: left;
  font-size: 13px;
  color: var(--gray-700);
  font-weight: 800;
  border-radius: 10px 0 0 10px;
}
.modern-table thead th:last-child {
  border-radius: 0 10px 10px 0;
}
.modern-table tbody tr {
  background: var(--white);
  box-shadow: 0 1.5px 8px rgba(37,99,235,0.04);
  border-radius: 10px;
  transition: box-shadow 0.2s, background 0.2s;
}
.modern-table tbody tr:hover {
  background: var(--primary-light);
  box-shadow: 0 4px 16px rgba(37,99,235,0.10);
}
.modern-td-title {
  padding: 12px 16px;
  font-size: 15px;
  color: var(--gray-800);
  font-weight: 700;
  border-radius: 10px 0 0 10px;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.modern-td-date {
  padding: 12px 16px;
  color: var(--gray-700);
  border-radius: 0 10px 10px 0;
  font-size: 14px;
}
.modern-td-empty {
  padding: 12px 16px;
  color: #888;
  text-align: center;
  font-style: italic;
}
.modern-table td {
  padding: 12px 16px;
  font-size: 14px;
}
  .badge-status {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin: 0;
    line-height: 1.5;
    letter-spacing: 0.1px;
  }
  .badge-completed {
    background: var(--success-light);
    color: var(--success-color);
  }
  .badge-pending {
    background: var(--warning-color);
    color: #fff;
  }
  .badge-inprogress {
    background: var(--primary-light);
    color: var(--primary-color);
  }
  .badge-default {
    background: var(--gray-200);
    color: var(--gray-700);
  }
</style>
{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Overview of your projects and tasks{% endblock %}

{% block content %}
<div class="welcome-banner">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <div style="position:relative;z-index:1;">
      <h3>Welcome, {{ user.first_name|default:user.email }}</h3>
      <div class="user-email-info">Your registered email: <strong>{{ user.email }}</strong></div>
    </div>

    <div class="top-actions">
      {% if is_team_lead %}
        <button id="teamViewBtn" class="btn-team" title="Team view (if you are a team lead)">
          <i class="fas fa-users"></i> Team View
        </button>
      {% endif %}
      <form method="post" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button class="btn-logout" type="submit">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </form>
    </div>
  </div>
</div>

<div class="dashboard-grid">
  <div class="metric-card total-tasks">
    <div class="label">Total Tasks Assigned</div>
    <div class="value">{{ assigned_count|default:0 }}</div>
  </div>
  <div class="metric-card active-projects">
    <div class="label">Active Projects</div>
    <div class="value">{{ active_projects|default:0 }}</div>
  </div>
  <div class="metric-card tasks-completed">
    <div class="label">Tasks Completed</div>
    <div class="value">{{ tasks_completed|default:0 }}</div>
  </div>
  <div class="metric-card tasks-pending">
    <div class="label">Tasks Pending</div>
    <div class="value">{{ tasks_pending|default:0 }}</div>
  </div>
</div>



<div class="charts-row">
  <!-- Combined Quick Actions + Task Breakdown -->
  <div class="chart-card">
    <div class="chart-split" style="margin-top:6px;">

      <!-- Left: Quick Actions -->
      <div class="shortcuts-area">
        <h3>Quick Actions:</h3>
        <div class="shortcuts" aria-hidden="false">

          <button class="shortcut-btn shortcut-blue" data-action="{% url 'my_tasks' %}" aria-label="My tasks">
            <span class="shortcut-badge">{{ assigned_count|default:0 }}</span>
            <!-- task list icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 11H7V9h2v2zm0 4H7v-2h2v2zm4-4h-2V9h2v2zM5 5h14v2H5V5zm2 14h10v-8H7v8z" fill="currentColor"/></svg>
            <div class="lbl">My Tasks</div>
          </button>

          <button class="shortcut-btn shortcut-green" data-action="{% url 'create_task' %}" aria-label="Create task">
            <span class="shortcut-badge">{{ my_new_tasks_count|default:0 }}</span>
            <!-- plus icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z" fill="currentColor"/></svg>
            <div class="lbl">Create</div>
          </button>

          <button class="shortcut-btn shortcut-violet" data-action="{% url 'task_board' %}" aria-label="Task board">
            <span class="shortcut-badge">{{ board_open_count|default:0 }}</span>
            <!-- board icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 13h8V3H3v10zm10 8h8V3h-8v18zM3 21h8v-6H3v6z" fill="currentColor"/></svg>
            <div class="lbl">Board</div>
          </button>

          <button class="shortcut-btn shortcut-orange" data-action="{% url 'projects_list' %}" aria-label="All projects">
            <span class="shortcut-badge">{{ active_projects|default:0 }}</span>
            <!-- projects icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 13h8V3H3v10zm10 8h8v-6h-8v6zM3 21h8v-6H3v6z" fill="currentColor" opacity="0.95"/></svg>
            <div class="lbl">Projects</div>
          </button>

        </div>
      </div>

      <!-- Right: Task Breakdown -->
      <div class="donut-pane">
        <h3>Task Breakdown:</h3>
        <canvas id="progressChart"></canvas>
        <div class="donut-legend" style="justify-content:flex-start;">
          <div class="item"><span class="dot" style="background:#16a34a"></span> Completed ({{ progress_completed|default:0 }})</div>
          <div class="item"><span class="dot" style="background:#1f86e3"></span> In Progress ({{ progress_inprogress|default:0 }})</div>
          <div class="item"><span class="dot" style="background:#eab308"></span> Pending ({{ progress_pending|default:0 }})</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Stacked horizontal bar: open vs closed per priority -->
  <div class="chart-card">
    <h3>Tasks by Priority (Open vs Closed)</h3>
    <canvas id="priorityChart"></canvas>
    <div style="margin-top:10px;color:var(--muted);font-size:13px;">
      Bars are stacked: <strong>Open</strong> (not closed) + <strong>Closed</strong>.
    </div>
  </div>
</div>

<!-- Additional Charts Row (moved directly after dashboard-grid) -->
<div class="charts-row">
  <!-- Line Chart Card -->
  <div class="chart-card chart-card-modern">
    <h3 class="chart-title-modern">ðŸ“ˆ Tasks Over Time</h3>
    <div class="chart-canvas-modern">
      <canvas id="lineChart"></canvas>
    </div>
    <div class="chart-desc-modern">Line chart showing tasks created and completed over time.</div>
  </div>
  <!-- Table Card -->
  <div class="chart-card chart-card-modern">
    <h3 class="chart-title-modern">ï¿½ Planned Tasks</h3>
    <div style="font-size:13px;color:var(--gray-700);margin-bottom:8px;">
      Showing planned tasks for: <strong>{{ planned_start|date:'d M Y' }}</strong> â€” <strong>{{ planned_end|date:'d M Y' }}</strong>
      <span style="color:var(--gray-500);font-weight:600;margin-left:8px;">(next {{ planned_limit }} days, max {{ planned_limit }} items)</span>
    </div>
    <div class="table-responsive-modern" style="max-height: 400px; overflow-y: auto;">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Task</th>
            <th>Status</th>
            <th>Due</th>
          </tr>
        </thead>
        <tbody>
          {% for task in planned_tasks %}
          <tr>
            <td class="modern-td-title">{{ task.title }}</td>
            <td>
              {% if task.status == 'Completed' %}
                <span class="badge-status badge-completed">{{ task.status }}</span>
              {% elif task.status == 'Pending' %}
                <span class="badge-status badge-pending">{{ task.status }}</span>
              {% elif task.status == 'In Progress' %}
                <span class="badge-status badge-inprogress">{{ task.status }}</span>
              {% else %}
                <span class="badge-status badge-default">{{ task.status }}</span>
              {% endif %}
            </td>
            <td class="modern-td-date">{{ task.due_date|date:'d M Y' }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="modern-td-empty">No planned tasks in the next 7 days.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# Team modal only rendered for team leads #}
{% if is_team_lead %}
<div class="modal fade team-modal" id="teamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Team Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Summary for team: <strong id="teamNameLabel">â€”</strong></p>

        <div class="table-responsive mb-3">
          <table class="team-table">
            <thead>
              <tr>
                <th>Member</th>
                <th>Assigned</th>
                <th>Completed</th>
                <th>Pending</th>
                <th>Priority (C/H/N/L)</th>
                <th class="text-end">Details</th>
              </tr>
            </thead>
            <tbody id="teamRows">
              <!-- filled by JS when team modal opens -->
            </tbody>
          </table>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="chart-card">
              <h3 class="mb-2">Team Task Breakdown</h3>
              <canvas id="teamProgressChart" class="team-chart"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-card">
              <h3 class="mb-2">Team Priority (Open vs Closed)</h3>
              <canvas id="teamPriorityChart" class="team-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-gradient" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Attach handlers to shortcut buttons
  document.querySelectorAll('.shortcut-btn').forEach(btn => {
    btn.addEventListener('click', function(e){
      const url = this.getAttribute('data-action');
      if (!url) return;
      location.assign(url);
    });
    btn.addEventListener('keydown', function(e){
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });

  // --- DASHBOARD SEARCH BAR ---
  const searchInput = document.getElementById('global-search');
  if (searchInput) {
    // Create dropdown for results
    let dropdown = document.createElement('div');
    dropdown.className = 'search-dropdown';
    dropdown.style.position = 'absolute';
    dropdown.style.background = '#fff';
    dropdown.style.border = '1px solid #e0e0e0';
    dropdown.style.boxShadow = '0 4px 16px rgba(0,0,0,0.08)';
    dropdown.style.zIndex = 1000;
    dropdown.style.minWidth = '320px';
    dropdown.style.display = 'none';
    dropdown.style.maxHeight = '320px';
    dropdown.style.overflowY = 'auto';
    searchInput.parentNode.appendChild(dropdown);

    function showDropdown(items) {
      if (!items.length) {
        dropdown.innerHTML = '<div style="padding:12px;color:#888;">No results found</div>';
      } else {
        dropdown.innerHTML = items.map(item =>
          `<div class="search-result-item" style="padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;" tabindex="0" data-url="${item.url}">
            <span style="font-weight:600;color:#0b57a4;">${item.type}</span>
            <span style="flex:1;">${item.label}</span>
            <span style="color:#888;font-size:12px;">${item.extra||''}</span>
          </div>`
        ).join('');
      }
      dropdown.style.display = 'block';
      const rect = searchInput.getBoundingClientRect();
      dropdown.style.left = '0px';
      dropdown.style.top = (searchInput.offsetHeight + 2) + 'px';
    }

    function hideDropdown() {
      dropdown.style.display = 'none';
    }

    searchInput.addEventListener('input', function() {
      const q = this.value.trim();
      if (q.length < 2) {
        hideDropdown();
        return;
      }
      // AJAX search: query both tasks and projects
      fetch(`/dashboard/search/?q=${encodeURIComponent(q)}`)
        .then(r => r.ok ? r.json() : {results: []})
        .then(data => {
          showDropdown(data.results || []);
        });
    });

    searchInput.addEventListener('focus', function() {
      if (dropdown.innerHTML) dropdown.style.display = 'block';
    });
    searchInput.addEventListener('blur', function() {
      setTimeout(hideDropdown, 180);
    });

    dropdown.addEventListener('mousedown', function(e) {
      const item = e.target.closest('.search-result-item');
      if (item && item.dataset.url) {
        window.location = item.dataset.url;
      }
    });
    dropdown.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const item = document.activeElement;
        if (item && item.classList.contains('search-result-item') && item.dataset.url) {
          window.location = item.dataset.url;
        }
      }
    });
  }

  // Donut chart
  const progressCtx = document.getElementById('progressChart')?.getContext('2d');
  if (progressCtx) {
    new Chart(progressCtx, {
      type: 'doughnut',
      data: {
        labels: ['Completed','In Progress','Pending'],
        datasets: [{
          data: [Number('{{ progress_completed|default:0 }}'), Number('{{ progress_inprogress|default:0 }}'), Number('{{ progress_pending|default:0 }}')],
          backgroundColor: ['#16a34a', '#1f86e3', '#eab308'],
          hoverOffset: 6,
          borderWidth: 0
        }]
      },
      options: { responsive:true, cutout:'60%', plugins:{ legend:{display:false} } }
    });
  }

  // Stacked priority chart (open vs closed)
  const priCtx = document.getElementById('priorityChart')?.getContext('2d');
  if (priCtx) {
    const openArr = [
      Number('{{ pri_critical_open|default:0 }}'),
      Number('{{ pri_high_open|default:0 }}'),
      Number('{{ pri_normal_open|default:0 }}'),
      Number('{{ pri_low_open|default:0 }}')
    ];
    const closedArr = [
      Number('{{ pri_critical_closed|default:0 }}'),
      Number('{{ pri_high_closed|default:0 }}'),
      Number('{{ pri_normal_closed|default:0 }}'),
      Number('{{ pri_low_closed|default:0 }}')
    ];
    new Chart(priCtx, {
      type: 'bar',
      data: {
        labels: ['Critical','High','Normal','Low'],
        datasets: [
          { label: 'Open', data: openArr, backgroundColor: '#ef4444', stack: 'a', borderRadius: 6 },
          { label: 'Closed', data: closedArr, backgroundColor: '#2BA388', stack: 'a', borderRadius: 6 }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'top' } } }
    });
  }

  // Line Chart (Tasks Over Time)
  const lineCtx = document.getElementById('lineChart')?.getContext('2d');
  if (lineCtx) {
    new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: {{ line_chart_labels|default:'["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]'|safe }},
        datasets: [
          {
            label: 'Created',
            data: {{ line_chart_created|default:'[0,0,0,0,0,0,0]'|safe }},
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.08)',
            tension: 0.3,
            fill: true
          },
          {
            label: 'Completed',
            data: {{ line_chart_completed|default:'[0,0,0,0,0,0,0]'|safe }},
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.08)',
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // Team View
  const teamBtn = document.getElementById('teamViewBtn');
  if (teamBtn) {
    teamBtn.addEventListener('click', async function() {
      try {
        const res = await fetch("{% url 'api_team_list' %}");
        if (!res.ok) throw new Error('no teams');
        const payload = await res.json();
        if (!payload.teams || payload.teams.length === 0) {
          alert('You are not a team lead or have no teams.');
          return;
        }
        const team = payload.teams[0];
        document.getElementById('teamNameLabel').textContent = team.name || team.id || 'Team';
        const modalEl = document.getElementById('teamModal');
        const bsModal = new bootstrap.Modal(modalEl);
        await loadTeamSummary(team.id);
        bsModal.show();
      } catch (err) {
        console.error(err);
        alert('Team view not available.');
      }
    });
  }

  async function loadTeamSummary(team_id) {
    try {
      const res = await fetch("{% url 'api_team_summary' %}?team_id=" + encodeURIComponent(team_id));
      if (!res.ok) throw new Error('no data');
      const data = await res.json();

      const tbody = document.getElementById('teamRows');
      tbody.innerHTML = '';
      (data.members || []).forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(m.name || m.email || 'â€”')}</td>
          <td>${m.assigned_count||0}</td>
          <td>${m.completed||0}</td>
          <td>${m.pending||0}</td>
          <td>${(m.priorities ? [m.priorities.Critical||0, m.priorities.High||0, m.priorities.Normal||0, m.priorities.Low||0].join(' / ') : '0 / 0 / 0 / 0')}</td>
          <td class="text-end"><button class="btn btn-outline-gradient btn-sm" data-member="${m.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // team donut
      const tProgCtx = document.getElementById('teamProgressChart').getContext('2d');
      const tProgData = [ data.totals.completed||0, data.totals.inprogress||0, data.totals.pending||0 ];
      if (window.teamProgChart) window.teamProgChart.destroy();
      window.teamProgChart = new Chart(tProgCtx, {
        type:'doughnut',
        data:{ labels:['Completed','In Progress','Pending'], datasets:[{ data:tProgData, backgroundColor:['#16a34a','#1f86e3','#eab308']}]},
        options:{ cutout:'58%', plugins:{legend:{display:false}}}
      });

      // team priority stacked horizontal
      const tPriCtx = document.getElementById('teamPriorityChart').getContext('2d');
      const openArr = [
        data.totals.priorities?.Critical_open || 0,
        data.totals.priorities?.High_open || 0,
        data.totals.priorities?.Normal_open || 0,
        data.totals.priorities?.Low_open || 0
      ];
      const closeArr = [
        data.totals.priorities?.Critical_closed || 0,
        data.totals.priorities?.High_closed || 0,
        data.totals.priorities?.Normal_closed || 0,
        data.totals.priorities?.Low_closed || 0
      ];

      if (window.teamPriChart) window.teamPriChart.destroy();

      window.teamPriChart = new Chart(tPriCtx, {
        type: 'bar',
        data: {
          labels: ['Critical', 'High', 'Normal', 'Low'],
          datasets: [
            { label: 'Open', data: openArr, backgroundColor: '#ef4444', stack: 'a' },
            { label: 'Closed', data: closeArr, backgroundColor: '#16a34a', stack: 'a' }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { beginAtZero: true }
          }
        }
      });

      } catch (err) {
        console.error(err);
        alert('Failed loading team data.');
      }

      function escapeHtml(s){
        if(!s) return '';
        return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      }});
</script>
{% endblock %}
