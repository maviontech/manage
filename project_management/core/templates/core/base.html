<style>
    .sidebar-collapsed {
      width: 0 !important;
      min-width: 0 !important;
      overflow: hidden !important;
      transition: width 0.2s;
      padding: 0 !important;   /* <--- ADD THIS LINE */
    }

    /* Header Timer Circle Animation */
    #header-timer {
      transition: box-shadow 0.2s;
    }
    .header-timer-progress {
      width:36px !important;
      height:36px !important;
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .header-timer-progress svg {
      width:36px !important;
      height:36px !important;
      display:block;
    }
    .header-timer-progress .header-timer-play {
      position:absolute;
      left:0;
      top:0;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .header-timer-play svg {
      width:20px;
      height:20px;
      display:block;
    }
    #header-timer {
      padding:6px 18px 6px 10px !important;
      min-width:220px !important;
      border-radius:24px !important;
      gap:10px !important;
    }
    #header-timer-label {
      font-size:1.1rem !important;
      font-weight:700;
      color:#222;
      font-family:'Inter',sans-serif;
      letter-spacing:1px;
    }
    #header-timer-task {
      font-size:0.95rem !important;
      color:#374151;
      font-weight:500;
      margin-left:0;
      max-width:120px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #header-timer-status {
      font-size:0.9rem !important;
      margin-left:6px;
    }
    .header-timer-status-badge {
      background:#22c55e;
      color:#fff;
      border-radius:12px;
      padding:2px 10px;
      font-size:0.9rem !important;
      font-weight:600;
      margin-left:4px;
      display:inline-block;
    }
    @keyframes headerTimerPulse {
      0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.08); transform: scale(1); }
      50% { box-shadow: 0 0 16px 2px #2563eb33; transform: scale(1.07); }
    }
    /* Layout tweak: make only the right-side main area scrollable
       without changing header or sidebar behavior. This keeps
       the header and sidebar fixed while `.main` scrolls. */
    .header { flex: 0 0 auto; }
    .main { flex: 1 1 auto; overflow: auto; -webkit-overflow-scrolling: touch; }
    html, body, #app { height: 100%; }

    /* ============================================
       POPUP NOTIFICATION STYLES
       ============================================ */
    .popup-notification-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      pointer-events: none;
    }

    .popup-notification {
      background: linear-gradient(135deg, #5B6CD6 0%, #7B83EB 100%);
      color: white;
      border-radius: 12px;
      padding: 16px;
      width: 360px;
      max-width: calc(100vw - 48px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 12px;
      pointer-events: auto;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .popup-notification:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.3), 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .popup-notification.hiding {
      animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 1, 1);
      opacity: 0;
      transform: translateX(400px);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(400px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(400px);
      }
    }

    .popup-notification-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .popup-notification-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
      color: #5B6CD6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .popup-notification-sender {
      flex: 1;
      font-weight: 600;
      font-size: 15px;
      line-height: 1.3;
    }

    .popup-notification-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .popup-notification-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .popup-notification-message {
      padding-left: 52px;
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.95;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .popup-notification-footer {
      padding-left: 52px;
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .popup-notification-footer i {
      font-size: 10px;
    }
</style>
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <title>{% block title %}Trackline — Clarity. Control. Closure.{% endblock %}</title>

  <!-- load our new css -->
  <link rel="stylesheet" href="{% static 'core/css/base.css' %}">
  
  {# Global Notification System - Toast styles #}
  <link rel="stylesheet" href="{% static 'core/css/notifications.css' %}">

  {# Small local overrides to ensure submenus collapse without leaving vertical gaps #}
  <style>
    /* Reset submenu spacing and animate height instead of display */
    .menu-root { list-style:none; margin:0; padding:0; }
    .menu-root > .menu-item { margin: 6px 0; } /* small spacing between main menu items */

    /* Submenu base: hidden by default (no padding/margin so it takes zero space) */
    .submenu {
      list-style:none;
      margin: 0;               /* remove default ul margin */
      padding: 0;              /* remove default ul padding */
      overflow: hidden;        /* clip children when collapsed */
      max-height: 0;           /* collapsed */
      transition: max-height .26s cubic-bezier(.2,.9,.2,1), padding .18s ease;
      will-change: max-height;
    }

    /* Submenu items when collapsed - keep heights zero */
    .submenu > li {
      padding: 0;
      margin: 0;
    }

    /* When a menu-item is open, allow the submenu to expand */
    .menu-item.open > .submenu {
      padding-top: 8px;        /* small breathing room when open */
      padding-bottom: 8px;
      max-height: 480px;       /* large enough for most submenus; will clip if more */
      transition: max-height .36s cubic-bezier(.2,.9,.2,1), padding .18s ease;
    }

    /* Submenu links styling (kept tight when collapsed) */
    .submenu-link {
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      padding:10px 14px;
      color:var(--muted);
      text-decoration:none;
      border-radius:8px;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
    }
    .submenu-link:hover { background: rgba(255,255,255,0.02); color: var(--text); }

    /* Nested submenu styling */
    .nested-submenu {
      padding-left: 20px;
    }
    .submenu .has-sub.open > .nested-submenu {
      padding-top: 4px;
      padding-bottom: 4px;
      max-height: 400px;
      opacity: 1; /* ensure nested submenu is visible when opened */
      transition: max-height var(--transition) ease, opacity var(--transition) ease;
    }
    .submenu .has-sub > .submenu-link .caret {
      display:inline-block;
      margin-left:auto;
      transition: transform .22s ease;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
    }
    .submenu .has-sub.open > .submenu-link .caret {
      transform: rotate(90deg);
    }

    /* Caret rotation */
    .menu-link .caret {
      display:inline-block;
      margin-left:auto;
      transition: transform .22s ease;
      color: rgba(255,255,255,0.6);
    }
    .menu-item.open > .menu-link .caret {
      transform: rotate(90deg);
    }

    /* When submenu is collapsed ensure no gap is left by list item padding */
    .menu-item > .menu-link { padding: 12px 14px; display:flex; align-items:center; gap:12px; border-radius:8px; }
    .menu-item > .menu-link:focus, .menu-item > .menu-link:hover { background: rgba(255,255,255,0.02); }

    /* small responsive fix: reduce submenu padding on narrow screens */
    @media (max-width:700px){
      .submenu-link { padding:8px 12px; font-size:14px; }
      .menu-item > .menu-link { padding:10px 12px; }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body data-tenant-id="{{ request.session.tenant_id|default:'' }}">
  <div id="app" class="app" data-theme="light">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary navigation">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">T</div>
        <div class="brand-info">
          <div class="brand-title">Trackline</div>
          <div class="brand-sub">Clarity. Control. Closure.</div>
        </div>
      </div>

      <nav class="nav" role="menu" aria-label="Main">
        <ul class="menu-root">

          <!-- Dashboard -->
          <li class="menu-item {% if page == 'dashboard' %}active{% endif %}">
            <a href="{% url 'dashboard' %}" class="menu-link ripple" role="menuitem" aria-current="{% if page == 'dashboard' %}true{% else %}false{% endif %}">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-tachometer-alt"></i></span>
              <span class="label">Dashboard</span>
            </a>
          </li>

          <!-- Projects -->
          <li class="menu-item has-sub {% if page == 'projects' or page == 'project_create' or page == 'subprojects' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'projects' or page == 'project_create' or page == 'subprojects' %}true{% else %}false{% endif %}" aria-controls="submenu-projects" aria-haspopup="true">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-folder-open"></i></span>
              <span class="label">Projects</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-projects" class="submenu" role="menu" aria-label="Projects submenu">
              <li role="none" class="{% if page == 'projects' %}active{% endif %}">
                <a href="{% url 'projects_list' %}" class="submenu-link ripple" role="menuitem">
                  <i class="fa-solid fa-list"></i>
                  <span>All Projects</span>
                </a>
              </li>
              <li role="none" class="{% if page == 'project_create' %}active{% endif %}">
                <a href="{% url 'project_create' %}" class="submenu-link ripple" role="menuitem">
                  <i class="fa-solid fa-plus-circle"></i>
                  <span>Create Project</span>
                </a>
              </li>
            </ul>
          </li>

          <!-- Tasks -->
          <li class="menu-item has-sub {% if page == 'tasks' or page == 'my_tasks' or page == 'unassigned' or page == 'task_board' or page == 'bulk_import' or page == 'task_create' or page == 'task_analytics' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'tasks' or page == 'my_tasks' or page == 'unassigned' or page == 'task_board' or page == 'bulk_import' or page == 'task_create' or page == 'task_analytics' %}true{% else %}false{% endif %}" aria-controls="submenu-tasks">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-tasks"></i></span>
              <span class="label">Tasks</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-tasks" class="submenu" role="menu" aria-label="Tasks submenu">
              <li role="none" class="{% if page == 'my_tasks' %}active{% endif %}">
                <a href="{% url 'my_tasks' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-clipboard-list"></i><span>My Tasks</span></a>
              </li>
              <li role="none" class="{% if page == 'unassigned' %}active{% endif %}">
                <a href="{% url 'unassigned_tasks' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user-clock"></i><span>Unassigned Tasks</span></a>
              </li>
              <li role="none" class="has-sub {% if page == 'task_create' %}active open{% endif %}">
                <button class="submenu-link sub-toggle ripple" aria-expanded="{% if page == 'task_create' %}true{% else %}false{% endif %}" aria-controls="submenu-create-task">
                  <i class="fa-solid fa-plus"></i>
                  <span>Create</span>
                  <span class="caret" aria-hidden="true">▸</span>
                </button>
                <ul id="submenu-create-task" class="submenu nested-submenu" role="menu" aria-label="Create task types">
                  {% if has_task %}
                  <li role="none">
                    <a href="{% url 'create_task' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-check-circle"></i><span>Task</span></a>
                  </li>
                  {% endif %}
                  {% if has_bug %}
                  <li role="none">
                    <a href="{% url 'create_bug' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-bug"></i><span>Bug</span></a>
                  </li>
                  {% endif %}
                  {% if has_story %}
                  <li role="none">
                    <a href="{% url 'create_story' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-book"></i><span>Story</span></a>
                  </li>
                  {% endif %}
                  {% if has_defect %}
                  <li role="none">
                    <a href="{% url 'create_defect' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-exclamation-triangle"></i><span>Defect</span></a>
                  </li>
                  {% endif %}
                  {% if has_subtask %}
                  <li role="none">
                    <a href="{% url 'create_subtask' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-list-check"></i><span>Subtask</span></a>
                  </li>
                  {% endif %}
                  {% if has_change_request %}
                  <li role="none">
                    <a href="{% url 'create_change_request' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-edit"></i><span>Change Request</span></a>
                  </li>
                  {% endif %}
                </ul>
              </li>
              <li role="none" class="{% if page == 'bulk_import' %}active{% endif %}">
                <a href="{% url 'bulk_import' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-file-csv"></i><span>Bulk Import (CSV)</span></a>
              </li>
              <li role="none" class="{% if page == 'task_board' %}active{% endif %}">
                <a href="{% url 'task_board' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-th-large"></i><span>Task Board</span></a>
              </li>
              <li role="none" class="{% if page == 'task_analytics' %}active{% endif %}">
                <a href="{% url 'task_analytics' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-chart-line"></i><span>Task Analytics</span></a>
              </li>
            </ul>
          </li>

          <!-- Time Tracking -->
          <li class="menu-item has-sub {% if page == 'time_tracking' or page == 'timer' or page == 'time_entries' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'time_tracking' or page == 'timer' or page == 'time_entries' %}true{% else %}false{% endif %}" aria-controls="submenu-time">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-clock"></i></span>
              <span class="label">Time Tracking</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-time" class="submenu" role="menu" aria-label="Time tracking submenu">
              <li role="none" class="{% if page == 'timer' %}active{% endif %}">
                <a href="{% url 'timer_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-stopwatch"></i><span>Start/Stop Timer</span></a>
              </li>
              <li role="none" class="{% if page == 'time_entries' %}active{% endif %}">
                <a href="{% url 'time_entries_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-list-check"></i><span>Time Entries / Approve</span></a>
              </li>
            </ul>
          </li>

          <!-- Teams -->
          <li class="menu-item has-sub {% if page == 'people' or page == 'teams' or page == 'roles' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'people' or page == 'teams' or page == 'roles' %}true{% else %}false{% endif %}" aria-controls="submenu-people">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-users"></i></span>
              <span class="label">Teams &amp; People</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-people" class="submenu" role="menu" aria-label="Teams and people submenu">
              <li role="none" class="{% if page == 'people' %}active{% endif %}">
                <a href="{% url 'people_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user"></i><span>People</span></a>
              </li>
              <li role="none" class="{% if page == 'teams' %}active{% endif %}">
                <a href="{% url 'teams_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user-friends"></i><span>Teams</span></a>
              </li>
            </ul>
          </li>

          <!-- Employees -->
          <li class="menu-item {% if page == 'employees' %}active{% endif %}">
            <a href="{% url 'employees_page' %}" class="menu-link ripple" role="menuitem" aria-current="{% if page == 'employees' %}true{% else %}false{% endif %}">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-id-card"></i></span>
              <span class="label">Employees</span>
            </a>
          </li>

          <!-- Reports -->
          <li class="menu-item {% if page == 'reports' %}active{% endif %}">
            <a href="{% url 'projects_report' %}" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-chart-bar"></i></span>
              <span class="label">Reports</span>
            </a>
          </li>

          <!-- Notifications -->
          <li class="menu-item {% if page == 'notifications' %}active{% endif %}">
            <a href="{% url 'notifications_page' %}" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-bell"></i></span>
              <span class="label">Notifications</span>
            </a>
          </li>

          <!-- Settings -->
          <li class="menu-item has-sub {% if page == 'settings' or page == 'workflows' or page == 'priorities' or page == 'workweek' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'settings' or page == 'workflows' or page == 'priorities' or page == 'workweek' %}true{% else %}false{% endif %}" aria-controls="submenu-settings">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-cog"></i></span>
              <span class="label">Settings</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-settings" class="submenu" role="menu" aria-label="Settings submenu">
             <li role="none" class="{% if page == 'workflows' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-stream"></i><span>Workflows</span></a></li>
            <li role="none" class="{% if page == 'priorities' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-flag"></i><span>Priorities</span></a></li>
            <li role="none" class="{% if page == 'workweek' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-calendar-week"></i><span>Work Week</span></a></li>

            <li role="none" class="{% if page == 'change_password' %}active{% endif %}"><a href="{% url 'change_password' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-key"></i><span>Change Password</span></a></li>

            <li role="none" class="{% if page == 'roles' %}active{% endif %}">
              <a href="{% url 'roles_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-user-shield"></i><span>Roles &amp; Permissions</span>
              </a>
            </li>

            <li role="none" class="{% if page == 'access_control' %}active{% endif %}">
              <a href="{% url 'access_control_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-lock"></i><span>Access Control</span>
              </a>
            </li>

            <li role="none" class="{% if page == 'password_policy' %}active{% endif %}">
              <a href="{% url 'password_policy_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-shield-alt"></i><span>Password Policy</span>
              </a>
            </li>

            </ul>
          </li>

          {% if request.session.role and 'PDL' in request.session.role %}
          <li class="menu-item {% if page == 'admin' %}active{% endif %}">
            <a href="#" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-user-shield"></i></span>
              <span class="label">Admin</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>

      <!-- Sidebar signed-in area -->
      <div class="sidebar-footer" role="region" aria-label="Signed in user">
        <div class="profile-actions" role="toolbar" aria-label="Profile actions">
          <a class="btn-ghost" href="{% url 'profile' %}" title="View profile">Profile</a>
          <a class="btn-ghost" href="{% url 'logout' %}" title="Log out">Log out</a>
        </div>
      </div>
    </aside>

    <!-- HEADER + MAIN -->
    <div style="flex:1 1 auto;display:flex;flex-direction:column;min-height:100vh">
      <header class="header" role="banner">
        <div class="header-left">
          <button id="menu-toggle" class="menu-btn ripple" aria-label="Toggle menu" title="Toggle menu">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
          </button>
          <div class="search-wrapper" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="search-icon" aria-hidden="true"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
            <input id="global-search" placeholder="Search projects, people, tickets..." aria-label="Search" />
          </div>
        </div>

        <div class="header-right">
          <div style="display: flex; align-items: center; gap: 18px;">
            <!-- Timer Display in Header (always present, event-driven) -->
            <span id="header-timer" style="display:none;align-items:center;gap:18px;background:#fff;padding:6px 18px 6px 10px;border-radius:24px;box-shadow:0 2px 16px 0 rgba(37,99,235,0.08);min-width:220px;">
              <span class="header-timer-progress">
                <svg width="36" height="36" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="15" fill="#f3f4f6" stroke="#e5e7eb" stroke-width="3"/>
                  <circle id="header-timer-progress-bar" cx="18" cy="18" r="15" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-dasharray="94.2" stroke-dashoffset="94.2"/>
                </svg>
                <span class="header-timer-play">
                  <svg width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="9" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                    <polygon points="8,6 15,10 8,14" fill="#2563eb" stroke="#2563eb" stroke-width="1"/>
                  </svg>
                </span>
              </span>
              <span style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                <span id="header-timer-label" style="font-size:1.1rem;font-weight:700;color:#222;font-family:'Inter',sans-serif;letter-spacing:1px;">00:00:00</span>
                <span id="header-timer-task" style="font-size:0.95rem;color:#374151;font-weight:500;margin-left:0;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                <span id="header-timer-status" style="font-size:0.9rem;margin-left:6px;"></span>
              </span>
            </span>
            <!-- Notifications -->
            <div style="position: relative;">
              <button id="notifications" class="btn-ghost" aria-label="Notifications" title="Notifications" onclick="toggleNotificationsDropdown()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 0 0-5-5.917V4a2 2 0 1 0-4 0v1.083A6 6 0 0 0 4 11v3.159c0 .538-.214 1.055-.595 1.436L2 17h5m8 0a3 3 0 0 1-6 0"/></svg>
                <span id="notif-badge" class="hidden" style="position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;font-size:11px;font-weight:600;padding:2px 6px;border-radius:10px;min-width:20px;text-align:center;">0</span>
              </button>
              <!-- Notifications Dropdown -->
              <div id="notifications-dropdown" style="display:none;position:absolute;right:0;top:calc(100% + 8px);width:380px;max-height:500px;overflow-y:auto;background:white;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:9999;">
                <div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                  <h3 style="margin:0;font-size:16px;font-weight:700;color:#1f2937;">Notifications</h3>
                  <a href="{% url 'notifications_page' %}" style="font-size:13px;color:#3b82f6;text-decoration:none;font-weight:500;">View All</a>
                </div>
                <div id="notifications-list" style="max-height:400px;overflow-y:auto;">
                  <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
                    <i class="fa fa-spinner fa-spin" style="font-size:24px;"></i>
                    <p style="margin-top:12px;font-size:14px;">Loading...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <a href="{% url 'profile' %}" class="user-mini-box" title="View Profile">
            <div class="avatar-sm">
              {% if request.session.profile_photo %}
                <img src="{{ MEDIA_URL }}{{ request.session.profile_photo }}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
              {% elif request.session.cn and request.session.cn|length > 0 %}
                {{ request.session.cn|first|upper }}
              {% elif request.session.member_name and request.session.member_name|length > 0 %}
                {{ request.session.member_name|first|upper }}
              {% elif request.user.is_authenticated and request.user.username and request.user.username|length > 0 %}
                {{ request.user.username|first|upper }}
              {% else %}
                ?
              {% endif %}
              <span id="header-online-indicator" class="online-indicator" style="position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;background:#10b981;border-radius:50%;box-shadow:0 0 0 6px rgba(16,185,129,0.08);display:none;" title="Online"></span>
            </div>
            <div class="user-name">
              {% if request.session.cn and request.session.cn|length > 0 %}
                {{ request.session.cn }}
              {% elif request.session.member_name and request.session.member_name|length > 0 %}
                {{ request.session.member_name }}
              {% elif request.user.is_authenticated and request.user.username and request.user.username|length > 0 %}
                {{ request.user.username }}
              {% else %}User{% endif %}
              {% if request.session.role and 'PDL' in request.session.role %}
                <span style="font-size:11px;color:#065f46;font-weight:700;margin-left:8px;background:#ecfdf5;padding:2px 6px;border-radius:8px;">Admin</span>
              {% endif %}
            </div>
          </a>
          <style>
            .user-mini-box {
              display: flex;
              align-items: center;
              gap: 10px;
              background: #f3f4f6;
              border-radius: 22px;
              padding: 4px 16px 4px 8px;
              box-shadow: 0 2px 8px rgba(37,99,235,0.08);
              text-decoration: none;
              color: #222;
              font-weight: 600;
              transition: box-shadow 0.18s, background 0.18s;
              margin-left: 2px;
            }
            .user-mini-box:hover {
              background: #e0e7ff;
              box-shadow: 0 4px 16px rgba(37,99,235,0.13);
              color: #2563eb;
            }
            .avatar-sm {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              position: relative;
              background: #2563eb;
              color: #fff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.2rem;
              font-weight: 700;
              box-shadow: 0 1px 4px rgba(37,99,235,0.10);
            }
            .user-name {
              font-size: 1rem;
              font-weight: 600;
              color: #222;
              letter-spacing: 0.2px;
              margin-left: 2px;
            }
          </style>
        </div>
      </header>

      <main class="main" role="main">
        <div class="container">
          <div class="page-title">
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              {% block actions %}{% endblock %}
            </div>
          </div>

          {% block content %}{% endblock %}

          <footer class="footer" role="contentinfo">
            <div>© {{ now|date:"Y" }} MavionTech</div>
            <div class="small muted">Project Management • Version 0.1</div>
          </footer>
        </div>
      </main>
    </div>
  </div>
  {# ----------------- CHAT WIDGET: pinned to footer (chat app namespace = "chat") ----------------- #}
  {# Add the static files to your static/chat/ path: chat_widget.css and chat_widget.js #}
  <link rel="stylesheet" href="{% static 'chat/chat_widget.css' %}">


  <div id="chat-shortcut" aria-hidden="false" style="position:fixed;right:22px;bottom:18px;z-index:1400">
    <a href="{% url 'chat:team_chat' %}" id="chat-open-btn" title="Open team chat" class="chat-fab" aria-label="Open chat" style="width: 50px;height: 50px;border-radius:999px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;background:linear-gradient(135deg,#2563eb,#38bdf8);box-shadow:0 10px 30px rgba(8,20,40,0.18);">
      <i class="fa fa-comments" aria-hidden="true" style="font-size:28px;color:#fff"></i>
      <span id="chat-unread-badge" class="hidden" style="position:absolute;right:-6px;top:-6px;background:#ff3b30;color:#fff;border-radius:999px;padding:4px 6px;font-size:14px"></span>
    </a>

    <div id="chat-panel" class="hidden" role="dialog" aria-label="Team chat" style="width:540px;max-height:88vh;background:linear-gradient(135deg,#2563eb 80%,#38bdf8 100%);border-radius:16px;box-shadow:0 24px 80px rgba(2,6,23,0.40);overflow:hidden;margin-top:10px;">
      <div class="chat-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
        <div class="chat-title" style="font-weight:700;font-size:18px;">Team chat</div>
        <button id="chat-close-btn" class="icon-btn" aria-label="Close chat" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><i class="fa fa-times" aria-hidden="true"></i></button>
      </div>

      <div class="chat-body" style="display:flex;min-height:420px;">
        <div class="chat-members" style="width:200px;border-right:1px solid #e0e7ff;padding:12px;background:#f1f5fd;">
          <input id="chat-member-search" placeholder="Search members..." style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #c7d7f6;margin-bottom:12px;font-size:15px;" />
          <ul id="chat-members-list" style="list-style:none;padding:0;margin:0;max-height:66vh;overflow:auto;"></ul>
        </div>

        <div id="chat-window" class="chat-window hidden" style="flex:1;display:flex;flex-direction:column;">
          <div id="chat-history" style="flex:1;padding:18px;overflow:auto;background:linear-gradient(to bottom,#e0e7ff 0%,#f7fbff 100%)"></div>
          <div class="chat-input" style="display:flex;gap:12px;padding:14px;border-top:1px solid #e0e7ff;background:#f1f5fd;">
            <input id="chat-input" placeholder="Write a message..." autocomplete="off" style="flex:1;padding:12px 14px;border-radius:10px;border:1px solid #c7d7f6;font-size:15px;" />
            <button id="chat-send" class="btn" style="padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,#2563eb,#38bdf8);color:#fff;cursor:pointer;font-size:15px;font-weight:600;">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="{% static 'chat/chat_widget.js' %}"></script>
  {# ----------------- end chat widget ----------------- #}

  {# Global Notification System - Works on all pages #}
  <script src="{% static 'core/js/notifications.js' %}"></script>

  <script>
    const SIDEBAR_KEY = 'trackline.sidebar.state';

    // --- Submenu controller (only one open at a time) ---
    (function(){
      document.querySelectorAll('.sub-toggle').forEach(btn=>{
        const id = btn.getAttribute('aria-controls');            // e.g. submenu-tasks
        const li = btn.closest('.menu-item, .has-sub');

        btn.addEventListener('click', function(e){
          e.preventDefault();

          // Check if this is a nested submenu (has-sub within submenu)
          const isNested = li.classList.contains('has-sub') && !li.classList.contains('menu-item');

          // toggle current
          const isNowOpen = li.classList.toggle('open');
          btn.setAttribute('aria-expanded', isNowOpen ? 'true' : 'false');

          // For main menu items (not nested), close any other open main menu-item
          if (!isNested) {
            document.querySelectorAll('.menu-item.open').forEach(other=>{
              if (other === li) return; // skip the one we just toggled
              other.classList.remove('open');

              // ensure button aria-expanded for the other submenu is false
              const otherBtn = other.querySelector('.sub-toggle');
              if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');

              // defensive: remove inline max-height/padding if any left by legacy code
              const otherSub = other.querySelector('.submenu');
              if (otherSub) {
                otherSub.style.maxHeight = null;
                otherSub.style.paddingTop = null;
                otherSub.style.paddingBottom = null;
              }
            });

            // persist per-submenu and collapsed state into localStorage
            try {
              const saved = JSON.parse(localStorage.getItem(SIDEBAR_KEY) || "{}");

              // set this submenu state
              saved[id] = isNowOpen;

              // ensure all other submenu keys are set to false (so only this one opens next time)
              document.querySelectorAll('.menu-item > .sub-toggle').forEach(b=>{
                const k = b.getAttribute('aria-controls');
                if (k !== id) saved[k] = false;
              });

              localStorage.setItem(SIDEBAR_KEY, JSON.stringify(saved));
            } catch(e) {
              // ignore storage errors
            }
          }
        });

        // keyboard activation
        btn.addEventListener('keydown', function(e){
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
        });
      });

      // On first load: restore previously saved open submenu state (if any)
      try {
        const saved = JSON.parse(localStorage.getItem(SIDEBAR_KEY) || "{}");
        Object.keys(saved).forEach(k=>{
          if (saved[k]) {
            const btn = document.querySelector(`[aria-controls="${k}"]`);
            if (btn) {
              const li = btn.closest('.menu-item');
              li.classList.add('open');
              btn.setAttribute('aria-expanded','true');
            }
          }
        });
      } catch(e){ /* ignore */ }

    })();
  </script>
  <script>
    // {% comment %}
    //   Expose canonical CURRENT_USER to client JS.
    //   Use session member_id (set at login); fall back safely.
    // {% endcomment %}
    // {% if request.session.member_id %}
    //   const CURRENT_USER = "{{ request.session.member_id|escapejs }}";
    // {% elif request.session.ident_email %}
    //   const CURRENT_USER = "{{ request.session.ident_email|escapejs }}";
    // {% elif request.user.is_authenticated %}
    //   const CURRENT_USER = "{{ request.user.email|default:request.user.username|escapejs }}";
    // {% else %}
    //   const CURRENT_USER = "";
    // {% endif %}

    const TENANT_ID = "{{ request.session.tenant_id|default:''|escapejs }}";
    // Expose CURRENT_USER and TENANT for presence WebSocket
    const CURRENT_USER = "{{ request.session.ident_email|default:request.session.member_id|default:''|escapejs }}".toLowerCase();
    // debug helper (remove in production)
    console.debug("[chat] CURRENT_USER on page load ->", CURRENT_USER);
    console.debug("[chat] TENANT_ID on page load ->", TENANT_ID);
    
    // Presence WebSocket: connect automatically when a user is logged in
    (function(){
      if(!CURRENT_USER) {
        console.warn('[Presence] Not connecting: CURRENT_USER is empty');
        return; // only connect for authenticated sessions
      }
      
      if(!TENANT_ID) {
        console.error('[Presence] Not connecting: TENANT_ID is empty. Please ensure tenant_id is set in session during login.');
        return;
      }

      try{
        const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const presenceUrl = `${scheme}://${window.location.host}/ws/presence/?tenant=${encodeURIComponent(TENANT_ID)}`;
        console.log('[Presence] Connecting to:', presenceUrl);
        const presenceSocket = new WebSocket(presenceUrl);

        presenceSocket.onopen = function(){
          console.log('✅ Presence WS connected');
          // announce ourselves as online
          try{ presenceSocket.send(JSON.stringify({ type: 'presence', status: 'online', user: CURRENT_USER })); }catch(e){}
          // ensure header indicator visible for current user
          const hd = document.getElementById('header-online-indicator'); if(hd) hd.style.display = 'inline-block';
        };

        presenceSocket.onmessage = function(ev){
          let msg;
          try{ msg = JSON.parse(ev.data); }catch(e){ return; }
          // support both `type` and `event` naming
          const t = msg.type || msg.event;
          if(!t) return;
          if(t === 'presence_update'){
            const userEmail = (msg.user_email || msg.user || msg.user_email_address || '').toString().toLowerCase();
            const status = msg.status || msg.presence || 'offline';
            setUserOnlineIndicator(userEmail, status === 'online');
          }
        };

        presenceSocket.onerror = function(err){ console.error('Presence WS error', err); };

        // send offline when leaving page
        window.addEventListener('beforeunload', function(){
          try{ if(presenceSocket && presenceSocket.readyState === WebSocket.OPEN){ presenceSocket.send(JSON.stringify({ type:'presence', status:'offline', user: CURRENT_USER })); presenceSocket.close(); } }catch(e){}
        });

        // helper: toggle any element that represents a user (data-user-email attr)
        function setUserOnlineIndicator(email, isOnline){
          if(!email) return;
          // elements that may represent users: data-user-email (avatars/messages/members)
          const selector = `[data-user-email="${email}"]`;
          document.querySelectorAll(selector).forEach(container => {
            // ensure container is positioned so absolute dot can be placed
            if(getComputedStyle(container).position === 'static') container.style.position = 'relative';
            let dot = container.querySelector('.online-indicator');
            if(!dot){
              dot = document.createElement('span');
              dot.className = 'online-indicator';
              dot.style.cssText = 'position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;background:#10b981;border-radius:50%;box-shadow:0 0 0 6px rgba(16,185,129,0.08);display:none;';
              container.appendChild(dot);
            }
            dot.style.display = isOnline ? 'inline-block' : 'none';
          });

          // header indicator: also toggle if this email is current session
          const myEmail = "{{ request.session.ident_email|default:''|escapejs }}".toLowerCase();
          if(email === myEmail){ const hd = document.getElementById('header-online-indicator'); if(hd) hd.style.display = isOnline ? 'inline-block' : 'none'; }
        }

      }catch(e){ console.warn('Presence WS init failed', e); }
    })();
  </script>

  {% block extra_js %}{% endblock %}
  <script>
  // --- Header Timer Logic ---
  let headerTimerInterval = null;
  let headerTimerActive = false;
  let headerTimerStart = null;
  let headerTimerTask = null;
  let headerTimerPaused = false;
  let headerTimerPausedAt = null;
  let headerTimerPausedDuration = 0;

  // Restore timer state from localStorage on page load
  document.addEventListener('DOMContentLoaded', function() {
    const timerState = localStorage.getItem('headerTimerState');
    if (timerState) {
      try {
        const state = JSON.parse(timerState);
        if (state.active && state.startTime) {
          showHeaderTimer(state.startTime, state.taskName || '');
          // Restore pause state if it was paused
          if (state.paused && state.pausedAt) {
            headerTimerPaused = true;
            headerTimerPausedAt = new Date(state.pausedAt);
            headerTimerPausedDuration = state.pausedDuration || 0;
            document.getElementById('header-timer-status').innerHTML = `<span class='header-timer-status-badge' style='background:#f59e0b;'>Paused</span>`;
            // Stop the interval since it's paused
            if (headerTimerInterval) {
              clearInterval(headerTimerInterval);
              headerTimerInterval = null;
            }
            // Update display once to show correct paused time
            updateHeaderTimerDisplay();
          } else if (state.pausedDuration) {
            // Not currently paused but has accumulated pause duration
            headerTimerPausedDuration = state.pausedDuration;
          }
        }
      } catch (e) {}
    }
  });

  function showHeaderTimer(startTime, taskName) {
    headerTimerActive = true;
    headerTimerStart = startTime ? new Date(startTime) : new Date();
    headerTimerTask = taskName || '';
    document.getElementById('header-timer').style.display = 'inline-flex';
    document.getElementById('header-timer-task').textContent = taskName ? `Task: ${taskName}` : '';
    document.getElementById('header-timer-status').innerHTML = `<span class='header-timer-status-badge'>Open</span>`;
    updateHeaderTimerDisplay();
    if (headerTimerInterval) clearInterval(headerTimerInterval);
    headerTimerInterval = setInterval(updateHeaderTimerDisplay, 1000);

    // Persist timer state
    localStorage.setItem('headerTimerState', JSON.stringify({
      active: true,
      startTime: headerTimerStart.toISOString(),
      taskName: headerTimerTask,
      paused: false,
      pausedDuration: 0
    }));
  }

  function hideHeaderTimer() {
    headerTimerActive = false;
    headerTimerPaused = false;
    headerTimerPausedAt = null;
    headerTimerPausedDuration = 0;
    document.getElementById('header-timer').style.display = 'none';
    document.getElementById('header-timer-label').textContent = '00:00:00';
    document.getElementById('header-timer-task').textContent = '';
    document.getElementById('header-timer-status').innerHTML = '';
    setHeaderTimerProgress(0);
    if (headerTimerInterval) clearInterval(headerTimerInterval);

    // Remove timer state
    localStorage.removeItem('headerTimerState');
  }

  function updateHeaderTimerDisplay() {
    if (!headerTimerActive || !headerTimerStart) return;
    const now = new Date();
    let elapsed;
    if (headerTimerPaused) {
      // When paused, calculate elapsed time up to pause point
      elapsed = Math.floor((headerTimerPausedAt - headerTimerStart - headerTimerPausedDuration) / 1000);
    } else {
      // When running, calculate current elapsed time minus paused duration
      elapsed = Math.floor((now - headerTimerStart - headerTimerPausedDuration) / 1000);
    }
    document.getElementById('header-timer-label').textContent = formatHeaderTime(elapsed);
    // Animate progress bar (0-60s loop for demo, or you can use task duration/goal)
    setHeaderTimerProgress((elapsed % 60) / 60);
  }

  function setHeaderTimerProgress(progress) {
    // progress: 0.0 to 1.0
    const circle = document.getElementById('header-timer-progress-bar');
    if (!circle) return;
    const total = 2 * Math.PI * 24; // r=24
    const offset = total * (1 - progress);
    circle.setAttribute('stroke-dashoffset', offset);
  }

  function formatHeaderTime(seconds) {
    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  // Example: Integrate with timer start/stop events
  window.addEventListener('startTaskTimer', function(e) {
    // e.detail = { startTime, taskName }
    if (headerTimerActive) {
      alert('Please stop or pause the current timer before starting a new one.');
      return;
    }
    showHeaderTimer(e.detail.startTime, e.detail.taskName);
  });

  window.addEventListener('stopTaskTimer', function(e) {
    hideHeaderTimer();
  });

  window.addEventListener('pauseTaskTimer', function(e) {
    if (headerTimerActive && !headerTimerPaused) {
      headerTimerPaused = true;
      headerTimerPausedAt = new Date();
      document.getElementById('header-timer-status').innerHTML = `<span class='header-timer-status-badge' style='background:#f59e0b;'>Paused</span>`;
      // Stop updating display while paused
      if (headerTimerInterval) {
        clearInterval(headerTimerInterval);
        headerTimerInterval = null;
      }
      // Update localStorage with pause state
      localStorage.setItem('headerTimerState', JSON.stringify({
        active: true,
        startTime: headerTimerStart.toISOString(),
        taskName: headerTimerTask,
        paused: true,
        pausedAt: headerTimerPausedAt.toISOString(),
        pausedDuration: headerTimerPausedDuration
      }));
    }
  });

  window.addEventListener('resumeTaskTimer', function(e) {
    if (headerTimerActive && headerTimerPaused) {
      // Calculate pause duration and add to total
      const now = new Date();
      const pauseDuration = now - headerTimerPausedAt;
      headerTimerPausedDuration += pauseDuration;
      headerTimerPaused = false;
      headerTimerPausedAt = null;
      document.getElementById('header-timer-status').innerHTML = `<span class='header-timer-status-badge'>Open</span>`;
      // Resume updating display
      if (!headerTimerInterval) {
        headerTimerInterval = setInterval(updateHeaderTimerDisplay, 1000);
      }
      updateHeaderTimerDisplay();
      // Update localStorage with resume state
      localStorage.setItem('headerTimerState', JSON.stringify({
        active: true,
        startTime: headerTimerStart.toISOString(),
        taskName: headerTimerTask,
        paused: false,
        pausedDuration: headerTimerPausedDuration
      }));
    }
  });

  // To trigger: dispatchEvent(new CustomEvent('startTaskTimer', { detail: { startTime: ..., taskName: ... } }))
  // To stop: dispatchEvent(new CustomEvent('stopTaskTimer'))
  // To pause: dispatchEvent(new CustomEvent('pauseTaskTimer'))
  // To resume: dispatchEvent(new CustomEvent('resumeTaskTimer'))
  </script>
  
  <!-- Global Search Functionality -->
  <style>
    .search-results-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      max-height: 500px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
    }
    
    .search-results-dropdown.show {
      display: block;
    }
    
    .search-wrapper {
      position: relative;
    }
    
    .search-result-section {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    
    .search-result-section:last-child {
      border-bottom: none;
    }
    
    .search-section-title {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 700;
      color: #6b7280;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .search-result-item {
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-result-item:hover {
      background: #f3f4f6;
    }
    
    .search-result-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .search-result-icon.project {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .search-result-icon.task {
      background: #d1fae5;
      color: #065f46;
    }
    
    .search-result-icon.person {
      background: #fef3c7;
      color: #92400e;
    }
    
    .search-result-icon.team {
      background: #e0e7ff;
      color: #4338ca;
    }
    
    .search-result-info {
      flex: 1;
      min-width: 0;
    }
    
    .search-result-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .search-result-meta {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .search-no-results {
      padding: 40px 20px;
      text-align: center;
      color: #9ca3af;
    }
    
    .search-loading {
      padding: 20px;
      text-align: center;
      color: #6b7280;
    }
  </style>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle
    var toggleBtn = document.getElementById('menu-toggle');
    var sidebar = document.getElementById('sidebar');
    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-collapsed');
        if (sidebar.classList.contains('sidebar-collapsed')) {
          localStorage.setItem('sidebar-collapsed', '1');
        } else {
          localStorage.removeItem('sidebar-collapsed');
        }
      });
      if (localStorage.getItem('sidebar-collapsed') === '1') {
        sidebar.classList.add('sidebar-collapsed');
      }
    }
    
    // Global Search Implementation
    const searchInput = document.getElementById('global-search');
    const searchWrapper = document.querySelector('.search-wrapper');
    
    if (searchInput && searchWrapper) {
      // Create results dropdown
      const resultsDropdown = document.createElement('div');
      resultsDropdown.className = 'search-results-dropdown';
      searchWrapper.appendChild(resultsDropdown);
      
      let searchTimeout;
      let currentResults = {
        projects: [],
        tasks: [],
        people: [],
        teams: []
      };
      
      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          resultsDropdown.classList.remove('show');
          return;
        }
        
        resultsDropdown.innerHTML = '<div class="search-loading"><i class="fa fa-spinner fa-spin"></i> Searching...</div>';
        resultsDropdown.classList.add('show');
        
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchWrapper.contains(e.target)) {
          resultsDropdown.classList.remove('show');
        }
      });
      
      function performSearch(query) {
        const searchTerm = query.toLowerCase();
        
        // Comprehensive search across all content
        const allResults = {
          pages: [],
          projects: [],
          tasks: [],
          people: [],
          teams: [],
          features: [],
          files: []
        };
        
        // Search navigation menu items (most immediate results)
        searchNavigationItems(searchTerm, allResults);
        
        // Search all visible page content
        searchPageContent(searchTerm, allResults);
        
        // Try to fetch from APIs if available (including tasks)
        Promise.all([
          fetchProjects(query),
          fetchTasks(query),
          fetchPeople(query),
          fetchTeams(query)
        ]).then(([projects, tasks, people, teams]) => {
          allResults.projects = projects;
          allResults.tasks = tasks;
          allResults.people = people;
          allResults.teams = teams;
          
          displayResults(allResults);
        }).catch(() => {
          // If API calls fail, just show what we found in the page
          displayResults(allResults);
        });
      }
      
      function searchNavigationItems(query, results) {
        const menuItems = document.querySelectorAll('.menu-link, .submenu-link');
        const foundPages = [];
        
        menuItems.forEach(item => {
          const text = item.textContent.toLowerCase().trim();
          const spanText = item.querySelector('span:last-child, .label')?.textContent.toLowerCase().trim();
          
          if (text.includes(query) || (spanText && spanText.includes(query))) {
            const href = item.getAttribute('href');
            let title = item.querySelector('span:last-child, .label')?.textContent.trim() || item.textContent.trim();
            
            // Clean up title
            title = title.replace(/\s+/g, ' ').trim();
            
            // Get icon if exists
            const icon = item.querySelector('i')?.className || 'fa fa-arrow-right';
            
            if (href && href !== '#' && !foundPages.some(p => p.href === href)) {
              // Determine category
              let category = 'Navigation';
              if (text.includes('project')) category = 'Projects';
              else if (text.includes('task')) category = 'Tasks';
              else if (text.includes('people') || text.includes('team')) category = 'Team';
              else if (text.includes('report')) category = 'Reports';
              else if (text.includes('employee')) category = 'Employees';
              else if (text.includes('setting')) category = 'Settings';
              
              foundPages.push({ 
                title, 
                href, 
                icon,
                category,
                type: 'page' 
              });
            }
          }
        });
        
        results.pages = foundPages;
      }
      
      function searchPageContent(query, results) {
        // Search for any text on the current page that might be relevant
        const headings = document.querySelectorAll('h1, h2, h3, h4, .card-title, .page-title');
        const features = [];
        
        headings.forEach(heading => {
          const text = heading.textContent.toLowerCase().trim();
          if (text.includes(query) && text.length < 100) {
            features.push({
              title: heading.textContent.trim(),
              description: 'Found on current page',
              type: 'feature'
            });
          }
        });
        
        results.features = features.slice(0, 5);
      }
      
      function fetchProjects(query) {
        return fetch(`/projects/ajax/search/?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => data.results || [])
          .catch(() => []);
      }
      
      function fetchTasks(query) {
        // Search tasks if API is available
        return fetch(`/tasks/api/search/?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => (data.tasks || []).slice(0, 5))
          .catch(() => []);
      }
      
      function fetchPeople(query) {
        return fetch(`/api/people/list`)
          .then(res => res.json())
          .then(data => {
            const people = data.members || [];
            return people.filter(p => {
              const fullName = (p.first_name + ' ' + p.last_name).toLowerCase();
              const email = (p.email || '').toLowerCase();
              return fullName.includes(query) || email.includes(query);
            }).slice(0, 5);
          })
          .catch(() => []);
      }
      
      function fetchTeams(query) {
        return fetch(`/api/teams/list`)
          .then(res => res.json())
          .then(data => {
            const teams = data.teams || [];
            return teams.filter(t => 
              (t.name || '').toLowerCase().includes(query) ||
              (t.description || '').toLowerCase().includes(query)
            ).slice(0, 5);
          })
          .catch(() => []);
      }
      
      function displayResults(results) {
        let html = '';
        let hasResults = false;
        
        // Page Navigation Results (show first for quick access)
        if (results.pages && results.pages.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-compass"></i> Quick Navigation</div>';
          results.pages.forEach(page => {
            const iconClass = page.icon || 'fa fa-arrow-right';
            html += `
              <a href="${page.href}" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon" style="background: #e0e7ff; color: #4338ca;">
                  <i class="${iconClass}"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(page.title)}</div>
                  <div class="search-result-meta">${escapeHtml(page.category)}</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }
        
        // Projects section
        if (results.projects && results.projects.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-folder"></i> Projects</div>';
          results.projects.forEach(project => {
            html += `
              <a href="/projects/${project.id}/edit/" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon project">
                  <i class="fa fa-folder"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(project.name)}</div>
                  <div class="search-result-meta">Project</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }
        
        // Tasks section
        if (results.tasks && results.tasks.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-tasks"></i> Tasks</div>';
          results.tasks.forEach(task => {
            const meta = (task.project_name ? task.project_name : task.assigned_to_display || task.status || 'Task');
            html += `
              <a href="/tasks/${task.id}/" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon task">
                  <i class="fa fa-tasks"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(task.title)}</div>
                  <div class="search-result-meta">${escapeHtml(meta)}</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }

        // People section
        if (results.people && results.people.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-user"></i> People</div>';
          results.people.forEach(person => {
            html += `
              <div class="search-result-item" onclick="window.location.href='/people/'">
                <div class="search-result-icon person">
                  <i class="fa fa-user"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(person.first_name + ' ' + person.last_name)}</div>
                  <div class="search-result-meta">${escapeHtml(person.email)}</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        // Teams section
        if (results.teams && results.teams.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-users"></i> Teams</div>';
          results.teams.forEach(team => {
            html += `
              <div class="search-result-item" onclick="window.location.href='/teams/'">
                <div class="search-result-icon team">
                  <i class="fa fa-users"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(team.name)}</div>
                  <div class="search-result-meta">Team</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        // Features found on current page
        if (results.features && results.features.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-info-circle"></i> Current Page</div>';
          results.features.forEach(feature => {
            html += `
              <div class="search-result-item" style="cursor: default;">
                <div class="search-result-icon" style="background: #f3f4f6; color: #6b7280;">
                  <i class="fa fa-bookmark"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(feature.title)}</div>
                  <div class="search-result-meta">${escapeHtml(feature.description)}</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        if (!hasResults) {
          html = `
            <div class="search-no-results">
              <i class="fa fa-search" style="font-size: 32px; color: #d1d5db; margin-bottom: 12px;"></i>
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No results found</div>
              <div style="font-size: 12px;">Try searching for projects, people, teams, or menu items</div>
            </div>
          `;
        }
        
        resultsDropdown.innerHTML = html;
        resultsDropdown.classList.add('show');
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }
  });
  </script>

  <!-- Notifications System -->
  <script>
  let notificationsDropdownOpen = false;

  // Load notification count on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    
    // Auto-refresh every 30 seconds
    setInterval(updateNotificationCount, 30000);
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('notifications-dropdown');
      const notifBtn = document.getElementById('notifications');
      if (dropdown && !dropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        dropdown.style.display = 'none';
        notificationsDropdownOpen = false;
      }
    });
  });

  function updateNotificationCount() {
    fetch('{% url "api_notifications_unread_count" %}')
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById('notif-badge');
        if (badge) {
          const count = data.count || 0;
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      })
      .catch(error => console.error('Error fetching notification count:', error));
  }

  function toggleNotificationsDropdown() {
    const dropdown = document.getElementById('notifications-dropdown');
    if (!dropdown) return;
    
    notificationsDropdownOpen = !notificationsDropdownOpen;
    
    if (notificationsDropdownOpen) {
      dropdown.style.display = 'block';
      loadNotificationsPreview();
    } else {
      dropdown.style.display = 'none';
    }
  }

  function loadNotificationsPreview() {
    const container = document.getElementById('notifications-list');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:#9ca3af;"><i class="fa fa-spinner fa-spin" style="font-size:24px;"></i><p style="margin-top:12px;font-size:14px;">Loading...</p></div>';
    
    fetch('{% url "api_notifications_list" %}')
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Error loading notifications</div>';
          return;
        }
        
        const notifications = (data.notifications || []).slice(0, 5); // Show only 5 recent
        
        if (notifications.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
              <i class="fa fa-bell-slash" style="font-size:32px;color:#d1d5db;"></i>
              <p style="margin-top:12px;font-size:14px;font-weight:600;">No notifications</p>
              <p style="font-size:12px;margin-top:4px;">You're all caught up!</p>
            </div>
          `;
          return;
        }
        
        let html = '';
        notifications.forEach(notif => {
          const iconClass = getNotifIconClass(notif.type);
          const iconBg = getNotifIconBg(notif.type);
          const timeAgo = getNotifTimeAgo(notif.created_at);
          const unreadDot = !notif.is_read ? '<div style="width:8px;height:8px;background:#3b82f6;border-radius:50%;margin-left:8px;"></div>' : '';
          
          html += `
            <div onclick="handleNotifClick(${notif.id}, '${notif.link || ''}')" style="padding:12px 16px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.2s;${!notif.is_read ? 'background:#eff6ff;' : ''}" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='${!notif.is_read ? '#eff6ff' : 'white'}'">
              <div style="display:flex;gap:12px;align-items:start;">
                <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;${iconBg}">
                  <i class="${iconClass}"></i>
                </div>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;align-items:center;">
                    <div style="font-size:14px;font-weight:600;color:#1f2937;flex:1;">${escapeHtmlNotif(notif.title)}</div>
                    ${unreadDot}
                  </div>
                  <div style="font-size:13px;color:#6b7280;margin-top:2px;line-height:1.4;">${escapeHtmlNotif(notif.message)}</div>
                  <div style="font-size:11px;color:#9ca3af;margin-top:4px;"><i class="fa fa-clock"></i> ${timeAgo}</div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      })
      .catch(error => {
        console.error('Error:', error);
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Failed to load notifications</div>';
      });
  }

  function getNotifIconClass(type) {
    const icons = {
      'info': 'fa fa-info-circle',
      'success': 'fa fa-check-circle',
      'warning': 'fa fa-exclamation-triangle',
      'error': 'fa fa-times-circle',
      'task': 'fa fa-tasks',
      'project': 'fa fa-folder',
      'team': 'fa fa-users'
    };
    return icons[type] || 'fa fa-bell';
  }

  function getNotifIconBg(type) {
    const colors = {
      'info': 'background:#dbeafe;color:#1e40af;',
      'success': 'background:#d1fae5;color:#065f46;',
      'warning': 'background:#fef3c7;color:#92400e;',
      'error': 'background:#fee2e2;color:#991b1b;',
      'task': 'background:#e0e7ff;color:#4338ca;',
      'project': 'background:#dbeafe;color:#1e40af;',
      'team': 'background:#fce7f3;color:#9f1239;'
    };
    return colors[type] || 'background:#f3f4f6;color:#6b7280;';
  }

  function getNotifTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    
    return date.toLocaleDateString();
  }

  function handleNotifClick(id, link) {
    // Mark as read
    fetch('{% url "api_notifications_mark_read" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ id: id })
    })
    .then(() => {
      updateNotificationCount();
      if (link && link !== 'null' && link !== '') {
        window.location.href = link;
      } else {
        window.location.href = '{% url "notifications_page" %}';
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function escapeHtmlNotif(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  </script>
  <script>
    // Show header online indicator for the logged-in user immediately
    document.addEventListener('DOMContentLoaded', function(){
      try{
        const CURRENT_USER_EMAIL = "{{ request.session.ident_email|default:''|escapejs }}".toLowerCase();
        const headerDot = document.getElementById('header-online-indicator');
        if(headerDot && CURRENT_USER_EMAIL){ headerDot.style.display = 'inline-block'; }
      }catch(e){ /* ignore */ }
    });
  </script>

  <!-- Popup Notification Container -->
  <div class="popup-notification-container" id="popup-notification-container"></div>

</body>
</html>