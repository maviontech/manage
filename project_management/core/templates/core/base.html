<style>
    .sidebar-collapsed {
      width: 0 !important;
      min-width: 0 !important;
      overflow: hidden !important;
      transition: width 0.2s;
      padding: 0 !important;   /* <--- ADD THIS LINE */
    }

    /* Header Timer Circle Animation */
    #header-timer {
      transition: box-shadow 0.2s;
    }
    .header-timer-progress {
      width:36px !important;
      height:36px !important;
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .header-timer-progress svg {
      width:36px !important;
      height:36px !important;
      display:block;
    }
    .header-timer-progress .header-timer-play {
      position:absolute;
      left:0;
      top:0;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .header-timer-play svg {
      width:20px;
      height:20px;
      display:block;
    }
    #header-timer {
      padding:6px 18px 6px 10px !important;
      min-width:220px !important;
      border-radius:24px !important;
      gap:10px !important;
    }
    #header-timer-label {
      font-size:1.1rem !important;
      font-weight:700;
      color:#222;
      font-family:'Inter',sans-serif;
      letter-spacing:1px;
    }
    #header-timer-task {
      font-size:0.95rem !important;
      color:#374151;
      font-weight:500;
      margin-left:0;
      max-width:120px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #header-timer-status {
      font-size:0.9rem !important;
      margin-left:6px;
    }
    .header-timer-status-badge {
      background:#22c55e;
      color:#fff;
      border-radius:12px;
      padding:2px 10px;
      font-size:0.9rem !important;
      font-weight:600;
      margin-left:4px;
      display:inline-block;
    }
    @keyframes headerTimerPulse {
      0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.08); transform: scale(1); }
      50% { box-shadow: 0 0 16px 2px #2563eb33; transform: scale(1.07); }
    }
    /* Layout tweak: make only the right-side main area scrollable
       without changing header or sidebar behavior. This keeps
       the header and sidebar fixed while `.main` scrolls. */
    .header { flex: 0 0 auto; }
    .main { flex: 1 1 auto; overflow: auto; -webkit-overflow-scrolling: touch; }
    html, body, #app { height: 100%; }
</style>
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <title>{% block title %}Trackline — Plan, Track, Deliver.{% endblock %}</title>

  <!-- load our new css -->
  <link rel="stylesheet" href="{% static 'core/css/base.css' %}">

  {# Small local overrides to ensure submenus collapse without leaving vertical gaps #}
  <style>
    /* Reset submenu spacing and animate height instead of display */
    .menu-root { list-style:none; margin:0; padding:0; }
    .menu-root > .menu-item { margin: 6px 0; } /* small spacing between main menu items */

    /* Submenu base: hidden by default (no padding/margin so it takes zero space) */
    .submenu {
      list-style:none;
      margin: 0;               /* remove default ul margin */
      padding: 0;              /* remove default ul padding */
      overflow: hidden;        /* clip children when collapsed */
      max-height: 0;           /* collapsed */
      transition: max-height .26s cubic-bezier(.2,.9,.2,1), padding .18s ease;
      will-change: max-height;
    }

    /* Submenu items when collapsed - keep heights zero */
    .submenu > li {
      padding: 0;
      margin: 0;
    }

    /* When a menu-item is open, allow the submenu to expand */
    .menu-item.open > .submenu {
      padding-top: 8px;        /* small breathing room when open */
      padding-bottom: 8px;
      max-height: 480px;       /* large enough for most submenus; will clip if more */
      transition: max-height .36s cubic-bezier(.2,.9,.2,1), padding .18s ease;
    }

    /* Submenu links styling (kept tight when collapsed) */
    .submenu-link {
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      padding:10px 14px;
      color:var(--muted);
      text-decoration:none;
      border-radius:8px;
    }
    .submenu-link:hover { background: rgba(255,255,255,0.02); color: var(--text); }

    /* Caret rotation */
    .menu-link .caret {
      display:inline-block;
      margin-left:auto;
      transition: transform .22s ease;
      color: rgba(255,255,255,0.6);
    }
    .menu-item.open > .menu-link .caret {
      transform: rotate(90deg);
    }

    /* When submenu is collapsed ensure no gap is left by list item padding */
    .menu-item > .menu-link { padding: 12px 14px; display:flex; align-items:center; gap:12px; border-radius:8px; }
    .menu-item > .menu-link:focus, .menu-item > .menu-link:hover { background: rgba(255,255,255,0.02); }

    /* small responsive fix: reduce submenu padding on narrow screens */
    @media (max-width:700px){
      .submenu-link { padding:8px 12px; font-size:14px; }
      .menu-item > .menu-link { padding:10px 12px; }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>
  <div id="app" class="app" data-theme="light">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary navigation">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">T</div>
        <div class="brand-info">
          <div class="brand-title">Trackline</div>
          <div class="brand-sub">Plan, Track, Deliver.</div>
        </div>
      </div>

      <nav class="nav" role="menu" aria-label="Main">
        <ul class="menu-root">

          <!-- Dashboard -->
          <li class="menu-item {% if page == 'dashboard' %}active{% endif %}">
            <a href="{% url 'dashboard' %}" class="menu-link ripple" role="menuitem" aria-current="{% if page == 'dashboard' %}true{% else %}false{% endif %}">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-tachometer-alt"></i></span>
              <span class="label">Dashboard</span>
            </a>
          </li>

          <!-- Projects -->
          <li class="menu-item has-sub {% if page == 'projects' or page == 'project_create' or page == 'subprojects' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'projects' or page == 'project_create' or page == 'subprojects' %}true{% else %}false{% endif %}" aria-controls="submenu-projects" aria-haspopup="true">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-folder-open"></i></span>
              <span class="label">Projects</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-projects" class="submenu" role="menu" aria-label="Projects submenu">
              <li role="none" class="{% if page == 'projects' %}active{% endif %}">
                <a href="{% url 'projects_list' %}" class="submenu-link ripple" role="menuitem">
                  <i class="fa-solid fa-list"></i>
                  <span>All Projects</span>
                </a>
              </li>
              <li role="none" class="{% if page == 'project_create' %}active{% endif %}">
                <a href="{% url 'project_create' %}" class="submenu-link ripple" role="menuitem">
                  <i class="fa-solid fa-plus-circle"></i>
                  <span>Create Project</span>
                </a>
              </li>
            </ul>
          </li>

          <!-- Tasks -->
          <li class="menu-item has-sub {% if page == 'tasks' or page == 'my_tasks' or page == 'unassigned' or page == 'task_board' or page == 'bulk_import' or page == 'task_create' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'tasks' or page == 'my_tasks' or page == 'unassigned' or page == 'task_board' or page == 'bulk_import' or page == 'task_create' %}true{% else %}false{% endif %}" aria-controls="submenu-tasks">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-tasks"></i></span>
              <span class="label">Tasks</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-tasks" class="submenu" role="menu" aria-label="Tasks submenu">
              <li role="none" class="{% if page == 'my_tasks' %}active{% endif %}">
                <a href="{% url 'my_tasks' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-clipboard-list"></i><span>My Tasks</span></a>
              </li>
              <li role="none" class="{% if page == 'unassigned' %}active{% endif %}">
                <a href="{% url 'unassigned_tasks' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user-clock"></i><span>Unassigned Tasks</span></a>
              </li>
              <li role="none" class="{% if page == 'task_create' %}active{% endif %}">
                <a href="{% url 'create_task' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-plus"></i><span>Create Task</span></a>
              </li>
              <li role="none" class="{% if page == 'bulk_import' %}active{% endif %}">
                <a href="{% url 'bulk_import' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-file-csv"></i><span>Bulk Import (CSV)</span></a>
              </li>
              <li role="none" class="{% if page == 'task_board' %}active{% endif %}">
                <a href="{% url 'task_board' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-th-large"></i><span>Task Board</span></a>
              </li>
            </ul>
          </li>

          <!-- Time Tracking -->
          <li class="menu-item has-sub {% if page == 'time_tracking' or page == 'timer' or page == 'time_entries' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'time_tracking' or page == 'timer' or page == 'time_entries' %}true{% else %}false{% endif %}" aria-controls="submenu-time">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-clock"></i></span>
              <span class="label">Time Tracking</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-time" class="submenu" role="menu" aria-label="Time tracking submenu">
              <li role="none" class="{% if page == 'timer' %}active{% endif %}">
                <a href="{% url 'timer_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-stopwatch"></i><span>Start/Stop Timer</span></a>
              </li>
              <li role="none" class="{% if page == 'time_entries' %}active{% endif %}">
                <a href="{% url 'time_entries_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-list-check"></i><span>Time Entries / Approve</span></a>
              </li>
            </ul>
          </li>

          <!-- Teams -->
          <li class="menu-item has-sub {% if page == 'people' or page == 'teams' or page == 'roles' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'people' or page == 'teams' or page == 'roles' %}true{% else %}false{% endif %}" aria-controls="submenu-people">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-users"></i></span>
              <span class="label">Teams &amp; People</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-people" class="submenu" role="menu" aria-label="Teams and people submenu">
              <li role="none" class="{% if page == 'people' %}active{% endif %}">
                <a href="{% url 'people_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user"></i><span>People</span></a>
              </li>
              <li role="none" class="{% if page == 'teams' %}active{% endif %}">
                <a href="{% url 'teams_page' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-user-friends"></i><span>Teams</span></a>
              </li>
            </ul>
          </li>

          <!-- Employees -->
          <li class="menu-item {% if page == 'employees' %}active{% endif %}">
            <a href="{% url 'employees_page' %}" class="menu-link ripple" role="menuitem" aria-current="{% if page == 'employees' %}true{% else %}false{% endif %}">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-id-card"></i></span>
              <span class="label">Employees</span>
            </a>
          </li>

          <!-- Reports -->
          <li class="menu-item {% if page == 'reports' %}active{% endif %}">
            <a href="{% url 'projects_report' %}" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-chart-bar"></i></span>
              <span class="label">Reports</span>
            </a>
          </li>

          <!-- Notifications -->
          <li class="menu-item {% if page == 'notifications' %}active{% endif %}">
            <a href="{% url 'notifications_page' %}" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-bell"></i></span>
              <span class="label">Notifications</span>
            </a>
          </li>

          <!-- Settings -->
          <li class="menu-item has-sub {% if page == 'settings' or page == 'workflows' or page == 'priorities' or page == 'workweek' %}open{% endif %}">
            <button class="menu-link sub-toggle ripple" aria-expanded="{% if page == 'settings' or page == 'workflows' or page == 'priorities' or page == 'workweek' %}true{% else %}false{% endif %}" aria-controls="submenu-settings">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-cog"></i></span>
              <span class="label">Settings</span>
              <span class="caret" aria-hidden="true">▸</span>
            </button>
            <ul id="submenu-settings" class="submenu" role="menu" aria-label="Settings submenu">
             <li role="none" class="{% if page == 'workflows' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-stream"></i><span>Workflows</span></a></li>
            <li role="none" class="{% if page == 'priorities' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-flag"></i><span>Priorities</span></a></li>
            <li role="none" class="{% if page == 'workweek' %}active{% endif %}"><a href="#" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-calendar-week"></i><span>Work Week</span></a></li>

            <li role="none" class="{% if page == 'change_password' %}active{% endif %}"><a href="{% url 'change_password' %}" class="submenu-link ripple" role="menuitem"><i class="fa-solid fa-key"></i><span>Change Password</span></a></li>

            <li role="none" class="{% if page == 'roles' %}active{% endif %}">
              <a href="{% url 'roles_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-user-shield"></i><span>Roles &amp; Permissions</span>
              </a>
            </li>

            <li role="none" class="{% if page == 'access_control' %}active{% endif %}">
              <a href="{% url 'access_control_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-lock"></i><span>Access Control</span>
              </a>
            </li>

            <li role="none" class="{% if page == 'password_policy' %}active{% endif %}">
              <a href="{% url 'password_policy_page' %}" class="submenu-link ripple" role="menuitem">
                <i class="fa-solid fa-shield-alt"></i><span>Password Policy</span>
              </a>
            </li>

            </ul>
          </li>

          {% if request.session.role and 'PDL' in request.session.role %}
          <li class="menu-item {% if page == 'admin' %}active{% endif %}">
            <a href="#" class="menu-link ripple" role="menuitem">
              <span class="icon" aria-hidden="true"><i class="fa-solid fa-user-shield"></i></span>
              <span class="label">Admin</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>

      <!-- Sidebar signed-in area -->
      <div class="sidebar-footer" role="region" aria-label="Signed in user">
        <div class="profile-actions" role="toolbar" aria-label="Profile actions">
          <a class="btn-ghost" href="{% url 'profile' %}" title="View profile">Profile</a>
          <a class="btn-ghost" href="{% url 'logout' %}" title="Log out">Log out</a>
        </div>
      </div>
    </aside>

    <!-- HEADER + MAIN -->
    <div style="flex:1 1 auto;display:flex;flex-direction:column;min-height:100vh">
      <header class="header" role="banner">
        <div class="header-left">
          <button id="menu-toggle" class="menu-btn ripple" aria-label="Toggle menu" title="Toggle menu">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
          </button>
          <div class="search-wrapper" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="search-icon" aria-hidden="true"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
            <input id="global-search" placeholder="Search projects, people, tickets..." aria-label="Search" />
          </div>
        </div>

        <div class="header-right">
          <div style="display: flex; align-items: center; gap: 18px;">
            <!-- Timer Display in Header (always present, event-driven) -->
            <span id="header-timer" style="display:none;align-items:center;gap:18px;background:#fff;padding:6px 18px 6px 10px;border-radius:24px;box-shadow:0 2px 16px 0 rgba(37,99,235,0.08);min-width:220px;">
              <span class="header-timer-progress">
                <svg width="36" height="36" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="15" fill="#f3f4f6" stroke="#e5e7eb" stroke-width="3"/>
                  <circle id="header-timer-progress-bar" cx="18" cy="18" r="15" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-dasharray="94.2" stroke-dashoffset="94.2"/>
                </svg>
                <span class="header-timer-play">
                  <svg width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="9" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                    <polygon points="8,6 15,10 8,14" fill="#2563eb" stroke="#2563eb" stroke-width="1"/>
                  </svg>
                </span>
              </span>
              <span style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                <span id="header-timer-label" style="font-size:1.1rem;font-weight:700;color:#222;font-family:'Inter',sans-serif;letter-spacing:1px;">00:00:00</span>
                <span id="header-timer-task" style="font-size:0.95rem;color:#374151;font-weight:500;margin-left:0;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                <span id="header-timer-status" style="font-size:0.9rem;margin-left:6px;"></span>
              </span>
            </span>
            <!-- Notifications -->
            <div style="position: relative;">
              <button id="notifications" class="btn-ghost" aria-label="Notifications" title="Notifications" onclick="toggleNotificationsDropdown()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 0 0-5-5.917V4a2 2 0 1 0-4 0v1.083A6 6 0 0 0 4 11v3.159c0 .538-.214 1.055-.595 1.436L2 17h5m8 0a3 3 0 0 1-6 0"/></svg>
                <span id="notif-badge" class="hidden" style="position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;font-size:11px;font-weight:600;padding:2px 6px;border-radius:10px;min-width:20px;text-align:center;">0</span>
              </button>
              <!-- Notifications Dropdown -->
              <div id="notifications-dropdown" style="display:none;position:absolute;right:0;top:calc(100% + 8px);width:380px;max-height:500px;overflow-y:auto;background:white;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:9999;">
                <div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                  <h3 style="margin:0;font-size:16px;font-weight:700;color:#1f2937;">Notifications</h3>
                  <a href="{% url 'notifications_page' %}" style="font-size:13px;color:#3b82f6;text-decoration:none;font-weight:500;">View All</a>
                </div>
                <div id="notifications-list" style="max-height:400px;overflow-y:auto;">
                  <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
                    <i class="fa fa-spinner fa-spin" style="font-size:24px;"></i>
                    <p style="margin-top:12px;font-size:14px;">Loading...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <a href="{% url 'profile' %}" class="user-mini-box" title="View Profile">
            <div class="avatar-sm">
              {% if request.session.profile_photo %}
                <img src="{{ MEDIA_URL }}{{ request.session.profile_photo }}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
              {% elif request.session.cn and request.session.cn|length > 0 %}
                {{ request.session.cn|first|upper }}
              {% elif request.session.member_name and request.session.member_name|length > 0 %}
                {{ request.session.member_name|first|upper }}
              {% elif request.user.is_authenticated and request.user.username and request.user.username|length > 0 %}
                {{ request.user.username|first|upper }}
              {% else %}
                ?
              {% endif %}
            </div>
            <div class="user-name">
              {% if request.session.cn and request.session.cn|length > 0 %}
                {{ request.session.cn }}
              {% elif request.session.member_name and request.session.member_name|length > 0 %}
                {{ request.session.member_name }}
              {% elif request.user.is_authenticated and request.user.username and request.user.username|length > 0 %}
                {{ request.user.username }}
              {% else %}User{% endif %}
            </div>
          </a>
          <style>
            .user-mini-box {
              display: flex;
              align-items: center;
              gap: 10px;
              background: #f3f4f6;
              border-radius: 22px;
              padding: 4px 16px 4px 8px;
              box-shadow: 0 2px 8px rgba(37,99,235,0.08);
              text-decoration: none;
              color: #222;
              font-weight: 600;
              transition: box-shadow 0.18s, background 0.18s;
              margin-left: 2px;
            }
            .user-mini-box:hover {
              background: #e0e7ff;
              box-shadow: 0 4px 16px rgba(37,99,235,0.13);
              color: #2563eb;
            }
            .avatar-sm {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: #2563eb;
              color: #fff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.2rem;
              font-weight: 700;
              box-shadow: 0 1px 4px rgba(37,99,235,0.10);
            }
            .user-name {
              font-size: 1rem;
              font-weight: 600;
              color: #222;
              letter-spacing: 0.2px;
              margin-left: 2px;
            }
          </style>
        </div>
      </header>

      <main class="main" role="main">
        <div class="container">
          <div class="page-title">
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              {% block actions %}{% endblock %}
            </div>
          </div>

          {% block content %}{% endblock %}

          <footer class="footer" role="contentinfo">
            <div>© {{ now|date:"Y" }} MavionTech</div>
            <div class="small muted">Project Management • Version 0.1</div>
          </footer>
        </div>
      </main>
    </div>
  </div>
  {# ----------------- CHAT WIDGET: pinned to footer (chat app namespace = "chat") ----------------- #}
  {# Add the static files to your static/chat/ path: chat_widget.css and chat_widget.js #}
  <link rel="stylesheet" href="{% static 'chat/chat_widget.css' %}">


  <div id="chat-shortcut" aria-hidden="false" style="position:fixed;right:22px;bottom:18px;z-index:1400">
    <button id="chat-open-btn" title="Open team chat" class="chat-fab" aria-label="Open chat" onclick="setChatState('windowed')" style="width: 50px;height: 50px;border-radius:999px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;background:linear-gradient(135deg,#2563eb,#38bdf8);box-shadow:0 10px 30px rgba(8,20,40,0.18);transition:all 0.3s ease;">
      <i class="fa fa-comments" aria-hidden="true" style="font-size:28px;color:#fff"></i>
      <span id="chat-unread-badge" class="hidden" style="position:absolute;right:-6px;top:-6px;background:#ff3b30;color:#fff;border-radius:999px;padding:4px 6px;font-size:14px"></span>
    </button>

    <div id="chat-panel" class="hidden" role="dialog" aria-label="Team chat" style="width:540px;max-height:88vh;background:linear-gradient(135deg,#2563eb 80%,#38bdf8 100%);border-radius:16px;box-shadow:0 24px 80px rgba(2,6,23,0.40);overflow:hidden;margin-top:10px;">
      <div class="chat-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
        <div class="chat-title" style="font-weight:700;font-size:18px;">Team chat</div>
        <button id="chat-close-btn" class="icon-btn" aria-label="Close chat" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><i class="fa fa-times" aria-hidden="true"></i></button>
      </div>

      <div class="chat-body" style="display:flex;min-height:420px;">
        <div class="chat-members" style="width:200px;border-right:1px solid #e0e7ff;padding:12px;background:#f1f5fd;">
          <input id="chat-member-search" placeholder="Search members..." style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #c7d7f6;margin-bottom:12px;font-size:15px;" />
          <ul id="chat-members-list" style="list-style:none;padding:0;margin:0;max-height:66vh;overflow:auto;"></ul>
        </div>

        <div id="chat-window" class="chat-window hidden" style="flex:1;display:flex;flex-direction:column;">
          <div id="chat-history" style="flex:1;padding:18px;overflow:auto;background:linear-gradient(to bottom,#e0e7ff 0%,#f7fbff 100%)"></div>
          <div class="chat-input" style="display:flex;gap:12px;padding:14px;border-top:1px solid #e0e7ff;background:#f1f5fd;">
            <input id="chat-input" placeholder="Write a message..." autocomplete="off" style="flex:1;padding:12px 14px;border-radius:10px;border:1px solid #c7d7f6;font-size:15px;" />
            <button id="chat-send" class="btn" style="padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,#2563eb,#38bdf8);color:#fff;cursor:pointer;font-size:15px;font-weight:600;">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const TENANT_ID = "{{ request.session.tenant_id|default:'' }}";
      function setNotifCount(n){
        const b = document.getElementById('notif-badge');
        if(!b) return;
        if(!n || n <= 0){ b.classList.add('hidden'); b.style.display='none'; }
        else { b.classList.remove('hidden'); b.style.display='block'; b.textContent = n; }
      }

      async function fetchTotals(){
        try{
          let total = 0;
          // DM unread
          const r1 = await fetch('/chat/unread/', {credentials:'same-origin'});
          if(r1.ok){ const d = await r1.json(); if(d && d.unread) total += d.unread.reduce((s,i)=>s+(i.count||0),0); }
          // Groups unread
          const r2 = await fetch('/chat/groups/', {credentials:'same-origin'});
          if(r2.ok){ const d = await r2.json(); if(d && d.groups) total += d.groups.reduce((s,g)=>s+(g.unread||0),0); }
          setNotifCount(total);
        }catch(e){ console.warn('fetchTotals failed', e); }
      }

      // WebSocket to notifications presence group
      try{
        const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const url = `${scheme}://${window.location.host}/ws/notifications/?tenant=${encodeURIComponent(TENANT_ID)}`;
        const nws = new WebSocket(url);
        nws.onopen = ()=>{ fetchTotals(); };
        nws.onmessage = (ev)=>{
          let msg; try{ msg = JSON.parse(ev.data); }catch(e){return}
          if(msg.event === 'new_message' || msg.event === 'new_group_message'){
            // if user is not on /chat page, increment badge; else ignore
            if(!window.location.pathname.startsWith('/chat')){
              // small increment UI (best-effort) then refresh totals
              const b = document.getElementById('notif-badge');
              if(b){ let cur = parseInt(b.textContent||'0')||0; cur+=1; setNotifCount(cur); }
            } else {
              // user is on chat page — clear
              setNotifCount(0);
            }
          }
        };
        nws.onclose = ()=>{ /* ignore */ };
      }catch(e){ console.warn('Notification WS failed', e); }

      // When clicking chat button, clear all chat notifications first
      const chatBtn = document.getElementById('chat-open-btn');
      if(chatBtn){
        chatBtn.addEventListener('click', async function(ev){
          try{
            await fetch('/chat/mark_all_read/', { method:'POST', credentials:'same-origin', headers:{ 'Content-Type':'application/json','X-CSRFToken': (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '' }, body: JSON.stringify({}) });
            setNotifCount(0);
          }catch(e){ console.warn('mark_all_read failed', e); }
        });
      }

      // periodically refresh totals when not on chat
      setInterval(()=>{ if(!window.location.pathname.startsWith('/chat')) fetchTotals(); else setNotifCount(0); }, 6000);
    })();
  </script>


  <script src="{% static 'chat/chat_widget.js' %}"></script>
  {# ----------------- end chat widget ----------------- #}

  <script>
    const SIDEBAR_KEY = 'trackline.sidebar.state';

    // --- Submenu controller (only one open at a time) ---
    (function(){
      document.querySelectorAll('.sub-toggle').forEach(btn=>{
        const id = btn.getAttribute('aria-controls');            // e.g. submenu-tasks
        const li = btn.closest('.menu-item');

        btn.addEventListener('click', function(e){
          e.preventDefault();

          // toggle current
          const isNowOpen = li.classList.toggle('open');
          btn.setAttribute('aria-expanded', isNowOpen ? 'true' : 'false');

          // close any other open menu-item (only keep this one open)
          document.querySelectorAll('.menu-item.open').forEach(other=>{
            if (other === li) return; // skip the one we just toggled
            other.classList.remove('open');

            // ensure button aria-expanded for the other submenu is false
            const otherBtn = other.querySelector('.sub-toggle');
            if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');

            // defensive: remove inline max-height/padding if any left by legacy code
            const otherSub = other.querySelector('.submenu');
            if (otherSub) {
              otherSub.style.maxHeight = null;
              otherSub.style.paddingTop = null;
              otherSub.style.paddingBottom = null;
            }
          });

          // persist per-submenu and collapsed state into localStorage
          try {
            const saved = JSON.parse(localStorage.getItem(SIDEBAR_KEY) || "{}");

            // set this submenu state
            saved[id] = isNowOpen;

            // ensure all other submenu keys are set to false (so only this one opens next time)
            document.querySelectorAll('.sub-toggle').forEach(b=>{
              const k = b.getAttribute('aria-controls');
              if (k !== id) saved[k] = false;
            });

            localStorage.setItem(SIDEBAR_KEY, JSON.stringify(saved));
          } catch(e) {
            // ignore storage errors
          }
        });

        // keyboard activation
        btn.addEventListener('keydown', function(e){
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
        });
      });

      // On first load: restore previously saved open submenu state (if any)
      try {
        const saved = JSON.parse(localStorage.getItem(SIDEBAR_KEY) || "{}");
        Object.keys(saved).forEach(k=>{
          if (saved[k]) {
            const btn = document.querySelector(`[aria-controls="${k}"]`);
            if (btn) {
              const li = btn.closest('.menu-item');
              li.classList.add('open');
              btn.setAttribute('aria-expanded','true');
            }
          }
        });
      } catch(e){ /* ignore */ }

    })();
  </script>
  <script>
    // {% comment %}
    //   Expose canonical CURRENT_USER to client JS.
    //   Use session member_id (set at login); fall back safely.
    // {% endcomment %}
    // {% if request.session.member_id %}
    //   const CURRENT_USER = "{{ request.session.member_id|escapejs }}";
    // {% elif request.session.ident_email %}
    //   const CURRENT_USER = "{{ request.session.ident_email|escapejs }}";
    // {% elif request.user.is_authenticated %}
    //   const CURRENT_USER = "{{ request.user.email|default:request.user.username|escapejs }}";
    // {% else %}
    //   const CURRENT_USER = "";
    // {% endif %}

    const TENANT_ID = "{{ request.session.tenant_id|default:''|escapejs }}";
    // debug helper (remove in production)
    console.debug("[chat] CURRENT_USER on page load ->", CURRENT_USER);
  </script>

  {% block extra_js %}{% endblock %}
  <script>
  // --- Header Timer Logic ---
  let headerTimerInterval = null;
  let headerTimerActive = false;
  let headerTimerStart = null;
  let headerTimerTask = null;

  // Restore timer state from localStorage on page load
  document.addEventListener('DOMContentLoaded', function() {
    const timerState = localStorage.getItem('headerTimerState');
    if (timerState) {
      try {
        const state = JSON.parse(timerState);
        if (state.active && state.startTime) {
          showHeaderTimer(state.startTime, state.taskName || '');
        }
      } catch (e) {}
    }
  });

  function showHeaderTimer(startTime, taskName) {
    headerTimerActive = true;
    headerTimerStart = startTime ? new Date(startTime) : new Date();
    headerTimerTask = taskName || '';
    document.getElementById('header-timer').style.display = 'inline-flex';
    document.getElementById('header-timer-task').textContent = taskName ? `Task: ${taskName}` : '';
    document.getElementById('header-timer-status').innerHTML = `<span class='header-timer-status-badge'>Open</span>`;
    updateHeaderTimerDisplay();
    if (headerTimerInterval) clearInterval(headerTimerInterval);
    headerTimerInterval = setInterval(updateHeaderTimerDisplay, 1000);

    // Persist timer state
    localStorage.setItem('headerTimerState', JSON.stringify({
      active: true,
      startTime: headerTimerStart.toISOString(),
      taskName: headerTimerTask
    }));
  }

  function hideHeaderTimer() {
    headerTimerActive = false;
    document.getElementById('header-timer').style.display = 'none';
    document.getElementById('header-timer-label').textContent = '00:00:00';
    document.getElementById('header-timer-task').textContent = '';
    document.getElementById('header-timer-status').innerHTML = '';
    setHeaderTimerProgress(0);
    if (headerTimerInterval) clearInterval(headerTimerInterval);

    // Remove timer state
    localStorage.removeItem('headerTimerState');
  }

  function updateHeaderTimerDisplay() {
    if (!headerTimerActive || !headerTimerStart) return;
    const now = new Date();
    let elapsed = Math.floor((now - headerTimerStart) / 1000);
    document.getElementById('header-timer-label').textContent = formatHeaderTime(elapsed);
    // Animate progress bar (0-60s loop for demo, or you can use task duration/goal)
    setHeaderTimerProgress((elapsed % 60) / 60);
  }

  function setHeaderTimerProgress(progress) {
    // progress: 0.0 to 1.0
    const circle = document.getElementById('header-timer-progress-bar');
    if (!circle) return;
    const total = 2 * Math.PI * 24; // r=24
    const offset = total * (1 - progress);
    circle.setAttribute('stroke-dashoffset', offset);
  }

  function formatHeaderTime(seconds) {
    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  // Example: Integrate with timer start/stop events
  window.addEventListener('startTaskTimer', function(e) {
    // e.detail = { startTime, taskName }
    if (headerTimerActive) {
      alert('Please stop or pause the current timer before starting a new one.');
      return;
    }
    showHeaderTimer(e.detail.startTime, e.detail.taskName);
  });

  window.addEventListener('stopTaskTimer', function(e) {
    hideHeaderTimer();
  });

  // To trigger: dispatchEvent(new CustomEvent('startTaskTimer', { detail: { startTime: ..., taskName: ... } }))
  // To stop: dispatchEvent(new CustomEvent('stopTaskTimer'))
  </script>
  
  <!-- Global Search Functionality -->
  <style>
    .search-results-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      max-height: 500px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
    }
    
    .search-results-dropdown.show {
      display: block;
    }
    
    .search-wrapper {
      position: relative;
    }
    
    .search-result-section {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    
    .search-result-section:last-child {
      border-bottom: none;
    }
    
    .search-section-title {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 700;
      color: #6b7280;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .search-result-item {
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-result-item:hover {
      background: #f3f4f6;
    }
    
    .search-result-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .search-result-icon.project {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .search-result-icon.task {
      background: #d1fae5;
      color: #065f46;
    }
    
    .search-result-icon.person {
      background: #fef3c7;
      color: #92400e;
    }
    
    .search-result-icon.team {
      background: #e0e7ff;
      color: #4338ca;
    }
    
    .search-result-info {
      flex: 1;
      min-width: 0;
    }
    
    .search-result-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .search-result-meta {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .search-no-results {
      padding: 40px 20px;
      text-align: center;
      color: #9ca3af;
    }
    
    .search-loading {
      padding: 20px;
      text-align: center;
      color: #6b7280;
    }
  </style>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle
    var toggleBtn = document.getElementById('menu-toggle');
    var sidebar = document.getElementById('sidebar');
    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-collapsed');
        if (sidebar.classList.contains('sidebar-collapsed')) {
          localStorage.setItem('sidebar-collapsed', '1');
        } else {
          localStorage.removeItem('sidebar-collapsed');
        }
      });
      if (localStorage.getItem('sidebar-collapsed') === '1') {
        sidebar.classList.add('sidebar-collapsed');
      }
    }
    
    // Global Search Implementation
    const searchInput = document.getElementById('global-search');
    const searchWrapper = document.querySelector('.search-wrapper');
    
    if (searchInput && searchWrapper) {
      // Create results dropdown
      const resultsDropdown = document.createElement('div');
      resultsDropdown.className = 'search-results-dropdown';
      searchWrapper.appendChild(resultsDropdown);
      
      let searchTimeout;
      let currentResults = {
        projects: [],
        tasks: [],
        people: [],
        teams: []
      };
      
      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          resultsDropdown.classList.remove('show');
          return;
        }
        
        resultsDropdown.innerHTML = '<div class="search-loading"><i class="fa fa-spinner fa-spin"></i> Searching...</div>';
        resultsDropdown.classList.add('show');
        
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchWrapper.contains(e.target)) {
          resultsDropdown.classList.remove('show');
        }
      });
      
      function performSearch(query) {
        const searchTerm = query.toLowerCase();
        
        // Comprehensive search across all content
        const allResults = {
          pages: [],
          projects: [],
          tasks: [],
          people: [],
          teams: [],
          features: [],
          files: []
        };
        
        // Search navigation menu items (most immediate results)
        searchNavigationItems(searchTerm, allResults);
        
        // Search all visible page content
        searchPageContent(searchTerm, allResults);
        
        // Try to fetch from APIs if available (including tasks)
        Promise.all([
          fetchProjects(query),
          fetchTasks(query),
          fetchPeople(query),
          fetchTeams(query)
        ]).then(([projects, tasks, people, teams]) => {
          allResults.projects = projects;
          allResults.tasks = tasks;
          allResults.people = people;
          allResults.teams = teams;
          
          displayResults(allResults);
        }).catch(() => {
          // If API calls fail, just show what we found in the page
          displayResults(allResults);
        });
      }
      
      function searchNavigationItems(query, results) {
        const menuItems = document.querySelectorAll('.menu-link, .submenu-link');
        const foundPages = [];
        
        menuItems.forEach(item => {
          const text = item.textContent.toLowerCase().trim();
          const spanText = item.querySelector('span:last-child, .label')?.textContent.toLowerCase().trim();
          
          if (text.includes(query) || (spanText && spanText.includes(query))) {
            const href = item.getAttribute('href');
            let title = item.querySelector('span:last-child, .label')?.textContent.trim() || item.textContent.trim();
            
            // Clean up title
            title = title.replace(/\s+/g, ' ').trim();
            
            // Get icon if exists
            const icon = item.querySelector('i')?.className || 'fa fa-arrow-right';
            
            if (href && href !== '#' && !foundPages.some(p => p.href === href)) {
              // Determine category
              let category = 'Navigation';
              if (text.includes('project')) category = 'Projects';
              else if (text.includes('task')) category = 'Tasks';
              else if (text.includes('people') || text.includes('team')) category = 'Team';
              else if (text.includes('report')) category = 'Reports';
              else if (text.includes('employee')) category = 'Employees';
              else if (text.includes('setting')) category = 'Settings';
              
              foundPages.push({ 
                title, 
                href, 
                icon,
                category,
                type: 'page' 
              });
            }
          }
        });
        
        results.pages = foundPages;
      }
      
      function searchPageContent(query, results) {
        // Search for any text on the current page that might be relevant
        const headings = document.querySelectorAll('h1, h2, h3, h4, .card-title, .page-title');
        const features = [];
        
        headings.forEach(heading => {
          const text = heading.textContent.toLowerCase().trim();
          if (text.includes(query) && text.length < 100) {
            features.push({
              title: heading.textContent.trim(),
              description: 'Found on current page',
              type: 'feature'
            });
          }
        });
        
        results.features = features.slice(0, 5);
      }
      
      function fetchProjects(query) {
        return fetch(`/projects/ajax/search/?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => data.results || [])
          .catch(() => []);
      }
      
      function fetchTasks(query) {
        // Search tasks if API is available
        return fetch(`/tasks/api/search/?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => (data.tasks || []).slice(0, 5))
          .catch(() => []);
      }
      
      function fetchPeople(query) {
        return fetch(`/api/people/list`)
          .then(res => res.json())
          .then(data => {
            const people = data.members || [];
            return people.filter(p => {
              const fullName = (p.first_name + ' ' + p.last_name).toLowerCase();
              const email = (p.email || '').toLowerCase();
              return fullName.includes(query) || email.includes(query);
            }).slice(0, 5);
          })
          .catch(() => []);
      }
      
      function fetchTeams(query) {
        return fetch(`/api/teams/list`)
          .then(res => res.json())
          .then(data => {
            const teams = data.teams || [];
            return teams.filter(t => 
              (t.name || '').toLowerCase().includes(query) ||
              (t.description || '').toLowerCase().includes(query)
            ).slice(0, 5);
          })
          .catch(() => []);
      }
      
      function displayResults(results) {
        let html = '';
        let hasResults = false;
        
        // Page Navigation Results (show first for quick access)
        if (results.pages && results.pages.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-compass"></i> Quick Navigation</div>';
          results.pages.forEach(page => {
            const iconClass = page.icon || 'fa fa-arrow-right';
            html += `
              <a href="${page.href}" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon" style="background: #e0e7ff; color: #4338ca;">
                  <i class="${iconClass}"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(page.title)}</div>
                  <div class="search-result-meta">${escapeHtml(page.category)}</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }
        
        // Projects section
        if (results.projects && results.projects.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-folder"></i> Projects</div>';
          results.projects.forEach(project => {
            html += `
              <a href="/projects/${project.id}/edit/" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon project">
                  <i class="fa fa-folder"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(project.name)}</div>
                  <div class="search-result-meta">Project</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }
        
        // Tasks section
        if (results.tasks && results.tasks.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-tasks"></i> Tasks</div>';
          results.tasks.forEach(task => {
            const meta = (task.project_name ? task.project_name : task.assigned_to_display || task.status || 'Task');
            html += `
              <a href="/tasks/${task.id}/" class="search-result-item" style="text-decoration: none; color: inherit;">
                <div class="search-result-icon task">
                  <i class="fa fa-tasks"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(task.title)}</div>
                  <div class="search-result-meta">${escapeHtml(meta)}</div>
                </div>
              </a>
            `;
          });
          html += '</div>';
        }

        // People section
        if (results.people && results.people.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-user"></i> People</div>';
          results.people.forEach(person => {
            html += `
              <div class="search-result-item" onclick="window.location.href='/people/'">
                <div class="search-result-icon person">
                  <i class="fa fa-user"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(person.first_name + ' ' + person.last_name)}</div>
                  <div class="search-result-meta">${escapeHtml(person.email)}</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        // Teams section
        if (results.teams && results.teams.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-users"></i> Teams</div>';
          results.teams.forEach(team => {
            html += `
              <div class="search-result-item" onclick="window.location.href='/teams/'">
                <div class="search-result-icon team">
                  <i class="fa fa-users"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(team.name)}</div>
                  <div class="search-result-meta">Team</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        // Features found on current page
        if (results.features && results.features.length > 0) {
          hasResults = true;
          html += '<div class="search-result-section">';
          html += '<div class="search-section-title"><i class="fa fa-info-circle"></i> Current Page</div>';
          results.features.forEach(feature => {
            html += `
              <div class="search-result-item" style="cursor: default;">
                <div class="search-result-icon" style="background: #f3f4f6; color: #6b7280;">
                  <i class="fa fa-bookmark"></i>
                </div>
                <div class="search-result-info">
                  <div class="search-result-title">${escapeHtml(feature.title)}</div>
                  <div class="search-result-meta">${escapeHtml(feature.description)}</div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        if (!hasResults) {
          html = `
            <div class="search-no-results">
              <i class="fa fa-search" style="font-size: 32px; color: #d1d5db; margin-bottom: 12px;"></i>
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No results found</div>
              <div style="font-size: 12px;">Try searching for projects, people, teams, or menu items</div>
            </div>
          `;
        }
        
        resultsDropdown.innerHTML = html;
        resultsDropdown.classList.add('show');
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }
  });
  </script>

  <!-- Notifications System -->
  <script>
  let notificationsDropdownOpen = false;

  // Load notification count on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    
    // Auto-refresh every 30 seconds
    setInterval(updateNotificationCount, 30000);
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('notifications-dropdown');
      const notifBtn = document.getElementById('notifications');
      if (dropdown && !dropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        dropdown.style.display = 'none';
        notificationsDropdownOpen = false;
      }
    });
  });

  function updateNotificationCount() {
    fetch('{% url "api_notifications_unread_count" %}')
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById('notif-badge');
        if (badge) {
          const count = data.count || 0;
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      })
      .catch(error => console.error('Error fetching notification count:', error));
  }

  function toggleNotificationsDropdown() {
    const dropdown = document.getElementById('notifications-dropdown');
    if (!dropdown) return;
    
    notificationsDropdownOpen = !notificationsDropdownOpen;
    
    if (notificationsDropdownOpen) {
      dropdown.style.display = 'block';
      loadNotificationsPreview();
    } else {
      dropdown.style.display = 'none';
    }
  }

  function loadNotificationsPreview() {
    const container = document.getElementById('notifications-list');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:#9ca3af;"><i class="fa fa-spinner fa-spin" style="font-size:24px;"></i><p style="margin-top:12px;font-size:14px;">Loading...</p></div>';
    
    fetch('{% url "api_notifications_list" %}')
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Error loading notifications</div>';
          return;
        }
        
        const notifications = (data.notifications || []).slice(0, 5); // Show only 5 recent
        
        if (notifications.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
              <i class="fa fa-bell-slash" style="font-size:32px;color:#d1d5db;"></i>
              <p style="margin-top:12px;font-size:14px;font-weight:600;">No notifications</p>
              <p style="font-size:12px;margin-top:4px;">You're all caught up!</p>
            </div>
          `;
          return;
        }
        
        let html = '';
        notifications.forEach(notif => {
          const iconClass = getNotifIconClass(notif.type);
          const iconBg = getNotifIconBg(notif.type);
          const timeAgo = getNotifTimeAgo(notif.created_at);
          const unreadDot = !notif.is_read ? '<div style="width:8px;height:8px;background:#3b82f6;border-radius:50%;margin-left:8px;"></div>' : '';
          
          html += `
            <div onclick="handleNotifClick(${notif.id}, '${notif.link || ''}')" style="padding:12px 16px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.2s;${!notif.is_read ? 'background:#eff6ff;' : ''}" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='${!notif.is_read ? '#eff6ff' : 'white'}'">
              <div style="display:flex;gap:12px;align-items:start;">
                <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;${iconBg}">
                  <i class="${iconClass}"></i>
                </div>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;align-items:center;">
                    <div style="font-size:14px;font-weight:600;color:#1f2937;flex:1;">${escapeHtmlNotif(notif.title)}</div>
                    ${unreadDot}
                  </div>
                  <div style="font-size:13px;color:#6b7280;margin-top:2px;line-height:1.4;">${escapeHtmlNotif(notif.message)}</div>
                  <div style="font-size:11px;color:#9ca3af;margin-top:4px;"><i class="fa fa-clock"></i> ${timeAgo}</div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      })
      .catch(error => {
        console.error('Error:', error);
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Failed to load notifications</div>';
      });
  }

  function getNotifIconClass(type) {
    const icons = {
      'info': 'fa fa-info-circle',
      'success': 'fa fa-check-circle',
      'warning': 'fa fa-exclamation-triangle',
      'error': 'fa fa-times-circle',
      'task': 'fa fa-tasks',
      'project': 'fa fa-folder',
      'team': 'fa fa-users'
    };
    return icons[type] || 'fa fa-bell';
  }

  function getNotifIconBg(type) {
    const colors = {
      'info': 'background:#dbeafe;color:#1e40af;',
      'success': 'background:#d1fae5;color:#065f46;',
      'warning': 'background:#fef3c7;color:#92400e;',
      'error': 'background:#fee2e2;color:#991b1b;',
      'task': 'background:#e0e7ff;color:#4338ca;',
      'project': 'background:#dbeafe;color:#1e40af;',
      'team': 'background:#fce7f3;color:#9f1239;'
    };
    return colors[type] || 'background:#f3f4f6;color:#6b7280;';
  }

  function getNotifTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    
    return date.toLocaleDateString();
  }

  function handleNotifClick(id, link) {
    // Mark as read
    fetch('{% url "api_notifications_mark_read" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ id: id })
    })
    .then(() => {
      updateNotificationCount();
      if (link && link !== 'null' && link !== '') {
        window.location.href = link;
      } else {
        window.location.href = '{% url "notifications_page" %}';
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function escapeHtmlNotif(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  </script>

  <!-- Team Chat Widget -->
  <style>
    /* Chat Floating Button Styles */
    #chat-open-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 40px rgba(37, 99, 235, 0.35);
    }

    #chat-open-btn:active {
      transform: scale(0.95);
    }

    /* Chat Widget Styles */
    #chatWrapper {
      display: flex;
      background: #fff;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }

    .state-full {
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      border-radius: 0;
      z-index: 9999;
    }

    .state-windowed {
      width: 90vw;
      height: 85vh;
      max-width: 1200px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 1px solid #E5E7EB;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .state-minimized {
      width: 400px;
      height: 600px;
      position: fixed;
      bottom: 30px;
      right: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      z-index: 9999;
    }

    .state-hidden {
      transform: translate(-50%, 120%);
      opacity: 0;
      pointer-events: none;
    }

    /* Chat Layout */
    .sidebar {
      width: 300px;
      background: #1F2023;
      color: #fff;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #3A3B3E;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      cursor: pointer;
    }

    .sidebar-section {
      padding: 16px 0;
      border-bottom: 1px solid #2d2e31;
    }

    .section-title {
      padding: 8px 20px;
      font-size: 12px;
      font-weight: 600;
      color: #9CA3AF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
      color: #E5E7EB;
      text-decoration: none;
    }

    .nav-item:hover {
      background: #3A3B3E;
    }

    .nav-item.active {
      background: #0A7AFF;
      color: #fff;
    }

    .badge {
      background: #ef4444;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .channel-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .channel-item {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
    }

    .channel-item:hover {
      background: #3A3B3E;
    }

    .channel-item.active {
      background: #0A7AFF;
      font-weight: 600;
    }

    .hash {
      opacity: 0.7;
    }

    .dm-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .dm-item:hover {
      background: #3A3B3E;
    }

    .dm-item.active {
      background: #0A7AFF;
    }

    .dm-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #6366f1;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      flex-shrink: 0;
    }

    .dm-info {
      flex: 1;
      min-width: 0;
    }

    .dm-name {
      font-size: 14px;
      font-weight: 500;
      color: #E5E7EB;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .online-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      border: 2px solid #1F2023;
      position: absolute;
      bottom: -2px;
      right: -2px;
    }

    .dm-avatar-wrapper {
      position: relative;
    }

    .loading {
      padding: 20px;
      text-align: center;
      color: #9CA3AF;
      font-size: 13px;
    }

    .back-link {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #9CA3AF;
      text-decoration: none;
      transition: 0.2s;
      margin-top: auto;
    }

    .back-link:hover {
      background: #3A3B3E;
      color: #E5E7EB;
    }

    .chat-main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      min-width: 0;
    }

    /* Chat Header */
    .chat-header {
      height: 64px;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: #fff;
    }

    .chat-window-controls {
      display: flex;
      gap: 12px;
    }

    .chat-control-btn {
      background: none;
      border: none;
      color: #9CA3AF;
      cursor: pointer;
      font-size: 16px;
      transition: 0.2s;
      padding: 4px;
    }

    .chat-control-btn:hover { color: #0A7AFF; }

    /* Messages Feed */
    .chat-messages-feed {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #fff;
    }

    .chat-message-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      max-width: 80%;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      margin-right: 12px;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    .chat-message-content {
      display: flex;
      flex-direction: column;
    }

    .chat-message-header {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .chat-username { font-weight: 700; color: #111827; }
    .chat-timestamp { color: #9CA3AF; }

    .chat-text {
      background: #F3F4F6;
      padding: 12px 16px;
      border-radius: 18px 18px 18px 4px;
      font-size: 14px;
      line-height: 1.5;
      color: #1F2937;
      max-width: 100%;
      word-wrap: break-word;
    }

    /* Sent Message Styles */
    .chat-message-group.sent-message {
      flex-direction: row-reverse;
      align-self: flex-end;
      margin-left: auto;
    }

    .chat-message-group.sent-message .chat-avatar {
      margin-left: 12px;
      margin-right: 0;
      background: linear-gradient(135deg, #0A7AFF 0%, #4F8CFF 100%);
    }

    .chat-message-group.sent-message .chat-text {
      background: #DBEAFE;
      border-radius: 18px 18px 4px 18px;
      text-align: left;
    }

    .chat-message-group.sent-message .chat-message-header {
      flex-direction: row-reverse;
    }

    /* Input Area */
    .chat-input-area {
      padding: 20px;
      border-top: 1px solid #E5E7EB;
    }

    .chat-input-box {
      display: flex;
      align-items: center;
      background: #f9fafb;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      padding: 8px 16px;
      transition: 0.2s;
    }

    .chat-input-box:focus-within {
      border-color: #0A7AFF;
      background: #fff;
    }

    .chat-input-box input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      padding: 10px;
      font-size: 14px;
    }

    /* Sidebar Elements */
    .chat-nav-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
    }

    .chat-nav-item:hover { background: #3A3B3E; }
    .chat-nav-item.active { background: #0A7AFF; }

    /* Floating Reopen Button */
    #reopenChat {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #0A7AFF;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      box-shadow: 0 10px 20px rgba(10, 122, 255, 0.3);
      cursor: pointer;
      display: none;
      z-index: 9998;
      transition: all 0.3s ease;
    }

    #reopenChat:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 30px rgba(10, 122, 255, 0.4);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <button id="reopenChat" onclick="setChatState('windowed')">
    <i class="fas fa-comments"></i>
  </button>

  <div id="chatWrapper" class="state-hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <span>{{ tenant_name|default:"Team Chat" }}</span>
            <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
        </div>

        <div class="sidebar-section">
            <a href="{% url 'dashboard' %}" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
            <div class="nav-item" id="nav-unread">
                <i class="fas fa-align-left"></i> Unread messages
                <span id="unread-badge" class="badge" style="margin-left:8px; display:none;">0</span>
            </div>
            <div class="nav-item" id="nav-groups"><i class="far fa-comments"></i> Groups <button id="create-group-btn" title="Create group" style="margin-left:8px;background:transparent;border:none;color:var(--sidebar-text);cursor:pointer;">+</button></div>
        </div>

        <div class="sidebar-section">
            <div class="section-title"><span>Groups</span></div>
            <div id="group-list">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading groups...</div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-title">
                <span>Company Name</span>
            </div>
            <ul class="channel-list">
                <li class="channel-item active"><span class="hash">#</span> <span id="channel-name">Software</span></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="section-title">
                <span>Direct messages</span>
            </div>
            <div id="dm-list">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        </div>

        <a href="{% url 'dashboard' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </aside>

    <!-- Main Chat -->
    <main class="chat-main-content">
      <header class="chat-header">
        <div class="header-left" style="display: flex; align-items: center; gap: 10px;">
          <h3 id="chat-header-title" style="font-weight: 700; margin: 0; color: #111827;">@ General Channel</h3>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="position: relative;">
            <i class="fas fa-bell" style="color: #9CA3AF; font-size: 18px; cursor: pointer;"></i>
            <span id="chat-notif-badge" class="badge" style="position: absolute; top: -8px; right: -8px; display: none;">3</span>
          </div>
        
        <div class="chat-window-controls">
          <button class="chat-control-btn" onclick="setChatState('minimized')" title="Minimize to Corner"><i class="fas fa-compress-alt"></i></button>
          <button class="chat-control-btn" onclick="toggleChatFullscreen()" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
          <button class="chat-control-btn" onclick="setChatState('hidden')" title="Close Chat"><i class="fas fa-times"></i></button>
        </div>
      </header>

      <div id="chatMessagesFeed" class="chat-messages-feed">
        <!-- Welcome Message -->
        <div style="text-align: center; margin: 40px 0; color: #999; font-size: 13px;">
          <i class="fas fa-comments" style="font-size: 48px; color: #ddd; margin-bottom: 16px;"></i>
          <p style="font-weight: 600; color: #666;">Welcome to Team Chat!</p>
          <p style="margin-top: 8px;">Start a conversation with your team members.</p>
        </div>
      </div>

      <footer class="chat-input-area">
        <div class="chat-input-box">
          <button class="chat-control-btn"><i class="fas fa-plus"></i></button>
          <button class="chat-control-btn"><i class="far fa-smile"></i></button>
          <input id="chatInput" type="text" placeholder="Type a message to #general...">
          <button class="chat-control-btn" onclick="handleChatSend()" style="color: #0A7AFF;"><i class="fas fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <script>
    const chatWrapper = document.getElementById('chatWrapper');
    const chatSidebar = document.querySelector('.sidebar');
    const reopenChatBtn = document.getElementById('reopenChat');
    const chatFeed = document.getElementById('chatMessagesFeed');
    const chatInput = document.getElementById('chatInput');

    let isChatFullscreen = false;
    let currentChatType = null; // 'dm' or 'group'
    let currentChatId = null; // peer id or group id
    let onlineUsers = new Set(); // Track online user IDs/emails
    let chatWebSocket = null; // WebSocket connection for real-time chat

    // Initialize WebSocket for real-time chat
    function initChatWebSocket() {
      const TENANT_ID = "{{ request.session.tenant_id|default:'' }}";
      if (!TENANT_ID) {
        console.warn('No tenant ID, cannot connect to chat WebSocket');
        return;
      }

      try {
        const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const url = `${scheme}://${window.location.host}/ws/chat/?tenant=${encodeURIComponent(TENANT_ID)}`;
        
        chatWebSocket = new WebSocket(url);
        
        chatWebSocket.onopen = () => {
          console.log('Chat WebSocket connected');
          // Send presence immediately
          sendPresence('online');
        };
        
        chatWebSocket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log('Chat WebSocket message:', data);
            
            if (data.type === 'new_message') {
              // New message received
              handleNewMessage(data);
            } else if (data.type === 'presence_update') {
              // User presence update
              handlePresenceUpdate(data);
            }
          } catch (e) {
            console.error('Error parsing WebSocket message:', e);
          }
        };
        
        chatWebSocket.onclose = () => {
          console.log('Chat WebSocket closed, reconnecting in 3s...');
          setTimeout(initChatWebSocket, 3000);
        };
        
        chatWebSocket.onerror = (error) => {
          console.error('Chat WebSocket error:', error);
        };
      } catch (e) {
        console.error('Failed to initialize chat WebSocket:', e);
      }
    }

    function sendPresence(status) {
      if (chatWebSocket && chatWebSocket.readyState === WebSocket.OPEN) {
        chatWebSocket.send(JSON.stringify({
          type: 'presence',
          status: status // 'online' or 'offline'
        }));
      }
    }

    function handleNewMessage(data) {
      // Check if this message belongs to current conversation
      const messageType = data.chat_type; // 'dm' or 'group'
      const messageId = data.chat_id; // peer id or group id
      
      // If we're viewing this conversation, append the message
      if (currentChatType === messageType && currentChatId == messageId) {
        const chatFeed = document.getElementById('chatMessagesFeed');
        if (!chatFeed) return;
        
        const currentUserEmail = '{{ request.session.ident_email|escapejs }}'.toLowerCase();
        const currentUserName = '{{ request.session.cn|default:request.session.member_name|escapejs }}'.toLowerCase();
        
        const senderEmail = (data.sender_email || '').toLowerCase();
        const senderName = (data.sender_name || '').toLowerCase();
        const isSelf = data.is_self || senderEmail === currentUserEmail || senderName === currentUserName;
        
        const time = new Date(data.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const initial = getInitials(data.sender_name || 'U');
        
        const msgClass = isSelf ? 'sent-message' : '';
        
        const msgHtml = `
          <div class="chat-message-group ${msgClass}" style="animation: slideIn 0.3s ease-out">
            <div class="chat-avatar">${escapeHtml(initial)}</div>
            <div class="chat-message-content">
              <div class="chat-message-header">
                <span class="chat-username">${escapeHtml(data.sender_name || 'Unknown')}</span>
                <span class="chat-timestamp">${time}</span>
              </div>
              <div class="chat-text">${escapeHtml(data.message)}</div>
            </div>
          </div>
        `;
        
        chatFeed.insertAdjacentHTML('beforeend', msgHtml);
        chatFeed.scrollTop = chatFeed.scrollHeight;
      }
      
      // Update unread counts
      refreshUnreadCounts();
    }

    function handlePresenceUpdate(data) {
      const userId = data.user_id;
      const userEmail = (data.user_email || '').toLowerCase();
      const userName = (data.user_name || '').toLowerCase();
      const status = data.status; // 'online' or 'offline'
      
      console.log('Presence update:', userName, status);
      
      if (status === 'online') {
        if (userId) onlineUsers.add(userId.toString());
        if (userEmail) onlineUsers.add(userEmail);
        if (userName) onlineUsers.add(userName);
      } else {
        if (userId) onlineUsers.delete(userId.toString());
        if (userEmail) onlineUsers.delete(userEmail);
        if (userName) onlineUsers.delete(userName);
      }
      
      // Update all online indicators
      document.querySelectorAll('.online-indicator').forEach(indicator => {
        const parent = indicator.closest('.dm-item');
        if (!parent) return;
        
        const memberId = parent.getAttribute('data-member-id');
        const memberEmail = (parent.getAttribute('data-member-email') || '').toLowerCase();
        const memberName = (parent.querySelector('.dm-name')?.textContent || '').toLowerCase().replace(/ ● online$/, '').trim();
        
        const isOnline = onlineUsers.has(memberId) || 
                        onlineUsers.has(memberEmail) || 
                        onlineUsers.has(memberName);
        
        indicator.style.display = isOnline ? 'block' : 'none';
        
        // Update "● Online" text in name
        const nameEl = parent.querySelector('.dm-name');
        if (nameEl) {
          const baseName = nameEl.textContent.replace(/ ● Online$/, '').trim();
          if (isOnline && !baseName.includes('(You)')) {
            nameEl.innerHTML = escapeHtml(baseName) + ' <span style="color: #10b981; font-size: 11px;">● Online</span>';
          } else {
            nameEl.textContent = baseName;
          }
        }
      });
    }

    function setChatState(state) {
      // Reset classes
      chatWrapper.classList.remove('state-full', 'state-windowed', 'state-minimized', 'state-hidden');
      reopenChatBtn.style.display = 'none';
      if (chatSidebar) chatSidebar.style.display = 'flex';

      if (state === 'windowed') {
        chatWrapper.classList.add('state-windowed');
        isChatFullscreen = false;
      } else if (state === 'minimized') {
        chatWrapper.classList.add('state-minimized');
        if (chatSidebar) chatSidebar.style.display = 'none';
        isChatFullscreen = false;
      } else if (state === 'hidden') {
        chatWrapper.classList.add('state-hidden');
        reopenChatBtn.style.display = 'block';
      } else if (state === 'full') {
        chatWrapper.classList.add('state-full');
        isChatFullscreen = true;
      }
      
      // Auto-scroll
      setTimeout(() => { 
        if (chatFeed) chatFeed.scrollTop = chatFeed.scrollHeight; 
      }, 300);
    }

    function toggleChatFullscreen() {
      if (isChatFullscreen) setChatState('windowed');
      else setChatState('full');
    }

    async function handleChatSend() {
      if (!chatInput) return;
      const val = chatInput.value.trim();
      if (!val) return;

      // Check if a chat is selected
      if (!currentChatType || !currentChatId) {
        alert('Please select a conversation first');
        return;
      }

      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const currentUser = '{% if request.session.cn %}{{ request.session.cn }}{% elif request.session.member_name %}{{ request.session.member_name }}{% elif request.user.is_authenticated %}{{ request.user.username }}{% else %}User{% endif %}';
      const userInitial = getInitials(currentUser);
      
      // Display message immediately (optimistic UI)
      const msgHtml = `
        <div class="chat-message-group sent-message" style="animation: slideIn 0.3s ease-out">
          <div class="chat-avatar">${userInitial}</div>
          <div class="chat-message-content">
            <div class="chat-message-header">
              <span class="chat-username">${escapeHtml(currentUser)}</span>
              <span class="chat-timestamp">${time}</span>
            </div>
            <div class="chat-text">${escapeHtml(val)}</div>
          </div>
        </div>
      `;
      
      if (chatFeed) {
        chatFeed.insertAdjacentHTML('beforeend', msgHtml);
        chatInput.value = '';
        chatFeed.scrollTop = chatFeed.scrollHeight;
      }

      // Send message via WebSocket for real-time delivery
      if (chatWebSocket && chatWebSocket.readyState === WebSocket.OPEN) {
        chatWebSocket.send(JSON.stringify({
          type: 'message',
          chat_type: currentChatType,
          chat_id: currentChatId,
          message: val
        }));
      } else {
        // Fallback to HTTP if WebSocket not available
        try {
          let url, body;
          
          if (currentChatType === 'dm') {
            url = '/chat/send/';
            body = JSON.stringify({ 
              to: currentChatId, 
              text: val 
            });
          } else if (currentChatType === 'group') {
            url = '/chat/group/send/';
            body = JSON.stringify({ 
              group_id: currentChatId, 
              text: val 
            });
          }

          const response = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: body
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('Send failed:', response.status, errorText);
            alert('Failed to send message. Please try again.');
            loadChatMessages(currentChatType, currentChatId);
          }
        } catch (e) {
          console.error('Send error:', e);
          alert('Error sending message. Please check your connection.');
          loadChatMessages(currentChatType, currentChatId);
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChatSend();
      });
    }

    // Helper functions
    function getCookie(name) {
      let value = '; ' + document.cookie;
      let parts = value.split('; ' + name + '=');
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    // Load groups and direct messages from backend APIs
    async function loadChatSidebar() {
      await loadGroups();
      await loadDirectMessages();
      await refreshUnreadCounts();
    }

    async function loadGroups() {
      const groupList = document.getElementById('group-list');
      if (!groupList) return;

      try {
        const res = await fetch('/chat/groups/', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load groups');
        
        const data = await res.json();
        const groups = data.groups || [];
        
        groupList.innerHTML = '';
        
        if (groups.length === 0) {
          groupList.innerHTML = '<div style="padding: 12px 20px; color: #6b7280; font-size: 13px;">No groups yet</div>';
        } else {
          groups.forEach(group => {
            const initials = (group.name || 'G').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
            const div = document.createElement('div');
            div.className = 'dm-item';
            div.dataset.groupId = group.id;
            div.innerHTML = `
              <div class="dm-avatar-wrapper">
                <div class="dm-avatar" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%)">${initials}</div>
              </div>
              <div class="dm-info">
                <div class="dm-name">${escapeHtml(group.name)}</div>
              </div>
              ${group.unread > 0 ? `<span class="badge" style="margin-left: auto;">${group.unread}</span>` : ''}
            `;
            div.addEventListener('click', () => selectGroup(group.id, group.name));
            groupList.appendChild(div);
          });
        }
      } catch (e) {
        console.error('loadGroups error:', e);
        groupList.innerHTML = '<div style="padding: 12px 20px; color: #ef4444; font-size: 13px;">Error loading groups</div>';
      }
    }

    async function loadDirectMessages() {
      const dmList = document.getElementById('dm-list');
      if (!dmList) return;

      try {
        const res = await fetch('/chat/members/', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load members');
        
        const data = await res.json();
        const members = data.members || [];
        
        dmList.innerHTML = '';
        
        if (members.length === 0) {
          dmList.innerHTML = '<div style="padding: 12px 20px; color: #6b7280; font-size: 13px;">No members found</div>';
        } else {
          members.forEach(member => {
            const memberId = (member.id !== undefined && member.id !== null) ? member.id.toString() : member.email;
            const memberEmail = (member.email || '').toLowerCase();
            const memberName = (member.name || member.email || 'Unknown').replace(/<[^>]+>/g, '').trim();
            const isSelf = !!member.is_self;
            const initials = getInitials(memberName);
            
            // Get current user info for matching
            const currentUserEmail = '{% if request.session.ident_email %}{{ request.session.ident_email }}{% elif request.user.email %}{{ request.user.email }}{% endif %}'.toLowerCase();
            const currentUserName = '{% if request.session.cn %}{{ request.session.cn }}{% elif request.session.member_name %}{{ request.session.member_name }}{% elif request.user.username %}{{ request.user.username }}{% endif %}'.toLowerCase();
            
            // Check if user is online - match by ID, email, or name
            const isOnline = onlineUsers.has(memberId) || 
                            onlineUsers.has(memberEmail) || 
                            onlineUsers.has(memberName.toLowerCase()) ||
                            (currentUserEmail && memberEmail === currentUserEmail) ||
                            (currentUserName && memberName.toLowerCase() === currentUserName);
            
            const div = document.createElement('div');
            div.className = 'dm-item';
            div.dataset.memberId = memberId;
            div.dataset.memberEmail = memberEmail;
            div.dataset.name = memberName;
            div.dataset.self = isSelf ? 'true' : 'false';
            
            const gradientColors = [
              'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
              'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
              'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
              'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
            ];
            const gradient = gradientColors[Math.abs(memberId.charCodeAt(0) || 0) % gradientColors.length];
            
            div.innerHTML = `
              <div class="dm-avatar-wrapper">
                <div class="dm-avatar" style="background: ${gradient}">${initials}</div>
                <div class="online-indicator" data-user-id="${memberId}" style="display: ${(isOnline && !isSelf) ? 'block' : 'none'};"></div>
              </div>
              <div class="dm-info">
                <div class="dm-name">${escapeHtml(memberName)}${isSelf ? ' (You)' : ''}${(isOnline && !isSelf) ? ' <span style="color: #10b981; font-size: 11px;">● Online</span>' : ''}</div>
              </div>
            `;
            
            if (!isSelf) {
              div.addEventListener('click', () => selectDM(memberId, memberName));
            } else {
              div.style.opacity = '0.6';
              div.style.cursor = 'default';
            }
            
            dmList.appendChild(div);
          });
        }
      } catch (e) {
        console.error('loadDirectMessages error:', e);
        dmList.innerHTML = '<div style="padding: 12px 20px; color: #ef4444; font-size: 13px;">Error loading members</div>';
      }
    }

    function selectDM(memberId, memberName) {
      currentChatType = 'dm';
      currentChatId = memberId;
      
      // Update chat header
      const headerTitle = document.getElementById('chat-header-title');
      if (headerTitle) {
        headerTitle.textContent = `@ ${memberName}`;
      }

      // Update active state
      document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active'));
      const selectedItem = document.querySelector(`.dm-item[data-member-id="${memberId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }

      // Load chat messages for this member
      loadChatMessages('dm', memberId);
    }

    function selectGroup(groupId, groupName) {
      currentChatType = 'group';
      currentChatId = groupId;
      
      // Update chat header
      const headerTitle = document.getElementById('chat-header-title');
      if (headerTitle) {
        headerTitle.innerHTML = `<i class="fas fa-users" style="margin-right:8px;opacity:0.6;"></i> ${escapeHtml(groupName)}`;
      }

      // Update active state
      document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active'));
      const selectedItem = document.querySelector(`.dm-item[data-group-id="${groupId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }

      // Load chat messages for this group
      loadChatMessages('group', groupId);
    }

    async function loadChatMessages(type, id) {
      const chatFeed = document.getElementById('chatMessagesFeed');
      if (!chatFeed) return;

      chatFeed.innerHTML = '<div style="text-align: center; padding: 40px; color: #9CA3AF;"><i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i><p style="margin-top: 12px;">Loading messages...</p></div>';

      try {
        let url;
        if (type === 'dm') {
          url = `/chat/history/?peer=${encodeURIComponent(id)}`;
        } else if (type === 'group') {
          url = `/chat/group/history/?group_id=${encodeURIComponent(id)}`;
        }

        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load messages');

        const data = await res.json();
        const messages = data.messages || [];
        const currentUserEmail = '{% if request.session.ident_email %}{{ request.session.ident_email }}{% elif request.user.email %}{{ request.user.email }}{% endif %}';
        const currentUserName = '{% if request.session.cn %}{{ request.session.cn }}{% elif request.session.member_name %}{{ request.session.member_name }}{% elif request.user.username %}{{ request.user.username }}{% endif %}';

        console.log('Current user email:', currentUserEmail);
        console.log('Current user name:', currentUserName);

        chatFeed.innerHTML = '';

        if (messages.length === 0) {
          chatFeed.innerHTML = '<div style="text-align: center; padding: 40px; color: #9CA3AF;"><i class="fas fa-comments" style="font-size: 48px; color: #ddd; margin-bottom: 16px;"></i><p style="font-weight: 600; color: #666;">No messages yet</p><p style="margin-top: 8px;">Start a conversation!</p></div>';
        } else {
          messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          
          messages.forEach(msg => {
            // Check if message is from current user using multiple criteria
            const msgSender = (msg.sender || '').toLowerCase().trim();
            const msgSenderEmail = (msg.sender_email || msgSender).toLowerCase().trim();
            const currentEmail = currentUserEmail.toLowerCase().trim();
            const currentName = currentUserName.toLowerCase().trim();
            
            const isSent = msg.is_self || 
                          msgSenderEmail === currentEmail || 
                          msgSender === currentEmail ||
                          msgSender === currentName;
            
            const senderName = msg.sender_name || msg.sender || 'Unknown';
            const senderInitial = getInitials(senderName);
            const timestamp = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            console.log('Message:', msg.text, 'Sender:', msgSender, 'Is sent:', isSent);
            
            const msgHtml = `
              <div class="chat-message-group ${isSent ? 'sent-message' : ''}" style="animation: slideIn 0.3s ease-out">
                <div class="chat-avatar">${senderInitial}</div>
                <div class="chat-message-content">
                  <div class="chat-message-header">
                    <span class="chat-username">${escapeHtml(senderName)}</span>
                    <span class="chat-timestamp">${timestamp}</span>
                  </div>
                  <div class="chat-text">${escapeHtml(msg.text)}</div>
                </div>
              </div>
            `;
            chatFeed.insertAdjacentHTML('beforeend', msgHtml);
          });

          chatFeed.scrollTop = chatFeed.scrollHeight;
        }
      } catch (e) {
        console.error('loadChatMessages error:', e);
        chatFeed.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i><p style="margin-top: 12px;">Error loading messages</p></div>';
      }
    }

    async function refreshUnreadCounts() {
      try {
        const res = await fetch('/chat/unread/', { credentials: 'same-origin' });
        if (!res.ok) return;
        
        const data = await res.json();
        let total = 0;
        
        if (data && data.unread) {
          data.unread.forEach(item => {
            total += item.count || 0;
          });
        }

        const badge = document.getElementById('unread-badge');
        if (badge) {
          if (total > 0) {
            badge.textContent = total;
            badge.style.display = '';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('refreshUnreadCounts error:', e);
      }
    }

    async function fetchOnlineUsers() {
      try {
        // First, always mark current user as online
        const currentUserEmail = '{% if request.session.ident_email %}{{ request.session.ident_email }}{% elif request.user.email %}{{ request.user.email }}{% endif %}'.toLowerCase();
        const currentUserName = '{% if request.session.cn %}{{ request.session.cn }}{% elif request.session.member_name %}{{ request.session.member_name }}{% elif request.user.username %}{{ request.user.username }}{% endif %}'.toLowerCase();
        
        if (currentUserEmail) {
          onlineUsers.add(currentUserEmail);
        }
        if (currentUserName) {
          onlineUsers.add(currentUserName);
        }

        // Try to fetch online users from backend
        try {
          const res = await fetch('/chat/online/', { credentials: 'same-origin' });
          if (res.ok) {
            const data = await res.json();
            
            if (data && data.online_users) {
              data.online_users.forEach(user => {
                // Store both ID and email for matching
                if (user.id) onlineUsers.add(user.id.toString());
                if (user.email) onlineUsers.add(user.email.toLowerCase());
                if (user.name) onlineUsers.add(user.name.toLowerCase());
              });
            }
          }
        } catch (fetchError) {
          console.log('Backend online status not available, using client-side only');
        }

        // Update UI - show/hide online indicators
        document.querySelectorAll('.online-indicator').forEach(indicator => {
          const userId = indicator.dataset.userId;
          const dmItem = indicator.closest('.dm-item');
          const userEmail = dmItem ? dmItem.dataset.memberEmail : null;
          const userName = dmItem ? dmItem.dataset.name : null;
          
          const isOnline = onlineUsers.has(userId) || 
                          (userEmail && onlineUsers.has(userEmail.toLowerCase())) ||
                          (userName && onlineUsers.has(userName.toLowerCase()));
          
          indicator.style.display = isOnline ? 'block' : 'none';
          
          // Update online text in name
          if (dmItem) {
            const nameEl = dmItem.querySelector('.dm-name');
            if (nameEl) {
              const baseName = nameEl.textContent.replace(/ ● Online$/, '');
              if (isOnline && !baseName.includes('(You)')) {
                nameEl.innerHTML = escapeHtml(baseName) + ' <span style="color: #10b981; font-size: 11px;">● Online</span>';
              } else {
                nameEl.textContent = baseName;
              }
            }
          }
        });

        console.log('Online users updated:', onlineUsers.size, 'users online');
      } catch (e) {
        console.error('fetchOnlineUsers error:', e);
      }
    }

    function updateCurrentUserOnlineStatus() {
      // Tell backend that current user is online (if endpoint exists)
      try {
        fetch('/chat/heartbeat/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          }
        }).catch(e => {
          // Backend endpoint might not exist yet, that's okay
          console.log('Heartbeat endpoint not available');
        });
      } catch (e) {
        console.log('Heartbeat not sent:', e.message);
      }
    }

    // Initialize sidebar when chat opens or page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadChatSidebar();
      
      // Initialize WebSocket for real-time chat
      initChatWebSocket();
      
      // Fetch online users immediately
      fetchOnlineUsers();
      
      // Refresh unread counts every 30 seconds
      setInterval(refreshUnreadCounts, 30000);
      
      // Refresh online status every 15 seconds (backup for WebSocket)
      setInterval(fetchOnlineUsers, 15000);
    });

    // Send presence when closing page
    window.addEventListener('beforeunload', function() {
      sendPresence('offline');
    });

    // Start with chat hidden
    if (chatFeed) chatFeed.scrollTop = chatFeed.scrollHeight;
  </script>
</body>
</html>