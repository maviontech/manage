{# Reusable attachments block: drag/drop + file list. #}
<style>
  .attachments-card {
    margin: 1.25rem 0 1.5rem 0;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 0;
    background: #ffffff;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .attachments-dropzone {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 32px 24px;
    border-radius: 0;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px dashed #cbd5e1;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0;
  }
  .attachments-dropzone:hover {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #60a5fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  }
  .attachments-dropzone.dragover { 
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-color: #3b82f6;
    border-style: solid;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  .attachments-icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
  }
  .attachments-hint { 
    color: #64748b; 
    font-size: 0.875rem;
    line-height: 1.5;
  }
  .attachments-title {
    font-weight: 600;
    color: #0f172a;
    font-size: 1rem;
    margin-bottom: 4px;
  }
  .attachments-list { 
    margin: 0;
    padding: 16px;
    text-align: left;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
  }
  .attachments-list li { 
    padding: 12px 14px;
    border-radius: 8px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
  }
  .attachments-list li:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .attachments-list .remove { 
    color: #ef4444;
    cursor: pointer;
    margin-left: 12px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  .attachments-list .remove:hover {
    background: #fee2e2;
    color: #dc2626;
  }
  .attachments-meta { 
    font-size: 0.8125rem;
    color: #94a3b8;
    padding: 12px 16px;
    background: #ffffff;
    border-top: 1px solid #e2e8f0;
    margin: 0;
  }
</style>

<div class="attachments-card">
  <div class="attachments-dropzone" tabindex="0" role="button">
    <div class="attachments-icon-wrapper">
      <i class="fa-solid fa-cloud-arrow-up" style="font-size:28px;color:#ffffff"></i>
    </div>
    <div style="text-align:left">
      <div class="attachments-title">Click to upload or drag and drop</div>
      <div class="attachments-hint">Screenshots, logs, or documents (Max 10MB per file, up to 5 files)</div>
    </div>
  </div>

  <input type="file" id="attachmentsInput" name="attachments" multiple style="display:none" accept="image/*,.pdf,.txt,.log,.doc,.docx,.xls,.xlsx" />

  <ul id="attachmentsList" class="attachments-list" aria-live="polite"></ul>
  <div class="attachments-meta">Accepted formats: Images, PDF, TXT, LOG, DOC, DOCX, XLS, XLSX.</div>
</div>

<script>
  (function(){
    const input = document.getElementById('attachmentsInput');
    const dropzone = document.querySelector('.attachments-dropzone');
    const list = document.getElementById('attachmentsList');
    const MAX_FILES = 5;
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB

    function humanSize(bytes){
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
      return (bytes/(1024*1024)).toFixed(1) + ' MB';
    }

    function renderFiles(files){
      list.innerHTML = '';
      Array.from(files).forEach((f, idx)=>{
        const li = document.createElement('li');
        li.textContent = f.name + ' â€” ' + humanSize(f.size);
        const remove = document.createElement('span');
        remove.className = 'remove';
        remove.innerHTML = '<i class="fa-solid fa-trash"></i>';
        remove.addEventListener('click', ()=>{
          const dt = new DataTransfer();
          Array.from(input.files).forEach((file,i)=>{ if(i!==idx) dt.items.add(file); });
          input.files = dt.files;
          renderFiles(input.files);
        });
        li.appendChild(remove);
        list.appendChild(li);
      });
    }

    dropzone.addEventListener('click', ()=>{ input.value = null; input.click(); });
    dropzone.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.value = null; input.click(); } });
    dropzone.addEventListener('dragover', function(e){ e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', function(e){ dropzone.classList.remove('dragover'); });
    dropzone.addEventListener('drop', function(e){
      e.preventDefault(); dropzone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      handleNewFiles(files);
    });

    input.addEventListener('change', function(){ handleNewFiles(this.files); });

    function handleNewFiles(fileList){
      const existing = Array.from(input.files || []);
      const incoming = Array.from(fileList || []);

      // dedupe by name+size+lastModified
      const existingSigs = new Set(existing.map(f=> `${f.name}|${f.size}|${f.lastModified}`));
      const filtered = incoming.filter(f => !existingSigs.has(`${f.name}|${f.size}|${f.lastModified}`));

      const combined = existing.concat(filtered);

      if(combined.length > MAX_FILES){ alert('Maximum ' + MAX_FILES + ' files allowed'); return; }

      for(const f of filtered){ if(f.size > MAX_SIZE){ alert(f.name + ' exceeds 10MB limit'); return; } }

      const dt = new DataTransfer();
      combined.forEach(f => dt.items.add(f));
      input.files = dt.files;
      renderFiles(input.files);
    }
  })();
</script>
